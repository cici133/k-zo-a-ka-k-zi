
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>NOIR · Premium SMS v10</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Inter:wght@300;400;500;600&display=swap');

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: rgba(18, 18, 18, 0.85);
            --bg-tertiary: rgba(28, 28, 28, 0.9);
            --bg-card: rgba(22, 22, 22, 0.75);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.06);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-accent: rgba(255, 255, 255, 0.12);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.55);
            --text-tertiary: rgba(255, 255, 255, 0.35);
            --text-muted: rgba(255, 255, 255, 0.25);
            --accent-gold: #c9a962;
            --accent-gold-dim: rgba(201, 169, 98, 0.15);
            --accent-rose: #b8627d;
            --accent-blue: #5a7db5;
            --accent-emerald: #4a9e7c;
            --accent-purple: #8b5cf6;
            --danger: #c75050;
            --success: #5a9e6f;
            --blur-heavy: 40px;
            --blur-medium: 25px;
            --blur-light: 15px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --font-serif: 'Cormorant Garamond', 'Noto Serif SC', Georgia, serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif;
            --transition-smooth: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-fast: all 0.2s ease;
            --font-scale: 1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            height: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            letter-spacing: 0.02em;
            line-height: 1.5;
            font-size: calc(14px * var(--font-scale));
        }

        #wallpaperLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(180deg, #0a0a0a 0%, #111111 50%, #0d0d0d 100%);
        }

        .phone-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
            z-index: 1;
        }

        /* ========== Status Bar ========== */
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: calc(28px + var(--safe-top));
            padding-top: var(--safe-top);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            z-index: 1000;
            background: transparent;
        }

        .status-bar.hidden { display: none !important; }

        .status-bar-time {
            font-size: calc(13px * var(--font-scale));
            font-weight: 500;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            letter-spacing: 0.5px;
        }

        .status-bar-icons {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .status-bar-icons svg {
            width: 14px;
            height: 14px;
            fill: var(--text-tertiary);
        }

        /* ========== Home Screen ========== */
        .home-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding-top: calc(60px + var(--safe-top));
            padding-bottom: calc(100px + var(--safe-bottom));
            padding-left: 24px;
            padding-right: 24px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 1;
        }

        .home-screen.no-statusbar {
            padding-top: calc(40px + var(--safe-top));
        }

        .home-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .home-brand {
            font-family: var(--font-serif);
            font-size: calc(11px * var(--font-scale));
            font-weight: 400;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .home-title {
            font-family: var(--font-serif);
            font-size: calc(32px * var(--font-scale));
            font-weight: 300;
            letter-spacing: 8px;
            text-transform: uppercase;
            color: var(--text-primary);
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .home-divider {
            width: 40px;
            height: 1px;
            margin: 20px auto;
            background: linear-gradient(90deg, transparent, var(--text-tertiary), transparent);
        }

        /* ========== App Grid ========== */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            justify-items: center;
            margin-top: 20px;
        }

        .app-icon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .app-icon-wrapper:active {
            transform: scale(0.92);
        }

        .app-icon {
            width: 64px;
            height: 64px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            backdrop-filter: blur(var(--blur-light));
            -webkit-backdrop-filter: blur(var(--blur-light));
            transition: var(--transition-smooth);
            overflow: hidden;
            position: relative;
        }

        .app-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            border-radius: 18px 18px 0 0;
            pointer-events: none;
        }

        .app-icon:hover {
            border-color: var(--border-accent);
            background: var(--bg-glass-hover);
        }

        .app-icon svg {
            width: 26px;
            height: 26px;
            stroke: var(--text-secondary);
            stroke-width: 1.5;
            fill: none;
            z-index: 1;
        }

        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-icon-label {
            font-size: calc(11px * var(--font-scale));
            font-weight: 400;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            text-align: center;
            font-family: var(--font-sans);
        }

        .home-indicator {
            position: absolute;
            bottom: calc(8px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            z-index: 1001;
        }

        /* ========== Page System ========== */
        .page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.92);
            backdrop-filter: blur(var(--blur-heavy));
            -webkit-backdrop-filter: blur(var(--blur-heavy));
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page.active {
            transform: translateX(0);
        }

        .page.slide-from-bottom {
            transform: translateY(100%);
        }

        .page.slide-from-bottom.active {
            transform: translateY(0);
        }

        .page#chatPage {
            background: rgba(8, 8, 8, 0.95);
        }

        .page#chatPage.has-custom-bg {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        /* ========== Navigation Bar ========== */
        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: calc(12px + var(--safe-top));
            padding-bottom: 16px;
            padding-left: 16px;
            padding-right: 16px;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 70%, transparent 100%);
            backdrop-filter: blur(var(--blur-medium));
            -webkit-backdrop-filter: blur(var(--blur-medium));
            flex-shrink: 0;
            min-height: calc(56px + var(--safe-top));
            border: none;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: calc(13px * var(--font-scale));
            font-weight: 400;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            min-width: 44px;
            transition: var(--transition-fast);
            font-family: var(--font-sans);
            letter-spacing: 0.3px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .nav-btn:active {
            transform: scale(0.96);
        }

        .nav-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .nav-title {
            font-family: var(--font-serif);
            font-size: calc(16px * var(--font-scale));
            font-weight: 400;
            color: var(--text-primary);
            text-align: center;
            flex: 1;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* ========== Page Content ========== */
        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }

        /* ========== Settings Groups ========== */
        .settings-group {
            background: var(--bg-card);
            backdrop-filter: blur(var(--blur-light));
            -webkit-backdrop-filter: blur(var(--blur-light));
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .settings-group-title {
            font-family: var(--font-serif);
            font-size: calc(11px * var(--font-scale));
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 20px 16px 8px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--bg-glass-hover);
        }

        .settings-item:active {
            background: rgba(255, 255, 255, 0.04);
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .settings-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
        }

        .settings-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
            stroke-width: 1.5;
            fill: none;
        }

        .settings-icon.gold { background: var(--accent-gold-dim); }
        .settings-icon.gold svg { stroke: var(--accent-gold); }
        .settings-icon.rose { background: rgba(184, 98, 125, 0.15); }
        .settings-icon.rose svg { stroke: var(--accent-rose); }
        .settings-icon.blue { background: rgba(90, 125, 181, 0.15); }
        .settings-icon.blue svg { stroke: var(--accent-blue); }
        .settings-icon.emerald { background: rgba(74, 158, 124, 0.15); }
        .settings-icon.emerald svg { stroke: var(--accent-emerald); }
        .settings-icon.purple { background: rgba(139, 92, 246, 0.15); }
        .settings-icon.purple svg { stroke: var(--accent-purple); }
        .settings-icon.danger { background: rgba(199, 80, 80, 0.15); }
        .settings-icon.danger svg { stroke: var(--danger); }

        .settings-item-label {
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            font-weight: 400;
        }

        .settings-item-desc {
            color: var(--text-tertiary);
            font-size: calc(11px * var(--font-scale));
            margin-top: 2px;
        }

        /* ========== Input Fields ========== */
        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: calc(10px * var(--font-scale));
            font-weight: 500;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-family: var(--font-sans);
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            outline: none;
            font-family: var(--font-sans);
            transition: var(--transition-fast);
        }

        .input-field:focus {
            border-color: var(--accent-gold);
            background: var(--bg-glass-hover);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.6;
        }

        textarea.css-editor {
            min-height: 180px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.4);
            color: var(--accent-gold);
        }

        /* ========== Buttons ========== */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            font-size: calc(13px * var(--font-scale));
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            font-family: var(--font-sans);
            letter-spacing: 0.5px;
            transition: var(--transition-fast);
            background: var(--bg-glass);
            color: var(--text-primary);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.12));
        }

        .btn-secondary {
            background: var(--bg-glass);
            border: 1px solid var(--border-accent);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-glass-hover);
        }

        .btn-danger {
            background: rgba(199, 80, 80, 0.2);
            border: 1px solid rgba(199, 80, 80, 0.3);
            color: var(--danger);
        }

        .btn-small {
            padding: 10px 16px;
            font-size: calc(12px * var(--font-scale));
        }

        .btn-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn-row .btn {
            flex: 1;
        }

        /* ========== Contact List ========== */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 16px;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-smooth);
        }

        .contact-item:hover {
            border-color: var(--border-accent);
            background: var(--bg-glass-hover);
        }

        .contact-item:active {
            transform: scale(0.99);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-secondary);
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-family: var(--font-serif);
            font-size: calc(15px * var(--font-scale));
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .contact-preview {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-time {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-muted);
            flex-shrink: 0;
        }

        /* ========== Empty State ========== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-glass);
            border-radius: 20px;
            border: 1px solid var(--border-subtle);
        }

        .empty-state-icon svg {
            width: 28px;
            height: 28px;
            stroke: var(--text-tertiary);
            stroke-width: 1.5;
            fill: none;
        }

        .empty-state-title {
            font-family: var(--font-serif);
            font-size: calc(18px * var(--font-scale));
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .empty-state-desc {
            font-size: calc(13px * var(--font-scale));
            color: var(--text-tertiary);
        }

        /* ========== Chat Container ========== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            -webkit-overflow-scrolling: touch;
        }

        /* ========== Message Wrapper ========== */
        .message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 2px;
        }

        .message-wrapper.sent {
            justify-content: flex-end;
        }

        .message-wrapper.received {
            justify-content: flex-start;
        }

        /* ========== Message Avatar ========== */
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .message-avatar.square { border-radius: 6px; }
        .message-avatar.rounded-square { border-radius: 8px; }
        .message-avatar.hidden { display: none; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* ========== Message Bubble ========== */
        .message {
            max-width: 72%;
            padding: calc(12px * var(--font-scale)) calc(16px * var(--font-scale));
            font-size: calc(14px * var(--font-scale));
            line-height: 1.5;
            word-wrap: break-word;
            animation: msgIn 0.25s ease-out;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message.sent {
            background: rgba(60, 60, 65, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border-radius: 18px 18px 4px 18px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .message.received {
            background: rgba(45, 45, 50, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: var(--text-primary);
            border-radius: 18px 18px 18px 4px;
        }

        /* Long press visual feedback */
        .message.long-pressing,
        .voice-message.long-pressing,
        .scene-image-card.long-pressing {
            transform: scale(0.97);
            opacity: 0.85;
            transition: transform 0.15s ease, opacity 0.15s ease;
        }

        /* ========== Message Quote ========== */
        .message-quote {
            background: rgba(0, 0, 0, 0.25);
            border-left: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            max-height: 48px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* ========== Message Image ========== */
        .message-image {
            max-width: 220px;
            max-height: 220px;
            border-radius: 12px;
            margin-top: 6px;
            cursor: pointer;
            display: block;
            border: 1px solid var(--border-subtle);
        }

        /* ========== Message Time ========== */
        .message-time {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 0.3px;
        }

        .message-time.time-hidden { display: none; }

        .message-time.time-side {
            position: absolute;
            bottom: 6px;
            right: -44px;
            margin-top: 0;
        }

        .message-wrapper.sent .message-time.time-side {
            right: auto;
            left: -44px;
        }

        /* ========== Message Checkbox (Select Mode) ========== */
        .message-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--text-tertiary);
            background: transparent;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: var(--transition-fast);
        }

        .message-checkbox.checked {
            background: var(--danger);
            border-color: var(--danger);
        }

        .message-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 11px;
        }

        .chat-messages.select-mode .message-checkbox {
            display: flex;
        }

        /* ========== Scene Image Card ========== */
        .scene-image-card {
            max-width: 240px;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            animation: msgIn 0.25s ease-out;
            transition: transform 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        .scene-image-card:active {
            transform: scale(0.98);
        }

        .scene-image-cover {
            width: 100%;
            height: 160px;
            background-image: url('https://iili.io/3dAcryG.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scene-image-cover::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.2));
            pointer-events: none;
        }

        .scene-image-cover::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.6));
            pointer-events: none;
        }

        .scene-image-icon {
            width: 48px;
            height: 48px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1;
            transition: var(--transition-fast);
        }

        .scene-image-icon svg {
            width: 22px;
            height: 22px;
            stroke: rgba(255,255,255,0.9);
            stroke-width: 1.5;
            fill: none;
        }

        .scene-image-footer {
            padding: 12px 14px;
            background: rgba(20, 20, 25, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.06);
        }

        .scene-image-label {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scene-image-label svg {
            width: 12px;
            height: 12px;
            stroke: var(--accent-purple);
            stroke-width: 2;
            fill: none;
        }

        .scene-image-card.expanded .scene-image-cover {
            display: none;
        }

        .scene-image-card.expanded .scene-image-content {
            display: block;
        }

        .scene-image-content {
            display: none;
            padding: 16px;
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            min-height: 120px;
        }

        .scene-image-text {
            font-size: calc(13px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.6;
            font-style: italic;
        }

        .scene-image-hint {
            margin-top: 12px;
            font-size: calc(10px * var(--font-scale));
            color: var(--text-muted);
            text-align: center;
        }

        /* ========== Voice Message ========== */
        .voice-message {
            max-width: 200px;
            padding: 12px 16px;
            border-radius: 20px;
            background: rgba(50, 50, 55, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            cursor: pointer;
            animation: msgIn 0.25s ease-out;
            transition: var(--transition-fast);
            user-select: none;
            -webkit-user-select: none;
        }

        .voice-message:active {
            transform: scale(0.98);
        }

        .voice-message.sent {
            background: rgba(60, 60, 65, 0.7);
            border-radius: 20px 20px 4px 20px;
        }

        .voice-message.received {
            background: rgba(45, 45, 50, 0.7);
            border-radius: 20px 20px 20px 4px;
        }

        .voice-message-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.15);
            flex-shrink: 0;
        }

        .voice-play-btn svg {
            width: 14px;
            height: 14px;
            stroke: var(--text-primary);
            stroke-width: 2;
            fill: none;
        }

        .voice-waveform {
            flex: 1;
            height: 24px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-wave-bar {
            width: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .voice-duration {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
            flex-shrink: 0;
            min-width: 28px;
            text-align: right;
        }

        .voice-text-content {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .voice-text-content.visible {
            display: block;
        }

        .voice-text-content p {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .voice-message-time {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-muted);
            margin-top: 6px;
            text-align: right;
        }

        /* ========== Typing Indicator ========== */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 18px 18px 18px 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* ========== Chat Input Area ========== */
        .chat-input-wrapper {
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%);
            backdrop-filter: blur(var(--blur-medium));
            -webkit-backdrop-filter: blur(var(--blur-medium));
        }

        .quote-preview-bar {
            display: none;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-subtle);
            align-items: center;
            gap: 12px;
        }

        .quote-preview-bar.active {
            display: flex;
        }

        .quote-preview-content {
            flex: 1;
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 2px solid rgba(255,255,255,0.3);
            padding-left: 10px;
        }

        .quote-preview-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
        }

        .chat-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: rgba(35, 35, 40, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition-fast);
        }

        .chat-btn:hover {
            background: rgba(50, 50, 55, 0.9);
            color: var(--text-primary);
        }

        .chat-btn:active {
            transform: scale(0.94);
        }

        .chat-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .chat-btn.send {
            background: rgba(40, 40, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-btn.send:hover {
            background: rgba(55, 55, 60, 0.95);
        }

        .chat-btn.send svg {
            stroke: var(--text-primary);
        }

        .chat-btn.ai {
            background: rgba(45, 45, 50, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-btn.ai:hover {
            background: rgba(60, 60, 65, 0.95);
        }

        .chat-btn.ai svg {
            stroke: var(--text-primary);
        }

        .chat-input-field {
            flex: 1;
            min-height: 40px;
            max-height: 100px;
            padding: 10px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            resize: none;
            outline: none;
            font-family: inherit;
            line-height: 1.4;
        }

        .chat-input-field:focus {
            border-color: rgba(255,255,255,0.2);
        }

        .chat-input-field::placeholder {
            color: var(--text-muted);
        }

        /* ========== Extension Panel ========== */
        .extension-panel {
            position: absolute;
            bottom: calc(70px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 0;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateY(16px);
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .extension-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .ext-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .ext-panel-title {
            font-family: var(--font-serif);
            font-size: calc(12px * var(--font-scale));
            font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .ext-panel-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ext-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
            padding: 16px 20px;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            cursor: pointer;
            transition: var(--transition-fast);
            text-align: left;
        }

        .ext-btn:last-child {
            border-bottom: none;
        }

        .ext-btn:hover {
            background: var(--bg-glass-hover);
        }

        .ext-btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
        }

        .ext-btn-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
            stroke-width: 1.5;
            fill: none;
        }

        .ext-btn-icon.danger { background: rgba(199, 80, 80, 0.15); }
        .ext-btn-icon.danger svg { stroke: var(--danger); }
        .ext-btn-icon.purple { background: rgba(139, 92, 246, 0.15); }
        .ext-btn-icon.purple svg { stroke: var(--accent-purple); }
        .ext-btn-icon.blue { background: rgba(90, 125, 181, 0.15); }
        .ext-btn-icon.blue svg { stroke: var(--accent-blue); }
        .ext-btn-icon.rose { background: rgba(184, 98, 125, 0.15); }
        .ext-btn-icon.rose svg { stroke: var(--accent-rose); }
        .ext-btn-icon.emerald { background: rgba(74, 158, 124, 0.15); }
        .ext-btn-icon.emerald svg { stroke: var(--accent-emerald); }

        .ext-btn-text {
            flex: 1;
        }

        .ext-btn-title {
            font-size: calc(14px * var(--font-scale));
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .ext-btn-desc {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
        }

        /* ========== Context Menu (Long Press Menu) ========== */
        .context-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .context-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .context-menu {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            width: 220px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.25s ease;
        }

        .context-menu-overlay.active .context-menu {
            transform: scale(1);
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: var(--bg-glass-hover);
        }

        .context-menu-item:active {
            background: rgba(255, 255, 255, 0.08);
        }

        .context-menu-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
        }

        .context-menu-icon svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
            stroke-width: 1.5;
            fill: none;
        }

        .context-menu-label {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-primary);
        }

        /* ========== Modal Overlay ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 24px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 100%;
            max-width: 360px;
            max-height: 85vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            backdrop-filter: blur(var(--blur-heavy));
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-subtle);
            transform: scale(0.92);
            transition: transform 0.3s ease;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-title {
            font-family: var(--font-serif);
            font-size: calc(18px * var(--font-scale));
            font-weight: 400;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .modal-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            outline: none;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            border-color: rgba(255,255,255,0.2);
        }

        .modal-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            outline: none;
            margin-bottom: 16px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        .modal-textarea:focus {
            border-color: rgba(255,255,255,0.2);
        }

        .modal-textarea::placeholder {
            color: var(--text-muted);
        }

        .modal-btns {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: calc(14px * var(--font-scale));
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .modal-btn.cancel {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
        }

        /* ========== Toast Container ========== */
        .toast-container {
            position: fixed;
            top: calc(60px + var(--safe-top));
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            padding: 12px 20px;
            background: var(--bg-secondary);
            backdrop-filter: blur(var(--blur-medium));
            border-radius: 12px;
            color: var(--text-primary);
            font-size: calc(13px * var(--font-scale));
            font-weight: 400;
            border: 1px solid var(--border-subtle);
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid rgba(255,255,255,0.4); }
        .toast.warning { border-left: 3px solid var(--accent-rose); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* ========== Search Field ========== */
        .search-field {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.3)' stroke-width='1.5'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 14px center;
        }

        .search-field:focus {
            border-color: rgba(255,255,255,0.2);
        }

        /* ========== Toggle Switch ========== */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 28px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .toggle-switch.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.25s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch.active::after {
            left: 23px;
        }

        /* ========== Select Field ========== */
        .select-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }

        .select-field option {
            background: var(--bg-primary);
        }

        /* ========== File Input Hidden ========== */
        .file-input-hidden {
            display: none;
        }

        /* ========== Divider ========== */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
            margin: 20px 0;
        }

        /* ========== Loading Spinner ========== */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== Slider ========== */
        .slider-container {
            margin: 16px 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
        }

        .slider-value {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-primary);
            font-weight: 500;
        }

        .slider-input {
            width: 100%;
            height: 4px;
            background: var(--bg-glass);
            border-radius: 2px;
            appearance: none;
        }

        .slider-input::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* ========== Action Hint ========== */
        .action-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .action-hint-icon {
            font-size: 14px;
        }

        .action-hint-text {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
        }

        .action-hint.success {
            background: rgba(90, 158, 111, 0.1);
            border-color: rgba(90, 158, 111, 0.2);
        }

        .action-hint.success .action-hint-text {
            color: var(--success);
        }

        .action-hint.warning {
            background: rgba(184, 98, 125, 0.1);
            border-color: rgba(184, 98, 125, 0.2);
        }

        .action-hint.warning .action-hint-text {
            color: var(--accent-rose);
        }

        /* ========== Delete Zone ========== */
        .delete-zone {
            padding: 18px;
            border: 1px dashed var(--danger);
            border-radius: 14px;
            text-align: center;
            color: var(--danger);
            margin-top: 20px;
            cursor: pointer;
            font-size: calc(14px * var(--font-scale));
            transition: var(--transition-fast);
        }

        .delete-zone:hover {
            background: rgba(199, 80, 80, 0.1);
        }

        /* ========== Log Container ========== */
        .log-container {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            max-height: 140px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.info { color: var(--text-secondary); }

        /* ========== Model List ========== */
        .model-list {
            max-height: 160px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .model-item {
            padding: 12px 14px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .model-item:hover {
            background: var(--bg-glass-hover);
            border-color: var(--border-accent);
        }

        .model-item.selected {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .model-item-name {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-primary);
        }

        /* ========== Date Separator ========== */
        .date-separator {
            display: flex;
            justify-content: center;
            padding: 12px 0;
        }

        .date-separator-text {
            padding: 4px 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
        }

        /* ========== Select Mode Bar ========== */
        .select-mode-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(199, 80, 80, 0.1);
            border-bottom: 1px solid rgba(199, 80, 80, 0.2);
        }

        .select-mode-bar.active {
            display: flex;
        }

        .select-mode-info {
            font-size: calc(13px * var(--font-scale));
            color: var(--text-primary);
        }

        .select-mode-btns {
            display: flex;
            gap: 10px;
        }

        .select-mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: calc(12px * var(--font-scale));
            font-weight: 500;
            cursor: pointer;
        }

        .select-mode-btn.cancel {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .select-mode-btn.delete {
            background: var(--danger);
            color: white;
        }

        /* ========== Avatar Upload Area ========== */
        .avatar-upload-area {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: var(--bg-glass);
            border: 2px dashed var(--border-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 auto 16px;
            color: var(--text-tertiary);
            overflow: hidden;
            transition: var(--transition-fast);
        }

        .avatar-upload-area:hover {
            border-color: rgba(255,255,255,0.3);
        }

        .avatar-upload-area.has-image {
            border-style: solid;
            border-color: rgba(255,255,255,0.3);
        }

        .avatar-upload-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-area svg {
            width: 28px;
            height: 28px;
            stroke: var(--text-tertiary);
            stroke-width: 1.5;
            fill: none;
        }

        /* ========== Color Picker Row ========== */
        .color-picker-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .color-picker-label {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-primary);
            flex: 1;
        }

        .color-picker-input {
            width: 44px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        /* ========== Shape Options ========== */
        .shape-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .shape-option {
            padding: 8px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: calc(12px * var(--font-scale));
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .shape-option.selected {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* ========== Worldbook Entries ========== */
        .worldbook-entries {
            margin-top: 12px;
        }

        .worldbook-entry-item {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }

        .worldbook-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .worldbook-entry-title {
            font-size: calc(13px * var(--font-scale));
            font-weight: 500;
            color: var(--text-primary);
        }

        .worldbook-entry-actions {
            display: flex;
            gap: 8px;
        }

        .worldbook-entry-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .worldbook-entry-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        .worldbook-entry-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .worldbook-entry-keywords {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .worldbook-entry-preview {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ========== Worldbook Item ========== */
        .worldbook-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .worldbook-item:hover {
            border-color: var(--border-accent);
        }

        .worldbook-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .worldbook-item-title {
            font-family: var(--font-serif);
            font-size: calc(15px * var(--font-scale));
            font-weight: 500;
            color: var(--text-primary);
        }

        .worldbook-item-badge {
            padding: 3px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            font-size: calc(10px * var(--font-scale));
            color: var(--text-secondary);
            font-weight: 500;
        }

        .worldbook-item-preview {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-tertiary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ========== Char Counter ========== */
        .char-counter {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-tertiary);
            text-align: right;
            margin-top: 4px;
        }

        .char-counter.warning { color: var(--accent-rose); }
        .char-counter.error { color: var(--danger); }

        /* ========== Wallpaper Preview ========== */
        .wallpaper-preview {
            width: 100%;
            height: 140px;
            border-radius: 14px;
            margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            background: var(--bg-glass);
        }

        /* ========== Icon Customize Grid ========== */
        .icon-customize-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .icon-customize-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .icon-customize-preview {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px dashed var(--border-accent);
            overflow: hidden;
            transition: var(--transition-fast);
            background: var(--bg-glass);
        }

        .icon-customize-preview:hover {
            border-color: rgba(255,255,255,0.3);
        }

        .icon-customize-preview.has-image {
            border-style: solid;
        }

        .icon-customize-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .icon-customize-preview svg {
            width: 22px;
            height: 22px;
            stroke: var(--text-tertiary);
            stroke-width: 1.5;
            fill: none;
        }

        .icon-customize-label {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-tertiary);
        }

        /* ========== Storage Card ========== */
        .storage-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .storage-title {
            font-size: calc(13px * var(--font-scale));
            font-weight: 500;
            color: var(--text-primary);
        }

        .storage-size {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
        }

        .storage-bar {
            height: 6px;
            background: var(--bg-glass);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .storage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.5));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .storage-bar-fill.warning {
            background: linear-gradient(90deg, var(--accent-rose), #8a4a5d);
        }

        .storage-bar-fill.danger {
            background: linear-gradient(90deg, var(--danger), #a04040);
        }

        .storage-details {
            display: flex;
            justify-content: space-between;
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
        }

        /* ========== Preset Selector ========== */
        .preset-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .preset-selector select {
            flex: 1;
        }

        .preset-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .preset-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        .preset-btn:active {
            transform: scale(0.94);
        }

        .preset-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        /* ========== Guide Content ========== */
        .guide-content {
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 8px;
        }

        .guide-section {
            margin-bottom: 18px;
        }

        .guide-section-title {
            font-size: calc(12px * var(--font-scale));
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .guide-code {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 10px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            overflow-x: auto;
        }

        .guide-text {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ========== Chat Wallpaper Preview ========== */
        .chat-wallpaper-preview {
            width: 100%;
            height: 100px;
            border-radius: 12px;
            margin-bottom: 14px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            font-size: calc(12px * var(--font-scale));
            overflow: hidden;
        }

        .chat-wallpaper-preview.has-image {
            background-size: cover !important;
            background-position: center !important;
        }

        .chat-wallpaper-preview.has-image span {
            display: none;
        }

        /* ========== Worldbook Multi Select ========== */
        .worldbook-multi-select {
            max-height: 160px;
            overflow-y: auto;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            background: var(--bg-glass);
        }

        .worldbook-multi-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .worldbook-multi-item:last-child {
            border-bottom: none;
        }

        .worldbook-multi-item:hover {
            background: var(--bg-glass-hover);
        }

        .worldbook-multi-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .worldbook-multi-checkbox.checked {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .worldbook-multi-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .worldbook-multi-name {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-primary);
        }

        /* ========== Font List ========== */
        .font-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .font-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .font-item:hover {
            border-color: var(--border-accent);
        }

        .font-item.selected {
            border-color: rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.05);
        }

        .font-item-info {
            flex: 1;
        }

        .font-item-name {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .font-item-preview {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
        }

        .font-item-actions {
            display: flex;
            gap: 8px;
        }

        .font-item-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .font-item-btn:hover {
            background: var(--bg-glass-hover);
        }

        .font-item-btn.danger {
            border-color: rgba(199, 80, 80, 0.3);
        }

        .font-item-btn.danger:hover {
            background: rgba(199, 80, 80, 0.1);
        }

        .font-item-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        /* ========== Color Picker Container ========== */
        .color-picker-container {
            width: 100%;
            max-width: 280px;
            margin: 0 auto 16px;
            position: relative;
        }

        .color-wheel-wrapper {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 0 auto;
            touch-action: none;
            user-select: none;
        }

        .color-ring-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .color-square-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 110px;
            height: 110px;
            transform: translate(-50%, -50%);
            border-radius: 6px;
            cursor: crosshair;
        }

        .color-ring-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.6), inset 0 0 0 2px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            transition: none;
        }

        .color-square-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.6), inset 0 0 0 2px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            transition: none;
        }

        .color-hex-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            font-family: 'SF Mono', monospace;
            text-align: center;
            outline: none;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .color-hex-input:focus {
            border-color: rgba(255,255,255,0.3);
        }

        .color-preview-swatch {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 2px solid var(--border-accent);
            margin: 0 auto 16px;
        }

        /* ========== Bubble Style Options ========== */
        .bubble-style-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .bubble-style-option {
            padding: 12px 8px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .bubble-style-option:hover {
            background: var(--bg-glass-hover);
        }

        .bubble-style-option.selected {
            border-color: rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.08);
        }

        .bubble-style-option-name {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-primary);
        }

        .bubble-preview-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .bubble-preview-sent, .bubble-preview-received {
            padding: 10px 14px;
            border-radius: 14px;
            font-size: calc(12px * var(--font-scale));
            max-width: 70%;
            margin-bottom: 8px;
        }

        .bubble-preview-sent {
            margin-left: auto;
            text-align: right;
        }

        .bubble-preview-received {
            margin-right: auto;
        }

        .color-section {
            margin-bottom: 20px;
        }

        .color-section-title {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .color-btn-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .color-btn {
            flex: 1;
            padding: 12px 10px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
            min-height: 48px;
        }

        .color-btn:hover {
            background: var(--bg-glass-hover);
        }

        .color-btn:active {
            transform: scale(0.98);
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .color-btn-label {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-primary);
        }

        /* ========== Scrollbar ========== */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #customCssStyles { }
    </style>
</head>
<body>
    <!-- Wallpaper Layer -->
    <div id="wallpaperLayer"></div>

    <!-- Phone Container -->
    <div class="phone-container">
        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">
            <span class="status-bar-time" id="statusBarTime">9:41</span>
            <div class="status-bar-icons">
                <svg viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3a4.237 4.237 0 0 0-6 0zm-4-4l2 2a7.074 7.074 0 0 1 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
                <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4zM13 18h-2v-2h2v2zm0-4h-2V9h2v5z"/></svg>
            </div>
        </div>

        <!-- Home Screen -->
        <div class="home-screen" id="homeScreen">
            <div class="home-header">
                <div class="home-brand">Premium Experience</div>
                <div class="home-title">NOIR</div>
                <div class="home-divider"></div>
            </div>

            <div class="app-grid">
                <div class="app-icon-wrapper" onclick="openPage('settingsPage')">
                    <div class="app-icon" id="appIconSettings">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </div>
                    <span class="app-icon-label">Settings</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('messagesPage')">
                    <div class="app-icon" id="appIconMessages">
                        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <span class="app-icon-label">Messages</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('lorePage')">
                    <div class="app-icon" id="appIconLore">
                        <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    </div>
                    <span class="app-icon-label">Lore</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('themePage')">
                    <div class="app-icon" id="appIconTheme">
                        <svg viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/><path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10c.55 0 1-.45 1-1v-1.67c0-.55.45-1 1-1h1.67c2.21 0 4-1.79 4-4 0-1.48-.81-2.77-2.01-3.46-.41-.24-.68-.69-.68-1.17 0-.74.6-1.34 1.34-1.34.41 0 .78.19 1.03.48.17.2.41.32.68.32.55 0 1-.45 1-1C22 6.49 17.51 2 12 2z"/></svg>
                    </div>
                    <span class="app-icon-label">Theme</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('fontsPage')">
                    <div class="app-icon" id="appIconFonts">
                        <svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                    </div>
                    <span class="app-icon-label">Fonts</span>
                </div>
            </div>
        </div>

        <!-- Home Indicator -->
        <div class="home-indicator"></div>
    </div>

    <!-- ========== Settings Page ========== -->
    <div class="page" id="settingsPage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closePage('settingsPage')">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                Back
            </button>
            <span class="nav-title">Settings</span>
            <button class="nav-btn" onclick="saveAllSettings()">Save</button>
        </div>
        <div class="page-content">
            <!-- Storage Usage -->
            <div class="storage-card">
                <div class="storage-header">
                    <span class="storage-title">Storage Usage</span>
                    <span class="storage-size" id="storageSize">Calculating...</span>
                </div>
                <div class="storage-bar">
                    <div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div>
                </div>
                <div class="storage-details">
                    <span id="storageUsed">Used: 0 MB</span>
                    <span>Unlimited</span>
                </div>
            </div>

            <!-- Display Settings -->
            <div class="settings-group">
                <div class="settings-group-title">Display Settings</div>
                <div class="settings-item">
                    <div class="settings-item-left">
                        <div class="settings-icon">
                            <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3zM21 3v18H3V3z"/><path d="M9 9h6v6H9z"/></svg>
                        </div>
                        <div>
                            <div class="settings-item-label">Font Size</div>
                        </div>
                    </div>
                    <span style="color: var(--text-secondary); font-size: 13px;" id="fontSizeValue">100%</span>
                </div>
                <div class="settings-item" style="padding-top: 8px; padding-bottom: 16px;">
                    <div class="shape-options" id="fontSizeOptions">
                        <div class="shape-option" data-size="0.85">Compact</div>
                        <div class="shape-option selected" data-size="1">Standard</div>
                        <div class="shape-option" data-size="1.15">Large</div>
                    </div>
                </div>
            </div>

            <!-- API Configuration -->
            <div class="settings-group">
                <div class="settings-group-title">API Configuration</div>
                <div class="action-hint warning" id="apiStatusHint">
                    <span class="action-hint-icon">⚠</span>
                    <span class="action-hint-text">API not configured</span>
                </div>

                <div style="padding: 0 16px 16px;">
                    <div class="input-group">
                        <label class="input-label">API Preset</label>
                        <div class="preset-selector">
                            <select class="select-field" id="apiPresetSelect">
                                <option value="">-- No Preset --</option>
                            </select>
                            <button class="preset-btn" onclick="showNewApiPresetModal()" title="Add Preset">
                                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </button>
                            <button class="preset-btn" onclick="deleteApiPreset()" title="Delete Preset">
                                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">API Endpoint</label>
                        <input type="url" class="input-field" id="apiEndpoint" placeholder="https://api.openai.com/v1">
                    </div>

                    <div class="input-group">
                        <label class="input-label">API Key</label>
                        <input type="password" class="input-field" id="apiKey" placeholder="sk-...">
                    </div>

                    <button class="btn btn-secondary btn-small" onclick="fetchModels()">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;stroke-width:1.5;fill:none;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                        Fetch Models
                    </button>

                    <div class="model-list" id="modelList">
                        <div style="padding: 12px; color: var(--text-tertiary); font-size: 12px; text-align: center;">
                            Available Models
                        </div>
                    </div>

                    <div class="input-group" style="margin-top: 12px;">
                        <label class="input-label">Current Model</label>
                        <input type="text" class="input-field" id="currentModel" placeholder="gpt-4">
                    </div>

                    <div class="btn-row" style="margin-top: 12px;">
                        <button class="btn btn-secondary btn-small" onclick="testConnection()">Test Connection</button>
                        <button class="btn btn-primary btn-small" onclick="saveApiConfig()">Save Configuration</button>
                    </div>

                    <div class="input-group" style="margin-top: 12px;">
                        <label class="input-label">Debug Log</label>
                        <div class="log-container" id="debugLog">
                            <div class="log-entry info">Waiting...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation Settings -->
            <div class="settings-group">
                <div class="settings-group-title">Conversation</div>
                <div style="padding: 0 16px 16px;">
                    <div class="input-group">
                        <label class="input-label">Max Memory Messages</label>
                        <input type="number" class="input-field" id="maxMemory" value="20" min="1" max="100">
                    </div>
                </div>
            </div>

            <!-- Model Parameters -->
            <div class="settings-group">
                <div class="settings-group-title">Model Parameters</div>
                <div style="padding: 0 16px 16px;">
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Temperature</span>
                            <span class="slider-value" id="tempValue">0.7</span>
                        </div>
                        <input type="range" class="slider-input" id="tempSlider" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Max Tokens</span>
                            <span class="slider-value" id="tokensValue">2048</span>
                        </div>
                        <input type="range" class="slider-input" id="tokensSlider" min="256" max="8192" step="256" value="2048">
                    </div>
                </div>
            </div>

            <!-- Cache & Storage -->
            <div class="settings-group">
                <div class="settings-group-title">Cache & Storage</div>
                <div class="settings-item" onclick="clearImageCache()">
                    <div class="settings-item-left">
                        <div class="settings-icon rose">
                            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                        </div>
                        <div>
                            <div class="settings-item-label">Clear Image Cache</div>
                            <div class="settings-item-desc">Avatars, wallpapers, etc.</div>
                        </div>
                    </div>
                </div>
                <div class="settings-item" onclick="clearMessageCache()">
                    <div class="settings-item-left">
                        <div class="settings-icon blue">
                            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </div>
                        <div>
                            <div class="settings-item-label">Clear Message Cache</div>
                            <div class="settings-item-desc">Keep character settings</div>
                        </div>
                    </div>
                </div>
                <div class="settings-item" onclick="optimizeStorage()">
                    <div class="settings-item-left">
                        <div class="settings-icon emerald">
                            <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </div>
                        <div>
                            <div class="settings-item-label">Optimize Storage</div>
                            <div class="settings-item-desc">Compress images</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="settings-group">
                <div class="settings-group-title">Data Management</div>
                <div style="padding: 16px;">
                    <div class="btn-stack">
                        <button class="btn btn-secondary" onclick="forceSave()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;stroke-width:1.5;fill:none;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Force Save
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;stroke-width:1.5;fill:none;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Export Data
                        </button>
                        <button class="btn btn-secondary" onclick="importData()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;stroke-width:1.5;fill:none;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Import Data
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;stroke-width:1.5;fill:none;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== Messages Page ========== -->
    <div class="page" id="messagesPage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closePage('messagesPage')">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                Back
            </button>
            <span class="nav-title">Messages</span>
            <button class="nav-btn" onclick="showNewCharModal()">
                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
        </div>
        <div class="page-content">
            <div class="contact-list" id="contactList">
                <!-- Contacts will be rendered here -->
            </div>
            <div class="empty-state" id="emptyContacts">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </div>
                <div class="empty-state-title">No Characters</div>
                <div class="empty-state-desc">Tap + to create one</div>
            </div>
        </div>
    </div>

    <!-- ========== Chat Page ========== -->
    <div class="page" id="chatPage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeChatPage()">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                Back
            </button>
            <span class="nav-title" id="chatTitle">Character</span>
            <button class="nav-btn" onclick="openCharEditPage()">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </div>

        <div class="select-mode-bar" id="selectModeBar">
            <span class="select-mode-info">Selected: <span id="selectedCount">0</span></span>
            <div class="select-mode-btns">
                <button class="select-mode-btn cancel" onclick="exitSelectMode()">Cancel</button>
                <button class="select-mode-btn delete" onclick="deleteSelectedMessages()">Delete</button>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be rendered here -->
            </div>

            <!-- Extension Panel -->
            <div class="extension-panel" id="extensionPanel">
                <div class="ext-panel-header">
                    <span class="ext-panel-title">Actions</span>
                    <button class="ext-panel-close" onclick="closeExtensionPanel()">✕</button>
                </div>
                <button class="ext-btn" onclick="enterSelectMode()">
                    <div class="ext-btn-icon danger">
                        <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </div>
                    <div class="ext-btn-text">
                        <div class="ext-btn-title">Select & Delete</div>
                        <div class="ext-btn-desc">Batch delete messages</div>
                    </div>
                </button>
                <button class="ext-btn" onclick="regenerateResponse()">
                    <div class="ext-btn-icon purple">
                        <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    </div>
                    <div class="ext-btn-text">
                        <div class="ext-btn-title">Regenerate</div>
                        <div class="ext-btn-desc">Regenerate AI response</div>
                    </div>
                </button>
                <button class="ext-btn" onclick="sendImage()">
                    <div class="ext-btn-icon blue">
                        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    </div>
                    <div class="ext-btn-text">
                        <div class="ext-btn-title">Send Image</div>
                        <div class="ext-btn-desc">Share an image with AI</div>
                    </div>
                </button>
                <button class="ext-btn" onclick="showSceneImageModal()">
                    <div class="ext-btn-icon purple">
                        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 15l4-4 4 4 6-6 4 4"/></svg>
                    </div>
                    <div class="ext-btn-text">
                        <div class="ext-btn-title">Scene Image</div>
                        <div class="ext-btn-desc">Describe a scene as image</div>
                    </div>
                </button>
                <button class="ext-btn" onclick="showVoiceMessageModal()">
                    <div class="ext-btn-icon rose">
                        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </div>
                    <div class="ext-btn-text">
                        <div class="ext-btn-title">Voice Message</div>
                        <div class="ext-btn-desc">Send as voice format</div>
                    </div>
                </button>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-wrapper">
                <div class="quote-preview-bar" id="quotePreviewBar">
                    <div class="quote-preview-content" id="quotePreviewContent"></div>
                    <button class="quote-preview-close" onclick="clearQuote()">✕</button>
                </div>
                <div class="chat-input-area">
                    <button class="chat-btn" onclick="toggleExtensionPanel()">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                    <textarea class="chat-input-field" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                    <button class="chat-btn send" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                    <button class="chat-btn ai" onclick="requestAIResponse()">
                        <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== Context Menu (Long Press Menu) ========== -->
    <div class="context-menu-overlay" id="contextMenuOverlay">
        <div class="context-menu">
            <div class="context-menu-item" data-action="copy">
                <div class="context-menu-icon">
                    <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                </div>
                <span class="context-menu-label">Copy</span>
            </div>
            <div class="context-menu-item" data-action="quote">
                <div class="context-menu-icon">
                    <svg viewBox="0 0 24 24"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21zm12 0c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg>
                </div>
                <span class="context-menu-label">Quote</span>
            </div>
            <div class="context-menu-item" data-action="edit">
                <div class="context-menu-icon">
                    <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </div>
                <span class="context-menu-label">Edit</span>
            </div>
            <div class="context-menu-item" data-action="cancel">
                <div class="context-menu-icon">
                    <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </div>
                <span class="context-menu-label">Cancel</span>
            </div>
        </div>
    </div>

    <!-- ========== Character Edit Page ========== -->
    <div class="page slide-from-bottom" id="charEditPage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeCharEditPage()">
                <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                Cancel
            </button>
            <span class="nav-title">Character</span>
            <button class="nav-btn" onclick="saveCharacter()">Save</button>
        </div>
        <div class="page-content">
            <!-- Chat Management -->
            <div class="settings-group">
                <div class="settings-group-title">Chat Management</div>
                <div class="settings-item" onclick="clearAllMessages()">
                    <div class="settings-item-left">
                        <div class="settings-icon danger">
                            <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </div>
                        <div>
                            <div class="settings-item-label">Clear All Messages</div>
                            <div class="settings-item-desc">Delete all chat history</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bubble Style -->
            <div class="settings-group">
                <div class="settings-group-title">Bubble Style (This Character)</div>
                <div style="padding: 16px;">
                    <div class="bubble-style-grid" id="bubbleStyleGrid">
                        <div class="bubble-style-option selected" data-style="none">
                            <div class="bubble-style-option-name">None</div>
                        </div>
                        <div class="bubble-style-option" data-style="glass">
                            <div class="bubble-style-option-name">Glass</div>
                        </div>
                        <div class="bubble-style-option" data-style="metal">
                            <div class="bubble-style-option-name">Metal</div>
                        </div>
                        <div class="bubble-style-option" data-style="solid">
                            <div class="bubble-style-option-name">Solid</div>
                        </div>
                        <div class="bubble-style-option" data-style="neon">
                            <div class="bubble-style-option-name">Neon</div>
                        </div>
                        <div class="bubble-style-option" data-style="aurora">
                            <div class="bubble-style-option-name">Aurora</div>
                        </div>
                    </div>

                    <div class="bubble-preview-container">
                        <div class="bubble-preview-received" id="bubblePreviewReceived">Hello there!</div>
                        <div class="bubble-preview-sent" id="bubblePreviewSent">Hi, how are you?</div>
                    </div>

                    <!-- Color Controls -->
                    <div class="color-section">
                        <div class="color-section-title">User Bubble</div>
                        <div class="color-btn-row">
                            <button class="color-btn" onclick="openColorPicker('sentColor1')">
                                <div class="color-swatch" id="sentColor1Swatch" style="background: rgba(60,60,65,0.6);"></div>
                                <span class="color-btn-label">Color 1</span>
                            </button>
                            <button class="color-btn" onclick="openColorPicker('sentColor2')">
                                <div class="color-swatch" id="sentColor2Swatch" style="background: rgba(60,60,65,0.6);"></div>
                                <span class="color-btn-label">Color 2</span>
                            </button>
                        </div>
                        <div class="color-btn-row">
                            <button class="color-btn" onclick="openColorPicker('sentTextColor')">
                                <div class="color-swatch" id="sentTextColorSwatch" style="background: rgba(255,255,255,0.95);"></div>
                                <span class="color-btn-label">Text Color</span>
                            </button>
                        </div>
                    </div>

                    <div class="color-section">
                        <div class="color-section-title">Character Bubble</div>
                        <div class="color-btn-row">
                            <button class="color-btn" onclick="openColorPicker('receivedColor1')">
                                <div class="color-swatch" id="receivedColor1Swatch" style="background: rgba(45,45,50,0.6);"></div>
                                <span class="color-btn-label">Color 1</span>
                            </button>
                            <button class="color-btn" onclick="openColorPicker('receivedColor2')">
                                <div class="color-swatch" id="receivedColor2Swatch" style="background: rgba(45,45,50,0.6);"></div>
                                <span class="color-btn-label">Color 2</span>
                            </button>
                        </div>
                        <div class="color-btn-row">
                            <button class="color-btn" onclick="openColorPicker('receivedTextColor')">
                                <div class="color-swatch" id="receivedTextColorSwatch" style="background: rgba(255,255,255,0.95);"></div>
                                <span class="color-btn-label">Text Color</span>
                            </button>
                        </div>
                    </div>

                    <div class="color-section">
                        <div class="color-section-title">Border</div>
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Border Width</span>
                                <span class="slider-value" id="borderWidthValue">1px</span>
                            </div>
                            <input type="range" class="slider-input" id="borderWidthSlider" min="0" max="4" step="1" value="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Wallpaper -->
            <div class="settings-group">
                <div class="settings-group-title">Chat Wallpaper</div>
                <div style="padding: 16px;">
                    <div class="chat-wallpaper-preview" id="chatWallpaperPreview">
                        <span>No custom wallpaper</span>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="uploadChatWallpaper()">Upload</button>
                        <button class="btn btn-secondary btn-small" onclick="clearChatWallpaper()">Clear</button>
                    </div>
                </div>
            </div>

            <!-- Avatars -->
            <div class="settings-group">
                <div class="settings-group-title">Avatars</div>
                <div style="padding: 16px;">
                    <div class="input-group">
                        <label class="input-label">Character Avatar</label>
                        <div class="avatar-upload-area" id="charAvatarUpload" onclick="uploadCharAvatar()">
                            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">User Avatar</label>
                        <div class="avatar-upload-area" id="userAvatarUpload" onclick="uploadUserAvatar()">
                            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Avatar Display</label>
                        <div class="settings-item" style="padding: 0; border: none;">
                            <span style="font-size: 13px; color: var(--text-primary);">Show Avatar</span>
                            <div class="toggle-switch active" id="showAvatarToggle" onclick="toggleShowAvatar()"></div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Shape</label>
                        <div class="shape-options" id="avatarShapeOptions">
                            <div class="shape-option selected" data-shape="circle">Circle</div>
                            <div class="shape-option" data-shape="square">Square</div>
                            <div class="shape-option" data-shape="rounded-square">Rounded</div>
                        </div>
                    </div>

                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Border</span>
                            <span class="slider-value" id="avatarBorderValue">0px</span>
                        </div>
                        <input type="range" class="slider-input" id="avatarBorderSlider" min="0" max="4" step="1" value="0">
                    </div>

                    <div class="color-btn-row" style="margin-top: 12px;">
                        <button class="color-btn" onclick="openColorPicker('avatarBorderColor')">
                            <div class="color-swatch" id="avatarBorderColorSwatch" style="background: rgba(255,255,255,0.2);"></div>
                            <span class="color-btn-label">Border Color</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Basic Info -->
            <div class="settings-group">
                <div class="settings-group-title">Basic Info</div>
                <div style="padding: 16px;">
                    <div class="input-group">
                        <label class="input-label">Name</label>
                        <input type="text" class="input-field" id="charName" placeholder="Character name">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Emoji (fallback)</label>
                        <input type="text" class="input-field" id="charEmoji" placeholder="🤖" maxlength="2">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Character Description</label>
                        <textarea class="input-field" id="charDescription" placeholder="Describe the character's personality, background, etc."></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">First Message (300 chars)</label>
                        <textarea class="input-field" id="charFirstMessage" placeholder="The first message the character sends..." maxlength="300"></textarea>
                        <div class="char-counter" id="firstMsgCounter">0/300</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Scenario</label>
                        <textarea class="input-field" id="charScenario" placeholder="The scenario or context for the conversation..."></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Linked Worldbooks</label>
                        <div class="worldbook-multi-select" id="linkedWorldbooks">
                            <!-- Worldbooks will be listed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced -->
            <div class="settings-group">
                <div class="settings-group-title">Advanced</div>
                <div style="padding: 16px;">
                    <div class="input-group">
                        <label class="input-label">User's Name</label>
                        <input type="text" class="input-field" id="userName" placeholder="User">
                    </div>
                    <div class="input-group">
                        <label class="input-label">System Prompt</label>
                        <textarea class="input-field" id="charSystemPrompt" placeholder="Custom system instructions for this character..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Custom CSS -->
            <div class="settings-group">
                <div class="settings-group-title">Custom CSS Styling</div>
                <div style="padding: 16px;">
                    <div class="action-hint warning">
                        <span class="action-hint-icon">⚠</span>
                        <span class="action-hint-text">Custom CSS overrides bubble style settings</span>
                    </div>

                    <div class="input-group">
                        <label class="input-label">CSS Preset</label>
                        <div class="preset-selector">
                            <select class="select-field" id="cssPresetSelect">
                                <option value="">-- No Preset --</option>
                            </select>
                            <button class="preset-btn" onclick="showNewCssPresetModal()" title="Add Preset">
                                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </button>
                            <button class="preset-btn" onclick="deleteCssPreset()" title="Delete Preset">
                                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Timestamp Position</label>
                        <select class="select-field" id="timestampPosition">
                            <option value="default">Default (inside bubble)</option>
                            <option value="hidden">Hidden</option>
                            <option value="side">Beside bubble</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Custom CSS Code</label>
                        <textarea class="input-field css-editor" id="charCustomCss" placeholder=".message.sent { }
.message.received { }"></textarea>
                    </div>

                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="previewCss()">Preview</button>
                        <button class="btn btn-secondary btn-small" onclick="clearCss()">Clear CSS</button>
                    </div>
                </div>
            </div>

            <!-- Delete Character -->
            <div class="delete-zone" onclick="deleteCharacter()">
                Delete Character
            </div>
        </div>
    </div>

    <!-- ========== Lore Page ========== -->
    <div class="page" id="lorePage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closePage('lorePage')">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                Back
            </button>
            <span class="nav-title">Lore</span>
            <button class="nav-btn" onclick="showNewWorldbookModal()">
                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
        </div>
        <div class="page-content">
            <div class="action-hint">
                <span class="action-hint-icon">📚</span>
                <span class="action-hint-text">Each worldbook can contain multiple entries</span>
            </div>

            <div id="worldbookList">
                <!-- Worldbooks will be rendered here -->
            </div>

            <div class="empty-state" id="emptyWorldbooks">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <div class="empty-state-title">No Worldbooks</div>
                <div class="empty-state-desc">Tap + to create</div>
            </div>
        </div>
    </div>

    <!-- ========== Worldbook Edit Page ========== -->
    <div class="page slide-from-bottom" id="worldbookEditPage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeWorldbookEditPage()">
                <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                Cancel
            </button>
            <span class="nav-title">Edit Lore</span>
            <button class="nav-btn" onclick="saveWorldbook()">Save</button>
        </div>
        <div class="page-content">
            <div class="input-group">
                <label class="input-label">Worldbook Name</label>
                <input type="text" class="input-field" id="worldbookName" placeholder="My Worldbook">
            </div>
            <div class="input-group">
                <label class="input-label">Summary</label>
                <textarea class="input-field" id="worldbookSummary" placeholder="Brief description of this worldbook..."></textarea>
            </div>

            <div class="input-group">
                <label class="input-label">Entries</label>
                <div class="worldbook-entries" id="worldbookEntries">
                    <!-- Entries will be rendered here -->
                </div>
                <button class="btn btn-secondary" onclick="addWorldbookEntry()" style="margin-top: 12px;">
                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;stroke-width:1.5;fill:none;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    + Add Entry
                </button>
            </div>

            <div class="delete-zone" onclick="deleteWorldbook()">
                Delete Worldbook
            </div>
        </div>
    </div>

    <!-- ========== Worldbook Entry Edit Modal ========== -->
    <div class="modal-overlay" id="entryEditModal">
        <div class="modal">
            <div class="modal-title">Edit Entry</div>
            <div class="input-group">
                <label class="input-label">Entry Name</label>
                <input type="text" class="modal-input" id="entryName" placeholder="Entry name" style="margin-bottom: 12px;">
            </div>
            <div class="input-group">
                <label class="input-label">Trigger Keywords (comma-separated)</label>
                <input type="text" class="modal-input" id="entryKeywords" placeholder="keyword1, keyword2" style="margin-bottom: 12px;">
            </div>
            <div class="input-group">
                <label class="input-label">Content</label>
                <textarea class="modal-textarea" id="entryContent" placeholder="Entry content..." style="min-height: 120px;"></textarea>
            </div>
            <div class="settings-item" style="padding: 12px 0; border: none;">
                <span style="font-size: 13px; color: var(--text-primary);">Always Active</span>
                <div class="toggle-switch" id="entryAlwaysActive" onclick="toggleEntryAlwaysActive()"></div>
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeEntryEditModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="saveEntry()">Save</button>
            </div>
        </div>
    </div>

    <!-- ========== Theme Page ========== -->
    <div class="page" id="themePage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closePage('themePage')">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                Back
            </button>
            <span class="nav-title">Theme</span>
            <button class="nav-btn" onclick="closeThemePage()">
                <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                X
            </button>
        </div>
        <div class="page-content">
            <!-- Display Options -->
            <div class="settings-group">
                <div class="settings-group-title">Display</div>
                <div class="settings-item">
                    <div class="settings-item-left">
                        <div class="settings-icon">
                            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>
                        </div>
                        <div>
                            <div class="settings-item-label">Hide Status Bar</div>
                            <div class="settings-item-desc">Avoid overlap with system bar</div>
                        </div>
                    </div>
                    <div class="toggle-switch" id="hideStatusBarToggle" onclick="toggleHideStatusBar()"></div>
                </div>
            </div>

            <!-- Wallpaper -->
            <div class="settings-group">
                <div class="settings-group-title">Preview</div>
                <div style="padding: 16px;">
                    <div class="wallpaper-preview" id="wallpaperPreview"></div>

                    <div class="input-group">
                        <label class="input-label">Preset Wallpapers</label>
                        <select class="select-field" id="presetWallpaper" onchange="applyPresetWallpaper()">
                            <option value="">Custom</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Image URL</label>
                        <input type="url" class="input-field" id="wallpaperUrl" placeholder="https://...">
                    </div>

                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="previewWallpaperUrl()">Preview URL</button>
                        <button class="btn btn-secondary btn-small" onclick="uploadWallpaper()">Upload Image</button>
                    </div>

                    <button class="btn btn-primary" onclick="applyWallpaper()" style="margin-top: 12px;">Apply Wallpaper</button>
                </div>
            </div>

            <!-- App Icons -->
            <div class="settings-group">
                <div class="settings-group-title">App Icons</div>
                <div style="padding: 16px;">
                    <div class="icon-customize-grid">
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconSettings" onclick="customizeIcon('settings')">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            </div>
                            <span class="icon-customize-label">Settings</span>
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconMessages" onclick="customizeIcon('messages')">
                                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            </div>
                            <span class="icon-customize-label">Messages</span>
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconLore" onclick="customizeIcon('lore')">
                                <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                            </div>
                            <span class="icon-customize-label">Lore</span>
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconTheme" onclick="customizeIcon('theme')">
                                <svg viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/><path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10c.55 0 1-.45 1-1v-1.67c0-.55.45-1 1-1h1.67c2.21 0 4-1.79 4-4 0-1.48-.81-2.77-2.01-3.46-.41-.24-.68-.69-.68-1.17 0-.74.6-1.34 1.34-1.34.41 0 .78.19 1.03.48.17.2.41.32.68.32.55 0 1-.45 1-1C22 6.49 17.51 2 12 2z"/></svg>
                            </div>
                            <span class="icon-customize-label">Theme</span>
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconFonts" onclick="customizeIcon('fonts')">
                                <svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                            </div>
                            <span class="icon-customize-label">Fonts</span>
                        </div>
                    </div>

                    <div class="btn-row" style="margin-top: 16px;">
                        <button class="btn btn-secondary btn-small" onclick="saveCustomIcons()">Save Icons</button>
                        <button class="btn btn-secondary btn-small" onclick="resetIcons()">Reset to Default</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== Fonts Page ========== -->
    <div class="page" id="fontsPage">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closePage('fontsPage')">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                Back
            </button>
            <span class="nav-title">Fonts</span>
            <button class="nav-btn" onclick="showAddFontModal()">
                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
        </div>
        <div class="page-content">
            <div class="action-hint">
                <span class="action-hint-icon">✦</span>
                <span class="action-hint-text">Select a font to apply globally</span>
            </div>

            <div class="input-label" style="margin-top: 16px;">Available Fonts</div>
            <div class="font-list" id="fontList">
                <!-- Fonts will be rendered here -->
            </div>
        </div>
    </div>

    <!-- ========== Modals ========== -->

    <!-- New Character Modal -->
    <div class="modal-overlay" id="newCharModal">
        <div class="modal">
            <div class="modal-title">New Character</div>
            <input type="text" class="modal-input" id="newCharName" placeholder="Character name">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeNewCharModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="createCharacter()">Create</button>
            </div>
        </div>
    </div>

    <!-- New Worldbook Modal -->
    <div class="modal-overlay" id="newWorldbookModal">
        <div class="modal">
            <div class="modal-title">New Worldbook</div>
            <input type="text" class="modal-input" id="newWorldbookName" placeholder="Worldbook name">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeNewWorldbookModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="createWorldbook()">Create</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal">
            <div class="modal-title">Confirm Delete?</div>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">This action cannot be undone.</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeDeleteConfirmModal()">Cancel</button>
                <button class="modal-btn confirm" style="background: var(--danger);" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Clear Messages Modal -->
    <div class="modal-overlay" id="clearMessagesModal">
        <div class="modal">
            <div class="modal-title">Clear All Messages</div>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Delete all chat history with this character?<br><span style="color: var(--danger);">This cannot be undone!</span></p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeClearMessagesModal()">Cancel</button>
                <button class="modal-btn confirm" style="background: var(--danger);" onclick="confirmClearMessages()">Delete All</button>
            </div>
        </div>
    </div>

    <!-- New CSS Preset Modal -->
    <div class="modal-overlay" id="newCssPresetModal">
        <div class="modal">
            <div class="modal-title">New CSS Preset</div>
            <input type="text" class="modal-input" id="newCssPresetName" placeholder="Preset name">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeNewCssPresetModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="createCssPreset()">Create</button>
            </div>
        </div>
    </div>

    <!-- Delete CSS Preset Modal -->
    <div class="modal-overlay" id="deleteCssPresetModal">
        <div class="modal">
            <div class="modal-title">Delete CSS Preset?</div>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Are you sure you want to delete this preset?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeDeleteCssPresetModal()">Cancel</button>
                <button class="modal-btn confirm" style="background: var(--danger);" onclick="confirmDeleteCssPreset()">Delete</button>
            </div>
        </div>
    </div>

    <!-- New API Preset Modal -->
    <div class="modal-overlay" id="newApiPresetModal">
        <div class="modal">
            <div class="modal-title">New API Preset</div>
            <input type="text" class="modal-input" id="newApiPresetName" placeholder="Preset name">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeNewApiPresetModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="createApiPreset()">Create</button>
            </div>
        </div>
    </div>

    <!-- Delete API Preset Modal -->
    <div class="modal-overlay" id="deleteApiPresetModal">
        <div class="modal">
            <div class="modal-title">Delete API Preset?</div>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Are you sure you want to delete this preset?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeDeleteApiPresetModal()">Cancel</button>
                <button class="modal-btn confirm" style="background: var(--danger);" onclick="confirmDeleteApiPreset()">Delete</button>
            </div>
        </div>
    </div>

    <!-- CSS Guide Modal -->
    <div class="modal-overlay" id="cssGuideModal">
        <div class="modal">
            <div class="modal-title">CSS Customization Guide</div>
            <div class="guide-content">
                <div class="guide-section">
                    <div class="guide-section-title">Message Bubbles</div>
                    <div class="guide-code">.message.sent { }
.message.received { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Quote Bubble</div>
                    <div class="guide-code">.message-quote { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Avatar</div>
                    <div class="guide-code">.message-avatar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Timestamp</div>
                    <div class="guide-code">.message-time { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Scene Image Card</div>
                    <div class="guide-code">.scene-image-card { }
.scene-image-cover { }
.scene-image-icon { }
.scene-image-footer { }
.scene-image-content { }
.scene-image-text { }</div>
                    <div class="guide-text">Scene image is a clickable card. Click to reveal the description text.</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Voice Message</div>
                    <div class="guide-code">.voice-message { }
.voice-message.sent { }
.voice-message.received { }
.voice-message-header { }
.voice-play-btn { }
.voice-waveform { }
.voice-wave-bar { }
.voice-duration { }
.voice-text-content { }
.voice-text-content p { }
.voice-message-time { }</div>
                    <div class="guide-text">Voice message displays as a voice bar. Click to reveal the text content below.</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Input Area</div>
                    <div class="guide-code">.chat-input-area { }
.chat-input-field { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Nav Bar</div>
                    <div class="guide-code">#chatPage .nav-bar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Example</div>
                    <div class="guide-code">.message.sent {
  background: rgba(60,60,65,0.8);
  border-radius: 20px;
}
.voice-message {
  background: rgba(80,60,90,0.6);
}
.scene-image-card {
  border: 2px solid purple;
}</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeCssGuideModal()" style="margin-top: 16px;">Got It</button>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div class="modal-overlay" id="editMsgModal">
        <div class="modal">
            <div class="modal-title">Edit Message</div>
            <textarea class="modal-textarea" id="editMsgContent" placeholder="Edit message content..."></textarea>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeEditMsgModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="saveEditedMessage()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Font Modal -->
    <div class="modal-overlay" id="addFontModal">
        <div class="modal">
            <div class="modal-title">Add Custom Font</div>
            <div class="input-group">
                <label class="input-label">Font Name</label>
                <input type="text" class="modal-input" id="customFontName" placeholder="My Font" style="margin-bottom: 8px;">
            </div>
            <div class="input-group">
                <label class="input-label">Font URL (.ttf, .otf, .woff, .woff2)</label>
                <input type="url" class="modal-input" id="customFontUrl" placeholder="https://..." style="margin-bottom: 8px;">
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeAddFontModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="addCustomFont()">Add Font</button>
            </div>
        </div>
    </div>

    <!-- Delete Font Modal -->
    <div class="modal-overlay" id="deleteFontModal">
        <div class="modal">
            <div class="modal-title">Delete Font?</div>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Are you sure you want to delete this font?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeDeleteFontModal()">Cancel</button>
                <button class="modal-btn confirm" style="background: var(--danger);" onclick="confirmDeleteFont()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div class="modal-overlay" id="colorPickerModal">
        <div class="modal">
            <div class="modal-title">Select Color</div>
            <div class="color-picker-container">
                <div class="color-preview-swatch" id="colorPreviewSwatch"></div>
                <div class="color-wheel-wrapper" id="colorWheelWrapper">
                    <canvas class="color-ring-canvas" id="colorRingCanvas" width="260" height="260"></canvas>
                    <canvas class="color-square-canvas" id="colorSquareCanvas" width="110" height="110"></canvas>
                    <div class="color-ring-handle" id="colorRingHandle"></div>
                    <div class="color-square-handle" id="colorSquareHandle"></div>
                </div>
                <input type="text" class="color-hex-input" id="colorHexInput" placeholder="#FFFFFF" maxlength="7">
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeColorPicker()">Cancel</button>
                <button class="modal-btn confirm" onclick="applyColor()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Scene Image Modal -->
    <div class="modal-overlay" id="sceneImageModal">
        <div class="modal">
            <div class="modal-title">Send Scene Image</div>
            <textarea class="modal-textarea" id="sceneImageContent" placeholder="Describe the scene from a third-person perspective. This will appear as a visual image card."></textarea>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeSceneImageModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="sendSceneImage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Voice Message Modal -->
    <div class="modal-overlay" id="voiceMessageModal">
        <div class="modal">
            <div class="modal-title">Send Voice Message</div>
            <textarea class="modal-textarea" id="voiceMessageContent" placeholder="Enter what you would say out loud. This will appear as a voice message."></textarea>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeVoiceMessageModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="sendVoiceMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden File Inputs -->
    <input type="file" class="file-input-hidden" id="fileInput" accept="*/*">
    <input type="file" class="file-input-hidden" id="imageInput" accept="image/*">
    <input type="file" class="file-input-hidden" id="importInput" accept=".json">

    <!-- Custom CSS Styles Container -->
    <style id="customCssStyles"></style>
    <style id="customFontStyles"></style>

    <script>
        // ========================================
        // NOIR Premium SMS v10 - Complete JavaScript
        // With Long Press Menu Integration
        // ========================================

        // ============ Global State ============
        let appData = {
            settings: {
                fontSize: 1,
                hideStatusBar: false,
                wallpaper: null,
                customIcons: {},
                apiEndpoint: '',
                apiKey: '',
                currentModel: '',
                temperature: 0.7,
                maxTokens: 2048,
                maxMemory: 20,
                apiPresets: [],
                currentApiPreset: ''
            },
            characters: [],
            worldbooks: [],
            cssPresets: [],
            customFonts: [],
            currentFont: 'default'
        };

        let currentCharIndex = -1;
        let currentWorldbookIndex = -1;
        let currentEntryIndex = -1;
        let deleteTarget = null;
        let deleteType = null;
        let currentColorTarget = null;
        let selectedColor = '#FFFFFF';

        // Long Press State
        let longPressTimer = null;
        let longPressTarget = null;
        let longPressMessageIndex = -1;
        let longPressMessageType = 'message'; // 'message', 'voice', 'scene'
        let isLongPressing = false;
        const LONG_PRESS_DURATION = 600;

        // Quote State
        let currentQuote = null;

        // Edit Message State
        let editingMessageIndex = -1;
        let editingMessageType = 'message';

        // Select Mode State
        let isSelectMode = false;
        let selectedMessages = new Set();

        // ============ Initialization ============
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateStatusBarTime();
            setInterval(updateStatusBarTime, 60000);
            initSliders();
            initFontSizeOptions();
            initBubbleStyleOptions();
            initAvatarShapeOptions();
            renderContacts();
            renderWorldbooks();
            renderFonts();
            applySettings();
            initColorPicker();
            initContextMenu();
            initChatInputAutoResize();
            calculateStorageUsage();
        });

        // ============ Data Persistence ============
        function loadData() {
            try {
                const saved = localStorage.getItem('noirSmsData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('noirSmsData', JSON.stringify(appData));
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('Storage error', 'error');
            }
        }

        // ============ Status Bar ============
        function updateStatusBarTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('statusBarTime').textContent = `${hours}:${minutes}`;
        }

        // ============ Page Navigation ============
        function openPage(pageId) {
            document.getElementById(pageId).classList.add('active');
        }

        function closePage(pageId) {
            document.getElementById(pageId).classList.remove('active');
        }

        function closeChatPage() {
            closePage('chatPage');
            if (isSelectMode) exitSelectMode();
            closeExtensionPanel();
            saveData();
        }

        function closeThemePage() {
            closePage('themePage');
        }

        // ============ Toast Notifications ============
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============ Settings Functions ============
        function initSliders() {
            // Temperature slider
            const tempSlider = document.getElementById('tempSlider');
            const tempValue = document.getElementById('tempValue');
            if (tempSlider) {
                tempSlider.value = appData.settings.temperature;
                tempValue.textContent = appData.settings.temperature;
                tempSlider.addEventListener('input', function() {
                    tempValue.textContent = this.value;
                    appData.settings.temperature = parseFloat(this.value);
                });
            }

            // Max tokens slider
            const tokensSlider = document.getElementById('tokensSlider');
            const tokensValue = document.getElementById('tokensValue');
            if (tokensSlider) {
                tokensSlider.value = appData.settings.maxTokens;
                tokensValue.textContent = appData.settings.maxTokens;
                tokensSlider.addEventListener('input', function() {
                    tokensValue.textContent = this.value;
                    appData.settings.maxTokens = parseInt(this.value);
                });
            }

            // Border width slider
            const borderWidthSlider = document.getElementById('borderWidthSlider');
            const borderWidthValue = document.getElementById('borderWidthValue');
            if (borderWidthSlider) {
                borderWidthSlider.addEventListener('input', function() {
                    borderWidthValue.textContent = this.value + 'px';
                });
            }

            // Avatar border slider
            const avatarBorderSlider = document.getElementById('avatarBorderSlider');
            const avatarBorderValue = document.getElementById('avatarBorderValue');
            if (avatarBorderSlider) {
                avatarBorderSlider.addEventListener('input', function() {
                    avatarBorderValue.textContent = this.value + 'px';
                });
            }
        }

        function initFontSizeOptions() {
            const options = document.querySelectorAll('#fontSizeOptions .shape-option');
            options.forEach(opt => {
                if (parseFloat(opt.dataset.size) === appData.settings.fontSize) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }

                opt.addEventListener('click', function() {
                    options.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    const size = parseFloat(this.dataset.size);
                    appData.settings.fontSize = size;
                    document.documentElement.style.setProperty('--font-scale', size);
                    document.getElementById('fontSizeValue').textContent = Math.round(size * 100) + '%';
                    saveData();
                });
            });
        }

        function saveAllSettings() {
            appData.settings.maxMemory = parseInt(document.getElementById('maxMemory').value) || 20;
            saveData();
            showToast('Settings saved', 'success');
            closePage('settingsPage');
        }

        function applySettings() {
            document.documentElement.style.setProperty('--font-scale', appData.settings.fontSize);

            if (appData.settings.hideStatusBar) {
                document.getElementById('statusBar').classList.add('hidden');
                document.getElementById('homeScreen').classList.add('no-statusbar');
                document.getElementById('hideStatusBarToggle').classList.add('active');
            }

            if (appData.settings.wallpaper) {
                document.getElementById('wallpaperLayer').style.background =
                    `url('${appData.settings.wallpaper}') center/cover no-repeat`;
            }

            // Apply custom font
            if (appData.currentFont && appData.currentFont !== 'default') {
                applyFont(appData.currentFont);
            }

            // Load custom fonts
            loadCustomFonts();
        }

        // ============ API Functions ============
        function saveApiConfig() {
            appData.settings.apiEndpoint = document.getElementById('apiEndpoint').value;
            appData.settings.apiKey = document.getElementById('apiKey').value;
            appData.settings.currentModel = document.getElementById('currentModel').value;
            saveData();
            updateApiStatus();
            showToast('API configuration saved', 'success');
        }

        function updateApiStatus() {
            const hint = document.getElementById('apiStatusHint');
            if (appData.settings.apiEndpoint && appData.settings.apiKey) {
                hint.classList.remove('warning');
                hint.classList.add('success');
                hint.querySelector('.action-hint-icon').textContent = '✓';
                hint.querySelector('.action-hint-text').textContent = 'API configured';
            } else {
                hint.classList.remove('success');
                hint.classList.add('warning');
                hint.querySelector('.action-hint-icon').textContent = '⚠';
                hint.querySelector('.action-hint-text').textContent = 'API not configured';
            }
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        async function fetchModels() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!endpoint || !apiKey) {
                showToast('Please enter API endpoint and key', 'warning');
                return;
            }

            addLog('Fetching models...', 'info');

            try {
                const response = await fetch(`${endpoint}/models`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const modelList = document.getElementById('modelList');
                modelList.innerHTML = '';

                const models = data.data || data.models || [];
                models.forEach(model => {
                    const modelId = model.id || model.name || model;
                    const item = document.createElement('div');
                    item.className = 'model-item';
                    item.innerHTML = `<div class="model-item-name">${modelId}</div>`;
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.model-item').forEach(m => m.classList.remove('selected'));
                        item.classList.add('selected');
                        document.getElementById('currentModel').value = modelId;
                    });
                    modelList.appendChild(item);
                });

                addLog(`Found ${models.length} models`, 'success');
            } catch (e) {
                addLog(`Error: ${e.message}`, 'error');
                showToast('Failed to fetch models', 'error');
            }
        }

        async function testConnection() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('currentModel').value;

            if (!endpoint || !apiKey || !model) {
                showToast('Please fill all API fields', 'warning');
                return;
            }

            addLog('Testing connection...', 'info');

            try {
                const response = await fetch(`${endpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: 'Hi' }],
                        max_tokens: 10
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                addLog('Connection successful!', 'success');
                showToast('Connection successful!', 'success');
            } catch (e) {
                addLog(`Connection failed: ${e.message}`, 'error');
                showToast('Connection failed', 'error');
            }
        }

        // ============ Storage Functions ============
        function calculateStorageUsage() {
            try {
                const data = localStorage.getItem('noirSmsData') || '';
                const bytes = new Blob([data]).size;
                const mb = (bytes / (1024 * 1024)).toFixed(2);

                document.getElementById('storageSize').textContent = `${mb} MB`;
                document.getElementById('storageUsed').textContent = `Used: ${mb} MB`;

                // Estimate percentage (assume 5MB as reference)
                const percentage = Math.min((bytes / (5 * 1024 * 1024)) * 100, 100);
                const fill = document.getElementById('storageBarFill');
                fill.style.width = percentage + '%';

                if (percentage > 80) {
                    fill.classList.add('danger');
                } else if (percentage > 60) {
                    fill.classList.add('warning');
                }
            } catch (e) {
                console.error('Error calculating storage:', e);
            }
        }

        function clearImageCache() {
            // Clear image data from characters
            appData.characters.forEach(char => {
                char.avatar = null;
                char.userAvatar = null;
                char.chatWallpaper = null;
            });
            appData.settings.wallpaper = null;
            appData.settings.customIcons = {};
            saveData();
            showToast('Image cache cleared', 'success');
            calculateStorageUsage();
        }

        function clearMessageCache() {
            appData.characters.forEach(char => {
                char.messages = [];
            });
            saveData();
            showToast('Message cache cleared', 'success');
            calculateStorageUsage();
        }

        function optimizeStorage() {
            // Simple optimization - just trigger save
            saveData();
            calculateStorageUsage();
            showToast('Storage optimized', 'success');
        }

        function forceSave() {
            saveData();
            showToast('Data saved', 'success');
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `noir-sms-backup-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported', 'success');
        }

        function importData() {
            document.getElementById('importInput').click();
        }

        document.getElementById('importInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const imported = JSON.parse(event.target.result);
                    appData = { ...appData, ...imported };
                    saveData();
                    showToast('Data imported successfully', 'success');
                    location.reload();
                } catch (err) {
                    showToast('Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
            this.value = '';
        });

        function clearAllData() {
            if (confirm('This will delete ALL data. Are you sure?')) {
                localStorage.removeItem('noirSmsData');
                showToast('All data cleared', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // ============ Character Management ============
        function renderContacts() {
            const list = document.getElementById('contactList');
            const empty = document.getElementById('emptyContacts');

            list.innerHTML = '';

            if (appData.characters.length === 0) {
                empty.style.display = 'flex';
                return;
            }

            empty.style.display = 'none';

            appData.characters.forEach((char, index) => {
                const lastMsg = char.messages && char.messages.length > 0
                    ? getMessagePreviewText(char.messages[char.messages.length - 1])
                    : 'No messages yet';

                const item = document.createElement('div');
                item.className = 'contact-item';
                item.innerHTML = `
                    <div class="contact-avatar">
                        ${char.avatar
                            ? `<img src="${char.avatar}" alt="${char.name}">`
                            : (char.emoji || '🤖')}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${char.name}</div>
                        <div class="contact-preview">${lastMsg}</div>
                    </div>
                    <span class="contact-time">${getRelativeTime(char.lastActive)}</span>
                `;
                item.addEventListener('click', () => openChat(index));
                list.appendChild(item);
            });
        }

        function getMessagePreviewText(msg) {
            if (!msg) return '';
            if (msg.type === 'voice') return '🎤 Voice message';
            if (msg.type === 'scene') return '🖼️ Scene description';
            if (msg.image) return '📷 Image';
            return msg.content ? msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '') : '';
        }

        function getRelativeTime(timestamp) {
            if (!timestamp) return '';
            const diff = Date.now() - timestamp;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (mins < 1) return 'now';
            if (mins < 60) return `${mins}m`;
            if (hours < 24) return `${hours}h`;
            return `${days}d`;
        }

        function showNewCharModal() {
            document.getElementById('newCharName').value = '';
            document.getElementById('newCharModal').classList.add('active');
        }

        function closeNewCharModal() {
            document.getElementById('newCharModal').classList.remove('active');
        }

        function createCharacter() {
            const name = document.getElementById('newCharName').value.trim();
            if (!name) {
                showToast('Please enter a name', 'warning');
                return;
            }

            const newChar = {
                id: Date.now(),
                name: name,
                emoji: '🤖',
                description: '',
                firstMessage: '',
                scenario: '',
                systemPrompt: '',
                userName: 'User',
                avatar: null,
                userAvatar: null,
                messages: [],
                linkedWorldbooks: [],
                bubbleStyle: 'none',
                customCss: '',
                timestampPosition: 'default',
                showAvatar: true,
                avatarShape: 'circle',
                avatarBorder: 0,
                avatarBorderColor: 'rgba(255,255,255,0.2)',
                chatWallpaper: null,
                colors: {
                    sentColor1: 'rgba(60,60,65,0.6)',
                    sentColor2: 'rgba(60,60,65,0.6)',
                    sentTextColor: 'rgba(255,255,255,0.95)',
                    receivedColor1: 'rgba(45,45,50,0.6)',
                    receivedColor2: 'rgba(45,45,50,0.6)',
                    receivedTextColor: 'rgba(255,255,255,0.95)'
                },
                borderWidth: 1,
                lastActive: Date.now()
            };

            appData.characters.push(newChar);
            saveData();
            renderContacts();
            closeNewCharModal();
            showToast('Character created', 'success');
        }

        function openChat(index) {
            currentCharIndex = index;
            const char = appData.characters[index];

            document.getElementById('chatTitle').textContent = char.name;

            // Apply chat wallpaper
            const chatPage = document.getElementById('chatPage');
            if (char.chatWallpaper) {
                chatPage.classList.add('has-custom-bg');
                chatPage.style.background = `url('${char.chatWallpaper}') center/cover no-repeat`;
            } else {
                chatPage.classList.remove('has-custom-bg');
                chatPage.style.background = '';
            }

            // Apply custom CSS
            applyCharacterCss(char);

            renderMessages();
            openPage('chatPage');

            // Scroll to bottom
            setTimeout(() => {
                const msgContainer = document.getElementById('chatMessages');
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }, 100);
        }

        function applyCharacterCss(char) {
            const styleEl = document.getElementById('customCssStyles');
            let css = '';

            // Apply bubble style colors
            if (char.colors) {
                css += `
                    .message.sent {
                        background: ${char.colors.sentColor1};
                        color: ${char.colors.sentTextColor};
                        border-width: ${char.borderWidth || 1}px;
                    }
                    .message.received {
                        background: ${char.colors.receivedColor1};
                        color: ${char.colors.receivedTextColor};
                        border-width: ${char.borderWidth || 1}px;
                    }
                `;
            }

            // Apply timestamp position
            if (char.timestampPosition === 'hidden') {
                css += '.message-time { display: none !important; }';
            } else if (char.timestampPosition === 'side') {
                css += '.message-time { position: absolute !important; bottom: 6px !important; }';
                css += '.message-wrapper.sent .message-time { left: -44px !important; right: auto !important; }';
                css += '.message-wrapper.received .message-time { right: -44px !important; left: auto !important; }';
            }

            // Apply custom CSS
            if (char.customCss) {
                css += char.customCss;
            }

            styleEl.textContent = css;
        }

        // ============ Message Rendering ============
        function renderMessages() {
            const container = document.getElementById('chatMessages');
            const char = appData.characters[currentCharIndex];

            if (!char || !char.messages) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '';

            char.messages.forEach((msg, index) => {
                const wrapper = createMessageWrapper(msg, index, char);
                container.appendChild(wrapper);
            });

            // Bind long press events to all message elements
            bindLongPressEvents();
        }

        function createMessageWrapper(msg, index, char) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'sent' : 'received'}`;

            // Checkbox for select mode
            const checkbox = document.createElement('div');
            checkbox.className = 'message -checkbox';
            checkbox.dataset.index = index;
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMessageSelection(index, checkbox);
            });

            // Avatar for received messages
            if (msg.sender !== 'user' && char.showAvatar !== false) {
                const avatar = document.createElement('div');
                avatar.className = `message-avatar ${char.avatarShape || 'circle'}`;
                if (char.avatarBorder) {
                    avatar.style.border = `${char.avatarBorder}px solid ${char.avatarBorderColor || 'rgba(255,255,255,0.2)'}`;
                }
                if (char.avatar) {
                    avatar.innerHTML = `<img src="${char.avatar}" alt="${char.name}">`;
                } else {
                    avatar.textContent = char.emoji || '🤖';
                }
                wrapper.appendChild(avatar);
            }

            // Create the appropriate message element based on type
            let messageEl;
            if (msg.type === 'voice') {
                messageEl = createVoiceMessage(msg, index);
            } else if (msg.type === 'scene') {
                messageEl = createSceneImageCard(msg, index);
            } else {
                messageEl = createTextMessage(msg, index, char);
            }

            messageEl.dataset.index = index;
            messageEl.dataset.type = msg.type || 'message';

            wrapper.appendChild(checkbox);
            wrapper.appendChild(messageEl);

            // User avatar for sent messages
            if (msg.sender === 'user' && char.showAvatar !== false && char.userAvatar) {
                const userAvatar = document.createElement('div');
                userAvatar.className = `message-avatar ${char.avatarShape || 'circle'}`;
                if (char.avatarBorder) {
                    userAvatar.style.border = `${char.avatarBorder}px solid ${char.avatarBorderColor || 'rgba(255,255,255,0.2)'}`;
                }
                userAvatar.innerHTML = `<img src="${char.userAvatar}" alt="User">`;
                wrapper.appendChild(userAvatar);
            }

            return wrapper;
        }

        function createTextMessage(msg, index, char) {
            const bubble = document.createElement('div');
            bubble.className = `message ${msg.sender === 'user' ? 'sent' : 'received'}`;

            // Quote if exists
            if (msg.quote) {
                const quoteEl = document.createElement('div');
                quoteEl.className = 'message-quote';
                quoteEl.textContent = msg.quote;
                bubble.appendChild(quoteEl);
            }

            // Message content
            const textNode = document.createTextNode(msg.content || '');
            bubble.appendChild(textNode);

            // Image if exists
            if (msg.image) {
                const img = document.createElement('img');
                img.className = 'message-image';
                img.src = msg.image;
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.open(msg.image, '_blank');
                });
                bubble.appendChild(img);
            }

            // Timestamp
            const time = document.createElement('div');
            time.className = `message-time ${char.timestampPosition === 'hidden' ? 'time-hidden' : ''} ${char.timestampPosition === 'side' ? 'time-side' : ''}`;
            time.textContent = formatTime(msg.timestamp);
            bubble.appendChild(time);

            return bubble;
        }

        function createVoiceMessage(msg, index) {
            const voice = document.createElement('div');
            voice.className = `voice-message ${msg.sender === 'user' ? 'sent' : 'received'}`;

            // Generate random wave bars
            const waveBars = [];
            for (let i = 0; i < 12; i++) {
                const height = Math.floor(Math.random() * 16) + 8;
                waveBars.push(`<div class="voice-wave-bar" style="height: ${height}px;"></div>`);
            }

            // Calculate fake duration based on content length
            const duration = Math.max(1, Math.min(60, Math.floor((msg.content?.length || 10) / 10)));
            const durationStr = `0:${duration.toString().padStart(2, '0')}`;

            voice.innerHTML = `
                <div class="voice-message-header">
                    <div class="voice-play-btn">
                        <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    </div>
                    <div class="voice-waveform">${waveBars.join('')}</div>
                    <span class="voice-duration">${durationStr}</span>
                </div>
                <div class="voice-text-content">
                    <p>${msg.content || ''}</p>
                </div>
                <div class="voice-message-time">${formatTime(msg.timestamp)}</div>
            `;

            // Toggle text visibility on click (but not on long press)
            voice.addEventListener('click', (e) => {
                if (isLongPressing || isSelectMode) return;
                const textContent = voice.querySelector('.voice-text-content');
                textContent.classList.toggle('visible');
            });

            return voice;
        }

        function createSceneImageCard(msg, index) {
            const card = document.createElement('div');
            card.className = 'scene-image-card';

            card.innerHTML = `
                <div class="scene-image-cover">
                    <div class="scene-image-icon">
                        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 15l4-4 4 4 6-6 4 4"/></svg>
                    </div>
                </div>
                <div class="scene-image-footer">
                    <div class="scene-image-label">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        Scene Description
                    </div>
                </div>
                <div class="scene-image-content">
                    <div class="scene-image-text">${msg.content || ''}</div>
                    <div class="scene-image-hint">Tap to close</div>
                </div>
            `;

            // Toggle expanded state on click
            card.addEventListener('click', (e) => {
                if (isLongPressing || isSelectMode) return;
                card.classList.toggle('expanded');
            });

            return card;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // ============ Long Press / Context Menu ============
        function initContextMenu() {
            const overlay = document.getElementById('contextMenuOverlay');
            const menuItems = document.querySelectorAll('.context-menu-item');

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeContextMenu();
                }
            });

            // Handle menu item clicks
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    handleContextMenuAction(action);
                });
            });
        }

        function bindLongPressEvents() {
            const messageElements = document.querySelectorAll('.message, .voice-message, .scene-image-card');

            messageElements.forEach(el => {
                // Touch events
                el.addEventListener('touchstart', handleTouchStart, { passive: false });
                el.addEventListener('touchend', handleTouchEnd);
                el.addEventListener('touchmove', handleTouchCancel);
                el.addEventListener('touchcancel', handleTouchCancel);

                // Mouse events (for desktop testing)
                el.addEventListener('mousedown', handleMouseDown);
                el.addEventListener('mouseup', handleMouseUp);
                el.addEventListener('mouseleave', handleTouchCancel);
            });
        }

        function handleTouchStart(e) {
            if (isSelectMode) return;

            const target = e.currentTarget;
            isLongPressing = false;

            target.classList.add('long-pressing');

            longPressTimer = setTimeout(() => {
                isLongPressing = true;
                target.classList.remove('long-pressing');
                triggerLongPress(target);
            }, LONG_PRESS_DURATION);
        }

        function handleTouchEnd(e) {
            clearTimeout(longPressTimer);
            e.currentTarget.classList.remove('long-pressing');

            if (isLongPressing) {
                e.preventDefault();
                e.stopPropagation();
            }
        }

        function handleTouchCancel(e) {
            clearTimeout(longPressTimer);
            if (e.currentTarget) {
                e.currentTarget.classList.remove('long-pressing');
            }
            isLongPressing = false;
        }

        function handleMouseDown(e) {
            if (isSelectMode) return;

            const target = e.currentTarget;
            isLongPressing = false;

            target.classList.add('long-pressing');

            longPressTimer = setTimeout(() => {
                isLongPressing = true;
                target.classList.remove('long-pressing');
                triggerLongPress(target);
            }, LONG_PRESS_DURATION);
        }

        function handleMouseUp(e) {
            clearTimeout(longPressTimer);
            e.currentTarget.classList.remove('long-pressing');

            if (isLongPressing) {
                e.preventDefault();
                e.stopPropagation();
            }
        }

        function triggerLongPress(target) {
            longPressTarget = target;
            longPressMessageIndex = parseInt(target.dataset.index);
            longPressMessageType = target.dataset.type || 'message';

            // Vibration feedback
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }

            showContextMenu();
        }

        function showContextMenu() {
            document.getElementById('contextMenuOverlay').classList.add('active');
        }

        function closeContextMenu() {
            document.getElementById('contextMenuOverlay').classList.remove('active');
            longPressTarget = null;
            isLongPressing = false;
        }

        function handleContextMenuAction(action) {
            if (!longPressTarget && action !== 'cancel') {
                closeContextMenu();
                return;
            }

            switch (action) {
                case 'copy':
                    copyMessageContent();
                    break;
                case 'quote':
                    quoteMessage();
                    break;
                case 'edit':
                    editMessage();
                    break;
                case 'cancel':
                    // Just close
                    break;
            }

            closeContextMenu();
        }

        function getMessageContent(element) {
            if (!element) return '';

            // Voice message
            if (element.classList.contains('voice-message')) {
                const textContent = element.querySelector('.voice-text-content p');
                return textContent ? textContent.textContent : '';
            }
            // Scene image
            else if (element.classList.contains('scene-image-card')) {
                const sceneText = element.querySelector('.scene-image-text');
                return sceneText ? sceneText.textContent : '';
            }
            // Regular message
            else if (element.classList.contains('message')) {
                const clone = element.cloneNode(true);
                const quote = clone.querySelector('.message-quote');
                const time = clone.querySelector('.message-time');
                const img = clone.querySelector('.message-image');
                if (quote) quote.remove();
                if (time) time.remove();
                if (img) img.remove();
                return clone.textContent.trim();
            }
            return '';
        }

        function copyMessageContent() {
            const content = getMessageContent(longPressTarget);
            if (content) {
                navigator.clipboard.writeText(content).then(() => {
                    showToast('Copied!', 'success');
                }).catch(() => {
                    showToast('Copy failed', 'error');
                });
            }
        }

        function quoteMessage() {
            const content = getMessageContent(longPressTarget);
            if (content) {
                currentQuote = {
                    text: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
                    messageIndex: longPressMessageIndex
                };
                document.getElementById('quotePreviewContent').textContent = currentQuote.text;
                document.getElementById('quotePreviewBar').classList.add('active');
                showToast('Quote added', 'info');
            }
        }

        function clearQuote() {
            currentQuote = null;
            document.getElementById('quotePreviewBar').classList.remove('active');
        }

        function editMessage() {
            const content = getMessageContent(longPressTarget);
            editingMessageIndex = longPressMessageIndex;
            editingMessageType = longPressMessageType;

            document.getElementById('editMsgContent').value = content;
            document.getElementById('editMsgModal').classList.add('active');
        }

        function closeEditMsgModal() {
            document.getElementById('editMsgModal').classList.remove('active');
            editingMessageIndex = -1;
        }

        function saveEditedMessage() {
            const newContent = document.getElementById('editMsgContent').value.trim();
            if (!newContent) {
                showToast('Content cannot be empty', 'warning');
                return;
            }

            const char = appData.characters[currentCharIndex];
            if (char && char.messages && char.messages[editingMessageIndex]) {
                char.messages[editingMessageIndex].content = newContent;
                saveData();
                renderMessages();
                showToast('Message updated', 'success');
            }

            closeEditMsgModal();
        }

        // ============ Select Mode ============
        function enterSelectMode() {
            isSelectMode = true;
            selectedMessages.clear();
            document.getElementById('chatMessages').classList.add('select-mode');
            document.getElementById('selectModeBar').classList.add('active');
            updateSelectedCount();
            closeExtensionPanel();
        }

        function exitSelectMode() {
            isSelectMode = false;
            selectedMessages.clear();
            document.getElementById('chatMessages').classList.remove('select-mode');
            document.getElementById('selectModeBar').classList.remove('active');

            // Uncheck all checkboxes
            document.querySelectorAll('.message-checkbox').forEach(cb => {
                cb.classList.remove('checked');
            });
        }

        function toggleMessageSelection(index, checkbox) {
            if (selectedMessages.has(index)) {
                selectedMessages.delete(index);
                checkbox.classList.remove('checked');
            } else {
                selectedMessages.add(index);
                checkbox.classList.add('checked');
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedMessages.size;
        }

        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) {
                showToast('No messages selected', 'warning');
                return;
            }

            const char = appData.characters[currentCharIndex];
            if (!char || !char.messages) return;

            // Convert to array and sort descending to delete from end
            const indices = Array.from(selectedMessages).sort((a, b) => b - a);
            indices.forEach(index => {
                char.messages.splice(index, 1);
            });

            saveData();
            exitSelectMode();
            renderMessages();
            showToast(`Deleted ${indices.length} message(s)`, 'success');
        }

        // ============ Chat Input Functions ============
        function initChatInputAutoResize() {
            const input = document.getElementById('chatInput');
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();

            if (!content) return;

            const char = appData.characters[currentCharIndex];
            if (!char) return;

            const msg = {
                sender: 'user',
                content: content,
                timestamp: Date.now(),
                type: 'message'
            };

            // Add quote if exists
            if (currentQuote) {
                msg.quote = currentQuote.text;
                clearQuote();
            }

            char.messages.push(msg);
            char.lastActive = Date.now();
            saveData();

            input.value = '';
            input.style.height = 'auto';
            renderMessages();

            // Scroll to bottom
            setTimeout(() => {
                const msgContainer = document.getElementById('chatMessages');
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }, 100);
        }

        function toggleExtensionPanel() {
            document.getElementById('extensionPanel').classList.toggle('active');
        }

        function closeExtensionPanel() {
            document.getElementById('extensionPanel').classList.remove('active');
        }

        // ============ Special Message Types ============
        function showVoiceMessageModal() {
            document.getElementById('voiceMessageContent').value = '';
            document.getElementById('voiceMessageModal').classList.add('active');
            closeExtensionPanel();
        }

        function closeVoiceMessageModal() {
            document.getElementById('voiceMessageModal').classList.remove('active');
        }

        function sendVoiceMessage() {
            const content = document.getElementById('voiceMessageContent').value.trim();
            if (!content) {
                showToast('Please enter content', 'warning');
                return;
            }

            const char = appData.characters[currentCharIndex];
            if (!char) return;

            const msg = {
                sender: 'user',
                content: content,
                timestamp: Date.now(),
                type: 'voice'
            };

            char.messages.push(msg);
            char.lastActive = Date.now();
            saveData();

            closeVoiceMessageModal();
            renderMessages();

            setTimeout(() => {
                const msgContainer = document.getElementById('chatMessages');
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }, 100);
        }

        function showSceneImageModal() {
            document.getElementById('sceneImageContent').value = '';
            document.getElementById('sceneImageModal').classList.add('active');
            closeExtensionPanel();
        }

        function closeSceneImageModal() {
            document.getElementById('sceneImageModal').classList.remove('active');
        }

        function sendSceneImage() {
            const content = document.getElementById('sceneImageContent').value.trim();
            if (!content) {
                showToast('Please enter a scene description', 'warning');
                return;
            }

            const char = appData.characters[currentCharIndex];
            if (!char) return;

            const msg = {
                sender: 'user',
                content: content,
                timestamp: Date.now(),
                type: 'scene'
            };

            char.messages.push(msg);
            char.lastActive = Date.now();
            saveData();

            closeSceneImageModal();
            renderMessages();

            setTimeout(() => {
                const msgContainer = document.getElementById('chatMessages');
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }, 100);
        }

        function sendImage() {
            document.getElementById('imageInput').click();
            closeExtensionPanel();
        }

        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const char = appData.characters[currentCharIndex];
                if (!char) return;

                const msg = {
                    sender: 'user',
                    content: '',
                    image: event.target.result,
                    timestamp: Date.now(),
                    type: 'message'
                };

                char.messages.push(msg);
                char.lastActive = Date.now();
                saveData();
                renderMessages();

                setTimeout(() => {
                    const msgContainer = document.getElementById('chatMessages');
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }, 100);
            };
            reader.readAsDataURL(file);
            this.value = '';
        });

        // ============ AI Response ============
        async function requestAIResponse() {
            const char = appData.characters[currentCharIndex];
            if (!char) return;

            if (!appData.settings.apiEndpoint || !appData.settings.apiKey || !appData.settings.currentModel) {
                showToast('Please configure API first', 'warning');
                return;
            }

            // Show typing indicator
            const container = document.getElementById('chatMessages');
            const typingEl = document.createElement('div');
            typingEl.className = 'message-wrapper received';
            typingEl.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            container.appendChild(typingEl);
            container.scrollTop = container.scrollHeight;

            try {
                // Build messages for API
                const messages = buildApiMessages(char);

                const response = await fetch(`${appData.settings.apiEndpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${appData.settings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: appData.settings.currentModel,
                        messages: messages,
                        temperature: appData.settings.temperature,
                        max_tokens: appData.settings.maxTokens
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const aiContent = data.choices?.[0]?.message?.content || 'No response';

                // Remove typing indicator
                typingEl.remove();

                // Add AI message
                const aiMsg = {
                    sender: 'ai',
                    content: aiContent,
                    timestamp: Date.now(),
                    type: 'message'
                };

                char.messages.push(aiMsg);
                char.lastActive = Date.now();
                saveData();
                renderMessages();

                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);

            } catch (e) {
                typingEl.remove();
                showToast('AI request failed: ' + e.message, 'error');
            }
        }

        function buildApiMessages(char) {
            const messages = [];

            // System prompt
            let systemPrompt = char.systemPrompt || '';
            if (char.description) {
                systemPrompt = `You are ${char.name}. ${char.description}\n\n${systemPrompt}`;
            }
            if (char.scenario) {
                systemPrompt += `\n\nScenario: ${char.scenario}`;
            }

            // Add worldbook entries
            if (char.linkedWorldbooks && char.linkedWorldbooks.length > 0) {
                char.linkedWorldbooks.forEach(wbId => {
                    const wb = appData.worldbooks.find(w => w.id === wbId);
                    if (wb && wb.entries) {
                        wb.entries.forEach(entry => {
                            if (entry.alwaysActive) {
                                systemPrompt += `\n\n${entry.content}`;
                            }
                        });
                    }
                });
            }

            if (systemPrompt) {
                messages.push({ role: 'system', content: systemPrompt });
            }

            // Add recent conversation history
            const maxMemory = appData.settings.maxMemory || 20;
            const recentMessages = char.messages.slice(-maxMemory);

            recentMessages.forEach(msg => {
                const role = msg.sender === 'user' ? 'user' : 'assistant';
                let content = msg.content || '';

                // Handle special message types
                if (msg.type === 'voice') {
                    content = `[Voice message]: ${content}`;
                } else if (msg.type === 'scene') {
                    content = `[Scene description]: ${content}`;
                }

                if (msg.quote) {
                    content = `[Quoting: "${msg.quote}"]\n${content}`;
                }

                if (content) {
                    messages.push({ role, content });
                }
            });

            return messages;
        }

        function regenerateResponse() {
            const char = appData.characters[currentCharIndex];
            if (!char || !char.messages || char.messages.length === 0) {
                showToast('No messages to regenerate', 'warning');
                return;
            }

            // Find and remove last AI message
            for (let i = char.messages.length - 1; i >= 0; i--) {
                if (char.messages[i].sender !== 'user') {
                    char.messages.splice(i, 1);
                    break;
                }
            }

            saveData();
            closeExtensionPanel();
            renderMessages();

            // Request new response
            requestAIResponse();
        }

        // ============ Character Edit ============
        function openCharEditPage() {
            const char = appData.characters[currentCharIndex];
            if (!char) return;

            // Populate fields
            document.getElementById('charName').value = char.name || '';
            document.getElementById('charEmoji').value = char.emoji || '';
            document.getElementById('charDescription').value = char.description || '';
            document.getElementById('charFirstMessage').value = char.firstMessage || '';
            document.getElementById('charScenario').value = char.scenario || '';
            document.getElementById('charSystemPrompt').value = char.systemPrompt || '';
            document.getElementById('userName').value = char.userName || 'User';
            document.getElementById('charCustomCss').value = char.customCss || '';
            document.getElementById('timestampPosition').value = char.timestampPosition || 'default';

            // Avatar
            const charAvatarEl = document.getElementById('charAvatarUpload');
            if (char.avatar) {
                charAvatarEl.innerHTML = `<img src="${char.avatar}" alt="Avatar">`;
                charAvatarEl.classList.add('has-image');
            } else {
                charAvatarEl.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>';
                charAvatarEl.classList.remove('has-image');
            }

            const userAvatarEl = document.getElementById('userAvatarUpload');
            if (char.userAvatar) {
                userAvatarEl.innerHTML = `<img src="${char.userAvatar}" alt="User">`;
                userAvatarEl.classList.add('has-image');
            } else {
                userAvatarEl.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>';
                userAvatarEl.classList.remove('has-image');
            }

            // Show avatar toggle
            const showAvatarToggle = document.getElementById('showAvatarToggle');
            if (char.showAvatar !== false) {
                showAvatarToggle.classList.add('active');
            } else {
                showAvatarToggle.classList.remove('active');
            }

            // Chat wallpaper
            const wallpaperPreview = document.getElementById('chatWallpaperPreview');
            if (char.chatWallpaper) {
                wallpaperPreview.style.background = `url('${char.chatWallpaper}') center/cover no-repeat`;
                wallpaperPreview.classList.add('has-image');
            } else {
                wallpaperPreview.style.background = '';
                wallpaperPreview.classList.remove('has-image');
            }

            // Linked worldbooks
            renderLinkedWorldbooks(char);

            // Update first message counter
            updateFirstMsgCounter();

            openPage('charEditPage');
        }

        function closeCharEditPage() {
            closePage('charEditPage');
        }

        function saveCharacter() {
            const char = appData.characters[currentCharIndex];
            if (!char) return;

            char.name = document.getElementById('charName').value.trim() || char.name;
            char.emoji = document.getElementById('charEmoji').value || '🤖';
            char.description = document.getElementById('charDescription').value;
            char.firstMessage = document.getElementById('charFirstMessage').value;
            char.scenario = document.getElementById('charScenario').value;
            char.systemPrompt = document.getElementById('charSystemPrompt').value;
            char.userName = document.getElementById('userName').value || 'User';
            char.customCss = document.getElementById('charCustomCss').value;
            char.timestampPosition = document.getElementById('timestampPosition').value;

            saveData();
            renderContacts();
            document.getElementById('chatTitle').textContent = char.name;
            applyCharacterCss(char);
            renderMessages();

            closeCharEditPage();
            showToast('Character saved', 'success');
        }

        function deleteCharacter() {
            if (confirm('Delete this character? This cannot be undone.')) {
                appData.characters.splice(currentCharIndex, 1);
                saveData();
                renderContacts();
                closeCharEditPage();
                closeChatPage();
                showToast('Character deleted', 'success');
            }
        }

        function updateFirstMsgCounter() {
            const textarea = document.getElementById('charFirstMessage');
            const counter = document.getElementById('firstMsgCounter');

            textarea.addEventListener('input', function() {
                const len = this.value.length;
                counter.textContent = `${len}/300`;
                counter.className = 'char-counter';
                if (len > 280) counter.classList.add('warning');
                if (len >= 300) counter.classList.add('error');
            });
        }

        function renderLinkedWorldbooks(char) {
            const container = document.getElementById('linkedWorldbooks');
            container.innerHTML = '';

            if (appData.worldbooks.length === 0) {
                container.innerHTML = '<div style="padding: 12px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No worldbooks available</div>';
                return;
            }

            appData.worldbooks.forEach(wb => {
                const isLinked = char.linkedWorldbooks?.includes(wb.id);
                const item = document.createElement('div');
                item.className = 'worldbook-multi-item';
                item.innerHTML = `
                    <div class="worldbook-multi-checkbox ${isLinked ? 'checked' : ''}"></div>
                    <span class="worldbook-multi-name">${wb.name}</span>
                `;
                item.addEventListener('click', () => {
                    const checkbox = item.querySelector('.worldbook-multi-checkbox');
                    if (!char.linkedWorldbooks) char.linkedWorldbooks = [];

                    if (char.linkedWorldbooks.includes(wb.id)) {
                        char.linkedWorldbooks = char.linkedWorldbooks.filter(id => id !== wb.id);
                        checkbox.classList.remove('checked');
                    } else {
                        char.linkedWorldbooks.push(wb.id);
                        checkbox.classList.add('checked');
                    }
                });
                container.appendChild(item);
            });
        }

        function toggleShowAvatar() {
            const toggle = document.getElementById('showAvatarToggle');
            toggle.classList.toggle('active');
        }

        function uploadCharAvatar() {
            const input = document.getElementById('imageInput');
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const char = appData.characters[currentCharIndex];
                    if (char) {
                        char.avatar = event.target.result;
                        const el = document.getElementById('charAvatarUpload');
                        el.innerHTML = `<img src="${char.avatar}" alt="Avatar">`;
                        el.classList.add('has-image');
                    }
                };
                reader.readAsDataURL(file);
                input.onchange = null;
            };
            input.click();
        }

        function uploadUserAvatar() {
            const input = document.getElementById('imageInput');
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const char = appData.characters[currentCharIndex];
                    if (char) {
                        char.userAvatar = event.target.result;
                        const el = document.getElementById('userAvatarUpload');
                        el.innerHTML = `<img src="${char.userAvatar}" alt="User">`;
                        el.classList.add('has-image');
                    }
                };
                reader.readAsDataURL(file);
                input.onchange = null;
            };
            input.click();
        }

        function uploadChatWallpaper() {
            const input = document.getElementById('imageInput');
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const char = appData.characters[currentCharIndex];
                    if (char) {
                        char.chatWallpaper = event.target.result;
                        const preview = document.getElementById('chatWallpaperPreview');
                        preview.style.background = `url('${char.chatWallpaper}') center/cover no-repeat`;
                        preview.classList.add('has-image');
                    }
                };
                reader.readAsDataURL(file);
                input.onchange = null;
            };
            input.click();
        }

        function clearChatWallpaper() {
            const char = appData.characters[currentCharIndex];
            if (char) {
                char.chatWallpaper = null;
                const preview = document.getElementById('chatWallpaperPreview');
                preview.style.background = '';
                preview.classList.remove('has-image');
            }
        }

        function clearAllMessages() {
            document.getElementById('clearMessagesModal').classList.add('active');
        }

        function closeClearMessagesModal() {
            document.getElementById('clearMessagesModal').classList.remove('active');
        }

        function confirmClearMessages() {
            const char = appData.characters[currentCharIndex];
            if (char) {
                char.messages = [];
                saveData();
                renderMessages();
                showToast('All messages cleared', 'success');
            }
            closeClearMessagesModal();
        }

        // ============ Bubble Style Options ============
        function initBubbleStyleOptions() {
            const options = document.querySelectorAll('#bubbleStyleGrid .bubble-style-option');
            options.forEach(opt => {
                opt.addEventListener('click', function() {
                    options.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        // ============ Avatar Shape Options ============
        function initAvatarShapeOptions() {
            const options = document.querySelectorAll('#avatarShapeOptions .shape-option');
            options.forEach(opt => {
                opt.addEventListener('click', function() {
                    options.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        // ============ Color Picker ============
        let colorPickerHue = 0;
        let colorPickerSat = 1;
        let colorPickerVal = 1;

        function initColorPicker() {
            drawColorRing();
            drawColorSquare();
        }

        function drawColorRing() {
            const canvas = document.getElementById('colorRingCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const outerRadius = 125;
            const innerRadius = 95;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let angle = 0; angle < 360; angle++) {
                const startAngle = (angle - 1) * Math.PI / 180;
                const endAngle = (angle + 1) * Math.PI / 180;

                ctx.beginPath();
                ctx.arc(centerX, centerY, outerRadius, startAngle, endAngle);
                ctx.arc(centerX, centerY, innerRadius, endAngle, startAngle, true);
                ctx.closePath();
                ctx.fillStyle = `hsl(${angle}, 100%, 50%)`;
                ctx.fill();
            }
        }

        function drawColorSquare() {
            const canvas = document.getElementById('colorSquareCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Create gradient
            const gradientH = ctx.createLinearGradient(0, 0, width, 0);
            gradientH.addColorStop(0, '#fff');
            gradientH.addColorStop(1, `hsl(${colorPickerHue}, 100%, 50%)`);

            ctx.fillStyle = gradientH;
            ctx.fillRect(0, 0, width, height);

            const gradientV = ctx.createLinearGradient(0, 0, 0, height);
            gradientV.addColorStop(0, 'rgba(0,0,0,0)');
            gradientV.addColorStop(1, '#000');

            ctx.fillStyle = gradientV;
            ctx.fillRect(0, 0, width, height);
        }

        function openColorPicker(target) {
            currentColorTarget = target;
            document.getElementById('colorPickerModal').classList.add('active');
            updateColorPreview();
        }

        function closeColorPicker() {
            document.getElementById('colorPickerModal').classList.remove('active');
            currentColorTarget = null;
        }

        function updateColorPreview() {
            const rgb = hsvToRgb(colorPickerHue, colorPickerSat, colorPickerVal);
            const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
            selectedColor = hex;

            document.getElementById('colorPreviewSwatch').style.background = hex;
            document.getElementById('colorHexInput').value = hex;
        }

        function hsvToRgb(h, s, v) {
            let r, g, b;
            const i = Math.floor(h / 60) % 6;
            const f = h / 60 - Math.floor(h / 60);
            const p = v * (1 - s);
            const q = v * (1 - f * s);
            const t = v * (1 - (1 - f) * s);

            switch (i) {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                case 5: r = v; g = p; b = q; break;
            }

            return {
                r: Math.round(r * 255),
                g: Math.round(g * 255),
                b: Math.round(b * 255)
            };
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
        }

        function applyColor() {
            if (!currentColorTarget) {
                closeColorPicker();
                return;
            }

            const char = appData.characters[currentCharIndex];
            if (!char) {
                closeColorPicker();
                return;
            }

            if (!char.colors) {
                char.colors = {};
            }

            char.colors[currentColorTarget] = selectedColor;

            // Update swatch
            const swatch = document.getElementById(`${currentColorTarget}Swatch`);
            if (swatch) {
                swatch.style.background = selectedColor;
            }

            closeColorPicker();
        }

        // ============ CSS Presets ============
        function previewCss() {
            const css = document.getElementById('charCustomCss').value;
            document.getElementById('customCssStyles').textContent = css;
            showToast('CSS preview applied', 'info');
        }

        function clearCss() {
            document.getElementById('charCustomCss').value = '';
            document.getElementById('customCssStyles').textContent = '';
            showToast('CSS cleared', 'info');
        }

        function showNewCssPresetModal() {
            document.getElementById('newCssPresetName').value = '';
            document.getElementById('newCssPresetModal').classList.add('active');
        }

        function closeNewCssPresetModal() {
            document.getElementById('newCssPresetModal').classList.remove('active');
        }

        function createCssPreset() {
            const name = document.getElementById('newCssPresetName').value.trim();
            if (!name) {
                showToast('Please enter a name', 'warning');
                return;
            }

            const css = document.getElementById('charCustomCss').value;
            appData.cssPresets.push({ name, css });
            saveData();
            closeNewCssPresetModal();
            showToast('Preset created', 'success');
        }

        function deleteCssPreset() {
            showToast('Select a preset first', 'warning');
        }

        function closeDeleteCssPresetModal() {
            document.getElementById('deleteCssPresetModal').classList.remove('active');
        }

        function confirmDeleteCssPreset() {
            closeDeleteCssPresetModal();
        }

        function closeCssGuideModal() {
            document.getElementById('cssGuideModal').classList.remove('active');
        }

        // ============ API Presets ============
        function showNewApiPresetModal() {
            document.getElementById('newApiPresetName').value = '';
            document.getElementById('newApiPresetModal').classList.add('active');
        }

        function closeNewApiPresetModal() {
            document.getElementById('newApiPresetModal').classList.remove('active');
        }

        function createApiPreset() {
            const name = document.getElementById('newApiPresetName').value.trim();
            if (!name) {
                showToast('Please enter a name', 'warning');
                return;
            }

            if (!appData.settings.apiPresets) {
                appData.settings.apiPresets = [];
            }

            appData.settings.apiPresets.push({
                name,
                endpoint: appData.settings.apiEndpoint,
                key: appData.settings.apiKey,
                model: appData.settings.currentModel
            });

            saveData();
            closeNewApiPresetModal();
            showToast('API preset created', 'success');
        }

        function deleteApiPreset() {
            showToast('Select a preset first', 'warning');
        }

        function closeDeleteApiPresetModal() {
            document.getElementById('deleteApiPresetModal').classList.remove('active');
        }

        function confirmDeleteApiPreset() {
            closeDeleteApiPresetModal();
        }

        // ============ Worldbooks ============
        function renderWorldbooks() {
            const list = document.getElementById('worldbookList');
            const empty = document.getElementById('emptyWorldbooks');

            list.innerHTML = '';

            if (appData.worldbooks.length === 0) {
                empty.style.display = 'flex';
                return;
            }

            empty.style.display = 'none';

            appData.worldbooks.forEach((wb, index) => {
                const entryCount = wb.entries ? wb.entries.length : 0;
                const item = document.createElement('div');
                item.className = 'worldbook-item';
                item.innerHTML = `
                    <div class="worldbook-item-header">
                        <span class="worldbook-item-title">${wb.name}</span>
                        <span class="worldbook-item-badge">${entryCount} entries</span>
                    </div>
                    <div class="worldbook-item-preview">${wb.summary || 'No description'}</div>
                `;
                item.addEventListener('click', () => openWorldbookEdit(index));
                list.appendChild(item);
            });
        }

        function showNewWorldbookModal() {
            document.getElementById('newWorldbookName').value = '';
            document.getElementById('newWorldbookModal').classList.add('active');
        }

        function closeNewWorldbookModal() {
            document.getElementById('newWorldbookModal').classList.remove('active');
        }

        function createWorldbook() {
            const name = document.getElementById('newWorldbookName').value.trim();
            if (!name) {
                showToast('Please enter a name', 'warning');
                return;
            }

            appData.worldbooks.push({
                id: Date.now(),
                name,
                summary: '',
                entries: []
            });

            saveData();
            renderWorldbooks();
            closeNewWorldbookModal();
            showToast('Worldbook created', 'success');
        }

        function openWorldbookEdit(index) {
            currentWorldbookIndex = index;
            const wb = appData.worldbooks[index];

            document.getElementById('worldbookName').value = wb.name || '';
            document.getElementById('worldbookSummary').value = wb.summary || '';

            renderWorldbookEntries();
            openPage('worldbookEditPage');
        }

        function closeWorldbookEditPage() {
            closePage('worldbookEditPage');
        }

        function saveWorldbook() {
            const wb = appData.worldbooks[currentWorldbookIndex];
            if (!wb) return;

            wb.name = document.getElementById('worldbookName').value.trim() || wb.name;
            wb.summary = document.getElementById('worldbookSummary').value;

            saveData();
            renderWorldbooks();
            closeWorldbookEditPage();
            showToast('Worldbook saved', 'success');
        }

        function deleteWorldbook() {
            if (confirm('Delete this worldbook?')) {
                appData.worldbooks.splice(currentWorldbookIndex, 1);
                saveData();
                renderWorldbooks();
                closeWorldbookEditPage();
                showToast('Worldbook deleted', 'success');
            }
        }

        function renderWorldbookEntries() {
            const container = document.getElementById('worldbookEntries');
            const wb = appData.worldbooks[currentWorldbookIndex];

            container.innerHTML = '';

            if (!wb || !wb.entries || wb.entries.length === 0) {
                container.innerHTML = '<div style="padding: 12px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No entries yet</div>';
                return;
            }

            wb.entries.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'worldbook-entry-item';
                item.innerHTML = `
                    <div class="worldbook-entry-header">
                        <span class="worldbook-entry-title">${entry.name || 'Unnamed Entry'}</span>
                        <div class="worldbook-entry-actions">
                            <button class="worldbook-entry-btn" onclick="editEntry(${index})">
                                <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button class="worldbook-entry-btn" onclick="deleteEntry(${index})">
                                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="worldbook-entry-keywords">Keywords: ${entry.keywords || 'None'}</div>
                    <div class="worldbook-entry-preview">${entry.content || 'No content'}</div>
                `;
                container.appendChild(item);
            });
        }

        function addWorldbookEntry() {
            currentEntryIndex = -1;
            document.getElementById('entryName').value = '';
            document.getElementById('entryKeywords').value = '';
            document.getElementById('entryContent').value = '';
            document.getElementById('entryAlwaysActive').classList.remove('active');
            document.getElementById('entryEditModal').classList.add('active');
        }

        function editEntry(index) {
            currentEntryIndex = index;
            const wb = appData.worldbooks[currentWorldbookIndex];
            const entry = wb.entries[index];

            document.getElementById('entryName').value = entry.name || '';
            document.getElementById('entryKeywords').value = entry.keywords || '';
            document.getElementById('entryContent').value = entry.content || '';

            const toggle = document.getElementById('entryAlwaysActive');
            if (entry.alwaysActive) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }

            document.getElementById('entryEditModal').classList.add('active');
        }

        function closeEntryEditModal() {
            document.getElementById('entryEditModal').classList.remove('active');
        }

        function toggleEntryAlwaysActive() {
            document.getElementById('entryAlwaysActive').classList.toggle('active');
        }

        function saveEntry() {
            const wb = appData.worldbooks[currentWorldbookIndex];
            if (!wb) return;

            if (!wb.entries) wb.entries = [];

            const entry = {
                name: document.getElementById('entryName').value.trim() || 'Unnamed',
                keywords: document.getElementById('entryKeywords').value,
                content: document.getElementById('entryContent').value,
                alwaysActive: document.getElementById('entryAlwaysActive').classList.contains('active')
            };

            if (currentEntryIndex === -1) {
                wb.entries.push(entry);
            } else {
                wb.entries[currentEntryIndex] = entry;
            }

            saveData();
            renderWorldbookEntries();
            closeEntryEditModal();
            showToast('Entry saved', 'success');
        }

        function deleteEntry(index) {
            if (confirm('Delete this entry?')) {
                const wb = appData.worldbooks[currentWorldbookIndex];
                if (wb && wb.entries) {
                    wb.entries.splice(index, 1);
                    saveData();
                    renderWorldbookEntries();
                    showToast('Entry deleted', 'success');
                }
            }
        }

        // ============ Theme ============
        function toggleHideStatusBar() {
            const toggle = document.getElementById('hideStatusBarToggle');
            toggle.classList.toggle('active');
            appData.settings.hideStatusBar = toggle.classList.contains('active');

            if (appData.settings.hideStatusBar) {
                document.getElementById('statusBar').classList.add('hidden');
                document.getElementById('homeScreen').classList.add('no-statusbar');
            } else {
                document.getElementById('statusBar').classList.remove('hidden');
                document.getElementById('homeScreen').classList.remove('no-statusbar');
            }

            saveData();
        }

        function previewWallpaperUrl() {
            const url = document.getElementById('wallpaperUrl').value;
            if (url) {
                document.getElementById('wallpaperPreview').style.background = `url('${url}') center/cover no-repeat`;
            }
        }

        function uploadWallpaper() {
            const input = document.getElementById('imageInput');
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('wallpaperPreview').style.background = `url('${event.target.result}') center/cover no-repeat`;
                    document.getElementById('wallpaperUrl').value = event.target.result;
                };
                reader.readAsDataURL(file);
                input.onchange = null;
            };
            input.click();
        }

        function applyPresetWallpaper() {
            // Placeholder for preset wallpapers
        }

        function applyWallpaper() {
            const url = document.getElementById('wallpaperUrl').value;
            if (url) {
                appData.settings.wallpaper = url;
                document.getElementById('wallpaperLayer').style.background = `url('${url}') center/cover no-repeat`;
                saveData();
                showToast('Wallpaper applied', 'success');
            }
        }

        function customizeIcon(iconName) {
            const input = document.getElementById('imageInput');
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const iconEl = document.getElementById(`icon${iconName.charAt(0).toUpperCase() + iconName.slice(1)}`);
                    iconEl.innerHTML = `<img src="${event.target.result}" alt="${iconName}">`;
                    iconEl.classList.add('has-image');

                    if (!appData.settings.customIcons) appData.settings.customIcons = {};
                    appData.settings.customIcons[iconName] = event.target.result;
                };
                reader.readAsDataURL(file);
                input.onchange = null;
            };
            input.click();
        }

        function saveCustomIcons() {
            saveData();
            showToast('Icons saved', 'success');
        }

        function resetIcons() {
            appData.settings.customIcons = {};
            saveData();
            showToast('Icons reset', 'success');
            location.reload();
        }

        // ============ Fonts ============
        function renderFonts() {
            const list = document.getElementById('fontList');
            list.innerHTML = '';

            // Default font
            const defaultItem = document.createElement('div');
            defaultItem.className = `font-item ${appData.currentFont === 'default' ? 'selected' : ''}`;
            defaultItem.innerHTML = `
                <div class="font-item-info">
                    <div class="font-item-name">System Default</div>
                    <div class="font-item-preview">The quick brown fox jumps over the lazy dog</div>
                </div>
            `;
            defaultItem.addEventListener('click', () => selectFont('default'));
            list.appendChild(defaultItem);

            // Custom fonts
            if (appData.customFonts) {
                appData.customFonts.forEach((font, index) => {
                    const item = document.createElement('div');
                    item.className = `font-item ${appData.currentFont === font.name ? 'selected' : ''}`;
                    item.innerHTML = `
                        <div class="font-item-info">
                            <div class="font-item-name">${font.name}</div>
                            <div class="font-item-preview" style="font-family: '${font.name}', sans-serif;">The quick brown fox</div>
                        </div>
                        <div class="font-item-actions">
                            <button class="font-item-btn danger" onclick="event.stopPropagation(); deleteFontItem(${index})">
                                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    `;
                    item.addEventListener('click', () => selectFont(font.name));
                    list.appendChild(item);
                });
            }
        }

        function selectFont(fontName) {
            appData.currentFont = fontName;
            saveData();
            applyFont(fontName);
            renderFonts();
            showToast('Font applied', 'success');
        }

        function applyFont(fontName) {
            if (fontName === 'default') {
                document.body.style.fontFamily = '';
            } else {
                document.body.style.fontFamily = `'${fontName}', sans-serif`;
            }
        }

        function loadCustomFonts() {
            if (!appData.customFonts || appData.customFonts.length === 0) return;

            let css = '';
            appData.customFonts.forEach(font => {
                css += `
                    @font-face {
                        font-family: '${font.name}';
                        src: url('${font.url}');
                    }
                `;
            });
            document.getElementById('customFontStyles').textContent = css;
        }

        function showAddFontModal() {
            document.getElementById('customFontName').value = '';
            document.getElementById('customFontUrl').value = '';
            document.getElementById('addFontModal').classList.add('active');
        }

        function closeAddFontModal() {
            document.getElementById('addFontModal').classList.remove('active');
        }

        function addCustomFont() {
            const name = document.getElementById('customFontName').value.trim();
            const url = document.getElementById('customFontUrl').value.trim();

            if (!name || !url) {
                showToast('Please fill all fields', 'warning');
                return;
            }

            if (!appData.customFonts) appData.customFonts = [];

            appData.customFonts.push({ name, url });
            saveData();
            loadCustomFonts();
            renderFonts();
            closeAddFontModal();
            showToast('Font added', 'success');
        }

        let deletingFontIndex = -1;

        function deleteFontItem(index) {
            deletingFontIndex = index;
            document.getElementById('deleteFontModal').classList.add('active');
        }

        function closeDeleteFontModal() {
            document.getElementById('deleteFontModal').classList.remove('active');
            deletingFontIndex = -1;
        }

        function confirmDeleteFont() {
            if (deletingFontIndex >= 0 && appData.customFonts) {
                const fontName = appData.customFonts[deletingFontIndex].name;
                appData.customFonts.splice(deletingFontIndex, 1);

                if (appData.currentFont === fontName) {
                    appData.currentFont = 'default';
                    applyFont('default');
                }

                saveData();
                renderFonts();
                showToast('Font deleted', 'success');
            }
            closeDeleteFontModal();
        }

        // ============ Delete Confirm Modal ============
        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.remove('active');
        }

        function confirmDelete() {
            closeDeleteConfirmModal();
        }
    </script>
</body>
</html>
```
