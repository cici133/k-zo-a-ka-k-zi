
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI短信">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <title>AI短信模拟器 v7.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style id="fontPreloadStyles"></style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap');

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: rgba(15, 15, 22, 0.85);
            --bg-tertiary: rgba(20, 20, 30, 0.6);
            --bg-card: rgba(18, 18, 28, 0.75);
            --bg-elevated: rgba(25, 25, 40, 0.9);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-bg-light: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-border-light: rgba(255, 255, 255, 0.12);
            --blur-amount: 40px;
            --blur-heavy: 60px;
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --text-muted: rgba(255, 255, 255, 0.25);
            --accent-gold: #c9a962;
            --accent-gold-dim: rgba(201, 169, 98, 0.6);
            --accent-gold-glow: rgba(201, 169, 98, 0.15);
            --accent-color: #8b9dc3;
            --accent-soft: rgba(139, 157, 195, 0.4);
            --danger-color: #c45c5c;
            --danger-soft: rgba(196, 92, 92, 0.2);
            --success-color: #6b9b7a;
            --success-soft: rgba(107, 155, 122, 0.2);
            --warning-color: #c9a962;
            --message-sent: rgba(139, 157, 195, 0.25);
            --message-sent-border: rgba(139, 157, 195, 0.3);
            --message-received: rgba(255, 255, 255, 0.05);
            --message-received-border: rgba(255, 255, 255, 0.1);
            --transition-smooth: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-fast: all 0.2s ease;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --shadow-subtle: 0 2px 20px rgba(0, 0, 0, 0.3);
            --shadow-medium: 0 8px 40px rgba(0, 0, 0, 0.4);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(201, 169, 98, 0.1);
            --font-display: 'Cinzel', 'Playfair Display', 'Times New Roman', serif;
            --font-elegant: 'Cormorant Garamond', 'Georgia', serif;
            --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            --custom-font: var(--font-body);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; height: -webkit-fill-available; }
        body {
            height: 100%; min-height: 100vh; min-height: -webkit-fill-available;
            overflow: hidden;
            font-family: var(--custom-font);
            background: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
            position: fixed; width: 100%; top: 0; left: 0;
        }

        #wallpaperLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: linear-gradient(180deg, #0a0a0f 0%, #0d0d15 50%, #0a0a0f 100%);
        }

        #wallpaperLayer::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at 50% 0%, rgba(201, 169, 98, 0.03) 0%, transparent 60%);
            pointer-events: none;
        }

        .phone-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; margin: 0; overflow: hidden; z-index: 1; }

        .status-bar {
            position: absolute; top: 0; left: 0; right: 0;
            height: calc(28px + var(--safe-top));
            padding-top: var(--safe-top);
            display: flex; justify-content: space-between; align-items: center;
            padding-left: 28px; padding-right: 28px;
            z-index: 1000;
            background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, transparent 100%);
        }
        .status-bar.hidden { display: none !important; }
        .status-bar-time {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }
        .status-bar-icons { display: flex; gap: 6px; align-items: center; }
        .status-bar-icons svg { width: 14px; height: 14px; fill: var(--text-tertiary); }

        .home-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding-top: calc(100px + var(--safe-top));
            padding-bottom: calc(100px + var(--safe-bottom));
            padding-left: 24px; padding-right: 24px;
            display: flex; flex-direction: column; gap: 40px;
            overflow-y: auto; z-index: 1;
        }
        .home-screen.no-statusbar { padding-top: calc(60px + var(--safe-top)); }

        .home-header {
            text-align: center;
            padding: 20px 0;
        }
        .home-header-title {
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 6px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .home-header-subtitle {
            font-family: var(--font-elegant);
            font-size: 28px;
            font-weight: 300;
            color: var(--text-primary);
            font-style: italic;
            letter-spacing: 1px;
        }

        .app-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 24px; justify-items: center;
            padding: 0 10px;
        }
        .app-icon-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .app-icon-wrapper:active { transform: scale(0.92); }
        .app-icon-wrapper:hover { transform: translateY(-2px); }

        .app-icon {
            width: 58px; height: 58px;
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--shadow-subtle), inset 0 1px 0 rgba(255,255,255,0.05);
            transition: var(--transition-smooth);
            overflow: hidden;
            position: relative;
        }
        .app-icon::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, transparent 100%);
            border-radius: 16px 16px 0 0;
            pointer-events: none;
        }
        .app-icon svg {
            width: 26px; height: 26px;
            fill: var(--text-secondary);
            position: relative;
            z-index: 1;
            transition: var(--transition-fast);
        }
        .app-icon-wrapper:hover .app-icon svg {
            fill: var(--accent-gold);
        }
        .app-icon img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon-label {
            font-family: var(--font-display);
            font-size: 10px;
            font-weight: 500;
            color: var(--text-tertiary);
            text-align: center;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .home-decoration {
            position: absolute;
            bottom: calc(40px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .home-decoration-line {
            width: 60px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-border-light), transparent);
            margin: 0 auto 12px;
        }
        .home-decoration-text {
            font-family: var(--font-display);
            font-size: 8px;
            letter-spacing: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .home-indicator {
            position: absolute;
            bottom: calc(8px + var(--safe-bottom));
            left: 50%; transform: translateX(-50%);
            width: 100px; height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            z-index: 1001;
        }

        .page {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: blur(var(--blur-heavy));
            -webkit-backdrop-filter: blur(var(--blur-heavy));
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .page.active { transform: translateX(0); }
        .page.slide-from-bottom { transform: translateY(100%); }
        .page.slide-from-bottom.active { transform: translateY(0); }
        .page#chatPage { background: transparent; }
        .page#chatPage::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            z-index: -1;
        }
        .page#chatPage.has-custom-bg::before {
            background: rgba(10, 10, 15, 0.7);
        }
        .page#chatPage.has-custom-bg {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        .nav-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding-top: calc(16px + var(--safe-top));
            padding-bottom: 16px;
            padding-left: 20px; padding-right: 20px;
            background: linear-gradient(180deg, rgba(10,10,15,0.95) 0%, rgba(10,10,15,0.8) 70%, transparent 100%);
            backdrop-filter: blur(var(--blur-heavy));
            -webkit-backdrop-filter: blur(var(--blur-heavy));
            flex-shrink: 0;
            min-height: calc(70px + var(--safe-top));
            position: relative;
            z-index: 10;
        }
        .nav-bar::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20px; right: 20px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-border), transparent);
            opacity: 0.5;
        }

        .nav-btn {
            display: flex; align-items: center; justify-content: center;
            gap: 6px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 8px;
            min-width: 44px;
            transition: var(--transition-fast);
        }
        .nav-btn:hover {
            background: var(--glass-bg-light);
            border-color: var(--glass-border-light);
            color: var(--text-primary);
        }
        .nav-btn:active { transform: scale(0.96); }
        .nav-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .nav-title {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            flex: 1;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .page-content {
            flex: 1; overflow-y: auto;
            padding: 24px 20px;
            padding-bottom: calc(24px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 0 4px;
        }
        .section-header-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--glass-border), transparent);
        }
        .section-header-line.right {
            background: linear-gradient(90deg, transparent, var(--glass-border));
        }
        .section-header-title {
            font-family: var(--font-display);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 3px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .settings-group {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-subtle);
        }
        .settings-group-title {
            font-family: var(--font-display);
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 3px;
            padding: 20px 16px 8px;
        }
        .settings-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .settings-item:hover {
            background: var(--glass-bg);
        }
        .settings-item:last-child { border-bottom: none; }
        .settings-item-left { display: flex; align-items: center; gap: 12px; }
        .settings-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        .settings-icon svg {
            width: 16px; height: 16px;
            fill: var(--text-secondary);
        }
        .settings-item-label { color: var(--text-primary); font-size: 14px; }
        .settings-item-desc { color: var(--text-tertiary); font-size: 11px; margin-top: 2px; }

        .input-group { margin-bottom: 16px; }
        .input-label {
            display: block;
            font-family: var(--font-display);
            font-size: 9px;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .input-field {
            width: 100%; padding: 14px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: var(--transition-fast);
        }
        .input-field:focus {
            border-color: var(--accent-gold-dim);
            background: var(--glass-bg-light);
            box-shadow: 0 0 20px var(--accent-gold-glow);
        }
        .input-field::placeholder { color: var(--text-muted); }
        textarea.input-field {
            min-height: 100px; resize: vertical;
            font-family: inherit; line-height: 1.5;
        }
        textarea.css-editor {
            min-height: 160px;
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            font-size: 12px; line-height: 1.6;
            background: rgba(0, 0, 0, 0.4);
            color: var(--accent-gold);
        }

        .btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 14px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            width: 100%;
            transition: var(--transition-fast);
            text-transform: uppercase;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.4; }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold-dim), var(--accent-gold));
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }
        .btn-primary:hover {
            box-shadow: var(--shadow-glow);
        }
        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-secondary);
        }
        .btn-secondary:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }
        .btn-danger {
            background: var(--danger-soft);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        .btn-success {
            background: var(--success-soft);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        .btn-small { padding: 10px 14px; font-size: 11px; }
        .btn-stack { display: flex; flex-direction: column; gap: 10px; }
        .btn-row { display: flex; gap: 10px; }
        .btn-row .btn { flex: 1; }

        .contact-list { display: flex; flex-direction: column; gap: 8px; }
        .contact-item {
            display: flex; align-items: center; gap: 14px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 16px;
            cursor: pointer;
            border: 1px solid var(--glass-border);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }
        .contact-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        .contact-item:hover {
            background: var(--bg-elevated);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        .contact-avatar {
            width: 50px; height: 50px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--glass-bg-light), var(--glass-bg));
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; color: var(--text-secondary);
            flex-shrink: 0; overflow: hidden;
        }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        .contact-preview {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .contact-time {
            font-family: var(--font-display);
            font-size: 10px;
            color: var(--text-muted);
            flex-shrink: 0;
            letter-spacing: 1px;
        }

        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 60px 30px; text-align: center;
        }
        .empty-state-icon {
            width: 80px; height: 80px;
            border-radius: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
        }
        .empty-state-icon svg {
            width: 36px; height: 36px;
            fill: var(--text-muted);
        }
        .empty-state-title {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .empty-state-desc { font-size: 12px; color: var(--text-muted); }

        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-messages {
            flex: 1; overflow-y: auto;
            padding: 16px;
            display: flex; flex-direction: column; gap: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .message-wrapper { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 2px; }
        .message-wrapper.sent { justify-content: flex-end; }
        .message-wrapper.received { justify-content: flex-start; }

        .message-avatar {
            width: 28px; height: 28px;
            border-radius: 8px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: var(--text-secondary);
            flex-shrink: 0; overflow: hidden;
        }
        .message-avatar.square { border-radius: 6px; }
        .message-avatar.rounded-square { border-radius: 8px; }
        .message-avatar.hidden { display: none; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .message {
            max-width: 75%; padding: 12px 16px;
            font-size: 14px; line-height: 1.45;
            word-wrap: break-word;
            animation: msgIn 0.3s ease-out;
            position: relative;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message.sent {
            background: var(--message-sent);
            border: 1px solid var(--message-sent-border);
            color: var(--text-primary);
            border-radius: 18px 18px 4px 18px;
        }
        .message.received {
            background: var(--message-received);
            border: 1px solid var(--message-received-border);
            color: var(--text-primary);
            border-radius: 18px 18px 18px 4px;
        }

        .message-quote {
            background: rgba(0, 0, 0, 0.3);
            border-left: 2px solid var(--accent-gold-dim);
            border-radius: 4px;
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
            max-height: 44px; overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        .message-image {
            max-width: 220px; max-height: 220px;
            border-radius: 12px; margin-top: 6px;
            cursor: pointer; display: block;
            border: 1px solid var(--glass-border);
        }

        .message-time {
            font-family: var(--font-display);
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 1px;
        }
        .message-time.time-hidden { display: none; }
        .message-time.time-side { position: absolute; bottom: 6px; right: -44px; margin-top: 0; }
        .message-wrapper.sent .message-time.time-side { right: auto; left: -44px; }

        .message-checkbox {
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 2px solid var(--glass-border-light);
            background: transparent;
            display: none;
            align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0;
            transition: var(--transition-fast);
        }
        .message-checkbox.checked {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }
        .message-checkbox.checked::after { content: '✓'; color: white; font-size: 11px; }
        .chat-messages.select-mode .message-checkbox { display: flex; }

        .typing-indicator {
            display: inline-flex; gap: 4px;
            padding: 14px 18px;
            background: var(--message-received);
            border: 1px solid var(--message-received-border);
            border-radius: 18px 18px 18px 4px;
            width: fit-content;
        }
        .typing-indicator span {
            width: 6px; height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .chat-input-wrapper {
            background: linear-gradient(0deg, rgba(10,10,15,0.98) 0%, rgba(10,10,15,0.9) 100%);
            backdrop-filter: blur(var(--blur-heavy));
            -webkit-backdrop-filter: blur(var(--blur-heavy));
            border-top: 1px solid var(--glass-border);
        }

        .quote-preview-bar {
            display: none;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid var(--glass-border);
            align-items: center; gap: 12px;
        }
        .quote-preview-bar.active { display: flex; }
        .quote-preview-content {
            flex: 1;
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-left: 2px solid var(--accent-gold-dim);
            padding-left: 10px;
        }
        .quote-preview-close {
            width: 26px; height: 26px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .quote-preview-close:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }

        .chat-input-area {
            display: flex; align-items: flex-end; gap: 8px;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
        }

        .chat-btn {
            width: 40px; height: 40px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: var(--transition-fast);
        }
        .chat-btn:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }
        .chat-btn:active { transform: scale(0.92); }
        .chat-btn.send {
            background: linear-gradient(135deg, var(--accent-gold-dim), var(--accent-gold));
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }
        .chat-btn.send:hover {
            box-shadow: var(--shadow-glow);
        }
        .chat-btn.ai {
            background: linear-gradient(135deg, rgba(139, 157, 195, 0.3), rgba(139, 157, 195, 0.5));
            border-color: var(--accent-color);
        }
        .chat-btn svg { width: 18px; height: 18px; fill: currentColor; }

        .chat-input-field {
            flex: 1;
            min-height: 40px; max-height: 100px;
            padding: 10px 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none; outline: none;
            font-family: inherit;
            transition: var(--transition-fast);
        }
        .chat-input-field:focus {
            border-color: var(--glass-border-light);
            background: var(--glass-bg-light);
        }
        .chat-input-field::placeholder { color: var(--text-muted); }

        .extension-panel {
            position: absolute;
            bottom: calc(70px + var(--safe-bottom));
            left: 16px; right: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 0;
            z-index: 50;
            opacity: 0; visibility: hidden;
            transform: translateY(16px);
            transition: var(--transition-smooth);
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
        }
        .extension-panel.active { opacity: 1; visibility: visible; transform: translateY(0); }

        .ext-panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        .ext-panel-title {
            font-family: var(--font-display);
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        .ext-panel-close {
            width: 28px; height: 28px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-tertiary);
            font-size: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .ext-panel-close:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }

        .ext-btn {
            display: flex; align-items: center; gap: 14px;
            width: 100%; padding: 16px 20px;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition-fast);
            text-align: left;
        }
        .ext-btn:last-child { border-bottom: none; }
        .ext-btn:hover { background: var(--glass-bg); }
        .ext-btn:active { background: var(--glass-bg-light); }

        .ext-btn-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        .ext-btn-icon svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .ext-btn-icon.danger { border-color: var(--danger-color); }
        .ext-btn-icon.danger svg { fill: var(--danger-color); }
        .ext-btn-icon.purple { border-color: var(--accent-color); }
        .ext-btn-icon.purple svg { fill: var(--accent-color); }
        .ext-btn-icon.blue { border-color: var(--accent-gold); }
        .ext-btn-icon.blue svg { fill: var(--accent-gold); }

        .ext-btn-text { flex: 1; }
        .ext-btn-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 3px;
        }
        .ext-btn-desc { font-size: 11px; color: var(--text-tertiary); }

        .context-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 2500;
            opacity: 0; visibility: hidden;
            transition: var(--transition-fast);
            display: flex; align-items: center; justify-content: center;
        }
        .context-menu-overlay.active { opacity: 1; visibility: visible; }

        .context-menu {
            background: var(--bg-elevated);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            width: 220px;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            transform: scale(0.9);
            transition: transform 0.25s ease;
        }
        .context-menu-overlay.active .context-menu { transform: scale(1); }

        .context-menu-item {
            display: flex; align-items: center; gap: 14px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .context-menu-item:last-child { border-bottom: none; }
        .context-menu-item:hover { background: var(--glass-bg); }
        .context-menu-item:active { background: var(--glass-bg-light); }

        .context-menu-icon {
            width: 36px; height: 36px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        .context-menu-icon svg { width: 18px; height: 18px; fill: var(--text-secondary); }
        .context-menu-item:hover .context-menu-icon svg { fill: var(--text-primary); }

        .context-menu-label { font-size: 14px; color: var(--text-primary); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            opacity: 0; visibility: hidden;
            transition: var(--transition-smooth);
            padding: 24px;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            width: 100%; max-width: 360px;
            max-height: 80vh; overflow-y: auto;
            background: var(--bg-elevated);
            backdrop-filter: blur(var(--blur-heavy));
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-heavy);
            transform: scale(0.92);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-title {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }
        .modal-body {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .modal-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            margin-bottom: 16px;
            transition: var(--transition-fast);
        }
        .modal-input:focus {
            border-color: var(--accent-gold-dim);
            box-shadow: 0 0 20px var(--accent-gold-glow);
        }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            transition: var(--transition-fast);
            text-transform: uppercase;
        }
        .modal-btn.cancel {
            background: var(--glass-bg);
            color: var(--text-secondary);
        }
        .modal-btn.cancel:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }
        .modal-btn.confirm {
            background: linear-gradient(135deg, var(--accent-gold-dim), var(--accent-gold));
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }
        .modal-btn.confirm:hover {
            box-shadow: var(--shadow-glow);
        }
        .modal-btn.danger {
            background: var(--danger-soft);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .toast-container {
            position: fixed;
            top: calc(70px + var(--safe-top));
            left: 50%; transform: translateX(-50%);
            z-index: 3000;
            display: flex; flex-direction: column; gap: 8px;
            pointer-events: none;
        }
        .toast {
            padding: 14px 24px;
            background: var(--bg-elevated);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-medium);
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }
        .toast.success { border-left: 3px solid var(--success-color); }
        .toast.error { border-left: 3px solid var(--danger-color); }
        .toast.info { border-left: 3px solid var(--accent-gold); }
        .toast.warning { border-left: 3px solid var(--warning-color); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

        .search-field {
            width: 100%;
            padding: 14px 16px 14px 44px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.3)' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 14px center;
            transition: var(--transition-fast);
        }
        .search-field:focus {
            border-color: var(--glass-border-light);
            background-color: var(--bg-elevated);
        }

        .toggle-switch {
            position: relative;
            width: 48px; height: 28px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .toggle-switch.active {
            background: var(--accent-gold-dim);
            border-color: var(--accent-gold);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px; left: 3px;
            width: 20px; height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: var(--transition-fast);
        }
        .toggle-switch.active::after { left: 23px; }

        .select-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='rgba(255,255,255,0.4)'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }
        .select-field option { background: var(--bg-primary); }

        .file-input-hidden { display: none; }
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-border), transparent);
            margin: 20px 0;
        }

        .loading-spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--glass-border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .slider-container { margin: 16px 0; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .slider-label { font-size: 13px; color: var(--text-primary); }
        .slider-value {
            font-family: var(--font-display);
            font-size: 13px;
            color: var(--accent-gold);
            font-weight: 600;
            letter-spacing: 1px;
        }
        .slider-input {
            width: 100%; height: 4px;
            background: var(--glass-bg);
            border-radius: 2px;
            appearance: none;
        }
        .slider-input::-webkit-slider-thumb {
            appearance: none;
            width: 20px; height: 20px;
            background: var(--accent-gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(201, 169, 98, 0.3);
        }

        .action-hint {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px;
            background: var(--accent-gold-glow);
            border: 1px solid var(--accent-gold-dim);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .action-hint-icon { font-size: 14px; }
        .action-hint-text {
            font-size: 12px;
            color: var(--accent-gold);
            letter-spacing: 0.5px;
        }
        .action-hint.success {
            background: var(--success-soft);
            border-color: var(--success-color);
        }
        .action-hint.success .action-hint-text { color: var(--success-color); }
        .action-hint.warning {
            background: rgba(201, 169, 98, 0.1);
            border-color: var(--accent-gold-dim);
        }
        .action-hint.warning .action-hint-text { color: var(--accent-gold); }

        .delete-zone {
            padding: 18px;
            border: 1px dashed var(--danger-color);
            border-radius: 14px;
            text-align: center;
            color: var(--danger-color);
            margin-top: 20px;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: var(--transition-fast);
        }
        .delete-zone:hover {
            background: var(--danger-soft);
        }

        .log-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            max-height: 160px;
            overflow-y: auto;
            font-family: 'SF Mono', monospace;
            font-size: 10px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--glass-border);
        }
        .log-entry.success { color: var(--success-color); }
        .log-entry.error { color: var(--danger-color); }
        .log-entry.info { color: var(--accent-gold); }

        .model-list { max-height: 180px; overflow-y: auto; margin-top: 12px; }
        .model-item {
            padding: 12px 14px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .model-item:hover {
            background: var(--glass-bg-light);
            border-color: var(--glass-border-light);
        }
        .model-item.selected {
            background: var(--accent-gold-glow);
            border-color: var(--accent-gold);
        }
        .model-item-name { font-size: 12px; color: var(--text-primary); }

        .date-separator { display: flex; justify-content: center; padding: 12px 0; }
        .date-separator-text {
            padding: 6px 14px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            font-family: var(--font-display);
            font-size: 10px;
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        .select-mode-bar {
            display: none;
            align-items: center; justify-content: space-between;
            padding: 12px 16px;
            background: var(--danger-soft);
            border-bottom: 1px solid var(--danger-color);
        }
        .select-mode-bar.active { display: flex; }
        .select-mode-info { font-size: 13px; color: var(--text-primary); }
        .select-mode-btns { display: flex; gap: 10px; }
        .select-mode-btn {
            padding: 8px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            text-transform: uppercase;
        }
        .select-mode-btn.cancel {
            background: var(--glass-bg);
            color: var(--text-primary);
        }
        .select-mode-btn.delete {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        .avatar-upload-area {
            width: 90px; height: 90px;
            border-radius: 20px;
            background: var(--glass-bg);
            border: 2px dashed var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            margin: 0 auto 16px;
            color: var(--text-muted);
            overflow: hidden;
            transition: var(--transition-smooth);
        }
        .avatar-upload-area svg {
            width: 32px; height: 32px;
            fill: var(--text-muted);
        }
        .avatar-upload-area:hover {
            border-color: var(--accent-gold-dim);
            background: var(--glass-bg-light);
        }
        .avatar-upload-area.has-image {
            border-style: solid;
            border-color: var(--accent-gold-dim);
        }
        .avatar-upload-area img { width: 100%; height: 100%; object-fit: cover; }

        .color-picker-row {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 12px;
        }
        .color-picker-label { font-size: 13px; color: var(--text-primary); flex: 1; }
        .color-picker-input {
            width: 44px; height: 32px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        .shape-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .shape-option {
            padding: 10px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .shape-option:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }
        .shape-option.selected {
            background: var(--accent-gold-glow);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .worldbook-entries { margin-top: 12px; }
        .worldbook-entry-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 10px;
        }
        .worldbook-entry-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .worldbook-entry-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .worldbook-entry-actions { display: flex; gap: 8px; }
        .worldbook-entry-btn {
            width: 28px; height: 28px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-tertiary);
            font-size: 12px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .worldbook-entry-btn:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }
        .worldbook-entry-keywords {
            font-size: 11px;
            color: var(--accent-gold);
            margin-bottom: 6px;
        }
        .worldbook-entry-preview {
            font-size: 11px;
            color: var(--text-tertiary);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .worldbook-item {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .worldbook-item:hover {
            background: var(--bg-elevated);
            transform: translateY(-2px);
        }
        .worldbook-item-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .worldbook-item-title {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }
        .worldbook-item-badge {
            padding: 4px 10px;
            background: var(--accent-gold-glow);
            border: 1px solid var(--accent-gold-dim);
            border-radius: 20px;
            font-family: var(--font-display);
            font-size: 9px;
            color: var(--accent-gold);
            letter-spacing: 1px;
        }
        .worldbook-item-preview {
            font-size: 12px;
            color: var(--text-tertiary);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .char-counter {
            font-size: 10px;
            color: var(--text-muted);
            text-align: right;
            margin-top: 4px;
        }
        .char-counter.warning { color: var(--warning-color); }
        .char-counter.error { color: var(--danger-color); }

        .wallpaper-preview {
            width: 100%; height: 140px;
            border-radius: 14px;
            margin-bottom: 16px;
            border: 1px solid var(--glass-border);
            overflow: hidden;
            background: var(--bg-card);
        }

        .icon-customize-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 14px;
        }
        .icon-customize-item {
            display: flex; flex-direction: column;
            align-items: center; gap: 8px;
        }
        .icon-customize-preview {
            width: 54px; height: 54px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            border: 2px dashed var(--glass-border);
            background: var(--glass-bg);
            overflow: hidden;
            transition: var(--transition-smooth);
        }
        .icon-customize-preview svg {
            width: 24px; height: 24px;
            fill: var(--text-muted);
        }
        .icon-customize-preview:hover {
            border-color: var(--accent-gold-dim);
            background: var(--glass-bg-light);
        }
        .icon-customize-preview.has-image { border-style: solid; }
        .icon-customize-preview img { width: 100%; height: 100%; object-fit: cover; }
        .icon-customize-label {
            font-family: var(--font-display);
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .storage-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
        }
        .storage-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .storage-title {
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: 1px;
        }
        .storage-size {
            font-family: var(--font-display);
            font-size: 12px;
            color: var(--accent-gold);
            letter-spacing: 1px;
        }
        .storage-bar {
            height: 6px;
            background: var(--glass-bg);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .storage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold-dim), var(--accent-gold));
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .storage-bar-fill.warning {
            background: linear-gradient(90deg, var(--warning-color), #e6b84a);
        }
        .storage-bar-fill.danger {
            background: linear-gradient(90deg, var(--danger-color), #d87070);
        }
        .storage-details {
            display: flex; justify-content: space-between;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .preset-selector {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 12px;
        }
        .preset-selector select { flex: 1; }
        .preset-btn {
            width: 40px; height: 40px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .preset-btn:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }
        .preset-btn:active { transform: scale(0.95); }
        .preset-btn.danger:hover {
            background: var(--danger-soft);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .guide-content {
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 8px;
        }
        .guide-section { margin-bottom: 18px; }
        .guide-section-title {
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-gold);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .guide-code {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 12px;
            font-family: 'SF Mono', monospace;
            font-size: 11px;
            color: var(--accent-gold);
            margin-bottom: 8px;
            overflow-x: auto;
        }
        .guide-text {
            font-size: 12px;
            color: var(--text-tertiary);
            line-height: 1.6;
        }

        .chat-wallpaper-preview {
            width: 100%; height: 100px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-muted);
            font-size: 12px;
            overflow: hidden;
        }
        .chat-wallpaper-preview.has-image {
            background-size: cover !important;
            background-position: center !important;
        }
        .chat-wallpaper-preview.has-image span { display: none; }

        .worldbook-multi-select {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            background: var(--glass-bg);
        }
        .worldbook-multi-item {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .worldbook-multi-item:last-child { border-bottom: none; }
        .worldbook-multi-item:hover { background: var(--glass-bg-light); }
        .worldbook-multi-checkbox {
            width: 22px; height: 22px;
            border-radius: 6px;
            border: 2px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .worldbook-multi-checkbox.checked {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
        }
        .worldbook-multi-checkbox.checked::after { content: '✓'; color: var(--bg-primary); font-size: 12px; font-weight: bold; }
        .worldbook-multi-name { font-size: 14px; color: var(--text-primary); }

        .font-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .font-item:hover {
            background: var(--glass-bg-light);
        }
        .font-item.selected {
            background: var(--accent-gold-glow);
            border-color: var(--accent-gold);
        }
        .font-item-info {
            flex: 1;
        }
        .font-item-name {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .font-item-preview {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .font-item-actions {
            display: flex;
            gap: 8px;
        }
        .font-item-btn {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-tertiary);
            font-size: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .font-item-btn:hover {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }
        .font-item-btn.danger:hover {
            background: var(--danger-soft);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 2px; }

        #customCssStyles { }
    </style>
    <style id="customCssStyles"></style>
</head>
<body>
    <div id="wallpaperLayer"></div>

    <div class="phone-container">
        <div class="status-bar" id="statusBar">
            <span class="status-bar-time" id="statusBarTime">9:41</span>
            <div class="status-bar-icons">
                <svg viewBox="0 0 24 24"><path d="M12 3C7.46 3 3.34 4.78.29 7.67c-.18.18-.29.43-.29.71 0 .28.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73s3.15.25 4.6.73v3.1c0 .4.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71 0-.28-.11-.53-.29-.71C20.66 4.78 16.54 3 12 3z"/></svg>
                <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
            </div>
        </div>

        <div class="home-screen" id="homeScreen">
            <div class="home-header">
                <div class="home-header-title">Welcome</div>
                <div class="home-header-subtitle">Persona</div>
            </div>

            <div class="app-grid" id="appGrid">
                <div class="app-icon-wrapper" onclick="openPage('settingsPage')">
                    <div class="app-icon" id="appIconSettings">
                        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    </div>
                    <span class="app-icon-label">Settings</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('messagesPage')">
                    <div class="app-icon" id="appIconMessages">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/><path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
                    </div>
                    <span class="app-icon-label">Messages</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('worldbookPage')">
                    <div class="app-icon" id="appIconWorldbook">
                        <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                    </div>
                    <span class="app-icon-label">Lore</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('wallpaperPage')">
                    <div class="app-icon" id="appIconPhotos">
                        <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </div>
                    <span class="app-icon-label">Theme</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('fontPage')">
                    <div class="app-icon" id="appIconFont">
                        <svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg>
                    </div>
                    <span class="app-icon-label">Fonts</span>
                </div>
            </div>

            <div class="home-decoration">
                <div class="home-decoration-line"></div>
                <div class="home-decoration-text">AI Persona Simulator</div>
            </div>
        </div>

        <div class="home-indicator"></div>

        <!-- 设置页面 -->
        <div class="page" id="settingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('settingsPage')">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title">Settings</span>
                <div class="nav-btn" style="visibility:hidden">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg>
                </div>
            </div>
            <div class="page-content">
                <div class="storage-card">
                    <div class="storage-header">
                        <span class="storage-title">STORAGE</span>
                        <span class="storage-size" id="storageSize">Calculating...</span>
                    </div>
                    <div class="storage-bar"><div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div></div>
                    <div class="storage-details">
                        <span id="storageUsed">Used: 0 MB</span>
                        <span id="storageTotal">Unlimited</span>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">API Configuration</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="action-hint" id="connectionStatusHint">
                        <span class="action-hint-icon">⚠</span>
                        <span class="action-hint-text">API not configured</span>
                    </div>

                    <div class="input-group">
                        <label class="input-label">API Preset</label>
                        <div class="preset-selector">
                            <select class="select-field" id="apiPresetSelect" onchange="loadApiPreset()">
                                <option value="">-- No Preset --</option>
                            </select>
                            <button class="preset-btn" onclick="addNewApiPreset()" title="New Preset">＋</button>
                            <button class="preset-btn" onclick="updateApiPreset()" title="Update Preset">💾</button>
                            <button class="preset-btn danger" onclick="deleteApiPreset()" title="Delete Preset">🗑</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">API Base URL</label>
                        <input type="text" class="input-field" id="apiBaseUrl" placeholder="https://api.example.com">
                    </div>
                    <div class="input-group">
                        <label class="input-label">API Key</label>
                        <input type="password" class="input-field" id="apiKey" placeholder="sk-xxx...">
                    </div>
                    <button class="btn btn-secondary" onclick="fetchModels()" id="fetchModelsBtn">Fetch Models</button>
                    <div id="modelListContainer" style="display:none">
                        <label class="input-label" style="margin-top:16px">Available Models</label>
                        <div class="model-list" id="modelList"></div>
                    </div>
                    <div class="input-group" style="margin-top:16px">
                        <label class="input-label">Current Model</label>
                        <input type="text" class="input-field" id="modelName" placeholder="Model name">
                    </div>
                    <div class="btn-stack" style="margin-top:16px">
                        <button class="btn btn-secondary" onclick="testConnection()" id="testConnectionBtn">Test Connection</button>
                        <button class="btn btn-primary" onclick="saveApiSettings()">Save Settings</button>
                    </div>
                    <div class="divider"></div>
                    <label class="input-label">Debug Log</label>
                    <div class="log-container" id="debugLog"><div class="log-entry info">Waiting...</div></div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Chat Settings</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="input-group">
                        <label class="input-label">Max Context Messages</label>
                        <input type="number" class="input-field" id="maxContextMessages" value="200">
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Model Parameters</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Temperature</span>
                            <span class="slider-value" id="tempValue">0.7</span>
                        </div>
                        <input type="range" class="slider-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempValue').textContent=this.value">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Max Tokens</span>
                            <span class="slider-value" id="maxTokensValue">2048</span>
                        </div>
                        <input type="range" class="slider-input" id="maxTokens" min="256" max="8192" step="256" value="2048" oninput="document.getElementById('maxTokensValue').textContent=this.value">
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Cache & Storage</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group">
                    <div class="settings-item" onclick="clearImageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M5 13h14v-2H5v2zm-2 4h14v-2H3v2zM7 7v2h14V7H7z"/></svg></span>
                            <div><span class="settings-item-label">Clear Image Cache</span><div class="settings-item-desc">Avatars, wallpapers</div></div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="clearMessageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></span>
                            <div><span class="settings-item-label">Clear Message Cache</span><div class="settings-item-desc">Keep character settings</div></div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="compactDatabase()">
                        <div class="settings-item-left">
                            <span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg></span>
                            <div><span class="settings-item-label">Optimize Storage</span><div class="settings-item-desc">Compress images</div></div>
                        </div>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Data Management</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group">
                    <div class="settings-item" onclick="forceSaveAll()">
                        <div class="settings-item-left"><span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></span><span class="settings-item-label">Force Save</span></div>
                    </div>
                    <div class="settings-item" onclick="exportAllData()">
                        <div class="settings-item-left"><span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg></span><span class="settings-item-label">Export Data</span></div>
                    </div>
                    <div class="settings-item" onclick="document.getElementById('importFileInput').click()">
                        <div class="settings-item-left"><span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zM6 11.5l1.41 1.41L11 9.33V19h2V9.33l3.59 3.58L18 11.5l-5-5-5 5z"/></svg></span><span class="settings-item-label">Import Data</span></div>
                    </div>
                    <input type="file" id="importFileInput" class="file-input-hidden" accept=".json" onchange="importData(event)">
                    <div class="settings-item" onclick="clearAllData()">
                        <div class="settings-item-left"><span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></span><span class="settings-item-label">Clear All Data</span></div>
                    </div>
                </div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- 短信列表 -->
        <div class="page" id="messagesPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('messagesPage')">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title">Messages</span>
                <button class="nav-btn" onclick="showModal('createCharacterModal')">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
            <div style="padding:0 16px 14px">
                <input type="text" class="search-field" id="contactSearch" placeholder="Search characters..." oninput="filterContacts()">
            </div>
            <div class="page-content" id="contactListContainer" style="padding-top:0">
                <div class="empty-state" id="emptyContactState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                    </div>
                    <div class="empty-state-title">No Characters</div>
                    <div class="empty-state-desc">Tap + to create one</div>
                </div>
                <div class="contact-list" id="contactList" style="display:none"></div>
            </div>
        </div>

        <!-- 聊天页面 -->
        <div class="page" id="chatPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeChatPage()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title" id="chatTitle">Character</span>
                <button class="nav-btn" onclick="openCharacterSettings()">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </button>
            </div>
            <div class="select-mode-bar" id="selectModeBar">
                <span class="select-mode-info">Selected <span id="selectedCount">0</span></span>
                <div class="select-mode-btns">
                    <button class="select-mode-btn cancel" onclick="exitSelectMode()">Cancel</button>
                    <button class="select-mode-btn delete" onclick="deleteSelectedMessages()">Delete</button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>

                <div class="extension-panel" id="extensionPanel">
                    <div class="ext-panel-header">
                        <span class="ext-panel-title">Actions</span>
                        <button class="ext-panel-close" onclick="toggleExtensionPanel()">✕</button>
                    </div>
                    <button class="ext-btn" onclick="enterSelectMode()">
                        <div class="ext-btn-icon danger"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Select & Delete</div><div class="ext-btn-desc">Batch delete messages</div></div>
                    </button>
                    <button class="ext-btn" onclick="regenerateLastReply()">
                        <div class="ext-btn-icon purple"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Regenerate</div><div class="ext-btn-desc">Regenerate AI reply</div></div>
                    </button>
                    <button class="ext-btn" onclick="openImagePicker()">
                        <div class="ext-btn-icon blue"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Send Image</div><div class="ext-btn-desc">Send image to AI</div></div>
                    </button>
                </div>

                <div class="chat-input-wrapper">
                    <div class="quote-preview-bar" id="quotePreviewBar">
                        <div class="quote-preview-content" id="quotePreviewContent"></div>
                        <button class="quote-preview-close" onclick="cancelQuote()">✕</button>
                    </div>
                    <div class="chat-input-area">
                        <button class="chat-btn" onclick="toggleExtensionPanel()" title="More">
                            <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
                        </button>
                        <textarea class="chat-input-field" id="chatInput" placeholder="Type a message..." rows="1" oninput="autoResizeTextarea(this)"></textarea>
                        <button class="chat-btn ai" onclick="triggerAIReply()" title="AI Reply">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        </button>
                        <button class="chat-btn send" onclick="sendMessage()" title="Send">
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <input type="file" id="chatImageInput" class="file-input-hidden" accept="image/*" onchange="handleChatImageUpload(event)">
        </div>

        <div class="context-menu-overlay" id="contextMenuOverlay" onclick="hideContextMenu()">
            <div class="context-menu" id="contextMenu" onclick="event.stopPropagation()">
                <div class="context-menu-item" onclick="copyMessageText()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></div>
                    <span class="context-menu-label">Copy</span>
                </div>
                <div class="context-menu-item" onclick="quoteMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/></svg></div>
                    <span class="context-menu-label">Quote</span>
                </div>
                <div class="context-menu-item" onclick="editMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div>
                    <span class="context-menu-label">Edit</span>
                </div>
            </div>
        </div>

        <!-- 角色设置页面 -->
        <div class="page slide-from-bottom" id="characterSettingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeCharacterSettings()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title">Character Settings</span>
                <button class="nav-btn" onclick="saveCharacterSettings()">Save</button>
            </div>
            <div class="page-content">
                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Chat Management</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group">
                    <div class="settings-item" onclick="confirmClearAllMessages()">
                        <div class="settings-item-left">
                            <span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></span>
                            <div><span class="settings-item-label">Clear All Messages</span><div class="settings-item-desc">Delete all chat history</div></div>
                        </div>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Chat Wallpaper</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="chat-wallpaper-preview" id="chatWallpaperPreview"><span>No custom wallpaper</span></div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="document.getElementById('chatWallpaperInput').click()">Upload</button>
                        <button class="btn btn-secondary btn-small" onclick="clearChatWallpaper()">Clear</button>
                    </div>
                    <input type="file" id="chatWallpaperInput" class="file-input-hidden" accept="image/*" onchange="handleChatWallpaperUpload(event)">
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Avatars</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <label class="input-label">Character Avatar</label>
                    <div class="avatar-upload-area" id="charAvatarUpload" onclick="document.getElementById('charAvatarInput').click()">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <input type="file" id="charAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleCharAvatarUpload(event)">
                    <label class="input-label" style="margin-top:16px">User Avatar</label>
                    <div class="avatar-upload-area" id="userAvatarUpload" onclick="document.getElementById('userAvatarInput').click()">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <input type="file" id="userAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleUserAvatarUpload(event)">
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Avatar Display</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="settings-item" style="padding:0 0 14px 0;border:none">
                        <span class="settings-item-label">Show Avatars</span>
                        <div class="toggle-switch" id="showAvatarToggle" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Shape</label>
                        <div class="shape-options" id="avatarShapeOptions">
                            <div class="shape-option selected" data-shape="circle" onclick="selectShape(this)">Circle</div>
                            <div class="shape-option" data-shape="square" onclick="selectShape(this)">Square</div>
                            <div class="shape-option" data-shape="rounded-square" onclick="selectShape(this)">Rounded</div>
                        </div>
                    </div>
                    <div class="settings-item" style="padding:14px 0;border:none">
                        <span class="settings-item-label">Border</span>
                        <div class="toggle-switch" id="showBorderToggle" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="color-picker-row">
                        <span class="color-picker-label">Border Color</span>
                        <input type="color" class="color-picker-input" id="borderColorPicker" value="#c9a962">
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Basic Info</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="input-group">
                        <label class="input-label">Name</label>
                        <input type="text" class="input-field" id="charName" placeholder="Character name">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Emoji (fallback)</label>
                        <input type="text" class="input-field" id="charAvatar" placeholder="😊">
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Character Definition</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <textarea class="input-field" id="charDescription" rows="5" placeholder="Personality, background..."></textarea>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">First Message (300 chars)</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <textarea class="input-field" id="charGreeting" rows="2" maxlength="300" placeholder="First message..." oninput="updateCharCounter()"></textarea>
                    <div class="char-counter" id="greetingCharCounter">0/300</div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Scenario</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <textarea class="input-field" id="charScenario" rows="2" placeholder="Scene setting..."></textarea>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Linked Lorebooks</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="worldbook-multi-select" id="worldbookMultiSelect"></div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Advanced</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="input-group">
                        <label class="input-label">User Name</label>
                        <input type="text" class="input-field" id="charUserNick" placeholder="Your character's name in the story">
                    </div>
                    <div class="input-group">
                        <label class="input-label">System Prompt</label>
                        <textarea class="input-field" id="charSystemPrompt" rows="2" placeholder="Extra instructions..."></textarea>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Custom CSS</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="action-hint warning">
                        <span class="action-hint-icon">⚠</span>
                        <span class="action-hint-text">Custom CSS overrides avatar settings</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label">CSS Preset</label>
                        <div class="preset-selector">
                            <select class="select-field" id="cssPresetSelect" onchange="loadCssPreset()"><option value="">-- No Preset --</option></select>
                            <button class="preset-btn" onclick="addNewCssPreset()" title="New">＋</button>
                            <button class="preset-btn" onclick="saveCssPreset()" title="Save">💾</button>
                            <button class="preset-btn danger" onclick="deleteCssPreset()" title="Delete">🗑</button>
                            <button class="preset-btn" onclick="showCssGuide()" title="Guide">?</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Timestamp Position</label>
                        <select class="select-field" id="timestampPosition">
                            <option value="default">Default (inside bubble)</option>
                            <option value="hidden">Hidden</option>
                            <option value="side">Side</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Custom CSS Code</label>
                        <textarea class="input-field css-editor" id="customCssEditor" rows="8" placeholder="/* Enter custom CSS */"></textarea>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="previewCss()">Preview</button>
                        <button class="btn btn-danger btn-small" onclick="clearCustomCss()">Clear</button>
                    </div>
                </div>

                <div class="delete-zone" onclick="deleteCurrentCharacter()">Delete Character</div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- 世界书页面 -->
        <div class="page" id="worldbookPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('worldbookPage')">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title">Lorebook</span>
                <button class="nav-btn" onclick="showModal('createWorldbookModal')">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
            <div class="page-content">
                <div class="action-hint">
                    <span class="action-hint-icon">📚</span>
                    <span class="action-hint-text">Each lorebook can contain multiple entries</span>
                </div>
                <div class="empty-state" id="emptyWorldbookState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                    </div>
                    <div class="empty-state-title">No Lorebooks</div>
                    <div class="empty-state-desc">Tap + to create one</div>
                </div>
                <div id="worldbookList" style="display:none"></div>
            </div>
        </div>

        <!-- 世界书编辑 -->
        <div class="page slide-from-bottom" id="worldbookEditPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeWorldbookEdit()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title">Edit Lorebook</span>
                <button class="nav-btn" onclick="saveWorldbook()">Save</button>
            </div>
            <div class="page-content">
                <div class="settings-group" style="padding:16px">
                    <div class="input-group">
                        <label class="input-label">Lorebook Name</label>
                        <input type="text" class="input-field" id="worldbookName" placeholder="Name">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Summary</label>
                        <textarea class="input-field" id="worldbookSummary" rows="2" placeholder="Summary..."></textarea>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Entries</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="worldbook-entries" id="worldbookEntries"></div>
                    <button class="btn btn-secondary" onclick="addWorldbookEntry()">+ Add Entry</button>
                </div>

                <div class="delete-zone" onclick="deleteCurrentWorldbook()">Delete Lorebook</div>
                <div style="height:40px"></div>
            </div>
        </div>

        <div class="modal-overlay" id="entryEditModal">
            <div class="modal">
                <div class="modal-title">Edit Entry</div>
                <div class="input-group">
                    <label class="input-label">Entry Name</label>
                    <input type="text" class="modal-input" id="entryName" placeholder="Name" style="margin-bottom:12px">
                </div>
                <div class="input-group">
                    <label class="input-label">Keywords (comma separated)</label>
                    <input type="text" class="modal-input" id="entryKeywords" placeholder="keyword1, keyword2..." style="margin-bottom:12px">
                </div>
                <div class="input-group">
                    <label class="input-label">Content</label>
                    <textarea class="input-field" id="entryContent" rows="5" placeholder="Content..."></textarea>
                </div>
                <div class="settings-item" style="padding:14px 0;border:none">
                    <span class="settings-item-label">Always Active</span>
                    <div class="toggle-switch" id="entryAlwaysActive" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="hideModal('entryEditModal')">Cancel</button>
                    <button class="modal-btn confirm" onclick="saveWorldbookEntry()">Save</button>
                </div>
            </div>
        </div>

        <!-- 壁纸页面 -->
        <div class="page" id="wallpaperPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('wallpaperPage')">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title">Theme</span>
                <div class="nav-btn" style="visibility:hidden">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg>
                </div>
            </div>
            <div class="page-content">
                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Display</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group">
                    <div class="settings-item" onclick="toggleStatusBar()">
                        <div class="settings-item-left">
                            <span class="settings-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></span>
                            <div><span class="settings-item-label">Hide Status Bar</span><div class="settings-item-desc">Avoid overlap with system bar</div></div>
                        </div>
                        <div class="toggle-switch" id="hideStatusBarToggle"></div>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Preview</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="wallpaper-preview" id="wallpaperPreview"></div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Preset Wallpapers</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px" id="wallpaperGrid">
                        <div onclick="selectPresetWallpaper('gradient1')" style="height:70px;border-radius:12px;background:linear-gradient(135deg,#0a0a0f,#12121a,#0a0a0f);cursor:pointer;border:2px solid transparent" data-wp="gradient1"></div>
                        <div onclick="selectPresetWallpaper('gradient2')" style="height:70px;border-radius:12px;background:linear-gradient(135deg,#1a1520,#0d1a1a);cursor:pointer;border:2px solid transparent" data-wp="gradient2"></div>
                        <div onclick="selectPresetWallpaper('gradient3')" style="height:70px;border-radius:12px;background:linear-gradient(135deg,#0d0d18,#1a1a2e,#0d0d18);cursor:pointer;border:2px solid transparent" data-wp="gradient3"></div>
                        <div onclick="selectPresetWallpaper('gradient4')" style="height:70px;border-radius:12px;background:linear-gradient(135deg,#0f1318,#1a2030);cursor:pointer;border:2px solid transparent" data-wp="gradient4"></div>
                        <div onclick="selectPresetWallpaper('gradient5')" style="height:70px;border-radius:12px;background:linear-gradient(135deg,#121212,#1a1a1a);cursor:pointer;border:2px solid transparent" data-wp="gradient5"></div>
                        <div onclick="selectPresetWallpaper('gradient6')" style="height:70px;border-radius:12px;background:linear-gradient(135deg,#0f0f15,#252030);cursor:pointer;border:2px solid transparent" data-wp="gradient6"></div>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Custom</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="input-group">
                        <label class="input-label">Image URL</label>
                        <input type="text" class="input-field" id="customWallpaperUrl" placeholder="https://...">
                    </div>
                    <button class="btn btn-secondary" onclick="previewUrlWallpaper()">Preview</button>
                    <div class="divider"></div>
                    <button class="btn btn-secondary" onclick="document.getElementById('wallpaperUpload').click()">Upload Image</button>
                    <input type="file" id="wallpaperUpload" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
                </div>

                <button class="btn btn-primary" onclick="saveWallpaper()" style="margin-bottom:20px">Save Wallpaper</button>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">App Icons</span>
                    <div class="section-header-line right"></div>
                </div>

                <div class="settings-group" style="padding:16px">
                    <div class="icon-customize-grid">
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewSettings" onclick="document.getElementById('iconInputSettings').click()">
                                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>
                            </div>
                            <span class="icon-customize-label">Settings</span>
                            <input type="file" id="iconInputSettings" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'settings')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewMessages" onclick="document.getElementById('iconInputMessages').click()">
                                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                            </div>
                            <span class="icon-customize-label">Messages</span>
                            <input type="file" id="iconInputMessages" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'messages')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewWorldbook" onclick="document.getElementById('iconInputWorldbook').click()">
                                <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                            </div>
                            <span class="icon-customize-label">Lore</span>
                            <input type="file" id="iconInputWorldbook" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'worldbook')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewPhotos" onclick="document.getElementById('iconInputPhotos').click()">
                                <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            </div>
                            <span class="icon-customize-label">Theme</span>
                            <input type="file" id="iconInputPhotos" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'photos')">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <button class="btn btn-primary" onclick="saveIcons()">Save Icons</button>
                    <div style="height:8px"></div>
                    <button class="btn btn-secondary" onclick="resetIcons()">Reset</button>
                </div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- 字体页面 -->
        <div class="page" id="fontPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('fontPage')">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <span class="nav-title">Fonts</span>
                <div class="nav-btn" style="visibility:hidden">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg>
                </div>
            </div>
            <div class="page-content">
                <div class="action-hint">
                    <span class="action-hint-icon">🔤</span>
                    <span class="action-hint-text">Font applies globally to the entire app</span>
                </div>

                <div class="section-header">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Preset Fonts</span>
                    <div class="section-header-line right"></div>
                </div>

                <div id="presetFontList"></div>

                <div class="section-header" style="margin-top:24px">
                    <div class="section-header-line"></div>
                    <span class="section-header-title">Custom Fonts</span>
                    <div class="section-header-line right"></div>
                </div>

                <div id="customFontList"></div>

                <div class="settings-group" style="padding:16px;margin-top:16px">
                    <div class="input-group">
                        <label class="input-label">Font Name</label>
                        <input type="text" class="input-field" id="newFontName" placeholder="My Custom Font">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Font URL (.ttf, .otf, .woff, .woff2)</label>
                        <input type="text" class="input-field" id="newFontUrl" placeholder="https://example.com/font.ttf">
                    </div>
                    <button class="btn btn-primary" onclick="addCustomFont()">Add Font</button>
                </div>

                <div style="height:40px"></div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal-overlay" id="createCharacterModal">
        <div class="modal">
            <div class="modal-title">Create Character</div>
            <input type="text" class="modal-input" id="newCharacterName" placeholder="Character name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createCharacterModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createCharacter()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createWorldbookModal">
        <div class="modal">
            <div class="modal-title">Create Lorebook</div>
            <input type="text" class="modal-input" id="newWorldbookName" placeholder="Name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createWorldbookModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createWorldbook()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal">
            <div class="modal-title" id="deleteModalTitle">Confirm Delete?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:18px;font-size:13px" id="deleteModalDesc">This action cannot be undone</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('confirmDeleteModal')">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="clearMessagesModal">
        <div class="modal">
            <div class="modal-title">Clear All Messages</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:18px;font-size:13px">Delete all chat history with this character?<br>This cannot be undone!</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('clearMessagesModal')">Cancel</button>
                <button class="modal-btn danger" onclick="executeClearAllMessages()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cssPresetNameModal">
        <div class="modal">
            <div class="modal-title">New CSS Preset</div>
            <input type="text" class="modal-input" id="newCssPresetName" placeholder="Preset name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('cssPresetNameModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createCssPreset()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="apiPresetNameModal">
        <div class="modal">
            <div class="modal-title">New API Preset</div>
            <input type="text" class="modal-input" id="newApiPresetName" placeholder="Preset name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('apiPresetNameModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createApiPreset()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteCssPresetModal">
        <div class="modal">
            <div class="modal-title">Delete CSS Preset?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:18px;font-size:13px">Are you sure you want to delete this preset?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('deleteCssPresetModal')">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDeleteCssPreset()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteApiPresetModal">
        <div class="modal">
            <div class="modal-title">Delete API Preset?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:18px;font-size:13px">Are you sure you want to delete this preset?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('deleteApiPresetModal')">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDeleteApiPreset()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteFontModal">
        <div class="modal">
            <div class="modal-title">Delete Font?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:18px;font-size:13px">Are you sure you want to delete this font?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('deleteFontModal')">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDeleteFont()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cssGuideModal">
        <div class="modal" style="max-width:400px">
            <div class="modal-title">CSS Guide</div>
            <div class="guide-content">
                <div class="guide-section">
                    <div class="guide-section-title">Message Bubbles</div>
                    <div class="guide-code">.message.sent { }<br>.message.received { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Quote</div>
                    <div class="guide-code">.message-quote { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Avatar</div>
                    <div class="guide-code">.message-avatar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Timestamp</div>
                    <div class="guide-code">.message-time { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Input Area</div>
                    <div class="guide-code">.chat-input-area { }<br>.chat-input-field { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Nav Bar</div>
                    <div class="guide-code">#chatPage .nav-bar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Example</div>
                    <div class="guide-code">.message.sent {<br>  background: linear-gradient(135deg, #c9a962, #a08040);<br>  border-radius: 20px;<br>}</div>
                </div>
            </div>
            <div class="modal-btns" style="margin-top:18px">
                <button class="modal-btn confirm" onclick="hideModal('cssGuideModal')">Got it</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editMessageModal">
        <div class="modal">
            <div class="modal-title">Edit Message</div>
            <textarea class="input-field" id="editMessageContent" rows="4" placeholder="Edit content..."></textarea>
            <div class="modal-btns" style="margin-top:16px">
                <button class="modal-btn cancel" onclick="hideModal('editMessageModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="saveEditedMessage()">Save</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const DB_NAME = 'SMSAppDB';
        const DB_VERSION = 4;
        let db = null;

        const PRESET_FONTS = [
            { id: 'default', name: 'System Default', url: null, preview: 'The quick brown fox' },
            { id: 'noto-sans-sc', name: 'Noto Sans SC', url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap', preview: '思源黑体 Hello', isGoogle: true },
            { id: 'noto-serif-sc', name: 'Noto Serif SC', url: 'https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;700&display=swap', preview: '思源宋体 Hello', isGoogle: true },
            { id: 'lxgw-wenkai', name: 'LXGW WenKai', url: 'https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css', preview: '霞鹜文楷 Hello', isGoogle: false, fontFamily: '"LXGW WenKai", cursive' },
            { id: 'zcool-kuaile', name: 'ZCOOL KuaiLe', url: 'https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap', preview: '站酷快乐体 Hello', isGoogle: true },
            { id: 'smiley-sans', name: 'Smiley Sans', url: 'https://cdn.jsdelivr.net/npm/smiley-sans@1.1.1/dist/SmileySans-Oblique.ttf.woff2', preview: '得意黑 Hello', isGoogle: false, fontFamily: '"Smiley Sans"' }
        ];

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('appData')) database.createObjectStore('appData', { keyPath: 'key' });
                    if (!database.objectStoreNames.contains('images')) database.createObjectStore('images', { keyPath: 'id' });
                };
            });
        }

        function saveToIDB(storeName, key, value) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).put(storeName === 'appData' ? { key, value } : { id: key, data: value });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        function loadFromIDB(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readonly');
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result ? (storeName === 'appData' ? req.result.value : req.result.data) : null);
                req.onerror = () => reject(req.error);
            });
        }

        function clearIDBStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).clear();
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function getStorageUsage() {
            try { if (navigator.storage?.estimate) { const est = await navigator.storage.estimate(); return { used: est.usage || 0, quota: est.quota || 0, percent: est.quota ? (est.usage / est.quota * 100) : 0 }; } } catch (e) {}
            return { used: 0, quota: 0, percent: 0 };
        }

        const App = {
            characters: [], worldbooks: [], currentCharId: null, currentWbId: null,
            currentEntryIndex: -1, pendingDeleteType: null, pendingDeleteId: null, models: [],
            connectionStatus: 'disconnected', isSelectMode: false, selectedMsgs: new Set(),
            lastAIStart: -1, tempWallpaper: null, tempIcons: {},
            appIcons: { settings: null, messages: null, worldbook: null, photos: null },
            settings: {
                apiBaseUrl: '', apiKey: '', modelName: '',
                temperature: 0.7, maxTokens: 2048, maxContextMessages: 200,
                wallpaper: 'gradient1', wallpaperData: null, hideStatusBar: false,
                currentFont: 'default'
            },
            globalCssPresets: [],
            apiPresets: [],
            customFonts: [],
            dataLoaded: false,
            currentQuote: null,
            contextMenuMsgId: null,
            longPressTimer: null,
            editingMsgId: null,
            pendingDeleteFontId: null
        };

        const GRADIENTS = {
            gradient1: 'linear-gradient(180deg, #0a0a0f 0%, #0d0d15 50%, #0a0a0f 100%)',
            gradient2: 'linear-gradient(135deg, #1a1520, #0d1a1a)',
            gradient3: 'linear-gradient(135deg, #0d0d18, #1a1a2e, #0d0d18)',
            gradient4: 'linear-gradient(135deg, #0f1318, #1a2030)',
            gradient5: 'linear-gradient(135deg, #121212, #1a1a1a)',
            gradient6: 'linear-gradient(135deg, #0f0f15, #252030)'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadData();
                updateTime();
                setInterval(updateTime, 60000);
                applyWallpaper();
                applyAppIcons();
                applyStatusBarVisibility();
                updateConnectionUI();
                highlightWallpaper();
                updateWallpaperPreview();
                updateIconPreviews();
                updateStorageDisplay();
                updateApiPresetSelect();
                renderFontLists();
                applyFont();
            } catch (e) { console.error('Init failed:', e); showToast('Initialization failed', 'error'); }
        });

        async function updateStorageDisplay() {
            const usage = await getStorageUsage();
            const usedMB = (usage.used / (1024 * 1024)).toFixed(2);
            document.getElementById('storageSize').textContent = `${usedMB} MB`;
            document.getElementById('storageUsed').textContent = `Used: ${usedMB} MB`;
            document.getElementById('storageTotal').textContent = usage.quota > 0 ? `Quota: ${(usage.quota / (1024 * 1024)).toFixed(0)} MB` : 'Unlimited';
            const barFill = document.getElementById('storageBarFill');
            barFill.style.width = `${Math.min(usage.percent, 100)}%`;
            barFill.className = 'storage-bar-fill' + (usage.percent > 80 ? ' danger' : usage.percent > 60 ? ' warning' : '');
        }

        function updateTime() {
            document.getElementById('statusBarTime').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function toggleStatusBar() {
            App.settings.hideStatusBar = !App.settings.hideStatusBar;
            applyStatusBarVisibility();
            saveData();
        }

        function applyStatusBarVisibility() {
            const statusBar = document.getElementById('statusBar');
            const homeScreen = document.getElementById('homeScreen');
            const toggle = document.getElementById('hideStatusBarToggle');
            if (App.settings.hideStatusBar) {
                statusBar.classList.add('hidden');
                homeScreen.classList.add('no-statusbar');
                toggle?.classList.add('active');
            } else {
                statusBar.classList.remove('hidden');
                homeScreen.classList.remove('no-statusbar');
                toggle?.classList.remove('active');
            }
        }

        async function saveData() {
            try {
                await Promise.all([
                    saveToIDB('appData', 'characters', App.characters),
                    saveToIDB('appData', 'worldbooks', App.worldbooks),
                    saveToIDB('appData', 'settings', App.settings),
                    saveToIDB('appData', 'appIcons', App.appIcons),
                    saveToIDB('appData', 'globalCssPresets', App.globalCssPresets),
                    saveToIDB('appData', 'apiPresets', App.apiPresets),
                    saveToIDB('appData', 'customFonts', App.customFonts)
                ]);
                return true;
            } catch (e) { console.error('Save failed:', e); return false; }
        }

        async function loadData() {
            try {
                const [characters, worldbooks, settings, icons, presets, apiPresets, customFonts] = await Promise.all([
                    loadFromIDB('appData', 'characters'),
                    loadFromIDB('appData', 'worldbooks'),
                    loadFromIDB('appData', 'settings'),
                    loadFromIDB('appData', 'appIcons'),
                    loadFromIDB('appData', 'globalCssPresets'),
                    loadFromIDB('appData', 'apiPresets'),
                    loadFromIDB('appData', 'customFonts')
                ]);
                if (characters) App.characters = characters;
                if (worldbooks) App.worldbooks = worldbooks;
                if (settings) App.settings = { ...App.settings, ...settings };
                if (icons) App.appIcons = { ...App.appIcons, ...icons };
                if (presets) App.globalCssPresets = presets;
                if (apiPresets) App.apiPresets = apiPresets;
                if (customFonts) App.customFonts = customFonts;
                App.worldbooks.forEach(wb => { if (!wb.entries) wb.entries = [{ name: 'Default Entry', keywords: wb.keywords || '', content: wb.content || '', alwaysActive: wb.alwaysActive || false }]; });
                App.characters.forEach(c => { if (c.worldbookId && !c.worldbookIds) c.worldbookIds = [c.worldbookId]; if (!c.worldbookIds) c.worldbookIds = []; });
                loadSettingsUI();
                if (App.settings.apiBaseUrl && App.settings.apiKey && App.settings.modelName) App.connectionStatus = 'connected';
                App.dataLoaded = true;
                return true;
            } catch (e) { console.error('Load failed:', e); return false; }
        }

        async function forceSaveAll() { if (await saveData()) { await updateStorageDisplay(); showToast('Saved', 'success'); } }

        async function clearImageCache() {
            if (!confirm('Clear image cache?')) return;
            App.settings.wallpaperData = null; App.settings.wallpaper = 'gradient1';
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null };
            App.characters.forEach(c => { c.avatarImage = null; c.userAvatar = null; c.chatWallpaper = null; c.messages.forEach(m => { if (m.image) m.image = null; }); });
            await saveData(); applyWallpaper(); applyAppIcons(); updateIconPreviews(); await updateStorageDisplay();
            showToast('Cleared', 'success');
        }

        async function clearMessageCache() {
            if (!confirm('Clear messages?')) return;
            App.characters.forEach(c => { c.messages = []; });
            await saveData(); await updateStorageDisplay(); showToast('Cleared', 'success');
        }

        async function compactDatabase() {
            showToast('Optimizing...', 'info');
            for (let c of App.characters) {
                if (c.avatarImage?.length > 50000) c.avatarImage = await compressImage(c.avatarImage, 150, 0.7);
                if (c.userAvatar?.length > 50000) c.userAvatar = await compressImage(c.userAvatar, 150, 0.7);
                if (c.chatWallpaper?.length > 300000) c.chatWallpaper = await compressImage(c.chatWallpaper, 500, 0.7);
                for (let m of c.messages) { if (m.image?.length > 200000) m.image = await compressImage(m.image, 400, 0.7); }
            }
            if (App.settings.wallpaperData?.length > 500000) App.settings.wallpaperData = await compressImage(App.settings.wallpaperData, 600, 0.7);
            for (let k of Object.keys(App.appIcons)) { if (App.appIcons[k]?.length > 30000) App.appIcons[k] = await compressImage(App.appIcons[k], 100, 0.7); }
            await saveData(); await updateStorageDisplay(); showToast('Done', 'success');
        }

        function compressImage(dataUrl, maxWidth = 400, quality = 0.7) {
            return new Promise((resolve) => {
                if (!dataUrl?.startsWith('data:image')) { resolve(dataUrl); return; }
                const img = new Image();
                img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality)); };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        window.addEventListener('beforeunload', () => { saveData(); });
        setInterval(() => { if (App.dataLoaded) saveData(); }, 30000);

        function loadSettingsUI() {
            document.getElementById('apiBaseUrl').value = App.settings.apiBaseUrl || '';
            document.getElementById('apiKey').value = App.settings.apiKey || '';
            document.getElementById('modelName').value = App.settings.modelName || '';
            document.getElementById('maxContextMessages').value = App.settings.maxContextMessages || 200;
            document.getElementById('temperature').value = App.settings.temperature;
            document.getElementById('tempValue').textContent = App.settings.temperature;
            document.getElementById('maxTokens').value = App.settings.maxTokens;
            document.getElementById('maxTokensValue').textContent = App.settings.maxTokens;
        }

        // API Presets
        function updateApiPresetSelect() {
            const select = document.getElementById('apiPresetSelect');
            select.innerHTML = '<option value="">-- No Preset --</option>' +
                App.apiPresets.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
        }

        function loadApiPreset() {
            const presetId = document.getElementById('apiPresetSelect').value;
            if (!presetId) return;
            const preset = App.apiPresets.find(p => p.id === presetId);
            if (preset) {
                document.getElementById('apiBaseUrl').value = preset.apiBaseUrl || '';
                document.getElementById('apiKey').value = preset.apiKey || '';
                document.getElementById('modelName').value = preset.modelName || '';
                showToast('Preset loaded', 'success');
            }
        }

        function addNewApiPreset() {
            showModal('apiPresetNameModal');
            document.getElementById('newApiPresetName').value = '';
        }

        async function createApiPreset() {
            const name = document.getElementById('newApiPresetName').value.trim();
            if (!name) { showToast('Enter a name', 'error'); return; }
            const preset = {
                id: Date.now().toString(),
                name,
                apiBaseUrl: document.getElementById('apiBaseUrl').value.trim(),
                apiKey: document.getElementById('apiKey').value.trim(),
                modelName: document.getElementById('modelName').value.trim()
            };
            App.apiPresets.push(preset);
            await saveData();
            hideModal('apiPresetNameModal');
            updateApiPresetSelect();
            document.getElementById('apiPresetSelect').value = preset.id;
            showToast(`Preset "${name}" created`, 'success');
        }

        async function updateApiPreset() {
            const presetId = document.getElementById('apiPresetSelect').value;
            if (!presetId) { showToast('Select a preset first', 'warning'); return; }
            const preset = App.apiPresets.find(p => p.id === presetId);
            if (!preset) return;
            preset.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            preset.apiKey = document.getElementById('apiKey').value.trim();
            preset.modelName = document.getElementById('modelName').value.trim();
            await saveData();
            showToast(`Preset "${preset.name}" updated`, 'success');
        }

        function deleteApiPreset() {
            const presetId = document.getElementById('apiPresetSelect').value;
            if (!presetId) { showToast('Select a preset first', 'warning'); return; }
            App.pendingDeleteId = presetId;
            showModal('deleteApiPresetModal');
        }

        async function confirmDeleteApiPreset() {
            App.apiPresets = App.apiPresets.filter(p => p.id !== App.pendingDeleteId);
            await saveData();
            hideModal('deleteApiPresetModal');
            updateApiPresetSelect();
            showToast('Preset deleted', 'success');
        }

        // Font Management
        function renderFontLists() {
            // Preset fonts
            const presetList = document.getElementById('presetFontList');
            presetList.innerHTML = PRESET_FONTS.map(font => {
                const isSelected = App.settings.currentFont === font.id;
                return `<div class="font-item ${isSelected ? 'selected' : ''}" onclick="selectFont('${font.id}', 'preset')">
                    <div class="font-item-info">
                        <div class="font-item-name">${escapeHtml(font.name)}</div>
                        <div class="font-item-preview" style="font-family: ${font.fontFamily || 'inherit'}">${font.preview}</div>
                    </div>
                </div>`;
            }).join('');

            // Custom fonts
            const customList = document.getElementById('customFontList');
            if (App.customFonts.length === 0) {
                customList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">No custom fonts added</div>';
            } else {
                customList.innerHTML = App.customFonts.map(font => {
                    const isSelected = App.settings.currentFont === font.id;
                    return `<div class="font-item ${isSelected ? 'selected' : ''}" onclick="selectFont('${font.id}', 'custom')">
                        <div class="font-item-info">
                            <div class="font-item-name">${escapeHtml(font.name)}</div>
                            <div class="font-item-preview" style="font-family: '${font.name}', sans-serif">Preview Text 预览文字</div>
                        </div>
                        <div class="font-item-actions">
                            <button class="font-item-btn danger" onclick="event.stopPropagation(); promptDeleteFont('${font.id}')">🗑</button>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        async function selectFont(fontId, type) {
            App.settings.currentFont = fontId;
            await saveData();
            applyFont();
            renderFontLists();
            showToast('Font applied', 'success');
        }

        function applyFont() {
            const fontId = App.settings.currentFont || 'default';
            const styleEl = document.getElementById('fontPreloadStyles');

            // Check preset fonts
            const presetFont = PRESET_FONTS.find(f => f.id === fontId);
            if (presetFont) {
                if (fontId === 'default') {
                    document.documentElement.style.setProperty('--custom-font', 'var(--font-body)');
                    styleEl.textContent = '';
                } else if (presetFont.isGoogle) {
                    styleEl.textContent = `@import url('${presetFont.url}');`;
                    const fontFamily = presetFont.fontFamily || `"${presetFont.name.replace('ZCOOL ', '').replace(' SC', '')}", sans-serif`;
                    document.documentElement.style.setProperty('--custom-font', fontFamily);
                } else {
                    styleEl.textContent = `@import url('${presetFont.url}');`;
                    document.documentElement.style.setProperty('--custom-font', presetFont.fontFamily || `"${presetFont.name}", sans-serif`);
                }
                return;
            }

            // Check custom fonts
            const customFont = App.customFonts.find(f => f.id === fontId);
            if (customFont) {
                const ext = customFont.url.split('.').pop().toLowerCase();
                let format = 'truetype';
                if (ext === 'otf') format = 'opentype';
                else if (ext === 'woff') format = 'woff';
                else if (ext === 'woff2') format = 'woff2';

                styleEl.textContent = `@font-face { font-family: '${customFont.name}'; src: url('${customFont.url}') format('${format}'); font-display: swap; }`;
                document.documentElement.style.setProperty('--custom-font', `'${customFont.name}', sans-serif`);
            }
        }

        async function addCustomFont() {
            const name = document.getElementById('newFontName').value.trim();
            const url = document.getElementById('newFontUrl').value.trim();

            if (!name) { showToast('Enter font name', 'error'); return; }
            if (!url) { showToast('Enter font URL', 'error'); return; }

            // Validate URL extension
            const ext = url.split('.').pop().toLowerCase().split('?')[0];
            const validExts = ['ttf', 'otf', 'woff', 'woff2'];
            if (!validExts.includes(ext) && !url.includes('fonts.googleapis.com')) {
                showToast('Invalid font format. Use .ttf, .otf, .woff, or .woff2', 'error');
                return;
            }

            const font = {
                id: Date.now().toString(),
                name,
                url
            };

            App.customFonts.push(font);
            await saveData();

            document.getElementById('newFontName').value = '';
            document.getElementById('newFontUrl').value = '';

            renderFontLists();
            showToast(`Font "${name}" added`, 'success');
        }

        function promptDeleteFont(fontId) {
            App.pendingDeleteFontId = fontId;
            showModal('deleteFontModal');
        }

        async function confirmDeleteFont() {
            const fontId = App.pendingDeleteFontId;
            App.customFonts = App.customFonts.filter(f => f.id !== fontId);

            // Reset to default if deleted font was active
            if (App.settings.currentFont === fontId) {
                App.settings.currentFont = 'default';
                applyFont();
            }

            await saveData();
            hideModal('deleteFontModal');
            renderFontLists();
            showToast('Font deleted', 'success');
        }

        function applyWallpaper() {
            const el = document.getElementById('wallpaperLayer');
            const wp = App.settings.wallpaper, wpData = App.settings.wallpaperData;
            el.style.cssText = '';
            if (wpData) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background-image:url(${wpData})!important;background-size:cover!important;background-position:center!important;`;
            else if (wp?.startsWith('http')) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background-image:url(${wp})!important;background-size:cover!important;background-position:center!important;`;
            else if (GRADIENTS[wp]) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background:${GRADIENTS[wp]}!important;`;
            else el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background:${GRADIENTS.gradient1}!important;`;
        }

        function updateWallpaperPreview() {
            const preview = document.getElementById('wallpaperPreview');
            const wp = App.tempWallpaper || App.settings.wallpaper;
            if (App.tempWallpaper?.startsWith('data:')) preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            else if (!App.tempWallpaper && App.settings.wallpaperData) preview.style.cssText = `background-image:url(${App.settings.wallpaperData})!important;background-size:cover!important;background-position:center!important;`;
            else if (App.tempWallpaper?.startsWith('http')) preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            else if (GRADIENTS[wp]) preview.style.cssText = `background:${GRADIENTS[wp]}!important;`;
            else preview.style.cssText = `background:${GRADIENTS.gradient1}!important;`;
        }

        function selectPresetWallpaper(name) { App.tempWallpaper = name; highlightWallpaper(); updateWallpaperPreview(); showToast('Click save to apply', 'info'); }
        function previewUrlWallpaper() { const url = document.getElementById('customWallpaperUrl').value.trim(); if (!url) { showToast('Enter URL', 'error'); return; } App.tempWallpaper = url; updateWallpaperPreview(); showToast('Click save to apply', 'info'); }

        async function handleWallpaperUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => { App.tempWallpaper = await compressImage(ev.target.result, 800, 0.8); updateWallpaperPreview(); showToast('Click save to apply', 'success'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function saveWallpaper() {
            if (!App.tempWallpaper) { showToast('Select wallpaper first', 'warning'); return; }
            if (App.tempWallpaper.startsWith('data:')) { App.settings.wallpaperData = App.tempWallpaper; App.settings.wallpaper = 'custom'; }
            else if (App.tempWallpaper.startsWith('http')) { App.settings.wallpaper = App.tempWallpaper; App.settings.wallpaperData = null; }
            else { App.settings.wallpaper = App.tempWallpaper; App.settings.wallpaperData = null; }
            App.tempWallpaper = null;
            if (await saveData()) { applyWallpaper(); highlightWallpaper(); updateWallpaperPreview(); await updateStorageDisplay(); showToast('Saved', 'success'); }
        }

        function highlightWallpaper() {
            const current = App.tempWallpaper || App.settings.wallpaper;
            document.querySelectorAll('#wallpaperGrid > div').forEach(el => { el.style.borderColor = el.dataset.wp === current ? 'var(--accent-gold)' : 'transparent'; });
        }

        function updateIconPreviews() {
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => {
                const preview = document.getElementById('iconPreview' + app.charAt(0).toUpperCase() + app.slice(1));
                const iconData = App.tempIcons[app] || App.appIcons[app];
                if (iconData) { preview.innerHTML = `<img src="${iconData}">`; preview.classList.add('has-image'); }
                else { preview.classList.remove('has-image'); }
            });
        }

        function applyAppIcons() {
            const defaultSvgs = {
                settings: '<svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>',
                messages: '<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/><path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>',
                worldbook: '<svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>',
                photos: '<svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>'
            };
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => {
                const el = document.getElementById('appIcon' + app.charAt(0).toUpperCase() + app.slice(1));
                const iconData = App.appIcons[app];
                el.innerHTML = iconData ? `<img src="${iconData}" style="width:100%;height:100%;object-fit:cover;">` : defaultSvgs[app];
            });
        }

        async function handleIconUpload(e, appName) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => { App.tempIcons[appName] = await compressImage(ev.target.result, 120, 0.8); updateIconPreviews(); showToast('Click save to apply', 'info'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function saveIcons() {
            let changed = false;
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => { if (App.tempIcons[app]) { App.appIcons[app] = App.tempIcons[app]; changed = true; } });
            App.tempIcons = {};
            if (changed && await saveData()) { applyAppIcons(); await updateStorageDisplay(); showToast('Saved', 'success'); }
            else if (!changed) showToast('No changes', 'info');
        }

        async function resetIcons() { App.appIcons = { settings: null, messages: null, worldbook: null, photos: null }; App.tempIcons = {}; await saveData(); applyAppIcons(); updateIconPreviews(); showToast('Reset', 'success'); }

        function openPage(id) {
            const page = document.getElementById(id);
            if (page) {
                page.classList.add('active');
                if (id === 'messagesPage') renderContacts();
                if (id === 'worldbookPage') renderWorldbooks();
                if (id === 'wallpaperPage') { updateWallpaperPreview(); updateIconPreviews(); highlightWallpaper(); applyStatusBarVisibility(); }
                if (id === 'settingsPage') { updateStorageDisplay(); updateApiPresetSelect(); }
                if (id === 'fontPage') renderFontLists();
            }
        }

        function closePage(id) { document.getElementById(id)?.classList.remove('active'); }
        function showModal(id) { document.getElementById(id)?.classList.add('active'); }
        function hideModal(id) { document.getElementById(id)?.classList.remove('active'); }
        function showToast(msg, type='info') { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); }

        function addLog(msg, type='info') { const c = document.getElementById('debugLog'); const e = document.createElement('div'); e.className = `log-entry ${type}`; e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; c.appendChild(e); c.scrollTop = c.scrollHeight; }
        function updateConnectionUI() { const h = document.getElementById('connectionStatusHint'); if (App.connectionStatus === 'connected') { h.className = 'action-hint success'; h.innerHTML = `<span class="action-hint-icon">✓</span><span class="action-hint-text">Connected - ${App.settings.modelName}</span>`; } else { h.className = 'action-hint'; h.innerHTML = `<span class="action-hint-icon">⚠</span><span class="action-hint-text">API not configured</span>`; } }

        async function fetchModels() {
            const url = document.getElementById('apiBaseUrl').value.trim(), key = document.getElementById('apiKey').value.trim();
            if (!url || !key) { showToast('Fill in URL and Key', 'error'); return; }
            const btn = document.getElementById('fetchModelsBtn'); btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>';
            try {
                const r = await fetch(`${url.replace(/\/+$/,'').replace(/\/v1$/,'')}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const d = await r.json(), models = d.data || d.models || d || [];
                App.models = models;
                document.getElementById('modelListContainer').style.display = 'block';
                document.getElementById('modelList').innerHTML = models.map(m => { const id = m.id || m.name || m; return `<div class="model-item" onclick="selectModel('${id}')"><span class="model-item-name">${id}</span></div>`; }).join('');
                addLog(`Found ${models.length} models`, 'success');
            } catch(e) { addLog(`Failed: ${e.message}`, 'error'); showToast(`Failed: ${e.message}`, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = 'Fetch Models'; }
        }

        function selectModel(id) { App.settings.modelName = id; document.getElementById('modelName').value = id; document.querySelectorAll('.model-item').forEach(el => { el.classList.toggle('selected', el.querySelector('.model-item-name').textContent === id); }); showToast(`Selected: ${id}`, 'success'); }

        async function testConnection() {
            const url = document.getElementById('apiBaseUrl').value.trim(), key = document.getElementById('apiKey').value.trim(), model = document.getElementById('modelName').value.trim();
            if (!url || !key || !model) { showToast('Fill all fields', 'error'); return; }
            const btn = document.getElementById('testConnectionBtn'); btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>';
            try {
                const r = await fetch(`${url.replace(/\/+$/,'').replace(/\/v1$/,'')}/v1/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 }) });
                if (r.ok) { App.connectionStatus = 'connected'; App.settings.apiBaseUrl = url; App.settings.apiKey = key; App.settings.modelName = model; await saveData(); showToast('Success!', 'success'); addLog('Connected', 'success'); }
                else throw new Error(`HTTP ${r.status}`);
            } catch(e) { App.connectionStatus = 'disconnected'; showToast(`Failed: ${e.message}`, 'error'); }
            finally { updateConnectionUI(); btn.disabled = false; btn.innerHTML = 'Test Connection'; }
        }

        async function saveApiSettings() {
            App.settings.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            App.settings.apiKey = document.getElementById('apiKey').value.trim();
            App.settings.modelName = document.getElementById('modelName').value.trim();
            App.settings.temperature = parseFloat(document.getElementById('temperature').value);
            App.settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            App.settings.maxContextMessages = parseInt(document.getElementById('maxContextMessages').value) || 200;
            await saveData(); showToast('Saved', 'success');
        }

        async function createCharacter() {
            const name = document.getElementById('newCharacterName').value.trim(); if (!name) { showToast('Enter name', 'error'); return; }
            const char = {
                id: Date.now().toString(), name,
                avatar: ['😊','😎','🥰','🦊','🐱','🐰'][Math.floor(Math.random()*6)],
                avatarImage: null, userAvatar: null, showAvatar: true, avatarShape: 'circle',
                showBorder: false, borderColor: '#c9a962', borderWidth: 2,
                description: '', greeting: '', scenario: '', worldbookIds: [],
                userNick: '', systemPrompt: '', messages: [],
                chatWallpaper: null, customCss: '', activeCssPresetId: null, timestampPosition: 'default'
            };
            App.characters.push(char); await saveData(); hideModal('createCharacterModal'); document.getElementById('newCharacterName').value = ''; renderContacts(); showToast(`"${name}" created`, 'success');
        }

        function renderContacts() {
            const list = document.getElementById('contactList'), empty = document.getElementById('emptyContactState');
            if (App.characters.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; }
            list.style.display = 'flex'; empty.style.display = 'none';
            list.innerHTML = App.characters.map(c => {
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content.substring(0,25)+'...' : 'Start conversation';
                const lastTime = c.messages.length > 0 ? formatTime(c.messages[c.messages.length-1].timestamp) : '';
                const avatarHtml = c.avatarImage ? `<img src="${c.avatarImage}">` : (c.avatar || c.name[0]);
                return `<div class="contact-item" onclick="openChat('${c.id}')"><div class="contact-avatar">${avatarHtml}</div><div class="contact-info"><div class="contact-name">${escapeHtml(c.name)}</div><div class="contact-preview">${escapeHtml(lastMsg)}</div></div><div class="contact-time">${lastTime}</div></div>`;
            }).join('');
        }

        function filterContacts() { const q = document.getElementById('contactSearch').value.toLowerCase(); document.querySelectorAll('.contact-item').forEach(el => { el.style.display = el.querySelector('.contact-name').textContent.toLowerCase().includes(q) ? 'flex' : 'none'; }); }

        function openChat(id) {
            const char = App.characters.find(c => c.id === id); if (!char) return;
            App.currentCharId = id; App.isSelectMode = false; App.selectedMsgs.clear(); App.lastAIStart = -1;
            App.currentQuote = null;
            document.getElementById('quotePreviewBar').classList.remove('active');
            document.getElementById('chatTitle').textContent = char.name;
            document.getElementById('selectModeBar').classList.remove('active');
            document.getElementById('chatMessages').classList.remove('select-mode');
            applyChatWallpaper(char);
            applyCustomCss(char);
            renderMessages(); openPage('chatPage');
            if (char.messages.length === 0 && char.greeting) addMessage(char.greeting, 'received');
        }

        function applyChatWallpaper(char) {
            const chatPage = document.getElementById('chatPage');
            if (char.chatWallpaper) { chatPage.classList.add('has-custom-bg'); chatPage.style.backgroundImage = `url(${char.chatWallpaper})`; }
            else { chatPage.classList.remove('has-custom-bg'); chatPage.style.backgroundImage = ''; }
        }

        function applyCustomCss(char) {
            const styleEl = document.getElementById('customCssStyles');
            let css = '';
            if (char.activeCssPresetId) { const preset = App.globalCssPresets.find(p => p.id === char.activeCssPresetId); if (preset) css = preset.css; }
            if (char.customCss) css = char.customCss;
            styleEl.textContent = css;
        }

        function closeChatPage() {
            exitSelectMode(); closePage('chatPage');
            document.getElementById('customCssStyles').textContent = '';
            const chatPage = document.getElementById('chatPage');
            chatPage.classList.remove('has-custom-bg'); chatPage.style.backgroundImage = '';
            App.currentCharId = null; App.currentQuote = null;
        }

        function openCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            updateChatWallpaperPreview(char);
            const charAvUpload = document.getElementById('charAvatarUpload'), userAvUpload = document.getElementById('userAvatarUpload');
            if (char.avatarImage) { charAvUpload.innerHTML = `<img src="${char.avatarImage}">`; charAvUpload.classList.add('has-image'); } else { charAvUpload.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'; charAvUpload.classList.remove('has-image'); }
            charAvUpload.dataset.image = char.avatarImage || '';
            if (char.userAvatar) { userAvUpload.innerHTML = `<img src="${char.userAvatar}">`; userAvUpload.classList.add('has-image'); } else { userAvUpload.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'; userAvUpload.classList.remove('has-image'); }
            userAvUpload.dataset.image = char.userAvatar || '';
            document.getElementById('showAvatarToggle').classList.toggle('active', char.showAvatar !== false);
            document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(el => { el.classList.toggle('selected', el.dataset.shape === (char.avatarShape || 'circle')); });
            document.getElementById('showBorderToggle').classList.toggle('active', char.showBorder === true);
            document.getElementById('borderColorPicker').value = char.borderColor || '#c9a962';
            document.getElementById('charName').value = char.name;
            document.getElementById('charAvatar').value = char.avatar || '';
            document.getElementById('charDescription').value = char.description || '';
            document.getElementById('charGreeting').value = char.greeting || '';
            document.getElementById('charScenario').value = char.scenario || '';
            document.getElementById('charUserNick').value = char.userNick || '';
            document.getElementById('charSystemPrompt').value = char.systemPrompt || '';
            document.getElementById('timestampPosition').value = char.timestampPosition || 'default';
            document.getElementById('customCssEditor').value = char.customCss || '';
            updateCssPresetSelect(char);
            updateWorldbookMultiSelect(char);
            updateCharCounter();
            openPage('characterSettingsPage');
        }

        function updateChatWallpaperPreview(char) {
            const preview = document.getElementById('chatWallpaperPreview');
            if (char.chatWallpaper) { preview.style.backgroundImage = `url(${char.chatWallpaper})`; preview.classList.add('has-image'); }
            else { preview.style.backgroundImage = ''; preview.classList.remove('has-image'); }
        }

        function updateCssPresetSelect(char) {
            const select = document.getElementById('cssPresetSelect');
            select.innerHTML = '<option value="">-- No Preset --</option>' + App.globalCssPresets.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            select.value = char.activeCssPresetId || '';
        }

        function updateWorldbookMultiSelect(char) {
            const container = document.getElementById('worldbookMultiSelect');
            if (App.worldbooks.length === 0) { container.innerHTML = '<div style="padding:14px;color:var(--text-muted);font-size:13px">No lorebooks available</div>'; return; }
            container.innerHTML = App.worldbooks.map(wb => {
                const checked = (char.worldbookIds || []).includes(wb.id);
                return `<div class="worldbook-multi-item" onclick="toggleWorldbookBinding('${wb.id}')"><div class="worldbook-multi-checkbox ${checked ? 'checked' : ''}"></div><span class="worldbook-multi-name">${escapeHtml(wb.name)}</span></div>`;
            }).join('');
        }

        function toggleWorldbookBinding(wbId) {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (!char.worldbookIds) char.worldbookIds = [];
            const idx = char.worldbookIds.indexOf(wbId);
            if (idx >= 0) char.worldbookIds.splice(idx, 1);
            else char.worldbookIds.push(wbId);
            updateWorldbookMultiSelect(char);
        }

        function closeCharacterSettings() { closePage('characterSettingsPage'); }

        async function handleCharAvatarUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async ev => { const compressed = await compressImage(ev.target.result, 200, 0.8); const upload = document.getElementById('charAvatarUpload'); upload.innerHTML = `<img src="${compressed}">`; upload.classList.add('has-image'); upload.dataset.image = compressed; }; reader.readAsDataURL(file); e.target.value = ''; }
        async function handleUserAvatarUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async ev => { const compressed = await compressImage(ev.target.result, 200, 0.8); const upload = document.getElementById('userAvatarUpload'); upload.innerHTML = `<img src="${compressed}">`; upload.classList.add('has-image'); upload.dataset.image = compressed; }; reader.readAsDataURL(file); e.target.value = ''; }
        function selectShape(el) { document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); }

        async function handleChatWallpaperUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const reader = new FileReader();
            reader.onload = async ev => { char.chatWallpaper = await compressImage(ev.target.result, 600, 0.8); updateChatWallpaperPreview(char); showToast('Set, save to apply', 'success'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        function clearChatWallpaper() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            char.chatWallpaper = null; updateChatWallpaperPreview(char); showToast('Cleared, save to apply', 'info');
        }

        function confirmClearAllMessages() { showModal('clearMessagesModal'); }

        async function executeClearAllMessages() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            char.messages = []; await saveData(); hideModal('clearMessagesModal'); renderMessages(); showToast('Messages cleared', 'success');
        }

        function loadCssPreset() { const presetId = document.getElementById('cssPresetSelect').value; if (!presetId) { document.getElementById('customCssEditor').value = ''; return; } const preset = App.globalCssPresets.find(p => p.id === presetId); if (preset) document.getElementById('customCssEditor').value = preset.css; }
        function addNewCssPreset() { showModal('cssPresetNameModal'); document.getElementById('newCssPresetName').value = ''; }

        async function createCssPreset() {
            const name = document.getElementById('newCssPresetName').value.trim(); if (!name) { showToast('Enter name', 'error'); return; }
            const css = document.getElementById('customCssEditor').value;
            const preset = { id: Date.now().toString(), name, css };
            App.globalCssPresets.push(preset); await saveData(); hideModal('cssPresetNameModal');
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (char) { updateCssPresetSelect(char); document.getElementById('cssPresetSelect').value = preset.id; }
            showToast(`Preset "${name}" created`, 'success');
        }

        async function saveCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value; if (!presetId) { showToast('Select or create preset first', 'warning'); return; }
            const preset = App.globalCssPresets.find(p => p.id === presetId); if (!preset) return;
            preset.css = document.getElementById('customCssEditor').value; await saveData(); showToast(`Preset "${preset.name}" updated`, 'success');
        }

        function deleteCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value;
            if (!presetId) { showToast('Select a preset first', 'warning'); return; }
            App.pendingDeleteId = presetId;
            showModal('deleteCssPresetModal');
        }

        async function confirmDeleteCssPreset() {
            App.globalCssPresets = App.globalCssPresets.filter(p => p.id !== App.pendingDeleteId);
            // Clear from any characters using this preset
            App.characters.forEach(c => { if (c.activeCssPresetId === App.pendingDeleteId) c.activeCssPresetId = null; });
            await saveData();
            hideModal('deleteCssPresetModal');
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (char) updateCssPresetSelect(char);
            document.getElementById('cssPresetSelect').value = '';
            showToast('Preset deleted', 'success');
        }

        function showCssGuide() { showModal('cssGuideModal'); }
        function previewCss() { document.getElementById('customCssStyles').textContent = document.getElementById('customCssEditor').value; showToast('CSS previewed', 'info'); }
        function clearCustomCss() { document.getElementById('customCssEditor').value = ''; document.getElementById('cssPresetSelect').value = ''; document.getElementById('customCssStyles').textContent = ''; showToast('CSS cleared', 'info'); }

        async function saveCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const greeting = document.getElementById('charGreeting').value; if (greeting.length > 300) { showToast('Greeting too long', 'error'); return; }
            char.avatarImage = document.getElementById('charAvatarUpload').dataset.image || null;
            char.userAvatar = document.getElementById('userAvatarUpload').dataset.image || null;
            char.showAvatar = document.getElementById('showAvatarToggle').classList.contains('active');
            const shapeEl = document.querySelector('#avatarShapeOptions .shape-option.selected');
            char.avatarShape = shapeEl ? shapeEl.dataset.shape : 'circle';
            char.showBorder = document.getElementById('showBorderToggle').classList.contains('active');
            char.borderColor = document.getElementById('borderColorPicker').value;
            char.name = document.getElementById('charName').value.trim() || char.name;
            char.avatar = document.getElementById('charAvatar').value.trim() || char.avatar;
            char.description = document.getElementById('charDescription').value;
            char.greeting = greeting;
            char.scenario = document.getElementById('charScenario').value;
            char.userNick = document.getElementById('charUserNick').value.trim();
            char.systemPrompt = document.getElementById('charSystemPrompt').value;
            char.timestampPosition = document.getElementById('timestampPosition').value;
            char.customCss = document.getElementById('customCssEditor').value;
            char.activeCssPresetId = document.getElementById('cssPresetSelect').value || null;
            document.getElementById('chatTitle').textContent = char.name;
            await saveData(); applyChatWallpaper(char); applyCustomCss(char); renderMessages(); closeCharacterSettings(); showToast('Saved', 'success');
        }

        function updateCharCounter() { const ta = document.getElementById('charGreeting'), counter = document.getElementById('greetingCharCounter'); counter.textContent = `${ta.value.length}/300`; counter.className = 'char-counter' + (ta.value.length >= 280 ? ' warning' : '') + (ta.value.length >= 300 ? ' error' : ''); }
        function deleteCurrentCharacter() { const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; App.pendingDeleteType = 'character'; App.pendingDeleteId = char.id; document.getElementById('deleteModalTitle').textContent = `Delete "${char.name}"?`; showModal('confirmDeleteModal'); }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (char.messages.length === 0) { container.innerHTML = '<div class="date-separator"><span class="date-separator-text">TODAY</span></div>'; return; }
            const showAvatar = char.showAvatar !== false, avatarShape = char.avatarShape || 'circle', showBorder = char.showBorder === true, borderColor = char.borderColor || '#c9a962', borderWidth = char.borderWidth || 2;
            let shapeClass = avatarShape === 'square' ? 'square' : avatarShape === 'rounded-square' ? 'rounded-square' : '';
            const borderStyle = showBorder ? `border:${borderWidth}px solid ${borderColor};` : '';
            const timestampPos = char.timestampPosition || 'default';
            let timeClass = timestampPos === 'hidden' ? 'time-hidden' : timestampPos === 'side' ? 'time-side' : '';
            let html = '', lastDate = null;
            char.messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString();
                if (msgDate !== lastDate) { html += `<div class="date-separator"><span class="date-separator-text">${formatDate(msg.timestamp)}</span></div>`; lastDate = msgDate; }
                const type = msg.role === 'user' ? 'sent' : 'received', checked = App.selectedMsgs.has(msg.id) ? 'checked' : '';
                let avatarHtml = '';
                if (showAvatar) { const avatarContent = type === 'received' ? (char.avatarImage ? `<img src="${char.avatarImage}">` : (char.avatar || char.name[0])) : (char.userAvatar ? `<img src="${char.userAvatar}">` : '👤'); avatarHtml = `<div class="message-avatar ${shapeClass}" style="${borderStyle}">${avatarContent}</div>`; }
                let quoteHtml = '';
                if (msg.quoteContent) { quoteHtml = `<div class="message-quote">${escapeHtml(msg.quoteContent)}</div>`; }
                let imageHtml = '';
                if (msg.image) { imageHtml = `<img src="${msg.image}" class="message-image" onclick="viewImage('${msg.id}')">`; }
                let displayContent = msg.content === '[Image]' && msg.image ? '' : msg.content;
                html += `<div class="message-wrapper ${type}" data-msg-id="${msg.id}" ontouchstart="startLongPress('${msg.id}')" ontouchend="endLongPress()" ontouchmove="endLongPress()" oncontextmenu="showContextMenuDirect(event,'${msg.id}')">
                    <div class="message-checkbox ${checked}" onclick="toggleMsgSelect('${msg.id}')"></div>
                    ${type === 'received' ? avatarHtml : ''}
                    <div class="message ${type}">
                        ${quoteHtml}
                        ${escapeHtml(displayContent)}
                        ${imageHtml}
                        <div class="message-time ${timeClass}">${formatTime(msg.timestamp)}</div>
                    </div>
                    ${type === 'sent' ? avatarHtml : ''}
                </div>`;
            });
            container.innerHTML = html;
            scrollToBottom();
        }

        function startLongPress(msgId) { App.longPressTimer = setTimeout(() => { showContextMenu(msgId); }, 500); }
        function endLongPress() { if (App.longPressTimer) { clearTimeout(App.longPressTimer); App.longPressTimer = null; } }
        function showContextMenu(msgId) { App.contextMenuMsgId = msgId; document.getElementById('contextMenuOverlay').classList.add('active'); }
        function showContextMenuDirect(e, msgId) { e.preventDefault(); showContextMenu(msgId); }
        function hideContextMenu() { document.getElementById('contextMenuOverlay').classList.remove('active'); App.contextMenuMsgId = null; }

        function copyMessageText() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId); if (!msg) return;
            navigator.clipboard.writeText(msg.content).then(() => showToast('Copied', 'success')).catch(() => showToast('Copy failed', 'error'));
            hideContextMenu();
        }

        function quoteMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId); if (!msg) return;
            App.currentQuote = { msgId: msg.id, content: msg.content.substring(0, 100) };
            document.getElementById('quotePreviewContent').textContent = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');
            document.getElementById('quotePreviewBar').classList.add('active');
            hideContextMenu();
            document.getElementById('chatInput').focus();
        }

        function cancelQuote() { App.currentQuote = null; document.getElementById('quotePreviewBar').classList.remove('active'); }

        function editMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId); if (!msg) return;
            App.editingMsgId = App.contextMenuMsgId;
            document.getElementById('editMessageContent').value = msg.content;
            hideContextMenu();
            showModal('editMessageModal');
        }

        async function saveEditedMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.editingMsgId);
            if (!msg) { showToast('Message not found', 'error'); hideModal('editMessageModal'); return; }
            msg.content = document.getElementById('editMessageContent').value;
            await saveData(); hideModal('editMessageModal'); App.editingMsgId = null; renderMessages(); showToast('Saved', 'success');
        }

        function viewImage(msgId) {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === msgId); if (msg?.image) window.open(msg.image, '_blank');
        }

        async function addMessage(content, type, imageData = null, quoteData = null) {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = {
                id: Date.now().toString() + Math.random().toString(36).substr(2,9),
                role: type === 'sent' ? 'user' : 'assistant',
                content, timestamp: new Date().toISOString(),
                image: imageData || null,
                quoteId: quoteData?.msgId || null,
                quoteContent: quoteData?.content || null
            };
            char.messages.push(msg); await saveData(); renderMessages();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput'), content = input.value.trim(); if (!content && !App.currentQuote) return;
            const quoteData = App.currentQuote ? { ...App.currentQuote } : null;
            addMessage(content || 'Reply', 'sent', null, quoteData);
            input.value = ''; autoResizeTextarea(input);
            cancelQuote();
        }

        function openImagePicker() { toggleExtensionPanel(); document.getElementById('chatImageInput').click(); }

        async function handleChatImageUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            if (file.size > 2 * 1024 * 1024 * 1024) { showToast('Image too large (>2GB)', 'error'); return; }
            const reader = new FileReader();
            reader.onload = async (ev) => { const compressed = await compressImage(ev.target.result, 800, 0.8); await addMessage('[Image]', 'sent', compressed); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function triggerAIReply() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (!App.settings.apiBaseUrl || !App.settings.apiKey || !App.settings.modelName) { showToast('Configure API first', 'error'); return; }
            App.lastAIStart = char.messages.length;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', '<div class="typing-indicator" id="typingIndicator"><span></span><span></span><span></span></div>');
            scrollToBottom();
            try {
                const max = App.settings.maxContextMessages || 200;
                const history = char.messages.slice(-max);
                const messages = buildAPIMessages(char, history);
                const url = App.settings.apiBaseUrl.replace(/\/+$/,'').replace(/\/v1$/,'');
                const hasImage = history.some(m => m.image);
                let body;
                if (hasImage) {
                    const mmMsgs = [messages[0]];
                    let msgIdx = 1, historyIdx = 0;
                    while (msgIdx < messages.length && historyIdx < history.length) {
                        const apiMsg = messages[msgIdx];
                        const role = apiMsg.role === 'user' ? 'user' : 'assistant';
                        const samRoleMsgs = [];
                        while (historyIdx < history.length && ((history[historyIdx].role === 'user' && role === 'user') || (history[historyIdx].role === 'assistant' && role === 'assistant'))) { samRoleMsgs.push(history[historyIdx]); historyIdx++; }
                        const hasImageInGroup = samRoleMsgs.some(m => m.image);
                        if (hasImageInGroup) {
                            const contentParts = [{ type: 'text', text: apiMsg.content }];
                            samRoleMsgs.forEach(m => { if (m.image) contentParts.push({ type: 'image_url', image_url: { url: m.image } }); });
                            mmMsgs.push({ role: apiMsg.role, content: contentParts });
                        } else { mmMsgs.push(apiMsg); }
                        msgIdx++;
                    }
                    while (msgIdx < messages.length) { mmMsgs.push(messages[msgIdx]); msgIdx++; }
                    body = JSON.stringify({ model: App.settings.modelName, messages: mmMsgs, temperature: App.settings.temperature, max_tokens: App.settings.maxTokens });
                } else {
                    body = JSON.stringify({ model: App.settings.modelName, messages, temperature: App.settings.temperature, max_tokens: App.settings.maxTokens });
                }
                const r = await fetch(`${url}/v1/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${App.settings.apiKey}`, 'Content-Type': 'application/json' }, body });
                document.getElementById('typingIndicator')?.remove();
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json(), reply = data.choices[0].message.content;
                const parsedParts = parseAIResponse(reply, history);
                for (let i = 0; i < parsedParts.length; i++) {
                    if (i > 0) await new Promise(r => setTimeout(r, 300 + Math.random()*400));
                    const p = parsedParts[i];
                    await addMessage(p.content, 'received', null, p.quote ? { msgId: null, content: p.quote } : null);
                }
            } catch(e) { document.getElementById('typingIndicator')?.remove(); App.lastAIStart = -1; showToast(`Failed: ${e.message}`, 'error'); }
        }

        function parseAIResponse(text, history) {
            if (!text) return [{ content: '...', quote: null }];
            const parts = text.trim().split(/\s*\|\|\|\s*/).map(s => s.trim()).filter(s => s);
            const results = [];
            const quoteRegex = /^\[Q:#(\d+)\](.*)$/s;
            for (const part of parts) {
                let cleanPart = part, quoteContent = null;
                const match = cleanPart.match(quoteRegex);
                if (match) { const idx = parseInt(match[1]) - 1; cleanPart = match[2].trim(); if (idx >= 0 && idx < history.length) quoteContent = history[idx].content.substring(0, 100); }
                cleanPart = cleanPart.replace(/^["「『"]+/, '').replace(/["」』"]+$/, '').trim();
                if (cleanPart) results.push({ content: cleanPart, quote: quoteContent });
            }
            return results.length > 0 ? results : [{ content: text.trim(), quote: null }];
        }

        function buildAPIMessages(char, history) {
            const msgs = [];
            let sys = `# SMS Simulation Rules\n\nYou are playing "${char.name}", chatting via SMS.\n\n## Output Format\n1. Separate each message with |||\n2. Keep messages 5-20 chars like real SMS\n3. No character name prefix\n4. Act like real person texting\n5. NO numbering like #1:\n\n## Quote Format (optional)\nTo quote history: [Q:#number]reply\nExample: [Q:#3]Really?|||Normal msg\n\n## Character\n${char.description || 'Friend'}`;
            if (char.scenario) sys += `\n\n## Scenario\n${char.scenario}`;
            if (char.userNick) sys += `\n\n## User Name\n${char.userNick}`;
            if (char.systemPrompt) sys += `\n\n## Extra\n${char.systemPrompt}`;
            if (char.worldbookIds?.length > 0) {
                char.worldbookIds.forEach(wbId => {
                    const wb = App.worldbooks.find(w => w.id === wbId);
                    if (wb?.entries) {
                        wb.entries.forEach(entry => {
                            const shouldInject = entry.alwaysActive || (entry.keywords && history.some(m => entry.keywords.split(',').some(k => m.content.toLowerCase().includes(k.trim().toLowerCase()))));
                            if (shouldInject && entry.content) sys += `\n\n## Lore (${entry.name})\n${entry.content}`;
                        });
                    }
                });
            }
            if (history.length > 0) {
                sys += `\n\n## History Reference\n`;
                history.forEach((m, i) => { const role = m.role === 'user' ? 'User' : 'You'; const hasImg = m.image ? '[Image]' : ''; sys += `#${i+1} ${role}: ${m.content.substring(0, 30)}${m.content.length > 30 ? '...' : ''}${hasImg}\n`; });
            }
            msgs.push({ role: 'system', content: sys });
            let currentRole = null, buffer = [];
            const flushBuffer = () => {
                if (buffer.length > 0) {
                    const role = buffer[0].role === 'user' ? 'user' : 'assistant';
                    const content = buffer.map(m => { let text = m.content; if (m.quoteContent) text = `[Quote:"${m.quoteContent.substring(0,30)}"]${text}`; if (m.image) text += '[Image]'; return text; }).join('|||');
                    msgs.push({ role, content }); buffer = [];
                }
            };
            history.forEach((m) => { if (currentRole !== m.role) { flushBuffer(); currentRole = m.role; } buffer.push(m); });
            flushBuffer();
            if (history.length > 10) msgs.push({ role: 'system', content: 'Reminder: Use ||| to separate messages. NO #number: prefix.' });
            return msgs;
        }

        async function regenerateLastReply() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; toggleExtensionPanel();
            if (char.messages.length === 0) { showToast('No messages', 'warning'); return; }
            if (App.lastAIStart >= 0 && App.lastAIStart < char.messages.length) {
                let allAI = true;
                for (let i = App.lastAIStart; i < char.messages.length; i++) { if (char.messages[i].role !== 'assistant') { allAI = false; break; } }
                if (allAI) { const count = char.messages.length - App.lastAIStart; char.messages.splice(App.lastAIStart, count); await saveData(); renderMessages(); showToast(`Deleted ${count}`, 'info'); App.lastAIStart = -1; await triggerAIReply(); return; }
            }
            if (char.messages[char.messages.length-1].role !== 'assistant') { showToast('Last not AI', 'warning'); return; }
            let first = char.messages.length - 1;
            for (let i = char.messages.length - 1; i >= 0; i--) { if (char.messages[i].role === 'assistant') first = i; else break; }
            const count = char.messages.length - first; char.messages.splice(first, count); await saveData(); renderMessages(); showToast(`Deleted ${count}`, 'info'); await triggerAIReply();
        }

        function enterSelectMode() { toggleExtensionPanel(); App.isSelectMode = true; App.selectedMsgs.clear(); document.getElementById('chatMessages').classList.add('select-mode'); document.getElementById('selectModeBar').classList.add('active'); updateSelectedCount(); }
        function exitSelectMode() { App.isSelectMode = false; App.selectedMsgs.clear(); document.getElementById('chatMessages').classList.remove('select-mode'); document.getElementById('selectModeBar').classList.remove('active'); document.querySelectorAll('.message-checkbox').forEach(el => el.classList.remove('checked')); }
        function toggleMsgSelect(id) { if (!App.isSelectMode) return; if (App.selectedMsgs.has(id)) App.selectedMsgs.delete(id); else App.selectedMsgs.add(id); document.querySelector(`[data-msg-id="${id}"] .message-checkbox`)?.classList.toggle('checked', App.selectedMsgs.has(id)); updateSelectedCount(); }
        function updateSelectedCount() { document.getElementById('selectedCount').textContent = App.selectedMsgs.size; }
        async function deleteSelectedMessages() { const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; if (App.selectedMsgs.size === 0) { showToast('Select messages', 'warning'); return; } const count = App.selectedMsgs.size; char.messages = char.messages.filter(m => !App.selectedMsgs.has(m.id)); await saveData(); exitSelectMode(); renderMessages(); showToast(`Deleted ${count}`, 'success'); App.lastAIStart = -1; }
        function toggleExtensionPanel() { document.getElementById('extensionPanel').classList.toggle('active'); }
        function autoResizeTextarea(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 100) + 'px'; }
        function scrollToBottom() { const c = document.getElementById('chatMessages'); c.scrollTop = c.scrollHeight; }

        async function createWorldbook() {
            const name = document.getElementById('newWorldbookName').value.trim(); if (!name) { showToast('Enter name', 'error'); return; }
            const wb = { id: Date.now().toString(), name, summary: '', entries: [{ name: 'Default Entry', keywords: '', content: '', alwaysActive: false }] };
            App.worldbooks.push(wb); await saveData(); hideModal('createWorldbookModal'); document.getElementById('newWorldbookName').value = ''; renderWorldbooks(); showToast(`"${name}" created`, 'success'); openWorldbookEdit(wb.id);
        }

        function renderWorldbooks() {
            const list = document.getElementById('worldbookList'), empty = document.getElementById('emptyWorldbookState');
            if (App.worldbooks.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; }
            list.style.display = 'block'; empty.style.display = 'none';
            list.innerHTML = App.worldbooks.map(wb => {
                const entryCount = wb.entries?.length || 0;
                return `<div class="worldbook-item" onclick="openWorldbookEdit('${wb.id}')"><div class="worldbook-item-header"><span class="worldbook-item-title">${escapeHtml(wb.name)}</span><span class="worldbook-item-badge">${entryCount} entries</span></div><div class="worldbook-item-preview">${escapeHtml(wb.summary || 'No summary')}</div></div>`;
            }).join('');
        }

        function openWorldbookEdit(id) {
            const wb = App.worldbooks.find(w => w.id === id); if (!wb) return;
            App.currentWbId = id;
            document.getElementById('worldbookName').value = wb.name;
            document.getElementById('worldbookSummary').value = wb.summary || '';
            renderWorldbookEntries(wb);
            openPage('worldbookEditPage');
        }

        function renderWorldbookEntries(wb) {
            const container = document.getElementById('worldbookEntries');
            if (!wb.entries || wb.entries.length === 0) { container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:14px">No entries</div>'; return; }
            container.innerHTML = wb.entries.map((entry, i) => `<div class="worldbook-entry-item"><div class="worldbook-entry-header"><span class="worldbook-entry-title">${escapeHtml(entry.name || `Entry ${i+1}`)}${entry.alwaysActive ? ' 🔒' : ''}</span><div class="worldbook-entry-actions"><button class="worldbook-entry-btn" onclick="editWorldbookEntry(${i})">✏</button><button class="worldbook-entry-btn" onclick="deleteWorldbookEntry(${i})">🗑</button></div></div><div class="worldbook-entry-keywords">${entry.keywords ? 'Keywords: ' + escapeHtml(entry.keywords) : 'No keywords'}</div><div class="worldbook-entry-preview">${escapeHtml(entry.content?.substring(0, 80) || 'No content')}...</div></div>`).join('');
        }

        function addWorldbookEntry() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            App.currentEntryIndex = -1;
            document.getElementById('entryName').value = '';
            document.getElementById('entryKeywords').value = '';
            document.getElementById('entryContent').value = '';
            document.getElementById('entryAlwaysActive').classList.remove('active');
            showModal('entryEditModal');
        }

        function editWorldbookEntry(idx) {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb || !wb.entries[idx]) return;
            App.currentEntryIndex = idx;
            const entry = wb.entries[idx];
            document.getElementById('entryName').value = entry.name || '';
            document.getElementById('entryKeywords').value = entry.keywords || '';
            document.getElementById('entryContent').value = entry.content || '';
            document.getElementById('entryAlwaysActive').classList.toggle('active', entry.alwaysActive);
            showModal('entryEditModal');
        }

        async function saveWorldbookEntry() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            const entry = { name: document.getElementById('entryName').value.trim() || 'Unnamed Entry', keywords: document.getElementById('entryKeywords').value, content: document.getElementById('entryContent').value, alwaysActive: document.getElementById('entryAlwaysActive').classList.contains('active') };
            if (App.currentEntryIndex >= 0) { wb.entries[App.currentEntryIndex] = entry; }
            else { wb.entries.push(entry); }
            await saveData(); hideModal('entryEditModal'); renderWorldbookEntries(wb); showToast('Entry saved', 'success');
        }

        async function deleteWorldbookEntry(idx) {
            if (!confirm('Delete this entry?')) return;
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            wb.entries.splice(idx, 1);
            await saveData(); renderWorldbookEntries(wb); showToast('Deleted', 'success');
        }

        function closeWorldbookEdit() { closePage('worldbookEditPage'); App.currentWbId = null; }

        async function saveWorldbook() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            wb.name = document.getElementById('worldbookName').value.trim() || wb.name;
            wb.summary = document.getElementById('worldbookSummary').value;
            await saveData(); closeWorldbookEdit(); renderWorldbooks(); showToast('Saved', 'success');
        }

        function deleteCurrentWorldbook() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            App.pendingDeleteType = 'worldbook'; App.pendingDeleteId = wb.id;
            document.getElementById('deleteModalTitle').textContent = `Delete "${wb.name}"?`;
            showModal('confirmDeleteModal');
        }

        async function confirmDelete() {
            if (App.pendingDeleteType === 'character') {
                App.characters = App.characters.filter(c => c.id !== App.pendingDeleteId);
                await saveData(); hideModal('confirmDeleteModal'); closeCharacterSettings(); closeChatPage(); renderContacts(); showToast('Deleted', 'success');
            } else if (App.pendingDeleteType === 'worldbook') {
                App.characters.forEach(c => { if (c.worldbookIds) c.worldbookIds = c.worldbookIds.filter(id => id !== App.pendingDeleteId); });
                App.worldbooks = App.worldbooks.filter(w => w.id !== App.pendingDeleteId);
                await saveData(); hideModal('confirmDeleteModal'); closeWorldbookEdit(); renderWorldbooks(); showToast('Deleted', 'success');
            }
        }

        function exportAllData() {
            const data = { characters: App.characters, worldbooks: App.worldbooks, settings: App.settings, appIcons: App.appIcons, globalCssPresets: App.globalCssPresets, apiPresets: App.apiPresets, customFonts: App.customFonts, version: '7.0.0', exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `persona-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
            showToast('Exported', 'success');
        }

        async function importData(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.characters) App.characters = data.characters;
                    if (data.worldbooks) App.worldbooks = data.worldbooks;
                    if (data.settings) App.settings = {...App.settings, ...data.settings};
                    if (data.appIcons) App.appIcons = {...App.appIcons, ...data.appIcons};
                    if (data.globalCssPresets) App.globalCssPresets = data.globalCssPresets;
                    if (data.apiPresets) App.apiPresets = data.apiPresets;
                    if (data.customFonts) App.customFonts = data.customFonts;
                    App.worldbooks.forEach(wb => { if (!wb.entries) wb.entries = [{ name: 'Default Entry', keywords: wb.keywords || '', content: wb.content || '', alwaysActive: wb.alwaysActive || false }]; });
                    App.characters.forEach(c => { if (c.worldbookId && !c.worldbookIds) c.worldbookIds = [c.worldbookId]; if (!c.worldbookIds) c.worldbookIds = []; });
                    if (await saveData()) { loadSettingsUI(); applyWallpaper(); applyAppIcons(); applyStatusBarVisibility(); applyFont(); await updateStorageDisplay(); showToast('Imported', 'success'); }
                } catch(err) { showToast('Import failed: ' + err.message, 'error'); }
            };
            reader.readAsText(file); e.target.value = '';
        }

        async function clearAllData() {
            if (confirm('Clear all data?')) {
                try { await clearIDBStore('appData'); await clearIDBStore('images'); location.reload(); }
                catch (e) { indexedDB.deleteDatabase(DB_NAME); location.reload(); }
            }
        }

        function toggleSwitch(el) { el.classList.toggle('active'); }
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatTime(ts) { return new Date(ts).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); }
        function formatDate(ts) { const d = new Date(ts), today = new Date(), yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1); if (d.toDateString() === today.toDateString()) return 'TODAY'; if (d.toDateString() === yesterday.toDateString()) return 'YESTERDAY'; return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }).toUpperCase(); }

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { const input = document.getElementById('chatInput'); if (document.activeElement === input && document.getElementById('chatPage').classList.contains('active')) { e.preventDefault(); sendMessage(); } }
            if (e.key === 'Escape') { ['createCharacterModal','createWorldbookModal','confirmDeleteModal','clearMessagesModal','cssPresetNameModal','apiPresetNameModal','deleteCssPresetModal','deleteApiPresetModal','deleteFontModal','cssGuideModal','entryEditModal','editMessageModal'].forEach(hideModal); hideContextMenu(); if (App.isSelectMode) exitSelectMode(); }
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); }); });
    </script>
</body>
</html>
```
