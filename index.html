```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NOIR">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0a">
    <title>NOIR · Premium SMS v10</title>
    <style id="globalFontStyle"></style>
    <style id="globalFontSizeStyle"></style>
    <style id="bubbleStyleSheet"></style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Inter:wght@300;400;500;600&display=swap');

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: rgba(18, 18, 18, 0.85);
            --bg-tertiary: rgba(28, 28, 28, 0.9);
            --bg-card: rgba(22, 22, 22, 0.75);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.06);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-accent: rgba(255, 255, 255, 0.12);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.55);
            --text-tertiary: rgba(255, 255, 255, 0.35);
            --text-muted: rgba(255, 255, 255, 0.25);
            --accent-gold: #c9a962;
            --accent-gold-dim: rgba(201, 169, 98, 0.15);
            --accent-rose: #b8627d;
            --accent-blue: #5a7db5;
            --accent-emerald: #4a9e7c;
            --accent-purple: #8b5cf6;
            --danger: #c75050;
            --success: #5a9e6f;
            --blur-heavy: 40px;
            --blur-medium: 25px;
            --blur-light: 15px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --font-serif: 'Cormorant Garamond', 'Noto Serif SC', Georgia, serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif;
            --transition-smooth: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-fast: all 0.2s ease;
            --font-scale: 1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; height: -webkit-fill-available; }
        body {
            height: 100%; min-height: 100vh; min-height: -webkit-fill-available;
            overflow: hidden; font-family: var(--font-sans);
            background: var(--bg-primary); color: var(--text-primary);
            overscroll-behavior: none; position: fixed; width: 100%; top: 0; left: 0;
            letter-spacing: 0.02em; line-height: 1.5;
            font-size: calc(14px * var(--font-scale));
        }

        #wallpaperLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: linear-gradient(180deg, #0a0a0a 0%, #111111 50%, #0d0d0d 100%);
        }

        .phone-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; margin: 0; overflow: hidden; z-index: 1;
        }

        .status-bar {
            position: absolute; top: 0; left: 0; right: 0;
            height: calc(28px + var(--safe-top)); padding-top: var(--safe-top);
            display: flex; justify-content: space-between; align-items: center;
            padding-left: 20px; padding-right: 20px; z-index: 1000;
            background: transparent;
        }
        .status-bar.hidden { display: none !important; }
        .status-bar-time {
            font-size: calc(13px * var(--font-scale)); font-weight: 500; color: var(--text-secondary);
            font-family: var(--font-sans); letter-spacing: 0.5px;
        }
        .status-bar-icons { display: flex; gap: 6px; align-items: center; }
        .status-bar-icons svg { width: 14px; height: 14px; fill: var(--text-tertiary); }

        .home-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding-top: calc(60px + var(--safe-top));
            padding-bottom: calc(100px + var(--safe-bottom));
            padding-left: 24px; padding-right: 24px;
            display: flex; flex-direction: column;
            overflow-y: auto; z-index: 1;
        }
        .home-screen.no-statusbar { padding-top: calc(40px + var(--safe-top)); }

        .home-header { margin-bottom: 40px; text-align: center; }
        .home-brand {
            font-family: var(--font-serif); font-size: calc(11px * var(--font-scale)); font-weight: 400;
            letter-spacing: 4px; text-transform: uppercase;
            color: var(--text-tertiary); margin-bottom: 8px;
        }
        .home-title {
            font-family: var(--font-serif); font-size: calc(32px * var(--font-scale)); font-weight: 300;
            letter-spacing: 8px; text-transform: uppercase;
            color: var(--text-primary);
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .home-divider {
            width: 40px; height: 1px; margin: 20px auto;
            background: linear-gradient(90deg, transparent, var(--text-tertiary), transparent);
        }

        .app-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 20px; justify-items: center; margin-top: 20px;
        }

        .app-icon-wrapper {
            display: flex; flex-direction: column; align-items: center;
            gap: 10px; cursor: pointer; transition: var(--transition-smooth);
        }
        .app-icon-wrapper:active { transform: scale(0.92); }

        .app-icon {
            width: 64px; height: 64px; border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            backdrop-filter: blur(var(--blur-light));
            -webkit-backdrop-filter: blur(var(--blur-light));
            transition: var(--transition-smooth);
            overflow: hidden; position: relative;
        }
        .app-icon::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 50%; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            border-radius: 18px 18px 0 0; pointer-events: none;
        }
        .app-icon:hover { border-color: var(--border-accent); background: var(--bg-glass-hover); }
        .app-icon svg { width: 26px; height: 26px; stroke: var(--text-secondary); stroke-width: 1.5; fill: none; z-index: 1; }
        .app-icon img { width: 100%; height: 100%; object-fit: cover; }

        .app-icon-label {
            font-size: calc(11px * var(--font-scale)); font-weight: 400; color: var(--text-secondary);
            letter-spacing: 0.5px; text-align: center;
            font-family: var(--font-sans);
        }

        .home-indicator {
            position: absolute; bottom: calc(8px + var(--safe-bottom));
            left: 50%; transform: translateX(-50%);
            width: 100px; height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px; z-index: 1001;
        }

        .page {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.92);
            backdrop-filter: blur(var(--blur-heavy));
            -webkit-backdrop-filter: blur(var(--blur-heavy));
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .page.active { transform: translateX(0); }
        .page.slide-from-bottom { transform: translateY(100%); }
        .page.slide-from-bottom.active { transform: translateY(0); }

        .page#chatPage { background: rgba(8, 8, 8, 0.95); }
        .page#chatPage.has-custom-bg {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        .nav-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding-top: calc(12px + var(--safe-top));
            padding-bottom: 16px; padding-left: 16px; padding-right: 16px;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 70%, transparent 100%);
            backdrop-filter: blur(var(--blur-medium));
            -webkit-backdrop-filter: blur(var(--blur-medium));
            flex-shrink: 0; min-height: calc(56px + var(--safe-top));
            border: none;
        }

        .nav-btn {
            display: flex; align-items: center; justify-content: center;
            gap: 4px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary); font-size: calc(13px * var(--font-scale)); font-weight: 400;
            cursor: pointer; padding: 8px 12px; border-radius: 20px;
            min-width: 44px; transition: var(--transition-fast);
            font-family: var(--font-sans); letter-spacing: 0.3px;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.08); color: var(--text-primary); }
        .nav-btn:active { transform: scale(0.96); }
        .nav-btn svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 1.5; fill: none; }

        .nav-title {
            font-family: var(--font-serif); font-size: calc(16px * var(--font-scale)); font-weight: 400;
            color: var(--text-primary); text-align: center; flex: 1;
            letter-spacing: 2px; text-transform: uppercase;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            max-width: calc(100% - 160px); margin: 0 8px;
        }

        .page-content {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }

        .settings-group {
            background: var(--bg-card);
            backdrop-filter: blur(var(--blur-light));
            -webkit-backdrop-filter: blur(var(--blur-light));
            border-radius: 16px; margin-bottom: 20px; overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .settings-group-title {
            font-family: var(--font-serif); font-size: calc(11px * var(--font-scale)); font-weight: 500;
            color: var(--text-tertiary); text-transform: uppercase;
            letter-spacing: 2px; padding: 20px 16px 8px;
        }

        .settings-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer; transition: var(--transition-fast);
        }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:hover { background: var(--bg-glass-hover); }
        .settings-item:active { background: rgba(255, 255, 255, 0.04); }

        .settings-item-left { display: flex; align-items: center; gap: 14px; }

        .settings-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
        }
        .settings-icon svg { width: 18px; height: 18px; stroke: var(--text-secondary); stroke-width: 1.5; fill: none; }
        .settings-icon.gold { background: var(--accent-gold-dim); }
        .settings-icon.gold svg { stroke: var(--accent-gold); }
        .settings-icon.rose { background: rgba(184, 98, 125, 0.15); }
        .settings-icon.rose svg { stroke: var(--accent-rose); }
        .settings-icon.blue { background: rgba(90, 125, 181, 0.15); }
        .settings-icon.blue svg { stroke: var(--accent-blue); }
        .settings-icon.emerald { background: rgba(74, 158, 124, 0.15); }
        .settings-icon.emerald svg { stroke: var(--accent-emerald); }
        .settings-icon.purple { background: rgba(139, 92, 246, 0.15); }
        .settings-icon.purple svg { stroke: var(--accent-purple); }
        .settings-icon.danger { background: rgba(199, 80, 80, 0.15); }
        .settings-icon.danger svg { stroke: var(--danger); }

        .settings-item-label { color: var(--text-primary); font-size: calc(14px * var(--font-scale)); font-weight: 400; }
        .settings-item-desc { color: var(--text-tertiary); font-size: calc(11px * var(--font-scale)); margin-top: 2px; }

        .input-group { margin-bottom: 16px; }

        .input-label {
            display: block; font-size: calc(10px * var(--font-scale)); font-weight: 500;
            color: var(--text-tertiary); margin-bottom: 8px;
            text-transform: uppercase; letter-spacing: 1.5px;
            font-family: var(--font-sans);
        }

        .input-field {
            width: 100%; padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; color: var(--text-primary);
            font-size: calc(14px * var(--font-scale)); outline: none;
            font-family: var(--font-sans);
            transition: var(--transition-fast);
        }
        .input-field:focus { border-color: var(--accent-gold); background: var(--bg-glass-hover); }
        .input-field::placeholder { color: var(--text-muted); }

        textarea.input-field {
            min-height: 100px; resize: vertical;
            font-family: inherit; line-height: 1.6;
        }

        textarea.css-editor {
            min-height: 180px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px; line-height: 1.6;
            background: rgba(0, 0, 0, 0.4);
            color: var(--accent-gold);
        }

        .btn {
            display: flex; align-items: center; justify-content: center;
            gap: 8px; padding: 14px 20px;
            border: 1px solid var(--border-subtle);
            border-radius: 12px; font-size: calc(13px * var(--font-scale)); font-weight: 500;
            cursor: pointer; width: 100%;
            font-family: var(--font-sans);
            letter-spacing: 0.5px;
            transition: var(--transition-fast);
            background: var(--bg-glass);
            color: var(--text-primary);
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-primary {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary);
        }
        .btn-primary:hover { background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.12)); }

        .btn-secondary {
            background: var(--bg-glass);
            border: 1px solid var(--border-accent);
            color: var(--text-primary);
        }
        .btn-secondary:hover { background: var(--bg-glass-hover); }

        .btn-danger {
            background: rgba(199, 80, 80, 0.2);
            border: 1px solid rgba(199, 80, 80, 0.3);
            color: var(--danger);
        }

        .btn-small { padding: 10px 16px; font-size: calc(12px * var(--font-scale)); }

        .btn-stack { display: flex; flex-direction: column; gap: 10px; }
        .btn-row { display: flex; gap: 10px; }
        .btn-row .btn { flex: 1; }

        .contact-list { display: flex; flex-direction: column; gap: 8px; }

        .contact-item {
            display: flex; align-items: center; gap: 14px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 16px; cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-smooth);
        }
        .contact-item:hover { border-color: var(--border-accent); background: var(--bg-glass-hover); }
        .contact-item:active { transform: scale(0.99); }

        .contact-avatar {
            width: 50px; height: 50px; border-radius: 14px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: var(--text-secondary);
            flex-shrink: 0; overflow: hidden;
            border: 1px solid var(--border-subtle);
        }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .contact-info { flex: 1; min-width: 0; }
        .contact-name {
            font-family: var(--font-serif); font-size: calc(15px * var(--font-scale)); font-weight: 500;
            color: var(--text-primary); margin-bottom: 4px; letter-spacing: 0.5px;
        }
        .contact-preview {
            font-size: calc(12px * var(--font-scale)); color: var(--text-tertiary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .contact-time { font-size: calc(11px * var(--font-scale)); color: var(--text-muted); flex-shrink: 0; }

        .empty-state {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 60px 20px; text-align: center;
        }
        .empty-state-icon {
            width: 64px; height: 64px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-glass); border-radius: 20px;
            border: 1px solid var(--border-subtle);
        }
        .empty-state-icon svg { width: 28px; height: 28px; stroke: var(--text-tertiary); stroke-width: 1.5; fill: none; }
        .empty-state-title {
            font-family: var(--font-serif); font-size: calc(18px * var(--font-scale)); font-weight: 400;
            color: var(--text-primary); margin-bottom: 8px; letter-spacing: 1px;
        }
        .empty-state-desc { font-size: calc(13px * var(--font-scale)); color: var(--text-tertiary); }

        .chat-container {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden; position: relative;
        }

        .chat-messages {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .message-wrapper {
            display: flex; align-items: flex-end; gap: 8px; margin-bottom: 2px;
        }
        .message-wrapper.sent { justify-content: flex-end; }
        .message-wrapper.received { justify-content: flex-start; }

        .message-avatar {
            width: 32px; height: 32px; border-radius: 10px;
            background: var(--bg-tertiary);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: var(--text-secondary);
            flex-shrink: 0; overflow: hidden;
            border: 1px solid var(--border-subtle);
        }
        .message-avatar.square { border-radius: 6px; }
        .message-avatar.rounded-square { border-radius: 8px; }
        .message-avatar.hidden { display: none; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .message {
            max-width: 72%; padding: calc(12px * var(--font-scale)) calc(16px * var(--font-scale));
            font-size: calc(14px * var(--font-scale)); line-height: 1.5;
            word-wrap: break-word;
            animation: msgIn 0.25s ease-out;
            position: relative;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message.sent {
            background: rgba(60, 60, 65, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border-radius: 18px 18px 4px 18px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .message.received {
            background: rgba(45, 45, 50, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: var(--text-primary);
            border-radius: 18px 18px 18px 4px;
        }

        .message-quote {
            background: rgba(0, 0, 0, 0.25);
            border-left: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px; padding: 6px 10px;
            margin-bottom: 8px; font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            max-height: 48px; overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        .message-image {
            max-width: 220px; max-height: 220px;
            border-radius: 12px; margin-top: 6px;
            cursor: pointer; display: block;
            border: 1px solid var(--border-subtle);
        }

        .message-time {
            font-size: calc(10px * var(--font-scale)); color: var(--text-muted);
            margin-top: 4px; letter-spacing: 0.3px;
        }
        .message-time.time-hidden { display: none; }
        .message-time.time-side {
            position: absolute; bottom: 6px; right: -44px;
            margin-top: 0;
        }
        .message-wrapper.sent .message-time.time-side { right: auto; left: -44px; }

        .message-checkbox {
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid var(--text-tertiary);
            background: transparent;
            display: none; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0;
            transition: var(--transition-fast);
        }
        .message-checkbox.checked { background: var(--danger); border-color: var(--danger); }
        .message-checkbox.checked::after { content: '✓'; color: white; font-size: 11px; }
        .chat-messages.select-mode .message-checkbox { display: flex; }

        /* 场景图片样式 */
        .scene-image-card {
            max-width: 240px;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            animation: msgIn 0.25s ease-out;
            transition: transform 0.3s ease;
        }
        .scene-image-card:active { transform: scale(0.98); }

        .scene-image-cover {
            width: 100%;
            height: 160px;
            background-image: url('https://iili.io/fsAcryG.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scene-image-cover::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.2));
            pointer-events: none;
        }
        .scene-image-cover::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.6));
            pointer-events: none;
        }

        .scene-image-icon {
            width: 48px; height: 48px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1;
            transition: var(--transition-fast);
        }
        .scene-image-icon svg {
            width: 22px; height: 22px;
            stroke: rgba(255,255,255,0.9);
            stroke-width: 1.5; fill: none;
        }

        .scene-image-footer {
            padding: 12px 14px;
            background: rgba(20, 20, 25, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .scene-image-label {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex; align-items: center; gap: 6px;
        }
        .scene-image-label svg {
            width: 12px; height: 12px;
            stroke: var(--accent-purple);
            stroke-width: 2; fill: none;
        }

        .scene-image-card.expanded .scene-image-cover { display: none; }
        .scene-image-card.expanded .scene-image-content { display: block; }

        .scene-image-content {
            display: none;
            padding: 16px;
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            min-height: 120px;
        }
        .scene-image-text {
            font-size: calc(13px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.6;
            font-style: italic;
        }
        .scene-image-hint {
            margin-top: 12px;
            font-size: calc(10px * var(--font-scale));
            color: var(--text-muted);
            text-align: center;
        }

        .scene-image-card-inner,
.voice-message-inner {
            width: 100%;
            height: 100%;
        }

        /* 语音消息样式 */
        .voice-message {
            max-width: 200px;
            padding: 12px 16px;
            border-radius: 20px;
            background: rgba(50, 50, 55, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            cursor: pointer;
            animation: msgIn 0.25s ease-out;
            transition: var(--transition-fast);
        }
        .voice-message:active { transform: scale(0.98); }
        .voice-message.sent {
            background: rgba(60, 60, 65, 0.7);
            border-radius: 20px 20px 4px 20px;
        }
        .voice-message.received {
            background: rgba(45, 45, 50, 0.7);
            border-radius: 20px 20px 20px 4px;
        }

        .voice-message-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-play-btn {
            width: 32px; height: 32px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.15);
            flex-shrink: 0;
        }
        .voice-play-btn svg {
            width: 14px; height: 14px;
            stroke: var(--text-primary);
            stroke-width: 2; fill: none;
        }

        .voice-waveform {
            flex: 1;
            height: 24px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .voice-wave-bar {
            width: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .voice-duration {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
            flex-shrink: 0;
            min-width: 28px;
            text-align: right;
        }

        .voice-text-content {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .voice-text-content.visible { display: block; }
        .voice-text-content p {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .voice-message-time {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-muted);
            margin-top: 6px;
            text-align: right;
        }

        .voice-message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .voice-message {
            max-width: 200px;
            padding: 12px 16px;
        }

        .typing-indicator {
            display: inline-flex; gap: 4px; padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 18px 18px 18px 4px; width: fit-content;
        }
        .typing-indicator span {
            width: 6px; height: 6px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .chat-input-wrapper {
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%);
            backdrop-filter: blur(var(--blur-medium));
            -webkit-backdrop-filter: blur(var(--blur-medium));
        }

        .quote-preview-bar {
            display: none; padding: 10px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-subtle);
            align-items: center; gap: 12px;
        }
        .quote-preview-bar.active { display: flex; }
        .quote-preview-content {
            flex: 1; font-size: calc(12px * var(--font-scale)); color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-left: 2px solid rgba(255,255,255,0.3); padding-left: 10px;
        }
        .quote-preview-close {
            width: 28px; height: 28px; border-radius: 50%;
            background: var(--bg-glass); border: 1px solid var(--border-subtle);
            color: var(--text-secondary); font-size: 12px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .chat-input-area {
            display: flex; align-items: flex-end; gap: 8px;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
        }

        .chat-btn {
            width: 40px; height: 40px; border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: rgba(35, 35, 40, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: var(--transition-fast);
        }
        .chat-btn:hover { background: rgba(50, 50, 55, 0.9); color: var(--text-primary); }
        .chat-btn:active { transform: scale(0.94); }
        .chat-btn svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 1.5; fill: none; }

        .chat-btn.send {
            background: rgba(40, 40, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chat-btn.send:hover { background: rgba(55, 55, 60, 0.95); }
        .chat-btn.send svg { stroke: var(--text-primary); }

        .chat-btn.ai {
            background: rgba(45, 45, 50, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chat-btn.ai:hover { background: rgba(60, 60, 65, 0.95); }
        .chat-btn.ai svg { stroke: var(--text-primary); }

        .chat-input-field {
            flex: 1; min-height: 40px; max-height: 100px;
            padding: 10px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 20px; color: var(--text-primary);
            font-size: calc(14px * var(--font-scale)); resize: none; outline: none;
            font-family: inherit; line-height: 1.4;
        }
        .chat-input-field:focus { border-color: rgba(255,255,255,0.2); }
        .chat-input-field::placeholder { color: var(--text-muted); }

        .extension-panel {
            position: absolute;
            bottom: calc(70px + var(--safe-bottom));
            left: 16px; right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px; padding: 0; z-index: 50;
            opacity: 0; visibility: hidden;
            transform: translateY(16px);
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .extension-panel.active { opacity: 1; visibility: visible; transform: translateY(0); }

        .ext-panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .ext-panel-title {
            font-family: var(--font-serif); font-size: calc(12px * var(--font-scale)); font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 2px; text-transform: uppercase;
        }
        .ext-panel-close {
            width: 28px; height: 28px; border-radius: 50%;
            background: var(--bg-glass); border: 1px solid var(--border-subtle);
            color: var(--text-secondary); font-size: 14px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .ext-btn {
            display: flex; align-items: center; gap: 16px;
            width: 100%; padding: 16px 20px;
            background: transparent; border: none;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-primary); font-size: calc(14px * var(--font-scale));
            cursor: pointer; transition: var(--transition-fast); text-align: left;
        }
        .ext-btn:last-child { border-bottom: none; }
        .ext-btn:hover { background: var(--bg-glass-hover); }

        .ext-btn-icon {
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-glass); border: 1px solid var(--border-subtle);
        }
        .ext-btn-icon svg { width: 18px; height: 18px; stroke: var(--text-secondary); stroke-width: 1.5; fill: none; }
        .ext-btn-icon.danger { background: rgba(199, 80, 80, 0.15); }
        .ext-btn-icon.danger svg { stroke: var(--danger); }
        .ext-btn-icon.purple { background: rgba(139, 92, 246, 0.15); }
        .ext-btn-icon.purple svg { stroke: var(--accent-purple); }
        .ext-btn-icon.blue { background: rgba(90, 125, 181, 0.15); }
        .ext-btn-icon.blue svg { stroke: var(--accent-blue); }
        .ext-btn-icon.rose { background: rgba(184, 98, 125, 0.15); }
        .ext-btn-icon.rose svg { stroke: var(--accent-rose); }
        .ext-btn-icon.emerald { background: rgba(74, 158, 124, 0.15); }
        .ext-btn-icon.emerald svg { stroke: var(--accent-emerald); }

        .ext-btn-text { flex: 1; }
        .ext-btn-title { font-size: calc(14px * var(--font-scale)); font-weight: 500; color: var(--text-primary); margin-bottom: 2px; }
        .ext-btn-desc { font-size: calc(11px * var(--font-scale)); color: var(--text-tertiary); }

        .context-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 2500; opacity: 0; visibility: hidden;
            transition: all 0.25s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .context-menu-overlay.active { opacity: 1; visibility: visible; }

        .context-menu {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px; width: 220px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9); transition: transform 0.25s ease;
        }
        .context-menu-overlay.active .context-menu { transform: scale(1); }

        .context-menu-item {
            display: flex; align-items: center; gap: 14px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer; transition: var(--transition-fast);
        }
        .context-menu-item:last-child { border-bottom: none; }
        .context-menu-item:hover { background: var(--bg-glass-hover); }

        .context-menu-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-glass); border: 1px solid var(--border-subtle);
        }
        .context-menu-icon svg { width: 16px; height: 16px; stroke: var(--text-secondary); stroke-width: 1.5; fill: none; }
        .context-menu-label { font-size: calc(14px * var(--font-scale)); color: var(--text-primary); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; padding: 24px;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            width: 100%; max-width: 360px; max-height: 85vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            backdrop-filter: blur(var(--blur-heavy));
            border-radius: 20px; padding: 24px;
            border: 1px solid var(--border-subtle);
            transform: scale(0.92); transition: transform 0.3s ease;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        }
        .modal-overlay.active .modal { transform: scale(1); }

        .modal-title {
            font-family: var(--font-serif); font-size: calc(18px * var(--font-scale)); font-weight: 400;
            color: var(--text-primary); text-align: center;
            margin-bottom: 20px; letter-spacing: 1px;
        }

        .modal-input {
            width: 100%; padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; color: var(--text-primary);
            font-size: calc(14px * var(--font-scale)); outline: none; margin-bottom: 16px;
        }
        .modal-input:focus { border-color: rgba(255,255,255,0.2); }

        .modal-btns { display: flex; gap: 12px; }
        .modal-btn {
            flex: 1; padding: 14px;
            border: none; border-radius: 12px;
            font-size: calc(14px * var(--font-scale)); font-weight: 500; cursor: pointer;
            transition: var(--transition-fast);
        }
        .modal-btn.cancel {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }
        .modal-btn.confirm {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
        }

        .toast-container {
            position: fixed; top: calc(60px + var(--safe-top));
            left: 50%; transform: translateX(-50%);
            z-index: 3000; display: flex; flex-direction: column; gap: 8px;
            pointer-events: none;
        }
        .toast {
            padding: 12px 20px;
            background: var(--bg-secondary);
            backdrop-filter: blur(var(--blur-medium));
            border-radius: 12px; color: var(--text-primary);
            font-size: calc(13px * var(--font-scale)); font-weight: 400;
            border: 1px solid var(--border-subtle);
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid rgba(255,255,255,0.4); }
        .toast.warning { border-left: 3px solid var(--accent-rose); }

        @keyframes toastIn { from { opacity: 0; transform: translateY(-12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

        .search-field {
            width: 100%; padding: 12px 16px 12px 44px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; color: var(--text-primary);
            font-size: calc(14px * var(--font-scale)); outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.3)' stroke-width='1.5'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 14px center;
        }
        .search-field:focus { border-color: rgba(255,255,255,0.2); }

        .toggle-switch {
            position: relative; width: 48px; height: 28px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 14px; cursor: pointer;
            transition: var(--transition-fast);
        }
        .toggle-switch.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .toggle-switch::after {
            content: ''; position: absolute;
            top: 3px; left: 3px;
            width: 20px; height: 20px;
            background: white; border-radius: 50%;
            transition: all 0.25s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .toggle-switch.active::after { left: 23px; }

        .select-field {
            width: 100%; padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; color: var(--text-primary);
            font-size: calc(14px * var(--font-scale)); cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }
        .select-field option { background: var(--bg-primary); }

        .file-input-hidden { display: none; }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
            margin: 20px 0;
        }

        .loading-spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .slider-container { margin: 16px 0; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .slider-label { font-size: calc(12px * var(--font-scale)); color: var(--text-secondary); }
        .slider-value { font-size: calc(12px * var(--font-scale)); color: var(--text-primary); font-weight: 500; }

        .slider-input {
            width: 100%; height: 4px;
            background: var(--bg-glass);
            border-radius: 2px; appearance: none;
        }
        .slider-input::-webkit-slider-thumb {
            appearance: none; width: 18px; height: 18px;
            background: white;
            border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .action-hint {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; margin-bottom: 16px;
        }
        .action-hint-icon { font-size: 14px; }
        .action-hint-text { font-size: calc(12px * var(--font-scale)); color: var(--text-secondary); }
        .action-hint.success { background: rgba(90, 158, 111, 0.1); border-color: rgba(90, 158, 111, 0.2); }
        .action-hint.success .action-hint-text { color: var(--success); }
        .action-hint.warning { background: rgba(184, 98, 125, 0.1); border-color: rgba(184, 98, 125, 0.2); }
        .action-hint.warning .action-hint-text { color: var(--accent-rose); }

        .delete-zone {
            padding: 18px;
            border: 1px dashed var(--danger);
            border-radius: 14px; text-align: center;
            color: var(--danger); margin-top: 20px;
            cursor: pointer; font-size: calc(14px * var(--font-scale));
            transition: var(--transition-fast);
        }
        .delete-zone:hover { background: rgba(199, 80, 80, 0.1); }

        .log-container {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-subtle);
            border-radius: 10px; padding: 12px;
            margin-top: 12px; max-height: 140px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
        }
        .log-entry { padding: 3px 0; border-bottom: 1px solid var(--border-subtle); }
        .log-entry:last-child { border-bottom: none; }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.info { color: var(--text-secondary); }

        .model-list { max-height: 160px; overflow-y: auto; margin-top: 12px; }
        .model-item {
            padding: 12px 14px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px; margin-bottom: 8px;
            cursor: pointer; transition: var(--transition-fast);
        }
        .model-item:hover { background: var(--bg-glass-hover); border-color: var(--border-accent); }
        .model-item.selected { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.3); }
        .model-item-name { font-size: calc(12px * var(--font-scale)); color: var(--text-primary); }

        .date-separator { display: flex; justify-content: center; padding: 12px 0; }
        .date-separator-text {
            padding: 4px 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: calc(11px * var(--font-scale)); color: var(--text-tertiary);
            letter-spacing: 0.5px;
        }

        .select-mode-bar {
            display: none; align-items: center; justify-content: space-between;
            padding: 12px 16px;
            background: rgba(199, 80, 80, 0.1);
            border-bottom: 1px solid rgba(199, 80, 80, 0.2);
        }
        .select-mode-bar.active { display: flex; }
        .select-mode-info { font-size: calc(13px * var(--font-scale)); color: var(--text-primary); }
        .select-mode-btns { display: flex; gap: 10px; }
        .select-mode-btn {
            padding: 8px 16px; border: none; border-radius: 8px;
            font-size: calc(12px * var(--font-scale)); font-weight: 500; cursor: pointer;
        }
        .select-mode-btn.cancel {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }
        .select-mode-btn.delete { background: var(--danger); color: white; }

        .avatar-upload-area {
            width: 88px; height: 88px; border-radius: 50%;
            background: var(--bg-glass);
            border: 2px dashed var(--border-accent);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin: 0 auto 16px;
            color: var(--text-tertiary);
            overflow: hidden; transition: var(--transition-fast);
        }
        .avatar-upload-area:hover { border-color: rgba(255,255,255,0.3); }
        .avatar-upload-area.has-image { border-style: solid; border-color: rgba(255,255,255,0.3); }
        .avatar-upload-area img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-upload-area svg { width: 28px; height: 28px; stroke: var(--text-tertiary); stroke-width: 1.5; fill: none; }

        .color-picker-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .color-picker-label { font-size: calc(12px * var(--font-scale)); color: var(--text-primary); flex: 1; }
        .color-picker-input {
            width: 44px; height: 32px;
            border: none; border-radius: 8px;
            cursor: pointer; background: transparent;
        }

        .shape-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .shape-option {
            padding: 8px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 8px; color: var(--text-primary);
            font-size: calc(12px * var(--font-scale)); cursor: pointer;
            transition: var(--transition-fast);
        }
        .shape-option.selected {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .worldbook-entries { margin-top: 12px; }
        .worldbook-entry-item {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; padding: 14px; margin-bottom: 10px;
        }
        .worldbook-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .worldbook-entry-title { font-size: calc(13px * var(--font-scale)); font-weight: 500; color: var(--text-primary); }
        .worldbook-entry-actions { display: flex; gap: 8px; }
        .worldbook-entry-btn {
            width: 28px; height: 28px; border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .worldbook-entry-btn:hover { background: var(--bg-glass-hover); color: var(--text-primary); }
        .worldbook-entry-btn svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 1.5; fill: none; }
        .worldbook-entry-keywords { font-size: calc(11px * var(--font-scale)); color: var(--text-secondary); margin-bottom: 4px; }
        .worldbook-entry-preview {
            font-size: calc(11px * var(--font-scale)); color: var(--text-tertiary);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .worldbook-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px; padding: 16px; margin-bottom: 10px;
            cursor: pointer; transition: var(--transition-fast);
        }
        .worldbook-item:hover { border-color: var(--border-accent); }
        .worldbook-item-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .worldbook-item-title { font-family: var(--font-serif); font-size: calc(15px * var(--font-scale)); font-weight: 500; color: var(--text-primary); }
        .worldbook-item-badge {
            padding: 3px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px; font-size: calc(10px * var(--font-scale));
            color: var(--text-secondary); font-weight: 500;
        }
        .worldbook-item-preview {
            font-size: calc(12px * var(--font-scale)); color: var(--text-tertiary);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .char-counter { font-size: calc(10px * var(--font-scale)); color: var(--text-tertiary); text-align: right; margin-top: 4px; }
        .char-counter.warning { color: var(--accent-rose); }
        .char-counter.error { color: var(--danger); }

        .wallpaper-preview {
            width: 100%; height: 140px;
            border-radius: 14px; margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            background: var(--bg-glass);
        }

        .icon-customize-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        .icon-customize-item { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .icon-customize-preview {
            width: 52px; height: 52px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            border: 2px dashed var(--border-accent);
            overflow: hidden; transition: var(--transition-fast);
            background: var(--bg-glass);
        }
        .icon-customize-preview:hover { border-color: rgba(255,255,255,0.3); }
        .icon-customize-preview.has-image { border-style: solid; }
        .icon-customize-preview img { width: 100%; height: 100%; object-fit: cover; }
        .icon-customize-preview svg { width: 22px; height: 22px; stroke: var(--text-tertiary); stroke-width: 1.5; fill: none; }
        .icon-customize-label { font-size: calc(10px * var(--font-scale)); color: var(--text-tertiary); }

        .storage-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px; padding: 16px; margin-bottom: 20px;
        }
        .storage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .storage-title { font-size: calc(13px * var(--font-scale)); font-weight: 500; color: var(--text-primary); }
        .storage-size { font-size: calc(12px * var(--font-scale)); color: var(--text-secondary); }
        .storage-bar {
            height: 6px;
            background: var(--bg-glass);
            border-radius: 3px; overflow: hidden; margin-bottom: 8px;
        }
        .storage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.5));
            border-radius: 3px; transition: width 0.3s ease;
        }
        .storage-bar-fill.warning { background: linear-gradient(90deg, var(--accent-rose), #8a4a5d); }
        .storage-bar-fill.danger { background: linear-gradient(90deg, var(--danger), #a04040); }
        .storage-details { display: flex; justify-content: space-between; font-size: calc(11px * var(--font-scale)); color: var(--text-tertiary); }

        .preset-selector { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
        .preset-selector select { flex: 1; }
        .preset-btn {
            width: 40px; height: 40px; border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .preset-btn:hover { background: var(--bg-glass-hover); color: var(--text-primary); }
        .preset-btn:active { transform: scale(0.94); }
        .preset-btn svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 1.5; fill: none; }

        .guide-content { max-height: 50vh; overflow-y: auto; padding-right: 8px; }
        .guide-section { margin-bottom: 18px; }
        .guide-section-title { font-size: calc(12px * var(--font-scale)); font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .guide-code {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 10px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px; color: var(--text-secondary);
            margin-bottom: 8px; overflow-x: auto;
        }
        .guide-text { font-size: calc(12px * var(--font-scale)); color: var(--text-secondary); line-height: 1.6; }

        .chat-wallpaper-preview {
            width: 100%; height: 100px;
            border-radius: 12px; margin-bottom: 14px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-tertiary); font-size: calc(12px * var(--font-scale));
            overflow: hidden;
        }
        .chat-wallpaper-preview.has-image {
            background-size: cover !important;
            background-position: center !important;
        }
        .chat-wallpaper-preview.has-image span { display: none; }

        .worldbook-multi-select {
            max-height: 160px; overflow-y: auto;
            border: 1px solid var(--border-subtle);
            border-radius: 12px; background: var(--bg-glass);
        }
        .worldbook-multi-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer; transition: var(--transition-fast);
        }
        .worldbook-multi-item:last-child { border-bottom: none; }
        .worldbook-multi-item:hover { background: var(--bg-glass-hover); }
        .worldbook-multi-checkbox {
            width: 22px; height: 22px; border-radius: 6px;
            border: 2px solid var(--border-accent);
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-fast);
        }
        .worldbook-multi-checkbox.checked {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }
        .worldbook-multi-checkbox.checked::after { content: '✓'; color: white; font-size: 12px; font-weight: 600; }
        .worldbook-multi-name { font-size: calc(14px * var(--font-scale)); color: var(--text-primary); }

        .font-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .font-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; cursor: pointer;
            transition: var(--transition-fast);
        }
        .font-item:hover { border-color: var(--border-accent); }
        .font-item.selected { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); }
        .font-item-info { flex: 1; }
        .font-item-name { font-size: calc(14px * var(--font-scale)); color: var(--text-primary); margin-bottom: 2px; }
        .font-item-preview { font-size: calc(11px * var(--font-scale)); color: var(--text-tertiary); }
        .font-item-actions { display: flex; gap: 8px; }
        .font-item-btn {
            width: 32px; height: 32px; border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-glass);
            color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .font-item-btn:hover { background: var(--bg-glass-hover); }
        .font-item-btn.danger { border-color: rgba(199, 80, 80, 0.3); }
        .font-item-btn.danger:hover { background: rgba(199, 80, 80, 0.1); }
        .font-item-btn svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 1.5; fill: none; }

        /* Color Picker - Classic Wheel + Square Design */
        .color-picker-container {
            width: 100%; max-width: 280px; margin: 0 auto 16px;
            position: relative;
        }
        .color-wheel-wrapper {
            position: relative; width: 260px; height: 260px; margin: 0 auto;
            touch-action: none; user-select: none;
        }
        .color-ring-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
        }
        .color-square-canvas {
            position: absolute;
            top: 50%; left: 50%;
            width: 110px; height: 110px;
            transform: translate(-50%, -50%);
            border-radius: 6px;
            cursor: crosshair;
        }
        .color-ring-handle {
            position: absolute; width: 24px; height: 24px;
            border: 3px solid white; border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.6), inset 0 0 0 2px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
            transition: none;
        }
        .color-square-handle {
            position: absolute; width: 20px; height: 20px;
            border: 3px solid white; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.6), inset 0 0 0 2px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
            transition: none;
        }
        .color-hex-input {
            width: 100%; padding: 12px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px; color: var(--text-primary);
            font-size: calc(14px * var(--font-scale));
            font-family: 'SF Mono', monospace;
            text-align: center; outline: none;
            text-transform: uppercase;
            margin-top: 12px;
        }
        .color-hex-input:focus { border-color: rgba(255,255,255,0.3); }
        .color-preview-swatch {
            width: 48px; height: 48px; border-radius: 12px;
            border: 2px solid var(--border-accent);
            margin: 0 auto 16px;
        }

        /* Bubble Style Options */
        .bubble-style-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; margin-bottom: 16px;
        }
        .bubble-style-option {
            padding: 12px 8px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            text-align: center; cursor: pointer;
            transition: var(--transition-fast);
        }
        .bubble-style-option:hover { background: var(--bg-glass-hover); }
        .bubble-style-option.selected { border-color: rgba(255,255,255,0.4); background: rgba(255,255,255,0.08); }
        .bubble-style-option-name { font-size: calc(11px * var(--font-scale)); color: var(--text-primary); }

        .bubble-preview-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px; padding: 16px;
            margin-bottom: 16px;
        }
        .bubble-preview-sent, .bubble-preview-received {
            padding: 10px 14px; border-radius: 14px;
            font-size: calc(12px * var(--font-scale)); max-width: 70%;
            margin-bottom: 8px;
        }
        .bubble-preview-sent { margin-left: auto; text-align: right; }
        .bubble-preview-received { margin-right: auto; }

        .color-section { margin-bottom: 20px; }
        .color-section-title {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .color-btn-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .color-btn {
            flex: 1; padding: 12px 10px;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            gap: 8px; cursor: pointer;
            transition: var(--transition-fast);
            min-height: 48px;
        }
        .color-btn:hover { background: var(--bg-glass-hover); }
        .color-btn:active { transform: scale(0.98); }
        .color-swatch {
            width: 24px; height: 24px;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }
        .color-btn-label { font-size: calc(11px * var(--font-scale)); color: var(--text-primary); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        #customCssStyles { }
    </style>
    <style>
        /* Voice Chat & Archive CSS */
        .voice-chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 2100; display: flex; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease; overflow: hidden; }
        .voice-chat-overlay.active { opacity: 1; visibility: visible; }
        .stars-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; background-image: radial-gradient(1px 1px at 10% 10%, white, transparent), radial-gradient(1px 1px at 20% 20%, white, transparent), radial-gradient(2px 2px at 30% 30%, rgba(255,255,255,0.5), transparent), radial-gradient(1px 1px at 40% 40%, white, transparent), radial-gradient(1px 1px at 50% 50%, white, transparent), radial-gradient(2px 2px at 60% 60%, rgba(255,255,255,0.5), transparent); background-size: 200px 200px; animation: starsMove 100s linear infinite; }
        @keyframes starsMove { from { transform: translateY(0); } to { transform: translateY(-1000px); } }
        .voice-header { padding-top: calc(40px + var(--safe-top)); display: flex; flex-direction: column; align-items: center; z-index: 2; flex-shrink: 0; position: relative; }
        .voice-minimize-btn { position: absolute; top: calc(10px + var(--safe-top)); right: 20px; width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; z-index: 10; }
        .planet-avatar-container { position: relative; width: 120px; height: 120px; margin-bottom: 10px; margin-top: 20px; }
        .planet-avatar { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px rgba(255,255,255,0.1); z-index: 2; border: 2px solid rgba(255,255,255,0.2); }
        .planet-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .planet-ring { position: absolute; top: 50%; left: 50%; width: 140px; height: 140px; border: 2px solid rgba(255,255,255,0.15); border-radius: 50%; transform: translate(-50%, -50%) rotateX(60deg) rotateY(10deg); box-shadow: 0 0 10px rgba(255,255,255,0.05); z-index: 1; animation: ringSpin 20s linear infinite; }
        .planet-ring::after { content: ''; position: absolute; top: -2px; left: 50%; width: 6px; height: 6px; background: white; border-radius: 50%; box-shadow: 0 0 10px white; }
        @keyframes ringSpin { from { transform: translate(-50%, -50%) rotateX(60deg) rotateY(10deg) rotate(0deg); } to { transform: translate(-50%, -50%) rotateX(60deg) rotateY(10deg) rotate(360deg); } }
        .voice-status { font-family: var(--font-serif); font-size: 14px; color: rgba(255,255,255,0.6); letter-spacing: 2px; text-transform: uppercase; margin-top: 10px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .lyrics-container { flex: 1; width: 100%; overflow-y: auto; padding: 20px 0; z-index: 2; scroll-behavior: smooth; display: flex; flex-direction: column; align-items: center; mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); }
        .lyric-line { width: 100%; text-align: center; padding: 16px 40px; color: rgba(255,255,255,0.2); font-size: 16px; transition: all 0.4s ease; position: relative; cursor: pointer; min-height: 50px; display: flex; align-items: center; justify-content: center; transform: scale(0.9); }
        .lyric-line.active { color: white; font-size: 20px; font-weight: 500; text-shadow: 0 0 15px rgba(255,255,255,0.5); transform: scale(1.05); }
        .lyric-line.active::after { content: ''; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 8px solid white; }
        .lyric-line.user-msg { color: rgba(200, 200, 255, 0.2); }
        .lyric-line.user-msg.active { color: #d0dfff; text-shadow: 0 0 15px rgba(200, 200, 255, 0.5); }
        .lyric-line.sound-effect { font-style: italic; font-size: 14px; color: rgba(255,255,255,0.15); font-family: var(--font-serif); }
        .lyric-line.sound-effect.active { color: rgba(255,255,255,0.7); font-size: 16px; }
        .voice-input-container { padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); z-index: 2; width: 100%; display: flex; flex-direction: column; gap: 14px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .context-menu-item.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        .voice-input-box { width: 100%; background: #151515; border-radius: 24px; border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; padding: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .voice-input-field { flex: 1; background: transparent; border: none; color: white; padding: 12px 16px; font-size: 14px; outline: none; }
        .voice-action-btn { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .voice-action-btn.send { background: white; color: black; }
        .voice-action-btn.ai { background: rgba(255,255,255,0.1); color: white; margin-right: 4px; }
        .voice-controls { display: flex; justify-content: center; gap: 40px; align-items: center; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white; cursor: pointer; transition: all 0.2s; }
        .control-btn.hangup { background: rgba(220, 50, 50, 0.2); border-color: rgba(220, 50, 50, 0.4); color: #ff4d4d; width: 60px; height: 60px; }
        .control-btn:active { transform: scale(0.9); }
        .minimized-voice { position: fixed; top: calc(60px + var(--safe-top)); right: 20px; width: 60px; height: 60px; border-radius: 16px; background: rgba(20, 20, 25, 0.9); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); z-index: 2100; display: none; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: pointer; animation: pulse 2s infinite; transition: transform 0.2s; }
        .minimized-voice:active { transform: scale(0.95); }
        .minimized-voice.active { display: flex; }
        .minimized-voice img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.2); } 70% { box-shadow: 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
        .msg-system-voice { align-self: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 8px 16px; font-size: 12px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 6px; margin: 10px 0; max-width: 80%; user-select: none; }
        .msg-system-voice svg { width: 14px; height: 14px; stroke: currentColor; }
        .archive-list-item { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; }
        .archive-list-item:hover { background: var(--bg-glass-hover); border-color: var(--border-accent); }
        .archive-date { font-size: 14px; color: var(--text-primary); font-weight: 500; }
        .archive-info { font-size: 12px; color: var(--text-tertiary); }
        .summary-container { margin-top: 16px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid var(--border-subtle); display: none; }
        .summary-container.active { display: block; }
        .summary-text { font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px; max-height: 200px; overflow-y: auto; }
    </style>
    <style id="customCssStyles"></style>
</head>
<body>
    <div id="wallpaperLayer"></div>

    <div class="phone-container">
        <div class="status-bar" id="statusBar">
            <span class="status-bar-time" id="statusBarTime">9:41</span>
            <div class="status-bar-icons">
                <svg viewBox="0 0 24 24"><path d="M12 3C7.46 3 3.34 4.78.29 7.67c-.18.18-.29.43-.29.71 0 .28.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73s3.15.25 4.6.73v3.1c0 .4.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71 0-.28-.11-.53-.29-.71C20.66 4.78 16.54 3 12 3z" fill="currentColor"/></svg>
                <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z" fill="currentColor"/></svg>
            </div>
        </div>

        <div class="home-screen" id="homeScreen">
            <div class="home-header">
                <div class="home-brand">Premium Experience</div>
                <div class="home-title">NOIR</div>
                <div class="home-divider"></div>
            </div>

            <div class="app-grid" id="appGrid">
                <div class="app-icon-wrapper" onclick="openPage('settingsPage')">
                    <div class="app-icon" id="appIconSettings">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </div>
                    <span class="app-icon-label">Settings</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('messagesPage')">
                    <div class="app-icon" id="appIconMessages">
                        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <span class="app-icon-label">Messages</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('worldbookPage')">
                    <div class="app-icon" id="appIconWorldbook">
                        <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    </div>
                    <span class="app-icon-label">Lore</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('wallpaperPage')">
                    <div class="app-icon" id="appIconPhotos">
                        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    </div>
                    <span class="app-icon-label">Theme</span>
                </div>

                <div class="app-icon-wrapper" onclick="openPage('fontsPage')">
                    <div class="app-icon" id="appIconFonts">
                        <svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                    </div>
                    <span class="app-icon-label">Fonts</span>
                </div>
            </div>
        </div>

        <div class="home-indicator"></div>

        <!-- Settings Page -->
        <div class="page" id="settingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('settingsPage')">
                    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                    Back
                </button>
                <span class="nav-title">Settings</span>
                <button class="nav-btn" onclick="saveMainSettings()">Save</button>
            </div>
            <div class="page-content">
                <div class="storage-card">
                    <div class="storage-header">
                        <span class="storage-title">Storage Usage</span>
                        <span class="storage-size" id="storageSize">Calculating...</span>
                    </div>
                    <div class="storage-bar"><div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div></div>
                    <div class="storage-details">
                        <span id="storageUsed">Used: 0 MB</span>
                        <span id="storageTotal">Unlimited</span>
                    </div>
                </div>

                <p class="settings-group-title">Display Settings</p>
                <div class="settings-group" style="padding:16px">
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Font Size</span>
                            <span class="slider-value" id="fontScaleValue">100%</span>
                        </div>
                        <input type="range" class="slider-input" id="fontScaleSlider" min="0.7" max="1.4" step="0.05" value="1" oninput="updateFontScalePreview()">
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
                        <span>Compact</span>
                        <span>Standard</span>
                        <span>Large</span>
                    </div>
                </div>

                <p class="settings-group-title">API Configuration</p>
                <div class="settings-group" style="padding:16px">
                    <div class="action-hint" id="connectionStatusHint">
                        <span class="action-hint-icon">⚠</span>
                        <span class="action-hint-text">API not configured</span>
                    </div>

                    <div class="input-group">
                        <label class="input-label">API Preset</label>
                        <div class="preset-selector">
                            <select class="select-field" id="apiPresetSelect" onchange="loadApiPreset()">
                                <option value="">-- No Preset --</option>
                            </select>
                            <button class="preset-btn" onclick="addNewApiPreset()" title="New Preset">
                                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </button>
                            <button class="preset-btn" onclick="saveApiPreset()" title="Save Preset">
                                <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            </button>
                            <button class="preset-btn" onclick="deleteApiPreset()" title="Delete Preset">
                                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">API Endpoint</label>
                        <input type="text" class="input-field" id="apiBaseUrl" placeholder="https://api.example.com">
                    </div>
                    <div class="input-group">
                        <label class="input-label">API Key</label>
                        <input type="password" class="input-field" id="apiKey" placeholder="sk-xxx">
                    </div>
                    <button class="btn btn-secondary" onclick="fetchModels()" id="fetchModelsBtn">Fetch Models</button>
                    <div id="modelListContainer" style="display:none">
                        <label class="input-label" style="margin-top:16px">Available Models</label>
                        <div class="model-list" id="modelList"></div>
                    </div>
                    <div class="input-group" style="margin-top:16px">
                        <label class="input-label">Current Model</label>
                        <input type="text" class="input-field" id="modelName" placeholder="Model name">
                    </div>
                    <div class="btn-stack" style="margin-top:16px">
                        <button class="btn btn-secondary" onclick="testConnection()" id="testConnectionBtn">Test Connection</button>
                        <button class="btn btn-primary" onclick="saveApiSettings()">Save Configuration</button>
                    </div>
                    <div class="divider"></div>
                    <label class="input-label">Debug Log</label>
                    <div class="log-container" id="debugLog"><div class="log-entry info">Waiting...</div></div>
                </div>

                <p class="settings-group-title">Conversation</p>
                <div class="settings-group" style="padding:16px">
                    <div class="input-group">
                        <label class="input-label">Max Memory Messages</label>
                        <input type="number" class="input-field" id="maxContextMessages" value="200">
                    </div>
                </div>

                <p class="settings-group-title">Model Parameters</p>
                <div class="settings-group" style="padding:16px">
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Temperature</span>
                            <span class="slider-value" id="tempValue">0.7</span>
                        </div>
                        <input type="range" class="slider-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempValue').textContent=this.value">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Max Tokens</span>
                            <span class="slider-value" id="maxTokensValue">2048</span>
                        </div>
                        <input type="range" class="slider-input" id="maxTokens" min="256" max="8192" step="256" value="2048" oninput="document.getElementById('maxTokensValue').textContent=this.value">
                    </div>
                </div>

                <p class="settings-group-title">Cache & Storage</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="clearImageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon blue"><svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></span>
                            <div><span class="settings-item-label">Clear Image Cache</span><div class="settings-item-desc">Avatars, wallpapers, etc.</div></div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="clearMessageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon rose"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
                            <div><span class="settings-item-label">Clear Message Cache</span><div class="settings-item-desc">Keep character settings</div></div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="compactDatabase()">
                        <div class="settings-item-left">
                            <span class="settings-icon emerald"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>
                            <div><span class="settings-item-label">Optimize Storage</span><div class="settings-item-desc">Compress images</div></div>
                        </div>
                    </div>
                </div>

                <p class="settings-group-title">Data Management</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="forceSaveAll()">
                        <div class="settings-item-left"><span class="settings-icon emerald"><svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></span><span class="settings-item-label">Force Save</span></div>
                    </div>
                    <div class="settings-item" onclick="exportAllData()">
                        <div class="settings-item-left"><span class="settings-icon blue"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span><span class="settings-item-label">Export Data</span></div>
                    </div>
                    <div class="settings-item" onclick="document.getElementById('importFileInput').click()">
                        <div class="settings-item-left"><span class="settings-icon gold"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></span><span class="settings-item-label">Import Data</span></div>
                    </div>
                    <input type="file" id="importFileInput" class="file-input-hidden" accept=".json" onchange="importData(event)">
                    <div class="settings-item" onclick="clearAllData()">
                        <div class="settings-item-left"><span class="settings-icon danger"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></span><span class="settings-item-label">Clear All Data</span></div>
                    </div>
                </div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- Messages Page -->
        <div class="page" id="messagesPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('messagesPage')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>Back</button>
                <span class="nav-title">Messages</span>
                <button class="nav-btn" onclick="showModal('createCharacterModal')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
            </div>
            <div style="padding:0 16px 14px">
                <input type="text" class="search-field" id="contactSearch" placeholder="Search..." oninput="filterContacts()">
            </div>
            <div class="page-content" id="contactListContainer" style="padding-top:0">
                <div class="empty-state" id="emptyContactState">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                    <div class="empty-state-title">No Characters</div>
                    <div class="empty-state-desc">Tap + to create one</div>
                </div>
                <div class="contact-list" id="contactList" style="display:none"></div>
            </div>
        </div>

        <!-- Chat Page -->
        <div class="page" id="chatPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeChatPage()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>Back</button>
                <span class="nav-title" id="chatTitle">Character</span>
                <button class="nav-btn" onclick="openCharacterSettings()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
            </div>
            <div class="select-mode-bar" id="selectModeBar">
                <span class="select-mode-info">Selected: <span id="selectedCount">0</span></span>
                <div class="select-mode-btns">
                    <button class="select-mode-btn cancel" onclick="exitSelectMode()">Cancel</button>
                    <button class="select-mode-btn delete" onclick="deleteSelectedMessages()">Delete</button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>

                <div class="extension-panel" id="extensionPanel">
                    <div class="ext-panel-header">
                        <span class="ext-panel-title">Actions</span>
                        <button class="ext-panel-close" onclick="toggleExtensionPanel()">✕</button>
                    </div>
                    <button class="ext-btn" onclick="enterSelectMode()">
                        <div class="ext-btn-icon danger"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Select & Delete</div><div class="ext-btn-desc">Batch delete messages</div></div>
                    </button>
                    <button class="ext-btn" onclick="regenerateLastReply()">
                        <div class="ext-btn-icon purple"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Regenerate</div><div class="ext-btn-desc">Regenerate AI response</div></div>
                    </button>
                    <button class="ext-btn" onclick="openImagePicker()">
                        <div class="ext-btn-icon blue"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Send Image</div><div class="ext-btn-desc">Share an image with AI</div></div>
                    </button>
                    <button class="ext-btn" onclick="openSceneImageInput()">
                        <div class="ext-btn-icon emerald"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 15l6-6 4 4 8-8"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Scene Image</div><div class="ext-btn-desc">Describe a scene as image</div></div>
                    </button>
                    <button class="ext-btn" onclick="openVoiceMessageInput()">
                        <div class="ext-btn-icon rose"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Voice Message</div><div class="ext-btn-desc">Send as voice format</div></div>
                    </button>
                    <button class="ext-btn" onclick="confirmVoiceChatRequest()">
                        <div class="ext-btn-icon purple"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Voice Call</div><div class="ext-btn-desc">Start a voice call</div></div>
                    </button>
                    <button class="ext-btn" onclick="openVoiceArchives()">
                        <div class="ext-btn-icon blue"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Call Archives</div><div class="ext-btn-desc">View past call records</div></div>
                    </button>
                </div>

                <div class="chat-input-wrapper">
                    <div class="quote-preview-bar" id="quotePreviewBar">
                        <div class="quote-preview-content" id="quotePreviewContent"></div>
                        <button class="quote-preview-close" onclick="cancelQuote()">✕</button>
                    </div>
                    <div class="chat-input-area">
                        <button class="chat-btn" onclick="toggleExtensionPanel()" title="More"><svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
                        <textarea class="chat-input-field" id="chatInput" placeholder="Type a message..." rows="1" oninput="autoResizeTextarea(this)"></textarea>
                        <button class="chat-btn ai" onclick="triggerAIReply()" title="AI Reply"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></button>
                        <button class="chat-btn send" onclick="sendMessage()" title="Send"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
                    </div>
                </div>
            </div>
            <input type="file" id="chatImageInput" class="file-input-hidden" accept="image/*" onchange="handleChatImageUpload(event)">
        </div>

        <div class="context-menu-overlay" id="contextMenuOverlay" onclick="hideContextMenu()">
            <div class="context-menu" id="contextMenu" onclick="event.stopPropagation()">
                <div class="context-menu-item" id="ctxCopy" onclick="copyMessageText()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></div>
                    <span class="context-menu-label">Copy</span>
                </div>
                <div class="context-menu-item" id="ctxQuote" onclick="quoteMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg></div>
                    <span class="context-menu-label">Quote</span>
                </div>
                <div class="context-menu-item" id="ctxEdit" onclick="editMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
                    <span class="context-menu-label">Edit</span>
                </div>
            </div>
        </div>

        <!-- Character Settings Page -->
        <div class="page slide-from-bottom" id="characterSettingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeCharacterSettings()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>Cancel</button>
                <span class="nav-title">Character</span>
                <button class="nav-btn" onclick="saveCharacterSettings()">Save</button>
            </div>
            <div class="page-content">
                <p class="settings-group-title">Chat Management</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="confirmClearAllMessages()">
                        <div class="settings-item-left">
                            <span class="settings-icon danger"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></span>
                            <div><span class="settings-item-label">Clear All Messages</span><div class="settings-item-desc">Delete all chat history</div></div>
                        </div>
                    </div>
                </div>

                <p class="settings-group-title">Bubble Style (This Character)</p>
                <div class="settings-group" style="padding:16px">
                    <div class="bubble-style-grid" id="bubbleStyleGrid">
                        <div class="bubble-style-option selected" data-style="none" onclick="selectBubbleStyle('none')">
                            <div class="bubble-style-option-name">None</div>
                        </div>
                        <div class="bubble-style-option" data-style="glass" onclick="selectBubbleStyle('glass')">
                            <div class="bubble-style-option-name">Glass</div>
                        </div>
                        <div class="bubble-style-option" data-style="metal" onclick="selectBubbleStyle('metal')">
                            <div class="bubble-style-option-name">Metal</div>
                        </div>
                        <div class="bubble-style-option" data-style="solid" onclick="selectBubbleStyle('solid')">
                            <div class="bubble-style-option-name">Solid</div>
                        </div>
                        <div class="bubble-style-option" data-style="neon" onclick="selectBubbleStyle('neon')">
                            <div class="bubble-style-option-name">Neon</div>
                        </div>
                        <div class="bubble-style-option" data-style="gradient" onclick="selectBubbleStyle('gradient')">
                            <div class="bubble-style-option-name">Aurora</div>
                        </div>
                    </div>

                    <div id="bubbleStyleOptions" style="display:none">
                        <div class="bubble-preview-container" id="bubblePreviewContainer">
                            <div class="bubble-preview-received" id="previewReceived">Hello there!</div>
                            <div class="bubble-preview-sent" id="previewSent">Hi, how are you?</div>
                        </div>

                        <div class="color-section">
                            <div class="color-section-title">User Bubble</div>
                            <div class="color-btn-row">
                                <div class="color-btn" onclick="openColorPicker('userBg1')">
                                    <div class="color-swatch" id="swatchUserBg1" style="background:#3c3c41"></div>
                                    <span class="color-btn-label">Color 1</span>
                                </div>
                                <div class="color-btn" onclick="openColorPicker('userBg2')" id="userBg2Btn">
                                    <div class="color-swatch" id="swatchUserBg2" style="background:#2d2d32"></div>
                                    <span class="color-btn-label">Color 2</span>
                                </div>
                            </div>
                            <div class="color-btn-row">
                                <div class="color-btn" onclick="openColorPicker('userText')">
                                    <div class="color-swatch" id="swatchUserText" style="background:#ffffff"></div>
                                    <span class="color-btn-label">Text Color</span>
                                </div>
                            </div>
                        </div>

                        <div class="color-section">
                            <div class="color-section-title">Character Bubble</div>
                            <div class="color-btn-row">
                                <div class="color-btn" onclick="openColorPicker('charBg1')">
                                    <div class="color-swatch" id="swatchCharBg1" style="background:#2d2d32"></div>
                                    <span class="color-btn-label">Color 1</span>
                                </div>
                                <div class="color-btn" onclick="openColorPicker('charBg2')" id="charBg2Btn">
                                    <div class="color-swatch" id="swatchCharBg2" style="background:#232328"></div>
                                    <span class="color-btn-label">Color 2</span>
                                </div>
                            </div>
                            <div class="color-btn-row">
                                <div class="color-btn" onclick="openColorPicker('charText')">
                                    <div class="color-swatch" id="swatchCharText" style="background:#ffffff"></div>
                                    <span class="color-btn-label">Text Color</span>
                                </div>
                            </div>
                        </div>

                        <div id="glassBorderOptions" style="display:none">
                            <div class="settings-item" style="padding:12px 0">
                                <span class="settings-item-label">Border</span>
                                <div class="toggle-switch" id="glassBorderToggle" onclick="toggleGlassBorder()"></div>
                            </div>
                            <div class="slider-container" id="glassBorderWidthContainer" style="display:none">
                                <div class="slider-header">
                                    <span class="slider-label">Border Width</span>
                                    <span class="slider-value" id="glassBorderWidthValue">1px</span>
                                </div>
                                <input type="range" class="slider-input" id="glassBorderWidth" min="0.5" max="3" step="0.5" value="1" oninput="updateGlassBorderWidth()">
                            </div>
                        </div>
                    </div>
                </div>

                <p class="settings-group-title">Chat Wallpaper</p>
                <div class="settings-group" style="padding:16px">
                    <div class="chat-wallpaper-preview" id="chatWallpaperPreview"><span>No custom wallpaper</span></div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="document.getElementById('chatWallpaperInput').click()">Upload</button>
                        <button class="btn btn-secondary btn-small" onclick="clearChatWallpaper()">Clear</button>
                    </div>
                    <input type="file" id="chatWallpaperInput" class="file-input-hidden" accept="image/*" onchange="handleChatWallpaperUpload(event)">
                </div>

                <p class="settings-group-title">Avatars</p>
                <div class="settings-group" style="padding:16px">
                    <label class="input-label">Character Avatar</label>
                    <div class="avatar-upload-area" id="charAvatarUpload" onclick="document.getElementById('charAvatarInput').click()"><svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
                    <input type="file" id="charAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleCharAvatarUpload(event)">
                    <label class="input-label" style="margin-top:16px">User Avatar</label>
                    <div class="avatar-upload-area" id="userAvatarUpload" onclick="document.getElementById('userAvatarInput').click()"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <input type="file" id="userAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleUserAvatarUpload(event)">
                </div>

                <p class="settings-group-title">Avatar Display</p>
                <div class="settings-group" style="padding:16px">
                    <div class="settings-item" style="padding:0 0 12px 0"><span class="settings-item-label">Show Avatar</span><div class="toggle-switch" id="showAvatarToggle" onclick="toggleSwitch(this)"></div></div>
                    <div class="input-group"><label class="input-label">Shape</label><div class="shape-options" id="avatarShapeOptions"><div class="shape-option selected" data-shape="circle" onclick="selectShape(this)">Circle</div><div class="shape-option" data-shape="square" onclick="selectShape(this)">Square</div><div class="shape-option" data-shape="rounded-square" onclick="selectShape(this)">Rounded</div></div></div>
                    <div class="settings-item" style="padding:12px 0"><span class="settings-item-label">Border</span><div class="toggle-switch" id="showBorderToggle" onclick="toggleSwitch(this)"></div></div>
                    <div class="color-picker-row"><span class="color-picker-label">Border Color</span><input type="color" class="color-picker-input" id="borderColorPicker" value="#ffffff"></div>
                </div>

                <p class="settings-group-title">Basic Info</p>
                <div class="settings-group" style="padding:16px">
                    <div class="input-group"><label class="input-label">Name</label><input type="text" class="input-field" id="charName" placeholder="Character name"></div>
                    <div class="input-group"><label class="input-label">Nickname (Display Only)</label><input type="text" class="input-field" id="charNickname" placeholder="Custom display name (max 30 chars)" maxlength="30" oninput="updateNicknameCharCounter()"><div class="char-counter" id="nicknameCharCounter">0/30</div></div>
                    <div class="input-group"><label class="input-label">Emoji (fallback)</label><input type="text" class="input-field" id="charAvatar" placeholder="◇"></div>
                </div>

                <p class="settings-group-title">Character Description</p>
                <div class="settings-group" style="padding:16px"><textarea class="input-field" id="charDescription" rows="5" placeholder="Personality, background..."></textarea></div>

                <p class="settings-group-title">First Message (300 chars)</p>
                <div class="settings-group" style="padding:16px">
                    <textarea class="input-field" id="charGreeting" rows="2" maxlength="300" placeholder="Opening message..." oninput="updateCharCounter()"></textarea>
                    <div class="char-counter" id="greetingCharCounter">0/300</div>
                </div>

                <p class="settings-group-title">Scenario</p>
                <div class="settings-group" style="padding:16px"><textarea class="input-field" id="charScenario" rows="2" placeholder="Scene setting..."></textarea></div>

                <p class="settings-group-title">Linked Worldbooks</p>
                <div class="settings-group" style="padding:16px"><div class="worldbook-multi-select" id="worldbookMultiSelect"></div></div>

                <p class="settings-group-title">Advanced</p>
                <div class="settings-group" style="padding:16px">
                    <div class="input-group"><label class="input-label">User's Name</label><input type="text" class="input-field" id="charUserNick" placeholder="What is the user's name/identity?"></div>
                    <div class="input-group"><label class="input-label">System Prompt</label><textarea class="input-field" id="charSystemPrompt" rows="2" placeholder="Additional instructions..."></textarea></div>
                </div>

                <p class="settings-group-title">Custom CSS Styling</p>
                <div class="settings-group" style="padding:16px">
                    <div class="action-hint warning"><span class="action-hint-icon">⚠</span><span class="action-hint-text">Custom CSS overrides bubble style settings</span></div>
                    <div class="input-group">
                        <label class="input-label">CSS Preset</label>
                        <div class="preset-selector">
                            <select class="select-field" id="cssPresetSelect" onchange="loadCssPreset()"><option value="">-- No Preset --</option></select>
                            <button class="preset-btn" onclick="addNewCssPreset()" title="New"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                            <button class="preset-btn" onclick="saveCssPreset()" title="Save"><svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                            <button class="preset-btn" onclick="deleteCssPreset()" title="Delete"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            <button class="preset-btn" onclick="showCssGuide()" title="Guide"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button>
                        </div>
                    </div>
                    <div class="input-group"><label class="input-label">Timestamp Position</label><select class="select-field" id="timestampPosition"><option value="default">Default (inside bubble)</option><option value="hidden">Hidden</option><option value="side">Beside bubble</option></select></div>
                    <div class="input-group"><label class="input-label">Custom CSS Code</label><textarea class="input-field css-editor" id="customCssEditor" rows="8" placeholder="/* Enter custom CSS here */"></textarea></div>
                    <div class="btn-row"><button class="btn btn-secondary btn-small" onclick="previewCss()">Preview</button><button class="btn btn-danger btn-small" onclick="clearCustomCss()">Clear CSS</button></div>
                </div>

                <div class="delete-zone" onclick="deleteCurrentCharacter()">Delete Character</div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- Worldbook Page -->
        <div class="page" id="worldbookPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('worldbookPage')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>Back</button>
                <span class="nav-title">Lore</span>
                <button class="nav-btn" onclick="showModal('createWorldbookModal')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
            </div>
            <div class="page-content">
                <div class="action-hint"><span class="action-hint-icon">📚</span><span class="action-hint-text">Each worldbook can contain multiple entries</span></div>
                <div class="empty-state" id="emptyWorldbookState"><div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div><div class="empty-state-title">No Worldbooks</div><div class="empty-state-desc">Tap + to create</div></div>
                <div id="worldbookList" style="display:none"></div>
            </div>
        </div>

        <!-- Worldbook Edit Page -->
        <div class="page slide-from-bottom" id="worldbookEditPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeWorldbookEdit()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>Cancel</button>
                <span class="nav-title">Edit Lore</span>
                <button class="nav-btn" onclick="saveWorldbook()">Save</button>
            </div>
            <div class="page-content">
                <div class="settings-group" style="padding:16px">
                    <div class="input-group"><label class="input-label">Worldbook Name</label><input type="text" class="input-field" id="worldbookName" placeholder="Name"></div>
                    <div class="input-group"><label class="input-label">Summary</label><textarea class="input-field" id="worldbookSummary" rows="2" placeholder="Brief description..."></textarea></div>
                </div>
                <p class="settings-group-title">Entries</p>
                <div class="settings-group" style="padding:16px">
                    <div class="worldbook-entries" id="worldbookEntries"></div>
                    <button class="btn btn-secondary" onclick="addWorldbookEntry()">+ Add Entry</button>
                </div>
                <div class="delete-zone" onclick="deleteCurrentWorldbook()">Delete Worldbook</div>
                <div style="height:40px"></div>
            </div>
        </div>

        <div class="modal-overlay" id="entryEditModal">
            <div class="modal">
                <div class="modal-title">Edit Entry</div>
                <div class="input-group"><label class="input-label">Entry Name</label><input type="text" class="modal-input" id="entryName" placeholder="Name" style="margin-bottom:12px"></div>
                <div class="input-group"><label class="input-label">Trigger Keywords (comma-separated)</label><input type="text" class="modal-input" id="entryKeywords" placeholder="keyword1, keyword2..." style="margin-bottom:12px"></div>
                <div class="input-group"><label class="input-label">Content</label><textarea class="input-field" id="entryContent" rows="5" placeholder="Entry content..."></textarea></div>
                <div class="settings-item" style="padding:12px 0"><span class="settings-item-label">Always Active</span><div class="toggle-switch" id="entryAlwaysActive" onclick="toggleSwitch(this)"></div></div>
                <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('entryEditModal')">Cancel</button><button class="modal-btn confirm" onclick="saveWorldbookEntry()">Save</button></div>
            </div>
        </div>

        <!-- Wallpaper Page -->
        <div class="page" id="wallpaperPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('wallpaperPage')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>Back</button>
                <span class="nav-title">Theme</span>
                <div class="nav-btn" style="visibility:hidden">X</div>
            </div>
            <div class="page-content">
                <p class="settings-group-title">Display</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="toggleStatusBar()">
                        <div class="settings-item-left">
                            <span class="settings-icon blue"><svg viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></span>
                            <div><span class="settings-item-label">Hide Status Bar</span><div class="settings-item-desc">Avoid overlap with system bar</div></div>
                        </div>
                        <div class="toggle-switch" id="hideStatusBarToggle"></div>
                    </div>
                </div>

                <p class="settings-group-title">Preview</p>
                <div class="wallpaper-preview" id="wallpaperPreview"></div>

                <p class="settings-group-title">Preset Wallpapers</p>
                <div class="settings-group" style="padding:16px">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px" id="wallpaperGrid">
                        <div onclick="selectPresetWallpaper('gradient1')" style="height:70px;border-radius:10px;background:linear-gradient(135deg,#0a0a0a,#1a1a1a,#0f0f0f);cursor:pointer;border:2px solid transparent" data-wp="gradient1"></div>
                        <div onclick="selectPresetWallpaper('gradient2')" style="height:70px;border-radius:10px;background:linear-gradient(135deg,#1a1520,#0d1a15);cursor:pointer;border:2px solid transparent" data-wp="gradient2"></div>
                        <div onclick="selectPresetWallpaper('gradient3')" style="height:70px;border-radius:10px;background:linear-gradient(135deg,#0f0c16,#1a1530,#12121a);cursor:pointer;border:2px solid transparent" data-wp="gradient3"></div>
                        <div onclick="selectPresetWallpaper('gradient4')" style="height:70px;border-radius:10px;background:linear-gradient(135deg,#0d1015,#151a20);cursor:pointer;border:2px solid transparent" data-wp="gradient4"></div>
                        <div onclick="selectPresetWallpaper('gradient5')" style="height:70px;border-radius:10px;background:linear-gradient(180deg,#101010,#1a1a1a);cursor:pointer;border:2px solid transparent" data-wp="gradient5"></div>
                        <div onclick="selectPresetWallpaper('gradient6')" style="height:70px;border-radius:10px;background:linear-gradient(135deg,#0f0d12,#201a28);cursor:pointer;border:2px solid transparent" data-wp="gradient6"></div>
                    </div>
                </div>

                <p class="settings-group-title">Custom</p>
                <div class="settings-group" style="padding:16px">
                    <div class="input-group"><label class="input-label">Image URL</label><input type="text" class="input-field" id="customWallpaperUrl" placeholder="https://..."></div>
                    <button class="btn btn-secondary" onclick="previewUrlWallpaper()">Preview URL</button>
                    <div class="divider"></div>
                    <button class="btn btn-secondary" onclick="document.getElementById('wallpaperUpload').click()">Upload Image</button>
                    <input type="file" id="wallpaperUpload" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
                </div>

                <button class="btn btn-primary" onclick="saveWallpaper()" style="margin-bottom:20px">Apply Wallpaper</button>

                <p class="settings-group-title">App Icons</p>
                <div class="settings-group" style="padding:16px">
                    <div class="icon-customize-grid">
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewSettings" onclick="document.getElementById('iconInputSettings').click()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
                            <span class="icon-customize-label">Settings</span>
                            <input type="file" id="iconInputSettings" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'settings')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewMessages" onclick="document.getElementById('iconInputMessages').click()"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                            <span class="icon-customize-label">Messages</span>
                            <input type="file" id="iconInputMessages" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'messages')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewWorldbook" onclick="document.getElementById('iconInputWorldbook').click()"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>
                            <span class="icon-customize-label">Lore</span>
                            <input type="file" id="iconInputWorldbook" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'worldbook')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewPhotos" onclick="document.getElementById('iconInputPhotos').click()"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
                            <span class="icon-customize-label">Theme</span>
                            <input type="file" id="iconInputPhotos" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'photos')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewFonts" onclick="document.getElementById('iconInputFonts').click()"><svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg></div>
                            <span class="icon-customize-label">Fonts</span>
                            <input type="file" id="iconInputFonts" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'fonts')">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <button class="btn btn-primary" onclick="saveIcons()">Save Icons</button>
                    <div style="height:8px"></div>
                    <button class="btn btn-secondary" onclick="resetIcons()">Reset to Default</button>
                </div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- Fonts Page -->
        <div class="page" id="fontsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('fontsPage')"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>Back</button>
                <span class="nav-title">Fonts</span>
                <button class="nav-btn" onclick="showModal('addFontModal')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
            </div>
            <div class="page-content">
                <div class="action-hint"><span class="action-hint-icon">✦</span><span class="action-hint-text">Select a font to apply globally</span></div>
                <p class="settings-group-title">Available Fonts</p>
                <div class="font-list" id="fontList"></div>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <div class="modal-overlay" id="createCharacterModal">
        <div class="modal">
            <div class="modal-title">New Character</div>
            <input type="text" class="modal-input" id="newCharacterName" placeholder="Character name...">
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('createCharacterModal')">Cancel</button><button class="modal-btn confirm" onclick="createCharacter()">Create</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="createWorldbookModal">
        <div class="modal">
            <div class="modal-title">New Worldbook</div>
            <input type="text" class="modal-input" id="newWorldbookName" placeholder="Worldbook name...">
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('createWorldbookModal')">Cancel</button><button class="modal-btn confirm" onclick="createWorldbook()">Create</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal">
            <div class="modal-title" id="deleteModalTitle">Confirm Delete?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:calc(13px * var(--font-scale))" id="deleteModalDesc">This action cannot be undone.</p>
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('confirmDeleteModal')">Cancel</button><button class="modal-btn confirm" style="background:var(--danger)" onclick="confirmDelete()">Delete</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="clearMessagesModal">
        <div class="modal">
            <div class="modal-title">Clear All Messages</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:calc(13px * var(--font-scale))">Delete all chat history with this character?<br>This cannot be undone!</p>
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('clearMessagesModal')">Cancel</button><button class="modal-btn confirm" style="background:var(--danger)" onclick="executeClearAllMessages()">Delete All</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="cssPresetNameModal">
        <div class="modal">
            <div class="modal-title">New CSS Preset</div>
            <input type="text" class="modal-input" id="newCssPresetName" placeholder="Preset name...">
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('cssPresetNameModal')">Cancel</button><button class="modal-btn confirm" onclick="createCssPreset()">Create</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteCssPresetModal">
        <div class="modal">
            <div class="modal-title">Delete CSS Preset?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:calc(13px * var(--font-scale))">Are you sure you want to delete this preset?</p>
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('deleteCssPresetModal')">Cancel</button><button class="modal-btn confirm" style="background:var(--danger)" onclick="confirmDeleteCssPreset()">Delete</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="apiPresetNameModal">
        <div class="modal">
            <div class="modal-title">New API Preset</div>
            <input type="text" class="modal-input" id="newApiPresetName" placeholder="Preset name...">
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('apiPresetNameModal')">Cancel</button><button class="modal-btn confirm" onclick="createApiPreset()">Create</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteApiPresetModal">
        <div class="modal">
            <div class="modal-title">Delete API Preset?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:calc(13px * var(--font-scale))">Are you sure you want to delete this preset?</p>
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('deleteApiPresetModal')">Cancel</button><button class="modal-btn confirm" style="background:var(--danger)" onclick="confirmDeleteApiPreset()">Delete</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="cssGuideModal">
        <div class="modal" style="max-width:400px">
            <div class="modal-title">CSS Customization Guide</div>
            <div class="guide-content">
                <div class="guide-section"><div class="guide-section-title">Message Bubbles</div><div class="guide-code">.message.sent { }<br>.message.received { }</div></div>
                <div class="guide-section"><div class="guide-section-title">Quote Bubble</div><div class="guide-code">.message-quote { }</div></div>
                <div class="guide-section"><div class="guide-section-title">Avatar</div><div class="guide-code">.message-avatar { }</div></div>
                <div class="guide-section"><div class="guide-section-title">Timestamp</div><div class="guide-code">.message-time { }</div></div>
                <div class="guide-section"><div class="guide-section-title">Scene Image Card</div><div class="guide-code">.scene-image-card { }<br>.scene-image-cover { }<br>.scene-image-icon { }<br>.scene-image-footer { }<br>.scene-image-content { }<br>.scene-image-text { }</div><div class="guide-text">Scene image is a clickable card. Click to reveal the description text.</div></div>
                <div class="guide-section"><div class="guide-section-title">Voice Message</div><div class="guide-code">.voice-message { }<br>.voice-message.sent { }<br>.voice-message.received { }<br>.voice-message-header { }<br>.voice-play-btn { }<br>.voice-waveform { }<br>.voice-wave-bar { }<br>.voice-duration { }<br>.voice-text-content { }<br>.voice-text-content p { }<br>.voice-message-time { }</div><div class="guide-text">Voice message displays as a voice bar. Click to reveal the text content below.</div></div>
                <div class="guide-section"><div class="guide-section-title">Input Area</div><div class="guide-code">.chat-input-area { }<br>.chat-input-field { }</div></div>
                <div class="guide-section"><div class="guide-section-title">Nav Bar</div><div class="guide-code">#chatPage .nav-bar { }</div></div>
                <div class="guide-section"><div class="guide-section-title">Example</div><div class="guide-code">.message.sent {<br>  background: rgba(60,60,65,0.8);<br>  border-radius: 20px;<br>}<br><br>.voice-message {<br>  background: rgba(80,60,90,0.6);<br>}<br><br>.scene-image-card {<br>  border: 2px solid purple;<br>}</div></div>
            </div>
            <div class="modal-btns" style="margin-top:20px"><button class="modal-btn confirm" onclick="hideModal('cssGuideModal')">Got It</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="editMessageModal">
        <div class="modal">
            <div class="modal-title">Edit Message</div>
            <textarea class="input-field" id="editMessageContent" rows="4" placeholder="Edit content..."></textarea>
            <div class="modal-btns" style="margin-top:16px"><button class="modal-btn cancel" onclick="hideModal('editMessageModal')">Cancel</button><button class="modal-btn confirm" onclick="saveEditedMessage()">Save</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="addFontModal">
        <div class="modal">
            <div class="modal-title">Add Custom Font</div>
            <div class="input-group"><label class="input-label">Font Name</label><input type="text" class="modal-input" id="newFontName" placeholder="My Custom Font" style="margin-bottom:0"></div>
            <div class="input-group" style="margin-top:16px"><label class="input-label">Font URL (.ttf, .otf, .woff, .woff2)</label><input type="text" class="modal-input" id="newFontUrl" placeholder="https://example.com/font.ttf" style="margin-bottom:0"></div>
            <div class="modal-btns" style="margin-top:20px"><button class="modal-btn cancel" onclick="hideModal('addFontModal')">Cancel</button><button class="modal-btn confirm" onclick="addCustomFont()">Add Font</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteFontModal">
        <div class="modal">
            <div class="modal-title">Delete Font?</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:calc(13px * var(--font-scale))">Are you sure you want to delete this font?</p>
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('deleteFontModal')">Cancel</button><button class="modal-btn confirm" style="background:var(--danger)" onclick="confirmDeleteFont()">Delete</button></div>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div class="modal-overlay" id="colorPickerModal">
        <div class="modal" style="max-width:320px">
            <div class="modal-title">Select Color</div>
            <div class="color-preview-swatch" id="colorPickerPreview"></div>
            <div class="color-picker-container">
                <div class="color-wheel-wrapper" id="colorWheelWrapper">
                    <canvas id="colorRingCanvas" class="color-ring-canvas" width="260" height="260"></canvas>
                    <canvas id="colorSquareCanvas" class="color-square-canvas" width="110" height="110"></canvas>
                    <div class="color-ring-handle" id="ringHandle"></div>
                    <div class="color-square-handle" id="squareHandle"></div>
                </div>
            </div>
            <input type="text" class="color-hex-input" id="colorHexInput" placeholder="#FFFFFF" maxlength="7" oninput="updateColorFromHex()">
            <div class="modal-btns" style="margin-top:16px"><button class="modal-btn cancel" onclick="hideModal('colorPickerModal')">Cancel</button><button class="modal-btn confirm" onclick="applySelectedColor()">Apply</button></div>
        </div>
    </div>

    <!-- Scene Image Input Modal -->
    <div class="modal-overlay" id="sceneImageModal">
        <div class="modal">
            <div class="modal-title">Send Scene Image</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:16px;font-size:calc(12px * var(--font-scale))">Describe the scene from a third-person perspective. This will appear as a visual image card.</p>
            <textarea class="input-field" id="sceneImageDesc" rows="4" placeholder="A cozy bedroom at night, soft lamplight casting warm shadows on the wall..."></textarea>
            <div class="modal-btns" style="margin-top:16px"><button class="modal-btn cancel" onclick="hideModal('sceneImageModal')">Cancel</button><button class="modal-btn confirm" onclick="sendSceneImage()">Send</button></div>
        </div>
    </div>

    <!-- Voice Message Input Modal -->
    <div class="modal-overlay" id="voiceMessageModal">
        <div class="modal">
            <div class="modal-title">Send Voice Message</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:16px;font-size:calc(12px * var(--font-scale))">Enter what you would say out loud. This will appear as a voice message.</p>
            <textarea class="input-field" id="voiceMessageText" rows="3" placeholder="Hey, I was just thinking about you..."></textarea>
            <div class="modal-btns" style="margin-top:16px"><button class="modal-btn cancel" onclick="hideModal('voiceMessageModal')">Cancel</button><button class="modal-btn confirm" onclick="sendVoiceMessage()">Send</button></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Voice Chat Overlay -->
    <div class="voice-chat-overlay" id="voiceChatOverlay">
        <div class="stars-bg"></div>
        <div class="voice-header">
            <div class="voice-minimize-btn" onclick="minimizeVoiceChat()"><svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></div>
            <div class="planet-avatar-container">
                <div class="planet-ring"></div>
                <div class="planet-avatar" id="voiceChatAvatar"><img src="" alt=""></div>
            </div>
            <div class="home-title" id="voiceChatName" style="font-size:24px;margin-bottom:0">Character</div>
            <div class="voice-status" id="voiceChatStatus">Connecting...</div>
        </div>
        <div class="lyrics-container" id="voiceLyricsContainer"></div>
        <div class="voice-input-container">
            <div class="voice-input-box">
                <input type="text" class="voice-input-field" id="voiceInputField" placeholder="Type a message...">
                <button class="voice-action-btn ai" onclick="triggerVoiceAIReply()"><svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></button>
                <button class="voice-action-btn send" onclick="sendVoiceChatMessage()"><svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
            </div>
            <div class="voice-controls">
                <button class="control-btn hangup" onclick="endVoiceChat()"><svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:2"><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"/></svg></button>
            </div>
        </div>
    </div>

    <div class="minimized-voice" id="minimizedVoice" onclick="maximizeVoiceChat()">
        <img id="minimizedVoiceAvatar" src="">
    </div>

    <div class="modal-overlay" id="voiceArchiveModal">
        <div class="modal" style="height:80vh;display:flex;flex-direction:column">
            <div class="modal-title">Voice Archives</div>
            <div id="voiceArchiveList" style="flex:1;overflow-y:auto"></div>
            <div class="modal-btns" style="margin-top:16px"><button class="modal-btn cancel" onclick="hideModal('voiceArchiveModal')">Close</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="voiceDetailModal">
        <div class="modal" style="height:85vh;display:flex;flex-direction:column;max-width:400px">
            <div class="modal-title" style="display:flex;justify-content:space-between;align-items:center">
                <span>Call Record</span>
                <button class="btn btn-secondary btn-small" onclick="openSummaryModal()">Summarize</button>
            </div>
            <div id="voiceDetailContent" style="flex:1;overflow-y:auto;background:rgba(0,0,0,0.2);padding:16px;border-radius:12px;margin-bottom:16px;white-space:pre-wrap;font-size:13px;color:var(--text-secondary)"></div>
            <div class="modal-btns"><button class="modal-btn cancel" onclick="hideModal('voiceDetailModal')">Close</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="summaryConfigModal">
        <div class="modal">
            <div class="modal-title">Summarize Call</div>
            <div class="input-group">
                <label class="input-label">Summary Prompt</label>
                <textarea class="input-field" id="summaryPrompt" rows="4">Summarize the key points of this voice conversation between {user} and {char}. Focus on emotional shifts and important information.</textarea>
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('summaryConfigModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="startSummary()">Start Summary</button>
            </div>
            <div class="summary-container" id="summaryResultContainer">
                <div class="summary-text" id="summaryResultText"></div>
                <button class="btn btn-primary" onclick="saveSummaryToWorldBook()">Save as World Book & Bind</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="voiceRequestModal">
        <div class="modal">
            <div class="modal-title">Voice Call</div>
            <p style="text-align:center;color:var(--text-secondary);margin-bottom:20px">Initiate a voice call with <span id="voiceRequestName">Character</span>?</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('voiceRequestModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="startVoiceChatRequest()">Call</button>
            </div>
        </div>
    </div>

    <!-- Audio for click sounds -->
    <audio id="clickSound" preload="auto">
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNBrT2AAAAAAAAAAAAAAAAAAAAAP/7UMQAA8AAAaQAAAAgAAA0gAAABExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//tQxB4DwAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=" type="audio/mp3">
    </audio>

    <script>
        const DB_NAME = 'NoirAppDB';
        const DB_VERSION = 7;
        let db = null;

        const SCENE_IMAGE_COVER = 'https://iili.io/fsAcryG.jpg';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('appData')) database.createObjectStore('appData', { keyPath: 'key' });
                    if (!database.objectStoreNames.contains('images')) database.createObjectStore('images', { keyPath: 'id' });
                };
            });
        }

        function saveToIDB(storeName, key, value) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).put(storeName === 'appData' ? { key, value } : { id: key, data: value });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        function loadFromIDB(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readonly');
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result ? (storeName === 'appData' ? req.result.value : req.result.data) : null);
                req.onerror = () => reject(req.error);
            });
        }

        async function getStorageUsage() {
            try { if (navigator.storage?.estimate) { const est = await navigator.storage.estimate(); return { used: est.usage || 0, quota: est.quota || 0, percent: est.quota ? (est.usage / est.quota * 100) : 0 }; } } catch (e) {}
            return { used: 0, quota: 0, percent: 0 };
        }

        const App = {
            characters: [], worldbooks: [], currentCharId: null, currentWbId: null,
            currentEntryIndex: -1, pendingDeleteType: null, pendingDeleteId: null, models: [],
            connectionStatus: 'disconnected', isSelectMode: false, selectedMsgs: new Set(),
            lastAIStart: -1, tempWallpaper: null, tempIcons: {},
            appIcons: { settings: null, messages: null, worldbook: null, photos: null, fonts: null },
            settings: {
                apiBaseUrl: '', apiKey: '', modelName: '', temperature: 0.7, maxTokens: 2048,
                maxContextMessages: 200, wallpaper: 'gradient1', wallpaperData: null, hideStatusBar: false,
                selectedFontId: null, fontScale: 1
            },
            globalCssPresets: [],
            apiPresets: [],
            fonts: [],
            dataLoaded: false,
            currentQuote: null,
            contextMenuMsgId: null,
            longPressTimer: null,
            editingMsgId: null,
            pendingDeleteFontId: null,
            pendingDeleteCssPresetId: null,
            pendingDeleteApiPresetId: null,
            currentColorTarget: null,
            selectedColor: '#ffffff',
            currentHue: 0,
            saturation: 1,
            brightness: 1,
            colorPickerDragging: null
        };

        const GRADIENTS = {
            gradient1: 'linear-gradient(180deg, #0a0a0a 0%, #111111 50%, #0d0d0d 100%)',
            gradient2: 'linear-gradient(135deg, #1a1520 0%, #0d1a15 100%)',
            gradient3: 'linear-gradient(135deg, #0f0c16 0%, #1a1530 50%, #12121a 100%)',
            gradient4: 'linear-gradient(135deg, #0d1015 0%, #151a20 100%)',
            gradient5: 'linear-gradient(180deg, #101010 0%, #1a1a1a 100%)',
            gradient6: 'linear-gradient(135deg, #0f0d12 0%, #201a28 100%)'
        };

        const DEFAULT_FONTS = [
            { id: 'default', name: 'System Default', url: null, isDefault: true },
            { id: 'noto-serif', name: 'Noto Serif SC', url: 'https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600&display=swap', isGoogleFont: true, isDefault: true },
            { id: 'source-han', name: 'Source Han Sans', url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600&display=swap', isGoogleFont: true, isDefault: true },
            { id: 'lxgw', name: 'LXGW WenKai', url: 'https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css', isGoogleFont: true, isDefault: true },
            { id: 'cormorant', name: 'Cormorant Garamond', url: 'https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&display=swap', isGoogleFont: true, isDefault: true }
        ];

        const DEFAULT_BUBBLE_COLORS = {
            userBg1: '#3c3c41', userBg2: '#2d2d32', userText: '#ffffff',
            charBg1: '#2d2d32', charBg2: '#232328', charText: '#ffffff'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadData();
                updateTime();
                setInterval(updateTime, 60000);
                applyWallpaper();
                applyAppIcons();
                applyStatusBarVisibility();
                applyGlobalFont();
                applyFontScale();
                updateConnectionUI();
                highlightWallpaper();
                updateWallpaperPreview();
                updateIconPreviews();
                updateStorageDisplay();
                renderFontList();
                updateApiPresetSelect();
                initColorPicker();
            } catch (e) { console.error('Init failed:', e); showToast('Initialization failed', 'error'); }
        });

        async function updateStorageDisplay() {
            const usage = await getStorageUsage();
            const usedMB = (usage.used / (1024 * 1024)).toFixed(2);
            document.getElementById('storageSize').textContent = `${usedMB} MB`;
            document.getElementById('storageUsed').textContent = `Used: ${usedMB} MB`;
            document.getElementById('storageTotal').textContent = usage.quota > 0 ? `Quota: ${(usage.quota / (1024 * 1024)).toFixed(0)} MB` : 'Unlimited';
            const barFill = document.getElementById('storageBarFill');
            barFill.style.width = `${Math.min(usage.percent, 100)}%`;
            barFill.className = 'storage-bar-fill' + (usage.percent > 80 ? ' danger' : usage.percent > 60 ? ' warning' : '');
        }

        function updateTime() { document.getElementById('statusBarTime').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); }

        function toggleStatusBar() { App.settings.hideStatusBar = !App.settings.hideStatusBar; applyStatusBarVisibility(); saveData(); }

        function applyStatusBarVisibility() {
            const statusBar = document.getElementById('statusBar');
            const homeScreen = document.getElementById('homeScreen');
            const toggle = document.getElementById('hideStatusBarToggle');
            if (App.settings.hideStatusBar) { statusBar.classList.add('hidden'); homeScreen.classList.add('no-statusbar'); toggle?.classList.add('active'); }
            else { statusBar.classList.remove('hidden'); homeScreen.classList.remove('no-statusbar'); toggle?.classList.remove('active'); }
        }

        async function saveData() {
            try {
                await Promise.all([
                    saveToIDB('appData', 'characters', App.characters),
                    saveToIDB('appData', 'worldbooks', App.worldbooks),
                    saveToIDB('appData', 'settings', App.settings),
                    saveToIDB('appData', 'appIcons', App.appIcons),
                    saveToIDB('appData', 'globalCssPresets', App.globalCssPresets),
                    saveToIDB('appData', 'apiPresets', App.apiPresets),
                    saveToIDB('appData', 'fonts', App.fonts)
                ]);
                return true;
            } catch (e) { console.error('Save failed:', e); return false; }
        }

        async function loadData() {
            try {
                const [characters, worldbooks, settings, icons, presets, apiPresets, fonts] = await Promise.all([
                    loadFromIDB('appData', 'characters'),
                    loadFromIDB('appData', 'worldbooks'),
                    loadFromIDB('appData', 'settings'),
                    loadFromIDB('appData', 'appIcons'),
                    loadFromIDB('appData', 'globalCssPresets'),
                    loadFromIDB('appData', 'apiPresets'),
                    loadFromIDB('appData', 'fonts')
                ]);
                if (characters) App.characters = characters;
                if (worldbooks) App.worldbooks = worldbooks;
                if (settings) App.settings = { ...App.settings, ...settings };
                if (icons) App.appIcons = { ...App.appIcons, ...icons };
                if (presets) App.globalCssPresets = presets;
                if (apiPresets) App.apiPresets = apiPresets;
                if (fonts) App.fonts = fonts;

                DEFAULT_FONTS.forEach(df => { if (!App.fonts.find(f => f.id === df.id)) App.fonts.push(df); });

                App.worldbooks.forEach(wb => { if (!wb.entries) wb.entries = [{ name: 'Default Entry', keywords: wb.keywords || '', content: wb.content || '', alwaysActive: wb.alwaysActive || false }]; });
                App.characters.forEach(c => {
                    if (c.worldbookId && !c.worldbookIds) c.worldbookIds = [c.worldbookId];
                    if (!c.worldbookIds) c.worldbookIds = [];
                    if (!c.bubbleStyle) c.bubbleStyle = 'none';
                    if (!c.bubbleColors) c.bubbleColors = { ...DEFAULT_BUBBLE_COLORS };
                    if (c.glassBorder === undefined) c.glassBorder = false;
                    if (c.glassBorderWidth === undefined) c.glassBorderWidth = 1;
                    if (!c.voiceHistory) c.voiceHistory = [];
                });

                loadSettingsUI();
                if (App.settings.apiBaseUrl && App.settings.apiKey && App.settings.modelName) App.connectionStatus = 'connected';
                App.dataLoaded = true;
                return true;
            } catch (e) { console.error('Load failed:', e); return false; }
        }

        async function forceSaveAll() { if (await saveData()) { await updateStorageDisplay(); showToast('Saved successfully', 'success'); } }

        async function saveMainSettings() {
            App.settings.fontScale = parseFloat(document.getElementById('fontScaleSlider').value);
            applyFontScale();
            await saveData();
            showToast('Settings saved', 'success');
        }

        function updateFontScalePreview() {
            const val = parseFloat(document.getElementById('fontScaleSlider').value);
            document.getElementById('fontScaleValue').textContent = Math.round(val * 100) + '%';
        }

        function applyFontScale() {
            const scale = App.settings.fontScale || 1;
            document.documentElement.style.setProperty('--font-scale', scale);
            document.getElementById('fontScaleSlider').value = scale;
            document.getElementById('fontScaleValue').textContent = Math.round(scale * 100) + '%';
        }

        // ========== 气泡样式相关 ==========
        function initBubbleStyleUI(char) {
            if (!char) return;
            const style = char.bubbleStyle || 'none';
            document.querySelectorAll('#bubbleStyleGrid .bubble-style-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.style === style);
            });
            document.getElementById('bubbleStyleOptions').style.display = style === 'none' ? 'none' : 'block';
            document.getElementById('glassBorderOptions').style.display = style === 'glass' ? 'block' : 'none';
            if (style === 'glass') {
                document.getElementById('glassBorderToggle').classList.toggle('active', char.glassBorder);
                document.getElementById('glassBorderWidthContainer').style.display = char.glassBorder ? 'block' : 'none';
                document.getElementById('glassBorderWidth').value = char.glassBorderWidth || 1;
                document.getElementById('glassBorderWidthValue').textContent = (char.glassBorderWidth || 1) + 'px';
            }
            updateColorSwatches(char);
            updateBubblePreview(char);
        }

        function selectBubbleStyle(style) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            char.bubbleStyle = style;
            document.querySelectorAll('#bubbleStyleGrid .bubble-style-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.style === style);
            });
            document.getElementById('bubbleStyleOptions').style.display = style === 'none' ? 'none' : 'block';
            document.getElementById('glassBorderOptions').style.display = style === 'glass' ? 'block' : 'none';
            updateBubblePreview(char);
        }

        function toggleGlassBorder() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const toggle = document.getElementById('glassBorderToggle');
            toggle.classList.toggle('active');
            char.glassBorder = toggle.classList.contains('active');
            document.getElementById('glassBorderWidthContainer').style.display = char.glassBorder ? 'block' : 'none';
            updateBubblePreview(char);
        }

        function updateGlassBorderWidth() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const val = parseFloat(document.getElementById('glassBorderWidth').value);
            document.getElementById('glassBorderWidthValue').textContent = val + 'px';
            char.glassBorderWidth = val;
            updateBubblePreview(char);
        }

        function updateColorSwatches(char) {
            if (!char || !char.bubbleColors) return;
            const c = char.bubbleColors;
            document.getElementById('swatchUserBg1').style.background = c.userBg1;
            document.getElementById('swatchUserBg2').style.background = c.userBg2;
            document.getElementById('swatchUserText').style.background = c.userText;
            document.getElementById('swatchCharBg1').style.background = c.charBg1;
            document.getElementById('swatchCharBg2').style.background = c.charBg2;
            document.getElementById('swatchCharText').style.background = c.charText;
        }

        function updateBubblePreview(char) {
            if (!char) return;
            const style = char.bubbleStyle || 'none';
            const c = char.bubbleColors || DEFAULT_BUBBLE_COLORS;
            const sent = document.getElementById('previewSent');
            const recv = document.getElementById('previewReceived');
            if (!sent || !recv) return;

            let sentStyle = '', recvStyle = '';
            const glassBorder = char.glassBorder ? `${char.glassBorderWidth || 1}px solid rgba(255,255,255,0.15)` : 'none';

            switch(style) {
                case 'glass':
                    sentStyle = `background:linear-gradient(135deg,${hexToRgba(c.userBg1,0.5)},${hexToRgba(c.userBg2,0.4)});backdrop-filter:blur(12px);border:${glassBorder};color:${c.userText};border-radius:14px 14px 4px 14px`;
                    recvStyle = `background:linear-gradient(135deg,${hexToRgba(c.charBg1,0.5)},${hexToRgba(c.charBg2,0.4)});backdrop-filter:blur(12px);border:${glassBorder};color:${c.charText};border-radius:14px 14px 14px 4px`;
                    break;
                case 'metal':
                    sentStyle = `background:linear-gradient(145deg,${c.userBg1},${c.userBg2});box-shadow:inset 2px 2px 4px rgba(255,255,255,0.1),inset -2px -2px 4px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.3);color:${c.userText};border-radius:14px 14px 4px 14px;border:1px solid rgba(255,255,255,0.1)`;
                    recvStyle = `background:linear-gradient(145deg,${c.charBg1},${c.charBg2});box-shadow:inset 2px 2px 4px rgba(255,255,255,0.1),inset -2px -2px 4px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.3);color:${c.charText};border-radius:14px 14px 14px 4px;border:1px solid rgba(255,255,255,0.1)`;
                    break;
                case 'solid':
                    sentStyle = `background:${c.userBg1};color:${c.userText};border-radius:14px 14px 4px 14px`;
                    recvStyle = `background:${c.charBg1};color:${c.charText};border-radius:14px 14px 14px 4px`;
                    break;
                case 'neon':
                    sentStyle = `background:${hexToRgba(c.userBg1,0.3)};border:1px solid ${c.userBg1};box-shadow:0 0 10px ${hexToRgba(c.userBg1,0.5)},inset 0 0 20px ${hexToRgba(c.userBg1,0.1)};color:${c.userText};border-radius:14px 14px 4px 14px`;
                    recvStyle = `background:${hexToRgba(c.charBg1,0.3)};border:1px solid ${c.charBg1};box-shadow:0 0 10px ${hexToRgba(c.charBg1,0.5)},inset 0 0 20px ${hexToRgba(c.charBg1,0.1)};color:${c.charText};border-radius:14px 14px 14px 4px`;
                    break;
                case 'gradient':
                    sentStyle = `background:linear-gradient(135deg,${c.userBg1},${c.userBg2});color:${c.userText};border-radius:14px 14px 4px 14px;border:1px solid rgba(255,255,255,0.1)`;
                    recvStyle = `background:linear-gradient(135deg,${c.charBg1},${c.charBg2});color:${c.charText};border-radius:14px 14px 14px 4px;border:1px solid rgba(255,255,255,0.1)`;
                    break;
                default:
                    sentStyle = 'background:rgba(60,60,65,0.6);color:#fff;border-radius:14px 14px 4px 14px';
                    recvStyle = 'background:rgba(45,45,50,0.6);color:#fff;border-radius:14px 14px 14px 4px';
            }
            sent.style.cssText = sentStyle;
            recv.style.cssText = recvStyle;
        }

        function hexToRgba(hex, alpha) {
            if (!hex || hex.length < 7) return `rgba(128,128,128,${alpha})`;
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function getBubbleStyleCss(char, type) {
            if (!char) return {};
            const style = char.bubbleStyle || 'none';
            const c = char.bubbleColors || DEFAULT_BUBBLE_COLORS;
            const isSent = type === 'sent';
            const bg1 = isSent ? c.userBg1 : c.charBg1;
            const bg2 = isSent ? c.userBg2 : c.charBg2;
            const text = isSent ? c.userText : c.charText;
            const glassBorder = char.glassBorder ? `${char.glassBorderWidth || 1}px solid rgba(255,255,255,0.15)` : '1px solid rgba(255,255,255,0.06)';

            switch(style) {
                case 'glass':
                    return { background: `linear-gradient(135deg,${hexToRgba(bg1,0.5)},${hexToRgba(bg2,0.4)})`, border: glassBorder, color: text };
                case 'metal':
                    return { background: `linear-gradient(145deg,${bg1},${bg2})`, boxShadow: 'inset 2px 2px 4px rgba(255,255,255,0.1),inset -2px -2px 4px rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)', color: text };
                case 'solid':
                    return { background: bg1, border: 'none', color: text };
                case 'neon':
                    return { background: hexToRgba(bg1,0.3), border: `1px solid ${bg1}`, boxShadow: `0 0 10px ${hexToRgba(bg1,0.5)}`, color: text };
                case 'gradient':
                    return { background: `linear-gradient(135deg,${bg1},${bg2})`, border: '1px solid rgba(255,255,255,0.1)', color: text };
                default:
                    return {};
            }
        }

        function applyBubbleStyles(char) {
            const styleEl = document.getElementById('bubbleStyleSheet');
            if (!char) { styleEl.textContent = ''; return; }
            const style = char.bubbleStyle || 'none';
            if (style === 'none') { styleEl.textContent = ''; return; }

            const c = char.bubbleColors || DEFAULT_BUBBLE_COLORS;
            const glassBorder = char.glassBorder ? `${char.glassBorderWidth || 1}px solid rgba(255,255,255,0.15)` : '1px solid rgba(255,255,255,0.06)';
            let css = '';

            switch(style) {
                case 'glass':
                    css = `.message.sent{background:linear-gradient(135deg,${hexToRgba(c.userBg1,0.5)},${hexToRgba(c.userBg2,0.4)})!important;backdrop-filter:blur(12px)!important;-webkit-backdrop-filter:blur(12px)!important;border:${glassBorder}!important;color:${c.userText}!important}.message.received{background:linear-gradient(135deg,${hexToRgba(c.charBg1,0.5)},${hexToRgba(c.charBg2,0.4)})!important;backdrop-filter:blur(12px)!important;-webkit-backdrop-filter:blur(12px)!important;border:${glassBorder}!important;color:${c.charText}!important}.voice-message.sent{background:linear-gradient(135deg,${hexToRgba(c.userBg1,0.6)},${hexToRgba(c.userBg2,0.5)})!important;border:${glassBorder}!important}.voice-message.received{background:linear-gradient(135deg,${hexToRgba(c.charBg1,0.6)},${hexToRgba(c.charBg2,0.5)})!important;border:${glassBorder}!important}`;
                    break;
                case 'metal':
                    css = `.message.sent{background:linear-gradient(145deg,${c.userBg1},${c.userBg2})!important;box-shadow:inset 2px 2px 4px rgba(255,255,255,0.1),inset -2px -2px 4px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.3)!important;border:1px solid rgba(255,255,255,0.1)!important;color:${c.userText}!important}.message.received{background:linear-gradient(145deg,${c.charBg1},${c.charBg2})!important;box-shadow:inset 2px 2px 4px rgba(255,255,255,0.1),inset -2px -2px 4px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.3)!important;border:1px solid rgba(255,255,255,0.1)!important;color:${c.charText}!important}.voice-message.sent{background:linear-gradient(145deg,${c.userBg1},${c.userBg2})!important}.voice-message.received{background:linear-gradient(145deg,${c.charBg1},${c.charBg2})!important}`;
                    break;
                case 'solid':
                    css = `.message.sent{background:${c.userBg1}!important;border:none!important;color:${c.userText}!important}.message.received{background:${c.charBg1}!important;border:none!important;color:${c.charText}!important}.voice-message.sent{background:${c.userBg1}!important}.voice-message.received{background:${c.charBg1}!important}`;
                    break;
                case 'neon':
                    css = `.message.sent{background:${hexToRgba(c.userBg1,0.3)}!important;border:1px solid ${c.userBg1}!important;box-shadow:0 0 10px ${hexToRgba(c.userBg1,0.5)},inset 0 0 20px ${hexToRgba(c.userBg1,0.1)}!important;color:${c.userText}!important}.message.received{background:${hexToRgba(c.charBg1,0.3)}!important;border:1px solid ${c.charBg1}!important;box-shadow:0 0 10px ${hexToRgba(c.charBg1,0.5)},inset 0 0 20px ${hexToRgba(c.charBg1,0.1)}!important;color:${c.charText}!important}.voice-message.sent{background:${hexToRgba(c.userBg1,0.4)}!important;border:1px solid ${c.userBg1}!important;box-shadow:0 0 8px ${hexToRgba(c.userBg1,0.4)}!important}.voice-message.received{background:${hexToRgba(c.charBg1,0.4)}!important;border:1px solid ${c.charBg1}!important;box-shadow:0 0 8px ${hexToRgba(c.charBg1,0.4)}!important}`;
                    break;
                case 'gradient':
                    css = `.message.sent{background:linear-gradient(135deg,${c.userBg1},${c.userBg2})!important;border:1px solid rgba(255,255,255,0.1)!important;color:${c.userText}!important}.message.received{background:linear-gradient(135deg,${c.charBg1},${c.charBg2})!important;border:1px solid rgba(255,255,255,0.1)!important;color:${c.charText}!important}.voice-message.sent{background:linear-gradient(135deg,${c.userBg1},${c.userBg2})!important}.voice-message.received{background:linear-gradient(135deg,${c.charBg1},${c.charBg2})!important}`;
                    break;
            }
            styleEl.textContent = css;
        }

        // ========== 颜色选择器 ==========
        function initColorPicker() {
            const wrapper = document.getElementById('colorWheelWrapper');
            if (!wrapper) return;

            drawColorRing();
            drawColorSquare(0);
            positionRingHandle(0);
            positionSquareHandle(0.5, 0.5);

            wrapper.addEventListener('mousedown', handleColorPickerStart);
            document.addEventListener('mousemove', handleColorPickerMove);
            document.addEventListener('mouseup', handleColorPickerEnd);

            wrapper.addEventListener('touchstart', handleColorPickerStart, { passive: false });
            document.addEventListener('touchmove', handleColorPickerMove, { passive: false });
            document.addEventListener('touchend', handleColorPickerEnd);
        }

        function drawColorRing() {
            const canvas = document.getElementById('colorRingCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const size = 260, center = size / 2;
            const outerR = 125, innerR = 90;

            ctx.clearRect(0, 0, size, size);

            for (let angle = 0; angle < 360; angle += 0.5) {
                const startAngle = (angle - 0.5) * Math.PI / 180;
                const endAngle = (angle + 0.5) * Math.PI / 180;
                ctx.beginPath();
                ctx.arc(center, center, outerR, startAngle, endAngle);
                ctx.arc(center, center, innerR, endAngle, startAngle, true);
                ctx.closePath();
                ctx.fillStyle = `hsl(${angle}, 100%, 50%)`;
                ctx.fill();
            }
        }

        function drawColorSquare(hue) {
            const canvas = document.getElementById('colorSquareCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const size = 110;

            ctx.clearRect(0, 0, size, size);

            ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.fillRect(0, 0, size, size);

            const gradWhite = ctx.createLinearGradient(0, 0, size, 0);
            gradWhite.addColorStop(0, 'rgba(255,255,255,1)');
            gradWhite.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = gradWhite;
            ctx.fillRect(0, 0, size, size);

            const gradBlack = ctx.createLinearGradient(0, 0, 0, size);
            gradBlack.addColorStop(0, 'rgba(0,0,0,0)');
            gradBlack.addColorStop(1, 'rgba(0,0,0,1)');
            ctx.fillStyle = gradBlack;
            ctx.fillRect(0, 0, size, size);
        }

        function positionRingHandle(hue) {
            const wrapper = document.getElementById('colorWheelWrapper');
            const handle = document.getElementById('ringHandle');
            if (!wrapper || !handle) return;

            const size = 260, center = size / 2;
            const radius = 107.5;
            const angle = hue * Math.PI / 180;

            const x = center + radius * Math.cos(angle);
            const y = center + radius * Math.sin(angle);

            handle.style.left = x + 'px';
            handle.style.top = y + 'px';
            handle.style.background = `hsl(${hue}, 100%, 50%)`;
        }

        function positionSquareHandle(satNorm, brightNorm) {
            const squareCanvas = document.getElementById('colorSquareCanvas');
            const handle = document.getElementById('squareHandle');
            const wrapper = document.getElementById('colorWheelWrapper');
            if (!squareCanvas || !handle || !wrapper) return;

            const wrapperRect = wrapper.getBoundingClientRect();
            const squareRect = squareCanvas.getBoundingClientRect();

            const x = satNorm * squareRect.width;
            const y = (1 - brightNorm) * squareRect.height;

            const handleX = (squareRect.left - wrapperRect.left) + x;
            const handleY = (squareRect.top - wrapperRect.top) + y;

            handle.style.left = handleX + 'px';
            handle.style.top = handleY + 'px';
        }

        function handleColorPickerStart(e) {
            e.preventDefault();
            const wrapper = document.getElementById('colorWheelWrapper');
            const squareCanvas = document.getElementById('colorSquareCanvas');
            const wrapperRect = wrapper.getBoundingClientRect();
            const squareRect = squareCanvas.getBoundingClientRect();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            if (clientX >= squareRect.left && clientX <= squareRect.right &&
                clientY >= squareRect.top && clientY <= squareRect.bottom) {
                App.colorPickerDragging = 'square';
                updateSquareFromEvent(clientX, clientY, squareRect);
            } else {
                const x = clientX - wrapperRect.left - 130;
                const y = clientY - wrapperRect.top - 130;
                const dist = Math.sqrt(x * x + y * y);

                if (dist >= 85 && dist <= 130) {
                    App.colorPickerDragging = 'ring';
                    updateRingFromEvent(clientX, clientY, wrapperRect);
                }
            }
        }

        function handleColorPickerMove(e) {
            if (!App.colorPickerDragging) return;
            e.preventDefault();

            const wrapper = document.getElementById('colorWheelWrapper');
            const squareCanvas = document.getElementById('colorSquareCanvas');
            const wrapperRect = wrapper.getBoundingClientRect();
            const squareRect = squareCanvas.getBoundingClientRect();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            if (App.colorPickerDragging === 'ring') {
                updateRingFromEvent(clientX, clientY, wrapperRect);
            } else if (App.colorPickerDragging === 'square') {
                updateSquareFromEvent(clientX, clientY, squareRect);
            }
        }

        function handleColorPickerEnd() {
            App.colorPickerDragging = null;
        }

        function updateRingFromEvent(clientX, clientY, wrapperRect) {
            const centerX = wrapperRect.left + 130;
            const centerY = wrapperRect.top + 130;
            const dx = clientX - centerX;
            const dy = clientY - centerY;

            let angle = Math.atan2(dy, dx) * 180 / Math.PI;
            if (angle < 0) angle += 360;

            App.currentHue = angle;
            drawColorSquare(angle);
            positionRingHandle(angle);
            updateFinalColor();
        }

        function updateSquareFromEvent(clientX, clientY, squareRect) {
            let x = clientX - squareRect.left;
            let y = clientY - squareRect.top;

            x = Math.max(0, Math.min(x, squareRect.width));
            y = Math.max(0, Math.min(y, squareRect.height));

            App.saturation = x / squareRect.width;
            App.brightness = 1 - (y / squareRect.height);

            positionSquareHandle(App.saturation, App.brightness);
            updateFinalColor();
        }

        function updateFinalColor() {
            const h = App.currentHue;
            const s = App.saturation;
            const v = App.brightness;

            const rgb = hsvToRgb(h, s, v);
            const hex = '#' + rgb.map(c => Math.round(c).toString(16).padStart(2, '0')).join('');

            App.selectedColor = hex;
            document.getElementById('colorHexInput').value = hex.toUpperCase();
            document.getElementById('colorPickerPreview').style.background = hex;

            const handle = document.getElementById('squareHandle');
            if (handle) handle.style.background = hex;
        }

        function hsvToRgb(h, s, v) {
            let r, g, b;
            const i = Math.floor(h / 60) % 6;
            const f = h / 60 - Math.floor(h / 60);
            const p = v * (1 - s);
            const q = v * (1 - f * s);
            const t = v * (1 - (1 - f) * s);

            switch (i) {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                case 5: r = v; g = p; b = q; break;
            }

            return [r * 255, g * 255, b * 255];
        }

        function updateColorFromHex() {
            let hex = document.getElementById('colorHexInput').value.trim();
            if (!hex.startsWith('#')) hex = '#' + hex;
            if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                App.selectedColor = hex;
                document.getElementById('colorPickerPreview').style.background = hex;

                const rgb = hexToRgbArray(hex);
                const hsv = rgbToHsv(rgb[0], rgb[1], rgb[2]);
                App.currentHue = hsv.h;
                App.saturation = hsv.s;
                App.brightness = hsv.v;

                drawColorSquare(hsv.h);
                positionRingHandle(hsv.h);
                positionSquareHandle(hsv.s, hsv.v);
            }
        }

        function hexToRgbArray(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return [r, g, b];
        }

        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            const d = max - min;
            s = max === 0 ? 0 : d / max;

            if (max === min) {
                h = 0;
            } else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h *= 60;
            }

            return { h, s, v };
        }

        function openColorPicker(target) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            App.currentColorTarget = target;
            const currentColor = (char.bubbleColors && char.bubbleColors[target]) || '#ffffff';
            App.selectedColor = currentColor;
            document.getElementById('colorHexInput').value = currentColor.toUpperCase();
            document.getElementById('colorPickerPreview').style.background = currentColor;

            const rgb = hexToRgbArray(currentColor);
            const hsv = rgbToHsv(rgb[0], rgb[1], rgb[2]);
            App.currentHue = hsv.h;
            App.saturation = hsv.s;
            App.brightness = hsv.v;

            drawColorSquare(hsv.h);
            positionRingHandle(hsv.h);
            positionSquareHandle(hsv.s, hsv.v);

            showModal('colorPickerModal');
        }

        function applySelectedColor() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            if (App.currentColorTarget && App.selectedColor) {
                if (!char.bubbleColors) char.bubbleColors = { ...DEFAULT_BUBBLE_COLORS };
                char.bubbleColors[App.currentColorTarget] = App.selectedColor;
                updateColorSwatches(char);
                updateBubblePreview(char);
            }
            hideModal('colorPickerModal');
        }

        // ========== 音效 ==========
        function playClickSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}
        }

        // ========== 以下是完整的核心功能代码 ==========

        async function clearImageCache() {
            if (!confirm('Clear all image cache?')) return;
            App.settings.wallpaperData = null; App.settings.wallpaper = 'gradient1';
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null, fonts: null };
            App.characters.forEach(c => { c.avatarImage = null; c.userAvatar = null; c.chatWallpaper = null; c.messages.forEach(m => { if (m.image) m.image = null; }); });
            await saveData(); applyWallpaper(); applyAppIcons(); updateIconPreviews(); await updateStorageDisplay();
            showToast('Cache cleared', 'success');
        }

        async function clearMessageCache() {
            if (!confirm('Clear all messages?')) return;
            App.characters.forEach(c => { c.messages = []; });
            await saveData(); await updateStorageDisplay(); showToast('Messages cleared', 'success');
        }

        async function compactDatabase() {
            showToast('Optimizing...', 'info');
            for (let c of App.characters) {
                if (c.avatarImage?.length > 50000) c.avatarImage = await compressImage(c.avatarImage, 150, 0.7);
                if (c.userAvatar?.length > 50000) c.userAvatar = await compressImage(c.userAvatar, 150, 0.7);
                if (c.chatWallpaper?.length > 300000) c.chatWallpaper = await compressImage(c.chatWallpaper, 500, 0.7);
                for (let m of c.messages) { if (m.image?.length > 200000) m.image = await compressImage(m.image, 400, 0.7); }
            }
            if (App.settings.wallpaperData?.length > 500000) App.settings.wallpaperData = await compressImage(App.settings.wallpaperData, 600, 0.7);
            for (let k of Object.keys(App.appIcons)) { if (App.appIcons[k]?.length > 30000) App.appIcons[k] = await compressImage(App.appIcons[k], 100, 0.7); }
            await saveData(); await updateStorageDisplay(); showToast('Optimization complete', 'success');
        }

        function compressImage(dataUrl, maxWidth = 400, quality = 0.7) {
            return new Promise((resolve) => {
                if (!dataUrl?.startsWith('data:image')) { resolve(dataUrl); return; }
                const img = new Image();
                img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality)); };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        window.addEventListener('beforeunload', () => { saveData(); });
        setInterval(() => { if (App.dataLoaded) saveData(); }, 30000);

        function loadSettingsUI() {
            document.getElementById('apiBaseUrl').value = App.settings.apiBaseUrl || '';
            document.getElementById('apiKey').value = App.settings.apiKey || '';
            document.getElementById('modelName').value = App.settings.modelName || '';
            document.getElementById('maxContextMessages').value = App.settings.maxContextMessages || 200;
            document.getElementById('temperature').value = App.settings.temperature;
            document.getElementById('tempValue').textContent = App.settings.temperature;
            document.getElementById('maxTokens').value = App.settings.maxTokens;
            document.getElementById('maxTokensValue').textContent = App.settings.maxTokens;
            document.getElementById('fontScaleSlider').value = App.settings.fontScale || 1;
            document.getElementById('fontScaleValue').textContent = Math.round((App.settings.fontScale || 1) * 100) + '%';
        }

        function applyGlobalFont() {
            const styleEl = document.getElementById('globalFontStyle');
            const selectedId = App.settings.selectedFontId;
            if (!selectedId || selectedId === 'default') { styleEl.textContent = ''; return; }
            const font = App.fonts.find(f => f.id === selectedId);
            if (!font) { styleEl.textContent = ''; return; }
            let css = '';
            if (font.isGoogleFont && font.url) css = `@import url('${font.url}');\n`;
            else if (font.url) { const fontName = font.name.replace(/[^a-zA-Z0-9]/g, ''); css = `@font-face { font-family: '${fontName}'; src: url('${font.url}'); }\n`; }
            if (font.isGoogleFont) {
                let familyName = font.name;
                if (font.id === 'noto-serif') familyName = "'Noto Serif SC'";
                else if (font.id === 'source-han') familyName = "'Noto Sans SC'";
                else if (font.id === 'lxgw') familyName = "'LXGW WenKai'";
                else if (font.id === 'cormorant') familyName = "'Cormorant Garamond'";
                css += `* { font-family: ${familyName}, -apple-system, BlinkMacSystemFont, sans-serif !important; }`;
            } else if (font.url) { const fontName = font.name.replace(/[^a-zA-Z0-9]/g, ''); css += `* { font-family: '${fontName}', -apple-system, BlinkMacSystemFont, sans-serif !important; }`; }
            styleEl.textContent = css;
        }

        function renderFontList() {
            const container = document.getElementById('fontList');
            if (!container) return;
            container.innerHTML = App.fonts.map(font => {
                const isSelected = App.settings.selectedFontId === font.id || (!App.settings.selectedFontId && font.id === 'default');
                const isDefault = font.isDefault;
                return `<div class="font-item ${isSelected ? 'selected' : ''}" onclick="selectFont('${font.id}')"><div class="font-item-info"><div class="font-item-name">${escapeHtml(font.name)}</div><div class="font-item-preview">${isDefault ? 'Built-in' : 'Custom'}</div></div>${!isDefault ? `<div class="font-item-actions"><button class="font-item-btn danger" onclick="event.stopPropagation(); promptDeleteFont('${font.id}')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div>` : ''}</div>`;
            }).join('');
        }

        async function selectFont(fontId) {
            App.settings.selectedFontId = fontId;
            applyGlobalFont();
            renderFontList();
            await saveData();
            showToast('Font applied', 'success');
        }

        function promptDeleteFont(fontId) {
            App.pendingDeleteFontId = fontId;
            showModal('deleteFontModal');
        }

        async function confirmDeleteFont() {
            if (App.pendingDeleteFontId) {
                App.fonts = App.fonts.filter(f => f.id !== App.pendingDeleteFontId);
                if (App.settings.selectedFontId === App.pendingDeleteFontId) {
                    App.settings.selectedFontId = 'default';
                    applyGlobalFont();
                }
                renderFontList();
                await saveData();
                showToast('Font deleted', 'success');
            }
            hideModal('deleteFontModal');
            App.pendingDeleteFontId = null;
        }

        async function addCustomFont() {
            const name = document.getElementById('newFontName').value.trim();
            const url = document.getElementById('newFontUrl').value.trim();
            if (!name || !url) { showToast('Please fill all fields', 'error'); return; }
            const id = 'custom-' + Date.now();
            App.fonts.push({ id, name, url, isDefault: false, isGoogleFont: false });
            renderFontList();
            await saveData();
            hideModal('addFontModal');
            document.getElementById('newFontName').value = '';
            document.getElementById('newFontUrl').value = '';
            showToast('Font added', 'success');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function hideModal(id) { document.getElementById(id).classList.remove('active'); }

        function openPage(id) { document.getElementById(id).classList.add('active'); if (id === 'messagesPage') renderContactList(); if (id === 'worldbookPage') renderWorldbookList(); }
        function closePage(id) { document.getElementById(id).classList.remove('active'); }

        function toggleSwitch(el) { el.classList.toggle('active'); }

        function updateConnectionUI() {
            const hint = document.getElementById('connectionStatusHint');
            if (App.connectionStatus === 'connected') {
                hint.className = 'action-hint success';
                hint.innerHTML = '<span class="action-hint-icon">✓</span><span class="action-hint-text">API connected</span>';
            } else {
                hint.className = 'action-hint';
                hint.innerHTML = '<span class="action-hint-icon">⚠</span><span class="action-hint-text">API not configured</span>';
            }
        }

        function addLog(msg, type = 'info') {
            const container = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        async function fetchModels() {
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!baseUrl || !apiKey) { showToast('Enter API URL and Key first', 'error'); return; }
            addLog('Fetching models...', 'info');
            try {
                const res = await fetch(`${baseUrl}/v1/models`, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                App.models = data.data || [];
                document.getElementById('modelListContainer').style.display = 'block';
                document.getElementById('modelList').innerHTML = App.models.map(m => `<div class="model-item" onclick="selectModel('${m.id}')"><span class="model-item-name">${m.id}</span></div>`).join('');
                addLog(`Found ${App.models.length} models`, 'success');
            } catch (e) { addLog(`Fetch failed: ${e.message}`, 'error'); showToast('Failed to fetch models', 'error'); }
        }

        function selectModel(id) {
            document.getElementById('modelName').value = id;
            document.querySelectorAll('.model-item').forEach(el => el.classList.toggle('selected', el.textContent === id));
            addLog(`Selected: ${id}`, 'info');
        }

        async function testConnection() {
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelName').value.trim();
            if (!baseUrl || !apiKey || !model) { showToast('Fill all API fields', 'error'); return; }
            addLog('Testing connection...', 'info');
            try {
                const res = await fetch(`${baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 10 })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                addLog('Connection successful!', 'success');
                showToast('Connection successful!', 'success');
                App.connectionStatus = 'connected';
                updateConnectionUI();
            } catch (e) { addLog(`Test failed: ${e.message}`, 'error'); showToast('Connection failed', 'error'); }
        }

        async function saveApiSettings() {
            App.settings.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            App.settings.apiKey = document.getElementById('apiKey').value.trim();
            App.settings.modelName = document.getElementById('modelName').value.trim();
            App.settings.maxContextMessages = parseInt(document.getElementById('maxContextMessages').value) || 200;
            App.settings.temperature = parseFloat(document.getElementById('temperature').value);
            App.settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            if (App.settings.apiBaseUrl && App.settings.apiKey && App.settings.modelName) App.connectionStatus = 'connected';
            updateConnectionUI();
            await saveData();
            showToast('API settings saved', 'success');
        }

        function updateApiPresetSelect() {
            const select = document.getElementById('apiPresetSelect');
            select.innerHTML = '<option value="">-- No Preset --</option>' + App.apiPresets.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
        }

        function loadApiPreset() {
            const id = document.getElementById('apiPresetSelect').value;
            if (!id) return;
            const preset = App.apiPresets.find(p => p.id === id);
            if (preset) {
                document.getElementById('apiBaseUrl').value = preset.apiBaseUrl || '';
                document.getElementById('apiKey').value = preset.apiKey || '';
                document.getElementById('modelName').value = preset.modelName || '';
                showToast('Preset loaded', 'success');
            }
        }

        function addNewApiPreset() { showModal('apiPresetNameModal'); }

        async function createApiPreset() {
            const name = document.getElementById('newApiPresetName').value.trim();
            if (!name) { showToast('Enter preset name', 'error'); return; }
            const preset = {
                id: 'api-' + Date.now(), name,
                apiBaseUrl: document.getElementById('apiBaseUrl').value.trim(),
                apiKey: document.getElementById('apiKey').value.trim(),
                modelName: document.getElementById('modelName').value.trim()
            };
            App.apiPresets.push(preset);
            updateApiPresetSelect();
            document.getElementById('apiPresetSelect').value = preset.id;
            await saveData();
            hideModal('apiPresetNameModal');
            document.getElementById('newApiPresetName').value = '';
            showToast('Preset created', 'success');
        }

        async function saveApiPreset() {
            const id = document.getElementById('apiPresetSelect').value;
            if (!id) { showToast('Select a preset first', 'error'); return; }
            const preset = App.apiPresets.find(p => p.id === id);
            if (preset) {
                preset.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
                preset.apiKey = document.getElementById('apiKey').value.trim();
                preset.modelName = document.getElementById('modelName').value.trim();
                await saveData();
                showToast('Preset saved', 'success');
            }
        }

        function deleteApiPreset() {
            const id = document.getElementById('apiPresetSelect').value;
            if (!id) { showToast('Select a preset first', 'error'); return; }
            App.pendingDeleteApiPresetId = id;
            showModal('deleteApiPresetModal');
        }

        async function confirmDeleteApiPreset() {
            if (App.pendingDeleteApiPresetId) {
                App.apiPresets = App.apiPresets.filter(p => p.id !== App.pendingDeleteApiPresetId);
                updateApiPresetSelect();
                await saveData();
                showToast('Preset deleted', 'success');
            }
            hideModal('deleteApiPresetModal');
            App.pendingDeleteApiPresetId = null;
        }

        function renderContactList() {
            const list = document.getElementById('contactList');
            const empty = document.getElementById('emptyContactState');
            if (App.characters.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; }
            list.style.display = 'flex'; empty.style.display = 'none';
            list.innerHTML = App.characters.map(c => {
                const lastMsg = c.messages?.[c.messages.length - 1];
                const preview = lastMsg ? (lastMsg.content || '[Image]').substring(0, 30) : 'No messages';
                const time = lastMsg ? formatTime(lastMsg.timestamp) : '';
                const avatarHtml = c.avatarImage ? `<img src="${c.avatarImage}" alt="">` : (c.avatar || '◇');
                return `<div class="contact-item" onclick="openChat('${c.id}')"><div class="contact-avatar">${avatarHtml}</div><div class="contact-info"><div class="contact-name">${escapeHtml(c.name)}</div><div class="contact-preview">${escapeHtml(preview)}</div></div><span class="contact-time">${time}</span></div>`;
            }).join('');
        }

        function filterContacts() {
            const query = document.getElementById('contactSearch').value.toLowerCase();
            document.querySelectorAll('.contact-item').forEach(el => {
                const name = el.querySelector('.contact-name').textContent.toLowerCase();
                el.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }

        function formatTime(ts) {
            if (!ts) return '';
            const d = new Date(ts), now = new Date();
            if (d.toDateString() === now.toDateString()) return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        async function createCharacter() {
            const name = document.getElementById('newCharacterName').value.trim();
            if (!name) { showToast('Enter character name', 'error'); return; }
            const char = {
                id: 'char-' + Date.now(), name, avatar: '◇', description: '', greeting: '', scenario: '',
                systemPrompt: '', userNick: '', messages: [], worldbookIds: [], avatarImage: null, userAvatar: null,
                chatWallpaper: null, showAvatar: true, avatarShape: 'circle', showBorder: false, borderColor: '#ffffff',
                customCss: '', timestampPosition: 'default', cssPresetId: null,
                bubbleStyle: 'none', bubbleColors: { ...DEFAULT_BUBBLE_COLORS }, glassBorder: false, glassBorderWidth: 1
            };
            App.characters.push(char);
            await saveData();
            hideModal('createCharacterModal');
            document.getElementById('newCharacterName').value = '';
            renderContactList();
            showToast('Character created', 'success');
        }

        function openChat(id) {
            App.currentCharId = id;
            const char = App.characters.find(c => c.id === id);
            if (!char) return;
            document.getElementById('chatTitle').textContent = char.nickname || char.name;
            const chatPage = document.getElementById('chatPage');
            if (char.chatWallpaper) {
                chatPage.classList.add('has-custom-bg');
                chatPage.style.background = `url(${char.chatWallpaper})`;
            } else {
                chatPage.classList.remove('has-custom-bg');
                chatPage.style.background = '';
            }
            applyBubbleStyles(char);
            if (char.customCss) document.getElementById('customCssStyles').textContent = char.customCss;
            else document.getElementById('customCssStyles').textContent = '';
            renderMessages();
            chatPage.classList.add('active');
        }

        function closeChatPage() {
            document.getElementById('chatPage').classList.remove('active');
            document.getElementById('bubbleStyleSheet').textContent = '';
            document.getElementById('customCssStyles').textContent = '';
            App.currentCharId = null;
            App.currentQuote = null;
            exitSelectMode();
            renderContactList();
        }

        function renderMessages() {
    const char = App.characters.find(c => c.id === App.currentCharId);
    if (!char) return;
    const container = document.getElementById('chatMessages');
    const timestampPos = char.timestampPosition || 'default';
    let html = '';
    let lastDate = '';

    char.messages.forEach((msg, idx) => {
        const msgDate = new Date(msg.timestamp).toDateString();
        if (msgDate !== lastDate) {
            html += `<div class="date-separator"><span class="date-separator-text">${new Date(msg.timestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</span></div>`;
            lastDate = msgDate;
        }

        const senderType = msg.sender === 'user' ? 'sent' : 'received';
        const showAvatar = char.showAvatar !== false;
        const avatarShape = char.avatarShape || 'circle';
        const showBorder = char.showBorder;
        const borderColor = char.borderColor || '#ffffff';

        let avatarHtml = '';
        if (showAvatar) {
            const avatarImg = senderType === 'sent' ? char.userAvatar : char.avatarImage;
            const avatarContent = avatarImg ? `<img src="${avatarImg}">` : (char.avatar || '◇');
            const borderStyle = showBorder ? `border: 2px solid ${borderColor}` : '';
            avatarHtml = `<div class="message-avatar ${avatarShape}" style="${borderStyle}">${avatarContent}</div>`;
        }

        const timeClass = timestampPos === 'hidden' ? 'time-hidden' : timestampPos === 'side' ? 'time-side' : '';
        const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

        // 运行时解析消息类型和内容
        let msgType = msg.type || 'text';
        let msgContent = msg.content || '';
        let quoteId = msg.quoteId;

        // 如果type不明确，尝试从内容中解析
        if (msgType === 'text' || !msgType) {
            // 检查是否是场景图片格式
            const imgMatch = msgContent.match(/^\[IMG:\s*(.+?)\s*\]$/is);
            if (imgMatch) {
                msgType = 'scene-image';
                msgContent = imgMatch[1].trim();
            }
            // 检查是否是语音消息格式
            const voiceMatch = msgContent.match(/^\[VOICE:\s*(.+?)\s*\]$/is);
            if (voiceMatch) {
                msgType = 'voice';
                msgContent = voiceMatch[1].trim();
            }
            // 检查是否有引用格式
            const quoteMatch = msgContent.match(/^\[Q:#(\d+)\]\s*/i);
            if (quoteMatch) {
                const msgIndex = parseInt(quoteMatch[1]) - 1;
                if (msgIndex >= 0 && msgIndex < char.messages.length) {
                    quoteId = char.messages[msgIndex].id;
                }
                msgContent = msgContent.replace(quoteMatch[0], '').trim();

                // 移除引用后再检查是否是特殊格式
                const imgMatch2 = msgContent.match(/^\[IMG:\s*(.+?)\s*\]$/is);
                if (imgMatch2) {
                    msgType = 'scene-image';
                    msgContent = imgMatch2[1].trim();
                }
                const voiceMatch2 = msgContent.match(/^\[VOICE:\s*(.+?)\s*\]$/is);
                if (voiceMatch2) {
                    msgType = 'voice';
                    msgContent = voiceMatch2[1].trim();
                }
            }
        }

        // 根据解析后的类型渲染
        if (msgType === 'scene-image') {
            html += renderSceneImageMessage({...msg, content: msgContent}, idx, senderType, avatarHtml, time, timeClass);
                } else if (msgType === 'voice') {
                    html += renderVoiceMessage({...msg, content: msgContent}, idx, senderType, avatarHtml, time, timeClass);
                } else if (msgType === 'system-voice') {
                    const isSystem = msg.sender === 'system' || msgContent.toLowerCase().includes('initiated') || msgContent.toLowerCase().includes('ended');
                    
                    if (isSystem) {
                        const icon = '<svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>';
                        html += `<div class="message-wrapper" data-id="${msg.id}" style="justify-content:center">
                            <div class="message-checkbox" onclick="toggleMsgSelect('${msg.id}')"></div>
                            <div class="msg-system-voice" oncontextmenu="showContextMenu(event, '${msg.id}')" ontouchstart="startLongPress('${msg.id}')" ontouchend="endLongPress()" ontouchmove="endLongPress()">
                                ${icon} <span>${escapeHtml(msgContent)}</span>
                            </div>
                        </div>`;
                    } else {
                        const isUser = msg.sender === 'user';
                        const type = isUser ? 'sent' : 'received';
                        const icon = isUser ? 
                            '<svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2"><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"/></svg>' : 
                            '<svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>';
                        
                        html += `<div class="message-wrapper ${type}" data-id="${msg.id}">
                            ${type === 'received' ? avatarHtml : ''}
                            <div class="message-checkbox" onclick="toggleMsgSelect('${msg.id}')"></div>
                            <div class="message ${type}" oncontextmenu="showContextMenu(event, '${msg.id}')" ontouchstart="startLongPress('${msg.id}')" ontouchend="endLongPress()" ontouchmove="endLongPress()">
                                <div class="message-content" style="display:flex;align-items:center;gap:8px">
                                    <span style="display:flex;opacity:0.8">${icon}</span>
                                    <span>${escapeHtml(msgContent)}</span>
                                </div>
                                <div class="message-time ${timeClass}">${time}</div>
                            </div>
                            ${type === 'sent' ? avatarHtml : ''}
                        </div>`;
                    }
                } else {
            // 普通文本消息
            let quoteHtml = '';
            if (quoteId !== undefined && quoteId !== null) {
                const quotedMsg = char.messages.find(m => m.id === quoteId);
                if (quotedMsg) {
                    let quotedContent = quotedMsg.content || '';
                    // 清理引用内容中的格式标记
                    quotedContent = quotedContent.replace(/^\[Q:#\d+\]\s*/i, '');
                    quotedContent = quotedContent.replace(/^\[(IMG|VOICE):\s*/i, '').replace(/\]$/, '');
                    quoteHtml = `<div class="message-quote">${escapeHtml(quotedContent.substring(0, 50))}</div>`;
                }
            }

            let contentHtml = escapeHtml(msgContent);
            if (msg.image) contentHtml += `<img src="${msg.image}" class="message-image" onclick="viewImage(this.src)">`;

            html += `<div class="message-wrapper ${senderType}" data-id="${msg.id}">
                ${senderType === 'received' ? avatarHtml : ''}
                <div class="message-checkbox" onclick="toggleMsgSelect('${msg.id}')"></div>
                <div class="message ${senderType}" oncontextmenu="showContextMenu(event, '${msg.id}')" ontouchstart="startLongPress('${msg.id}')" ontouchend="endLongPress()" ontouchmove="endLongPress()">
                    ${quoteHtml}
                    <div class="message-content">${contentHtml}</div>
                    <div class="message-time ${timeClass}">${time}</div>
                </div>
                ${senderType === 'sent' ? avatarHtml : ''}
            </div>`;
        }
    });

    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
}

        function renderSceneImageMessage(msg, idx, type, avatarHtml, time, timeClass) {
    return `<div class="message-wrapper ${type}" data-id="${msg.id}">
        ${type === 'received' ? avatarHtml : ''}
        <div class="message-checkbox" onclick="toggleMsgSelect('${msg.id}')"></div>
        <div class="scene-image-card" data-id="${msg.id}" oncontextmenu="showContextMenu(event, '${msg.id}')" ontouchstart="startLongPress('${msg.id}')" ontouchend="endLongPress()" ontouchmove="endLongPress()">
            <div class="scene-image-card-inner" onclick="toggleSceneImage(this.parentElement)">
                    <div class="scene-image-cover" style="background-image: url('${SCENE_IMAGE_COVER}')">
                        <div class="scene-image-icon">
                            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        </div>
                    </div>
                    <div class="scene-image-content">
                        <p class="scene-image-text">${escapeHtml(msg.content)}</p>
                        <p class="scene-image-hint">Tap to collapse</p>
                    </div>
                    <div class="scene-image-footer">
                        <div class="scene-image-label">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
                    Scene Image · ${time}
                </div>
            </div>
            </div>
        </div>
        ${type === 'sent' ? avatarHtml : ''}
    </div>`;
}

        function renderVoiceMessage(msg, idx, type, avatarHtml, time, timeClass) {
    const duration = Math.ceil(msg.content.length / 8);
    const waveBars = generateWaveBars();
    return `<div class="message-wrapper ${type}" data-id="${msg.id}">
        ${type === 'received' ? avatarHtml : ''}
        <div class="message-checkbox" onclick="toggleMsgSelect('${msg.id}')"></div>
        <div class="voice-message ${type}" data-id="${msg.id}"
             oncontextmenu="event.preventDefault(); showContextMenu(event, '${msg.id}')"
             ontouchstart="startLongPress('${msg.id}')"
             ontouchend="endLongPress()"
             ontouchmove="endLongPress()">
            <div class="voice-message-header" onclick="toggleVoiceText(this.closest('.voice-message'))">
                <div class="voice-play-btn">
                    <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                </div>
                <div class="voice-waveform">${waveBars}</div>
                <span class="voice-duration">${duration}"</span>
            </div>
            <div class="voice-text-content">
                <p>${escapeHtml(msg.content)}</p>
            </div>
            <div class="voice-message-time">${time}</div>
        </div>
        ${type === 'sent' ? avatarHtml : ''}
    </div>`;
}

        function generateWaveBars() {
            let bars = '';
            const heights = [8, 14, 10, 18, 12, 16, 8, 14, 10, 12, 16, 8, 14, 18, 10];
            for (let i = 0; i < 15; i++) {
                bars += `<div class="voice-wave-bar" style="height:${heights[i]}px"></div>`;
            }
            return bars;
        }

        function toggleSceneImage(el) {
    // 如果是内部元素触发，找到外层card
    const card = el.classList.contains('scene-image-card') ? el : el.closest('.scene-image-card');
    if (card) {
        playClickSound();
        card.classList.toggle('expanded');
    }
}

        function toggleVoiceText(el) {
    const voiceMsg = el.classList.contains('voice-message') ? el : el.closest('.voice-message');
    if (voiceMsg) {
        playClickSound();
        const textContent = voiceMsg.querySelector('.voice-text-content');
        if (textContent) {
            textContent.classList.toggle('visible');
        }
    }
}

        function viewImage(src) {
            window.open(src, '_blank');
        }

        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 100) + 'px';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content) return;
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            const msg = {
                id: 'msg-' + Date.now(),
                sender: 'user',
                content,
                timestamp: Date.now(),
                quoteId: App.currentQuote?.id || null
            };
            char.messages.push(msg);
            input.value = '';
            input.style.height = 'auto';
            cancelQuote();
            renderMessages();
            await saveData();
        }

        function toggleExtensionPanel() {
            document.getElementById('extensionPanel').classList.toggle('active');
        }

        function openImagePicker() {
            document.getElementById('chatImageInput').click();
            toggleExtensionPanel();
        }

        async function handleChatImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (!char) return;
                const compressed = await compressImage(ev.target.result, 400, 0.8);
                const msg = { id: 'msg-' + Date.now(), sender: 'user', content: '', image: compressed, timestamp: Date.now() };
                char.messages.push(msg);
                renderMessages();
                await saveData();
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function openSceneImageInput() {
            toggleExtensionPanel();
            document.getElementById('sceneImageDesc').value = '';
            showModal('sceneImageModal');
        }

        async function sendSceneImage() {
            const desc = document.getElementById('sceneImageDesc').value.trim();
            if (!desc) { showToast('Enter scene description', 'error'); return; }
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            const msg = {
                id: 'msg-' + Date.now(),
                sender: 'user',
                type: 'scene-image',
                content: desc,
                timestamp: Date.now()
            };
            char.messages.push(msg);
            hideModal('sceneImageModal');
            renderMessages();
            await saveData();
        }

        function openVoiceMessageInput() {
            toggleExtensionPanel();
            document.getElementById('voiceMessageText').value = '';
            showModal('voiceMessageModal');
        }

        async function sendVoiceMessage() {
            const text = document.getElementById('voiceMessageText').value.trim();
            if (!text) { showToast('Enter voice message text', 'error'); return; }
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            const msg = {
                id: 'msg-' + Date.now(),
                sender: 'user',
                type: 'voice',
                content: text,
                timestamp: Date.now()
            };
            char.messages.push(msg);
            hideModal('voiceMessageModal');
            renderMessages();
            await saveData();
        }

        function showContextMenu(e, msgId) {
            e.preventDefault();
            App.contextMenuMsgId = msgId;
            const char = App.characters.find(c => c.id === App.currentCharId);
            const msg = char?.messages.find(m => m.id === msgId);
            
            const isSystem = msg && msg.type === 'system-voice';
            const ctxCopy = document.getElementById('ctxCopy');
            const ctxEdit = document.getElementById('ctxEdit');
            
            if (isSystem) {
                ctxCopy.style.opacity = '0.5';
                ctxCopy.style.pointerEvents = 'none';
                ctxEdit.style.opacity = '0.5';
                ctxEdit.style.pointerEvents = 'none';
            } else {
                ctxCopy.style.opacity = '1';
                ctxCopy.style.pointerEvents = 'auto';
                ctxEdit.style.opacity = '1';
                ctxEdit.style.pointerEvents = 'auto';
            }
            
            document.getElementById('contextMenuOverlay').classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenuOverlay').classList.remove('active');
            App.contextMenuMsgId = null;
        }

        function startLongPress(msgId) {
    App.longPressTimer = setTimeout(() => {
        // 创建一个模拟事件用于定位菜单
        showContextMenu({ preventDefault: () => {} }, msgId);
    }, 500);
}

        function endLongPress() {
            if (App.longPressTimer) { clearTimeout(App.longPressTimer); App.longPressTimer = null; }
        }

        function copyMessageText() {
    const char = App.characters.find(c => c.id === App.currentCharId);
    const msg = char?.messages.find(m => m.id === App.contextMenuMsgId);
    if (msg) {
        let textToCopy = msg.content || '';
        // 对于特殊类型，直接复制内容（不带格式标记）
        if (msg.type === 'scene-image' || msg.type === 'voice') {
            textToCopy = msg.content;
        }
        if (textToCopy) {
            navigator.clipboard.writeText(textToCopy);
            showToast('Copied', 'success');
        }
    }
    hideContextMenu();
}

        function quoteMessage() {
    const char = App.characters.find(c => c.id === App.currentCharId);
    const msg = char?.messages.find(m => m.id === App.contextMenuMsgId);
    if (msg) {
        App.currentQuote = msg;
        document.getElementById('quotePreviewBar').classList.add('active');

        let previewText = msg.content || '';
        if (msg.type === 'scene-image') {
            previewText = '[Scene] ' + (msg.content || '').substring(0, 40);
        } else if (msg.type === 'voice') {
            previewText = '[Voice] ' + (msg.content || '').substring(0, 40);
        } else if (msg.image && !msg.content) {
            previewText = '[Image]';
        } else {
            previewText = (msg.content || '[Image]').substring(0, 50);
        }

        document.getElementById('quotePreviewContent').textContent = previewText;
    }
    hideContextMenu();
}

        function cancelQuote() {
            App.currentQuote = null;
            document.getElementById('quotePreviewBar').classList.remove('active');
        }

        function editMessage() {
    const char = App.characters.find(c => c.id === App.currentCharId);
    const msg = char?.messages.find(m => m.id === App.contextMenuMsgId);
    if (msg) {
        App.editingMsgId = msg.id;
        // 直接编辑content内容，不管是什么类型
        document.getElementById('editMessageContent').value = msg.content || '';
        showModal('editMessageModal');
    }
    hideContextMenu();
}

        async function saveEditedMessage() {
    const char = App.characters.find(c => c.id === App.currentCharId);
    const msg = char?.messages.find(m => m.id === App.editingMsgId);
    if (msg) {
        const newContent = document.getElementById('editMessageContent').value.trim();
        // 保持原有类型不变，只更新内容
        msg.content = newContent;
        renderMessages();
        await saveData();
        showToast('Message updated', 'success');
    }
    hideModal('editMessageModal');
    App.editingMsgId = null;
}

        function enterSelectMode() {
            App.isSelectMode = true;
            App.selectedMsgs.clear();
            document.getElementById('chatMessages').classList.add('select-mode');
            document.getElementById('selectModeBar').classList.add('active');
            updateSelectedCount();
            toggleExtensionPanel();
        }

        function exitSelectMode() {
            App.isSelectMode = false;
            App.selectedMsgs.clear();
            document.getElementById('chatMessages').classList.remove('select-mode');
            document.getElementById('selectModeBar').classList.remove('active');
            document.querySelectorAll('.message-checkbox').forEach(el => el.classList.remove('checked'));
        }

        function toggleMsgSelect(id) {
            if (!App.isSelectMode) return;
            if (App.selectedMsgs.has(id)) App.selectedMsgs.delete(id);
            else App.selectedMsgs.add(id);
            document.querySelector(`[data-id="${id}"] .message-checkbox`)?.classList.toggle('checked');
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = App.selectedMsgs.size;
        }

        async function deleteSelectedMessages() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            char.messages = char.messages.filter(m => !App.selectedMsgs.has(m.id));
            exitSelectMode();
            renderMessages();
            await saveData();
            showToast('Messages deleted', 'success');
        }

        function buildAPIMessages(char) {
            let systemContent = `You are ${char.name}. `;
            if (char.description) systemContent += `\n\n[Character Description]\n${char.description}`;
            if (char.scenario) systemContent += `\n\n[Scenario]\n${char.scenario}`;
            if (char.systemPrompt) systemContent += `\n\n[Instructions]\n${char.systemPrompt}`;

            // Process linked worldbooks
            if (char.worldbookIds?.length > 0) {
                const recentMsgs = char.messages.slice(-10).map(m => m.content || '').join(' ').toLowerCase();
                char.worldbookIds.forEach(wbId => {
                    const wb = App.worldbooks.find(w => w.id === wbId);
                    if (wb?.entries) {
                        wb.entries.forEach(entry => {
                            if (entry.alwaysActive) {
                                systemContent += `\n\n[Lore: ${entry.name}]\n${entry.content}`;
                            } else if (entry.keywords) {
                                const keywords = entry.keywords.split(',').map(k => k.trim().toLowerCase());
                                if (keywords.some(k => k && recentMsgs.includes(k))) {
                                    systemContent += `\n\n[Lore: ${entry.name}]\n${entry.content}`;
                                }
                            }
                        });
                    }
                });
            }

            if (char.userNick) systemContent += `\n\n[User's Name/Identity]\nThe user is called "${char.userNick}".`;

            // Enhanced format instructions with scene image and voice message support
            systemContent += `\n\n[Response Format]
You are texting via SMS/messaging app. Respond naturally in ${char.name}'s authentic texting style.

In real texting, people sometimes send a single message or multiple messages depending on their mood and preference. You must fully become ${char.name}, sending text messages continuously as this character based on their personality, contextual logic, and the ongoing plot.

When replying via text, strictly follow these formats:

【Multiple Messages Format】
Use "|||" to separate multiple messages.
Example: "Hey!|||How've you been?|||Just thought of you."
This represents the character sending multiple messages, simulating the feel of consecutive messages in real online texting. The number of separations equals the number of messages sent, mimicking authentic texting style.

【Quoting Messages】
Use [Q:#N] to quote/reply to message #N.
Example: "[Q:#5] I agree with that|||But also..."

【Scene Images (Optional)】
Use [IMG:description] to send a descriptive scene image.
Write the description from an objective third-person perspective.
Example: "Check this out|||[IMG:A cozy café with warm lighting, a latte steaming on a wooden table by the window]|||Beautiful, right?"

【Voice Messages (Optional)】
Use [VOICE:content] to send a voice message.
Write what you would actually say out loud.
Example: "[VOICE:Hey, I was just thinking about you... hope you're doing well]|||Miss you"

【Critical Guidelines】
- These special formats are OPTIONAL - use them only when natural and contextually appropriate
- Do NOT overuse them - most messages should be plain text
- Scene images are for sharing moments, places, or describing what you're seeing
- Voice messages are for more personal, emotional, or casual moments, or based on ${char.name}'s own preferences and personality - be spontaneous, not rigid or repetitive
- Format choices must match ${char.name}'s personality and conversation flow
- The number of messages per reply depends on the situation and character personality. Sending just one message or three to four in a single response is perfectly normal - texting should be completely spontaneous. Reference how a real person texts with natural spontaneity rather than mechanically. DO NOT let the character go overboard! For example: suddenly outputting a flood of messages when it doesn't fit the scenario or character, or being rigid and repetitive in every output is ABSOLUTELY FORBIDDEN! Text content should be three-dimensional, built on completely mimicking reality and treating the character as a fully-realized person, never losing logic or vivacity. Each message varies in length naturally. Consider the scenario and multiple aspects of the character. Strive to show the character's clever and lively side, unless ${char.name}'s setting is that of a fool or stiff person. Adapt based on character settings.
- MOST IMPORTANT: While playing ${char.name}, you should default to treating all messages (voice messages, sharing images, typing) as naturally being sent through the input field. To simulate authenticity. The character should NOT know or think they need to follow the above formats - this is only backend formatting to standardize your roleplay output. When sending messages as the character, you should be COMPLETELY in character, logically and narratively defaulting to sending messages the normal way, never breaking character. While maintaining the output formats above`;

            systemContent += `\n\n[Message History Reference Numbers]\n`;
            const messages = [{ role: 'system', content: systemContent }];
            const maxMsgs = App.settings.maxContextMessages || 200;
            const recentMsgs = char.messages.slice(-maxMsgs);

            recentMsgs.forEach((msg, idx) => {
                const msgNum = idx + 1;
                const role = msg.sender === 'user' ? 'user' : 'assistant';
                let content = msg.content || '';

                // Handle special message types in history
                if (msg.type === 'scene-image') {
                    content = `[IMG:${msg.content}]`;
                } else if (msg.type === 'voice') {
                    content = `[VOICE:${msg.content}]`;
                } else if (msg.type === 'system-voice') {
                    const lower = msg.content.toLowerCase();
                    if (lower.includes('initiated')) content = '[System: User requested voice chat]';
                    else if (lower.includes('rejected')) content = '[System: Character refused voice chat]';
                    else if (lower.includes('cancelled')) content = '[System: User cancelled voice chat request]';
                    else content = `[System: ${msg.content}]`;
                }

                if (msg.image) {
                    messages.push({
                        role, content: [
                            { type: 'text', text: `#${msgNum}: ${content}` },
                            { type: 'image_url', image_url: { url: msg.image } }
                        ]
                    });
                } else {
                    // Merge consecutive same-role messages
                    const lastMsg = messages[messages.length - 1];
                    if (lastMsg && lastMsg.role === role && typeof lastMsg.content === 'string') {
                        lastMsg.content += `|||#${msgNum}: ${content}`;
                    } else {
                        messages.push({ role, content: `#${msgNum}: ${content}` });
                    }
                }
            });

            return messages;
        }

        function parseAIResponse(responseText, char) {
    const parts = responseText.split('|||').map(p => p.trim()).filter(p => p);
    return parts.map(part => {
        let content = part.trim();
        let quoteId = null;
        let type = 'text';

        // 1. 检查引用格式 [Q:#N] - 可以出现在开头，后面可能跟其他内容
        const quoteMatch = content.match(/^\[Q:#(\d+)\]\s*/i);
        if (quoteMatch) {
            const msgIndex = parseInt(quoteMatch[1]) - 1;
            const recentMsgs = char.messages.slice(-(App.settings.maxContextMessages || 200));
            if (msgIndex >= 0 && msgIndex < recentMsgs.length) {
                quoteId = recentMsgs[msgIndex].id;
            }
            content = content.replace(quoteMatch[0], '').trim();
        }

        // 2. 检查场景图片格式 [IMG:description] - 更宽松的匹配
        const imgMatch = content.match(/^\[IMG:\s*(.+?)\s*\]$/is);
        if (imgMatch) {
            type = 'scene-image';
            content = imgMatch[1].trim();
            return { content, quoteId, type };
        }

        // 3. 检查语音消息格式 [VOICE:content] - 更宽松的匹配
        const voiceMatch = content.match(/^\[VOICE:\s*(.+?)\s*\]$/is);
        if (voiceMatch) {
            type = 'voice';
            content = voiceMatch[1].trim();
            return { content, quoteId, type };
        }

        // 4. 清理普通文本
        content = content.replace(/^#\d+:\s*/, '');
        content = content.replace(/^["']|["']$/g, '');

        return { content: content.trim(), quoteId, type };
    });
}


        async function triggerAIReply() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            if (!App.settings.apiBaseUrl || !App.settings.apiKey || !App.settings.modelName) {
                showToast('Configure API first', 'error'); return;
            }

            document.getElementById('extensionPanel').classList.remove('active');

            // Show typing indicator
            const container = document.getElementById('chatMessages');
            const typingEl = document.createElement('div');
            typingEl.className = 'message-wrapper received';
            typingEl.id = 'typingIndicator';
            typingEl.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            container.appendChild(typingEl);
            container.scrollTop = container.scrollHeight;

            App.lastAIStart = char.messages.length;

            try {
                const messages = buildAPIMessages(char);
                const res = await fetch(`${App.settings.apiBaseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.settings.apiKey}` },
                    body: JSON.stringify({
                        model: App.settings.modelName,
                        messages,
                        temperature: App.settings.temperature,
                        max_tokens: App.settings.maxTokens
                    })
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const responseText = data.choices?.[0]?.message?.content || '';

                document.getElementById('typingIndicator')?.remove();

                const parsed = parseAIResponse(responseText, char);
                for (const p of parsed) {
                    if (!p.content) continue;
                    const msg = {
                        id: 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
                        sender: 'char',
                        content: p.content,
                        type: p.type || 'text',
                        timestamp: Date.now(),
                        quoteId: p.quoteId
                    };
                    char.messages.push(msg);
                    await new Promise(r => setTimeout(r, 300));
                    renderMessages();
                }

                await saveData();
            } catch (e) {
                document.getElementById('typingIndicator')?.remove();
                showToast('AI reply failed: ' + e.message, 'error');
            }
        }

        async function regenerateLastReply() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            // Find and remove the last batch of AI messages
            let lastUserIdx = -1;
            for (let i = char.messages.length - 1; i >= 0; i--) {
                if (char.messages[i].sender === 'user') { lastUserIdx = i; break; }
            }

            if (lastUserIdx >= 0 && lastUserIdx < char.messages.length - 1) {
                char.messages = char.messages.slice(0, lastUserIdx + 1);
                renderMessages();
                await saveData();
            }

            await triggerAIReply();
        }

        function openCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            document.getElementById('charName').value = char.name || '';
            document.getElementById('charNickname').value = char.nickname || '';
            updateNicknameCharCounter();
            document.getElementById('charAvatar').value = char.avatar || '';
            document.getElementById('charDescription').value = char.description || '';
            document.getElementById('charGreeting').value = char.greeting || '';
            document.getElementById('charScenario').value = char.scenario || '';
            document.getElementById('charSystemPrompt').value = char.systemPrompt || '';
            document.getElementById('charUserNick').value = char.userNick || '';
            document.getElementById('customCssEditor').value = char.customCss || '';
            document.getElementById('timestampPosition').value = char.timestampPosition || 'default';

            updateCharCounter();

            // Avatar uploads
            const charAvatarEl = document.getElementById('charAvatarUpload');
            if (char.avatarImage) { charAvatarEl.innerHTML = `<img src="${char.avatarImage}">`; charAvatarEl.classList.add('has-image'); }
            else { charAvatarEl.innerHTML = '<svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>'; charAvatarEl.classList.remove('has-image'); }

            const userAvatarEl = document.getElementById('userAvatarUpload');
            if (char.userAvatar) { userAvatarEl.innerHTML = `<img src="${char.userAvatar}">`; userAvatarEl.classList.add('has-image'); }
            else { userAvatarEl.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'; userAvatarEl.classList.remove('has-image'); }

            // Chat wallpaper
            const wpPreview = document.getElementById('chatWallpaperPreview');
            if (char.chatWallpaper) { wpPreview.style.background = `url(${char.chatWallpaper})`; wpPreview.classList.add('has-image'); }
            else { wpPreview.style.background = ''; wpPreview.classList.remove('has-image'); }

            // Avatar settings
            const showAvatarToggle = document.getElementById('showAvatarToggle');
            showAvatarToggle.classList.toggle('active', char.showAvatar !== false);

            document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.shape === (char.avatarShape || 'circle'));
            });

            const showBorderToggle = document.getElementById('showBorderToggle');
            showBorderToggle.classList.toggle('active', char.showBorder);
            document.getElementById('borderColorPicker').value = char.borderColor || '#ffffff';

            // Bubble style UI
            initBubbleStyleUI(char);

            // CSS presets
            updateCssPresetSelect();
            document.getElementById('cssPresetSelect').value = char.cssPresetId || '';

            // Worldbook multi-select
            renderWorldbookMultiSelect(char);

            document.getElementById('characterSettingsPage').classList.add('active');
        }

        function updateCharCounter() {
            const val = document.getElementById('charGreeting').value;
            const counter = document.getElementById('greetingCharCounter');
            counter.textContent = `${val.length}/300`;
            counter.className = 'char-counter' + (val.length > 280 ? ' warning' : '') + (val.length >= 300 ? ' error' : '');
        }

        function updateNicknameCharCounter() {
            const val = document.getElementById('charNickname').value;
            const counter = document.getElementById('nicknameCharCounter');
            counter.textContent = `${val.length}/30`;
            counter.className = 'char-counter' + (val.length > 25 ? ' warning' : '') + (val.length >= 30 ? ' error' : '');
        }

        function renderWorldbookMultiSelect(char) {
            const container = document.getElementById('worldbookMultiSelect');
            if (App.worldbooks.length === 0) {
                container.innerHTML = '<div style="padding:16px;color:var(--text-tertiary);text-align:center">No worldbooks available</div>';
                return;
            }
            container.innerHTML = App.worldbooks.map(wb => {
                const isLinked = char.worldbookIds?.includes(wb.id);
                return `<div class="worldbook-multi-item" onclick="toggleWorldbookLink('${wb.id}')"><div class="worldbook-multi-checkbox ${isLinked ? 'checked' : ''}"></div><span class="worldbook-multi-name">${escapeHtml(wb.name)}</span></div>`;
            }).join('');
        }

        function toggleWorldbookLink(wbId) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            if (!char.worldbookIds) char.worldbookIds = [];
            const idx = char.worldbookIds.indexOf(wbId);
            if (idx >= 0) char.worldbookIds.splice(idx, 1);
            else char.worldbookIds.push(wbId);
            renderWorldbookMultiSelect(char);
        }

        function selectShape(el) {
            document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        async function saveCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            char.name = document.getElementById('charName').value.trim();
            char.nickname = document.getElementById('charNickname').value.trim();
            char.avatar = document.getElementById('charAvatar').value.trim();
            char.description = document.getElementById('charDescription').value;
            char.greeting = document.getElementById('charGreeting').value;
            char.scenario = document.getElementById('charScenario').value;
            char.systemPrompt = document.getElementById('charSystemPrompt').value;
            char.userNick = document.getElementById('charUserNick').value;
            char.customCss = document.getElementById('customCssEditor').value;
            char.timestampPosition = document.getElementById('timestampPosition').value;
            char.cssPresetId = document.getElementById('cssPresetSelect').value || null;

            char.showAvatar = document.getElementById('showAvatarToggle').classList.contains('active');
            char.avatarShape = document.querySelector('#avatarShapeOptions .shape-option.selected')?.dataset.shape || 'circle';
            char.showBorder = document.getElementById('showBorderToggle').classList.contains('active');
            char.borderColor = document.getElementById('borderColorPicker').value;

            document.getElementById('chatTitle').textContent = char.nickname || char.name;

            await saveData();
            closeCharacterSettings();
            applyBubbleStyles(char);
            if (char.customCss) document.getElementById('customCssStyles').textContent = char.customCss;
            renderMessages();
            showToast('Settings saved', 'success');
        }

        function closeCharacterSettings() {
            document.getElementById('characterSettingsPage').classList.remove('active');
        }

        async function handleCharAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (!char) return;
                char.avatarImage = await compressImage(ev.target.result, 150, 0.8);
                const el = document.getElementById('charAvatarUpload');
                el.innerHTML = `<img src="${char.avatarImage}">`;
                el.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        async function handleUserAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (!char) return;
                char.userAvatar = await compressImage(ev.target.result, 150, 0.8);
                const el = document.getElementById('userAvatarUpload');
                el.innerHTML = `<img src="${char.userAvatar}">`;
                el.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        async function handleChatWallpaperUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (!char) return;
                char.chatWallpaper = await compressImage(ev.target.result, 500, 0.8);
                const preview = document.getElementById('chatWallpaperPreview');
                preview.style.background = `url(${char.chatWallpaper})`;
                preview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function clearChatWallpaper() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            char.chatWallpaper = null;
            const preview = document.getElementById('chatWallpaperPreview');
            preview.style.background = '';
            preview.classList.remove('has-image');
        }

        function confirmClearAllMessages() { showModal('clearMessagesModal'); }

        async function executeClearAllMessages() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (char) { char.messages = []; renderMessages(); await saveData(); showToast('Messages cleared', 'success'); }
            hideModal('clearMessagesModal');
        }

        function updateCssPresetSelect() {
            const select = document.getElementById('cssPresetSelect');
            select.innerHTML = '<option value="">-- No Preset --</option>' + App.globalCssPresets.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
        }

        function loadCssPreset() {
            const id = document.getElementById('cssPresetSelect').value;
            if (!id) return;
            const preset = App.globalCssPresets.find(p => p.id === id);
            if (preset) document.getElementById('customCssEditor').value = preset.css || '';
        }

        function addNewCssPreset() { showModal('cssPresetNameModal'); }

        async function createCssPreset() {
            const name = document.getElementById('newCssPresetName').value.trim();
            if (!name) { showToast('Enter preset name', 'error'); return; }
            const preset = { id: 'css-' + Date.now(), name, css: document.getElementById('customCssEditor').value };
            App.globalCssPresets.push(preset);
            updateCssPresetSelect();
            document.getElementById('cssPresetSelect').value = preset.id;
            await saveData();
            hideModal('cssPresetNameModal');
            document.getElementById('newCssPresetName').value = '';
            showToast('Preset created', 'success');
        }

        async function saveCssPreset() {
            const id = document.getElementById('cssPresetSelect').value;
            if (!id) { showToast('Select a preset first', 'error'); return; }
            const preset = App.globalCssPresets.find(p => p.id === id);
            if (preset) { preset.css = document.getElementById('customCssEditor').value; await saveData(); showToast('Preset saved', 'success'); }
        }

        function deleteCssPreset() {
            const id = document.getElementById('cssPresetSelect').value;
            if (!id) { showToast('Select a preset first', 'error'); return; }
            App.pendingDeleteCssPresetId = id;
            showModal('deleteCssPresetModal');
        }

        async function confirmDeleteCssPreset() {
            if (App.pendingDeleteCssPresetId) {
                App.globalCssPresets = App.globalCssPresets.filter(p => p.id !== App.pendingDeleteCssPresetId);
                updateCssPresetSelect();
                await saveData();
                showToast('Preset deleted', 'success');
            }
            hideModal('deleteCssPresetModal');
            App.pendingDeleteCssPresetId = null;
        }

        function showCssGuide() { showModal('cssGuideModal'); }

        function previewCss() {
            const css = document.getElementById('customCssEditor').value;
            document.getElementById('customCssStyles').textContent = css;
            showToast('CSS preview applied', 'info');
        }

        function clearCustomCss() {
            document.getElementById('customCssEditor').value = '';
            document.getElementById('customCssStyles').textContent = '';
            showToast('CSS cleared', 'success');
        }

        function deleteCurrentCharacter() {
            App.pendingDeleteType = 'character';
            App.pendingDeleteId = App.currentCharId;
            document.getElementById('deleteModalTitle').textContent = 'Delete Character?';
            document.getElementById('deleteModalDesc').textContent = 'This will delete all messages and settings.';
            showModal('confirmDeleteModal');
        }

        async function confirmDelete() {
            if (App.pendingDeleteType === 'character') {
                App.characters = App.characters.filter(c => c.id !== App.pendingDeleteId);
                closeCharacterSettings();
                closeChatPage();
            } else if (App.pendingDeleteType === 'worldbook') {
                App.worldbooks = App.worldbooks.filter(w => w.id !== App.pendingDeleteId);
                closeWorldbookEdit();
            }
            await saveData();
            hideModal('confirmDeleteModal');
            showToast('Deleted', 'success');
        }

        // Worldbook functions
        function renderWorldbookList() {
            const list = document.getElementById('worldbookList');
            const empty = document.getElementById('emptyWorldbookState');
            if (App.worldbooks.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; }
            list.style.display = 'block'; empty.style.display = 'none';
            list.innerHTML = App.worldbooks.map(wb => {
                const entryCount = wb.entries?.length || 0;
                return `<div class="worldbook-item" onclick="openWorldbookEdit('${wb.id}')"><div class="worldbook-item-header"><span class="worldbook-item-title">${escapeHtml(wb.name)}</span><span class="worldbook-item-badge">${entryCount} entries</span></div><div class="worldbook-item-preview">${escapeHtml(wb.summary || 'No description')}</div></div>`;
            }).join('');
        }

        async function createWorldbook() {
            const name = document.getElementById('newWorldbookName').value.trim();
            if (!name) { showToast('Enter worldbook name', 'error'); return; }
            const wb = { id: 'wb-' + Date.now(), name, summary: '', entries: [] };
            App.worldbooks.push(wb);
            await saveData();
            hideModal('createWorldbookModal');
            document.getElementById('newWorldbookName').value = '';
            renderWorldbookList();
            showToast('Worldbook created', 'success');
        }

        function openWorldbookEdit(id) {
            App.currentWbId = id;
            const wb = App.worldbooks.find(w => w.id === id);
            if (!wb) return;
            document.getElementById('worldbookName').value = wb.name || '';
            document.getElementById('worldbookSummary').value = wb.summary || '';
            renderWorldbookEntries();
            document.getElementById('worldbookEditPage').classList.add('active');
        }

        function closeWorldbookEdit() {
            document.getElementById('worldbookEditPage').classList.remove('active');
            App.currentWbId = null;
            renderWorldbookList();
        }

        function renderWorldbookEntries() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb) return;
            const container = document.getElementById('worldbookEntries');
            if (!wb.entries?.length) { container.innerHTML = '<p style="color:var(--text-tertiary);text-align:center;padding:16px">No entries yet</p>'; return; }
            container.innerHTML = wb.entries.map((entry, idx) => `<div class="worldbook-entry-item"><div class="worldbook-entry-header"><span class="worldbook-entry-title">${escapeHtml(entry.name || 'Unnamed')}</span><div class="worldbook-entry-actions"><button class="worldbook-entry-btn" onclick="editWorldbookEntry(${idx})"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="worldbook-entry-btn" onclick="deleteWorldbookEntry(${idx})"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div></div><div class="worldbook-entry-keywords">Keywords: ${escapeHtml(entry.keywords || 'None')}${entry.alwaysActive ? ' | Always Active' : ''}</div><div class="worldbook-entry-preview">${escapeHtml((entry.content || '').substring(0, 100))}</div></div>`).join('');
        }

        function addWorldbookEntry() {
            App.currentEntryIndex = -1;
            document.getElementById('entryName').value = '';
            document.getElementById('entryKeywords').value = '';
            document.getElementById('entryContent').value = '';
            document.getElementById('entryAlwaysActive').classList.remove('active');
            showModal('entryEditModal');
        }

        function editWorldbookEntry(idx) {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb?.entries?.[idx]) return;
            App.currentEntryIndex = idx;
            const entry = wb.entries[idx];
            document.getElementById('entryName').value = entry.name || '';
            document.getElementById('entryKeywords').value = entry.keywords || '';
            document.getElementById('entryContent').value = entry.content || '';
            document.getElementById('entryAlwaysActive').classList.toggle('active', entry.alwaysActive);
            showModal('entryEditModal');
        }

        function saveWorldbookEntry() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb) return;
            const entry = {
                name: document.getElementById('entryName').value.trim(),
                keywords: document.getElementById('entryKeywords').value.trim(),
                content: document.getElementById('entryContent').value,
                alwaysActive: document.getElementById('entryAlwaysActive').classList.contains('active')
            };
            if (App.currentEntryIndex >= 0) wb.entries[App.currentEntryIndex] = entry;
            else { if (!wb.entries) wb.entries = []; wb.entries.push(entry); }
            renderWorldbookEntries();
            hideModal('entryEditModal');
        }

        function deleteWorldbookEntry(idx) {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (wb?.entries) { wb.entries.splice(idx, 1); renderWorldbookEntries(); }
        }

        async function saveWorldbook() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb) return;
            wb.name = document.getElementById('worldbookName').value.trim();
            wb.summary = document.getElementById('worldbookSummary').value;
            await saveData();
            closeWorldbookEdit();
            showToast('Worldbook saved', 'success');
        }

        function deleteCurrentWorldbook() {
            App.pendingDeleteType = 'worldbook';
            App.pendingDeleteId = App.currentWbId;
            document.getElementById('deleteModalTitle').textContent = 'Delete Worldbook?';
            document.getElementById('deleteModalDesc').textContent = 'All entries will be lost.';
            showModal('confirmDeleteModal');
        }

        // Wallpaper functions
        function applyWallpaper() {
            const layer = document.getElementById('wallpaperLayer');
            if (App.settings.wallpaperData) {
                layer.style.background = `url(${App.settings.wallpaperData}) center/cover no-repeat`;
            } else if (App.settings.wallpaper && GRADIENTS[App.settings.wallpaper]) {
                layer.style.background = GRADIENTS[App.settings.wallpaper];
            } else {
                layer.style.background = GRADIENTS.gradient1;
            }
        }

        function highlightWallpaper() {
            document.querySelectorAll('#wallpaperGrid > div').forEach(el => {
                el.style.borderColor = el.dataset.wp === App.settings.wallpaper ? 'rgba(255,255,255,0.5)' : 'transparent';
            });
        }

        function updateWallpaperPreview() {
            const preview = document.getElementById('wallpaperPreview');
            if (App.tempWallpaper?.type === 'data') {
                preview.style.background = `url(${App.tempWallpaper.data}) center/cover`;
            } else if (App.tempWallpaper?.type === 'preset') {
                preview.style.background = GRADIENTS[App.tempWallpaper.name];
            } else if (App.settings.wallpaperData) {
                preview.style.background = `url(${App.settings.wallpaperData}) center/cover`;
            } else {
                preview.style.background = GRADIENTS[App.settings.wallpaper] || GRADIENTS.gradient1;
            }
        }

        function selectPresetWallpaper(name) {
            App.tempWallpaper = { type: 'preset', name };
            updateWallpaperPreview();
            document.querySelectorAll('#wallpaperGrid > div').forEach(el => {
                el.style.borderColor = el.dataset.wp === name ? 'rgba(255,255,255,0.5)' : 'transparent';
            });
        }

        function previewUrlWallpaper() {
            const url = document.getElementById('customWallpaperUrl').value.trim();
            if (url) { App.tempWallpaper = { type: 'url', url }; updateWallpaperPreview(); }
        }

        async function handleWallpaperUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const compressed = await compressImage(ev.target.result, 600, 0.8);
                App.tempWallpaper = { type: 'data', data: compressed };
                updateWallpaperPreview();
            };
            reader.readAsDataURL(file);
        }

        async function saveWallpaper() {
            if (App.tempWallpaper) {
                if (App.tempWallpaper.type === 'preset') {
                    App.settings.wallpaper = App.tempWallpaper.name;
                    App.settings.wallpaperData = null;
                } else if (App.tempWallpaper.type === 'data') {
                    App.settings.wallpaperData = App.tempWallpaper.data;
                    App.settings.wallpaper = null;
                } else if (App.tempWallpaper.type === 'url') {
                    try {
                        const res = await fetch(App.tempWallpaper.url);
                        const blob = await res.blob();
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            App.settings.wallpaperData = await compressImage(e.target.result, 600, 0.8);
                            App.settings.wallpaper = null;
                            applyWallpaper();
                            await saveData();
                        };
                        reader.readAsDataURL(blob);
                        return;
                    } catch { showToast('Failed to load URL', 'error'); return; }
                }
            }
            applyWallpaper();
            highlightWallpaper();
            await saveData();
            App.tempWallpaper = null;
            showToast('Wallpaper applied', 'success');
        }

        // Icon functions
        function applyAppIcons() {
            const icons = App.appIcons;
            ['settings', 'messages', 'worldbook', 'photos', 'fonts'].forEach(key => {
                const el = document.getElementById('appIcon' + key.charAt(0).toUpperCase() + key.slice(1));
                if (el && icons[key]) el.innerHTML = `<img src="${icons[key]}">`;
            });
        }

        function updateIconPreviews() {
            const icons = App.tempIcons.settings !== undefined ? App.tempIcons : App.appIcons;
            ['settings', 'messages', 'worldbook', 'photos', 'fonts'].forEach(key => {
                const preview = document.getElementById('iconPreview' + key.charAt(0).toUpperCase() + key.slice(1));
                if (preview) {
                    if (icons[key]) { preview.innerHTML = `<img src="${icons[key]}">`; preview.classList.add('has-image'); }
                    else { preview.classList.remove('has-image'); }
                }
            });
        }

        async function handleIconUpload(e, iconType) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const compressed = await compressImage(ev.target.result, 100, 0.8);
                if (Object.keys(App.tempIcons).length === 0) App.tempIcons = { ...App.appIcons };
                App.tempIcons[iconType] = compressed;
                updateIconPreviews();
            };
            reader.readAsDataURL(file);
        }

        async function saveIcons() {
            if (Object.keys(App.tempIcons).length > 0) {
                App.appIcons = { ...App.tempIcons };
                App.tempIcons = {};
            }
            applyAppIcons();
            await saveData();
            showToast('Icons saved', 'success');
        }

        function resetIcons() {
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null, fonts: null };
            App.tempIcons = {};
            location.reload();
        }

        // Data management
        async function exportAllData() {
            const data = {
                version: 1, exportDate: new Date().toISOString(),
                characters: App.characters, worldbooks: App.worldbooks,
                settings: App.settings, appIcons: App.appIcons,
                globalCssPresets: App.globalCssPresets, apiPresets: App.apiPresets, fonts: App.fonts
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `noir-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported', 'success');
        }

        async function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.characters) App.characters = data.characters;
                    if (data.worldbooks) App.worldbooks = data.worldbooks;
                    if (data.settings) App.settings = { ...App.settings, ...data.settings };
                    if (data.appIcons) App.appIcons = data.appIcons;
                    if (data.globalCssPresets) App.globalCssPresets = data.globalCssPresets;
                    if (data.apiPresets) App.apiPresets = data.apiPresets;
                    if (data.fonts) App.fonts = data.fonts;
                    await saveData();
                    location.reload();
                } catch (err) { showToast('Import failed: ' + err.message, 'error'); }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            if (!confirm('Delete ALL data? This cannot be undone!')) return;
            if (!confirm('Are you absolutely sure?')) return;
            App.characters = []; App.worldbooks = [];
            App.settings = { apiBaseUrl: '', apiKey: '', modelName: '', temperature: 0.7, maxTokens: 2048, maxContextMessages: 200, wallpaper: 'gradient1', wallpaperData: null, hideStatusBar: false, selectedFontId: null, fontScale: 1 };
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null, fonts: null };
            App.globalCssPresets = []; App.apiPresets = []; App.fonts = [...DEFAULT_FONTS];
            await saveData();
            location.reload();
        }
        // ========== Voice Chat Logic ==========
        App.voiceState = {
            isActive: false,
            startTime: 0,
            pendingMsgId: null,
            lyrics: []
        };

        function openVoiceArchives() {
            toggleExtensionPanel();
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const list = document.getElementById('voiceArchiveList');
            if (!char.voiceHistory || char.voiceHistory.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></div><div class="empty-state-title">No Calls</div><div class="empty-state-desc">Voice chat history will appear here</div></div>';
            } else {
                list.innerHTML = char.voiceHistory.slice().reverse().map((h, i) => `
                    <div class="archive-list-item" onclick="openVoiceDetail(${char.voiceHistory.length - 1 - i})">
                        <div>
                            <div class="archive-date">${new Date(h.timestamp).toLocaleString()}</div>
                            <div class="archive-info">${h.messages.length} messages</div>
                        </div>
                        <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--text-tertiary);fill:none;stroke-width:2"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                `).join('');
            }
            showModal('voiceArchiveModal');
        }

        function openVoiceDetail(index) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char || !char.voiceHistory[index]) return;
            App.currentVoiceArchive = char.voiceHistory[index];
            const content = App.currentVoiceArchive.messages.map(m => `${m.role === 'user' ? 'User' : char.name}: ${m.content}`).join('\n\n');
            document.getElementById('voiceDetailContent').textContent = content;
            showModal('voiceDetailModal');
        }

        function openSummaryModal() {
            if (!App.currentVoiceArchive) return;
            document.getElementById('summaryResultContainer').classList.remove('active');
            showModal('summaryConfigModal');
        }

        async function startSummary() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            const prompt = document.getElementById('summaryPrompt').value;
            if (!char || !prompt) return;

            const btn = document.querySelector('#summaryConfigModal .modal-btn.confirm');
            const originalText = btn.textContent;
            btn.textContent = 'Summarizing...';
            btn.disabled = true;

            try {
                const historyText = App.currentVoiceArchive.messages.map(m => `${m.role === 'user' ? 'User' : char.name}: ${m.content}`).join('\n');
                const fullPrompt = prompt.replace('{user}', char.userNick || 'User').replace('{char}', char.name) + '\n\n[Conversation]\n' + historyText;

                const res = await fetch(`${App.settings.apiBaseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.settings.apiKey}` },
                    body: JSON.stringify({
                        model: App.settings.modelName,
                        messages: [{ role: 'user', content: fullPrompt }],
                        temperature: 0.7
                    })
                });

                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                const summary = data.choices?.[0]?.message?.content || 'No summary generated.';

                document.getElementById('summaryResultText').textContent = summary;
                document.getElementById('summaryResultContainer').classList.add('active');
                App.currentSummary = summary;
            } catch (e) {
                showToast('Summary failed: ' + e.message, 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function saveSummaryToWorldBook() {
            if (!App.currentSummary) return;
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            const wbName = `${char.name} Voice Logs`;
            let wb = App.worldbooks.find(w => w.name === wbName);
            
            if (!wb) {
                wb = { id: 'wb-' + Date.now(), name: wbName, summary: 'Auto-generated voice chat summaries', entries: [] };
                App.worldbooks.push(wb);
            }

            wb.entries.push({
                name: `Call ${new Date(App.currentVoiceArchive.timestamp).toLocaleDateString()}`,
                keywords: 'voice,call,summary',
                content: App.currentSummary,
                alwaysActive: true
            });

            if (!char.worldbookIds.includes(wb.id)) char.worldbookIds.push(wb.id);

            await saveData();
            hideModal('summaryConfigModal');
            hideModal('voiceDetailModal');
            hideModal('voiceArchiveModal');
            showToast('Saved to World Book', 'success');
        }

        function confirmVoiceChatRequest() {
            toggleExtensionPanel();
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            document.getElementById('voiceRequestName').textContent = char.name;
            showModal('voiceRequestModal');
        }

        async function startVoiceChatRequest() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            hideModal('voiceRequestModal');

        // Add system message to main chat
        const msgId = 'msg-' + Date.now();
        App.voiceState.pendingMsgId = msgId;
        const sysMsg = {
            id: msgId,
            sender: 'system',
            type: 'system-voice',
            content: `${char.userNick || 'User'} initiated voice call`,
            timestamp: Date.now()
        };
            char.messages.push(sysMsg);
            renderMessages();
            await saveData();

            // Prepare UI
            const overlay = document.getElementById('voiceChatOverlay');
            document.getElementById('voiceChatName').textContent = char.name;
            document.getElementById('voiceChatAvatar').innerHTML = `<img src="${char.avatarImage || ''}" onerror="this.style.display='none'">`;
            document.getElementById('voiceChatStatus').textContent = 'Waiting for response...';
            document.getElementById('voiceLyricsContainer').innerHTML = '';
            overlay.classList.add('active');
            
            App.voiceState.isActive = false;
            App.voiceState.startTime = 0;

            // Send request to AI
try {
    const messages = buildAPIMessages(char);

    const voicePrompt = `【紧急中断 - 语音通话请求】

${char.userNick || 'User'}正在呼叫你。

⚠️ 重要：所有之前的短信对话现已暂停。你现在必须立刻做出选择。

📞 你的选择：
- 如果你愿意接听这通电话 → 只输出：ACCEPT
- 如果你拒绝接听这通电话 → 只输出：REFUSE

⛔ 严格规则：
1. 你只能输出 ACCEPT 或 REFUSE 其中一个单词
2. 不要输出任何其他文字、解释、标点或符号
3. 不要说"我选择..."或"好的..."，直接输出那一个单词

现在立刻输出你的选择：`;

    messages.push({ role: 'user', content: voicePrompt });

    const res = await fetch(`${App.settings.apiBaseUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.settings.apiKey}` },
        body: JSON.stringify({
            model: App.settings.modelName,
            messages,
            temperature: 1.0,
            max_tokens: 15
        })
    });

    const data = await res.json();
    const rawDecision = (data.choices?.[0]?.message?.content || '').trim().toUpperCase();

    // 宽松判断：只有明确拒绝才算拒绝
    if (rawDecision.includes('REFUSE') || rawDecision.includes('NO') || rawDecision.includes('REJECT')) {
        handleVoiceRefuse(char);
    } else {
        handleVoiceAccept(char);
    }
} catch (e) {
    console.error(e);
    document.getElementById('voiceChatStatus').textContent = 'Connection Error';
    setTimeout(() => handleVoiceAccept(char), 1000);
}

        function handleVoiceAccept(char) {
            document.getElementById('voiceChatStatus').textContent = 'Connected';
            showToast(`${char.name} accepted!`, 'success');
            App.voiceState.isActive = true;
            App.voiceState.startTime = Date.now();
            App.voiceState.lyrics = [];
            triggerVoiceAIReply(true);
        }

        async function handleVoiceRefuse(char) {
            const msg = {
                id: 'msg-' + Date.now(),
                sender: 'char',
                type: 'system-voice',
                content: 'Call rejected',
                timestamp: Date.now()
            };
            char.messages.push(msg);
            renderMessages();
            await saveData();
            document.getElementById('voiceChatStatus').textContent = 'Call Rejected';
            setTimeout(() => { endVoiceChat(false, true); }, 1500);
        }

        function endVoiceChat(isCancel = false, isRejected = false) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            const overlay = document.getElementById('voiceChatOverlay');
            const minimized = document.getElementById('minimizedVoice');
            overlay.classList.remove('active');
            minimized.classList.remove('active');
            
            if (isRejected) { App.voiceState.isActive = false; return; }

            if (!App.voiceState.isActive) {
                if (char && isCancel) {
                    const msg = { id: 'msg-' + Date.now(), sender: 'user', type: 'system-voice', content: 'Call cancelled', timestamp: Date.now() };
                    char.messages.push(msg);
                    renderMessages();
                    saveData();
                }
            } else {
                if (char) {
                    const durationMs = Date.now() - App.voiceState.startTime;
                    const durationMin = Math.floor(durationMs / 60000);
                    const durationSec = Math.floor((durationMs % 60000) / 1000);
                    const durationStr = `${durationMin}:${durationSec.toString().padStart(2, '0')}`;
                    const msg = { id: 'msg-' + Date.now(), sender: 'system', type: 'system-voice', content: `Call ended. Duration: ${durationStr}`, timestamp: Date.now() };
                    char.messages.push(msg);
                    if (App.voiceState.lyrics.length > 0) {
                        char.voiceHistory.push({ timestamp: App.voiceState.startTime, duration: durationStr, messages: [...App.voiceState.lyrics] });
                    }
                    renderMessages();
                    saveData();
                }
            }
            App.voiceState.isActive = false;
            App.voiceState.pendingMsgId = null;
        }

        function minimizeVoiceChat() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            document.getElementById('voiceChatOverlay').classList.remove('active');
            const minBtn = document.getElementById('minimizedVoice');
            document.getElementById('minimizedVoiceAvatar').src = char?.avatarImage || '';
            minBtn.classList.add('active');
        }

        function maximizeVoiceChat() {
            document.getElementById('minimizedVoice').classList.remove('active');
            document.getElementById('voiceChatOverlay').classList.add('active');
        }

        async function sendVoiceChatMessage() {
            const input = document.getElementById('voiceInputField');
            const text = input.value.trim();
            if (!text) return;
            const char = App.characters.find(c => c.id === App.currentCharId);
            addLyric(text, 'user');
            App.voiceState.lyrics.push({ role: 'user', content: text });
            input.value = '';
            await saveData();
            triggerVoiceAIReply();
        }

        function buildVoiceAPIMessages(char) {
            let systemContent = `You are ${char.name}. `;
            if (char.description) systemContent += `\n\n[Character Description]\n${char.description}`;
            if (char.scenario) systemContent += `\n\n[Scenario]\n${char.scenario}`;
            if (char.systemPrompt) systemContent += `\n\n[Instructions]\n${char.systemPrompt}`;
            
            if (char.worldbookIds?.length > 0) {
                const recentMsgs = char.messages.slice(-10).map(m => m.content || '').join(' ').toLowerCase();
                char.worldbookIds.forEach(wbId => {
                    const wb = App.worldbooks.find(w => w.id === wbId);
                    if (wb?.entries) {
                        wb.entries.forEach(entry => {
                            if (entry.alwaysActive) { systemContent += `\n\n[Lore: ${entry.name}]\n${entry.content}`; }
                            else if (entry.keywords) {
                                const keywords = entry.keywords.split(',').map(k => k.trim().toLowerCase());
                                if (keywords.some(k => k && recentMsgs.includes(k))) { systemContent += `\n\n[Lore: ${entry.name}]\n${entry.content}`; }
                            }
                        });
                    }
                });
            }

            if (char.userNick) systemContent += `\n\n[User's Name/Identity]\nThe user is called "${char.userNick}".`;

            systemContent += `\n\n[VOICE CALL MODE]\nYou are currently in a voice call with ${char.userNick || 'the user'}.\n- Output ONLY what you say. No asterisks for actions.\n- Use (parentheses) for sound effects you make (e.g. (laughs), (sighs)).\n- Be conversational, spontaneous, and concise.\n- You can hang up by outputting [HANGUP] if the conversation is over or you are upset.\n- Do NOT output "User:" or "Char:" prefixes.\n- TYPE 1: Spoken text (normal text).\n- TYPE 2: Sound effects (in parentheses).`;

            systemContent += `\n\n[Previous Text Messages Context]`;
            const recentTexts = char.messages.slice(-10);
            recentTexts.forEach(m => {
                if (m.type === 'text' || !m.type) { systemContent += `\n${m.sender === 'user' ? 'User' : char.name}: ${m.content}`; }
            });

            const messages = [{ role: 'system', content: systemContent }];

            if (App.voiceState.lyrics.length > 0) {
                App.voiceState.lyrics.forEach(l => {
                    messages.push({ role: l.role === 'user' ? 'user' : 'assistant', content: l.content });
                });
            }
            return messages;
        }

        async function triggerVoiceAIReply(isFirst = false) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            const messages = buildVoiceAPIMessages(char);
            try {
                const res = await fetch(`${App.settings.apiBaseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.settings.apiKey}` },
                    body: JSON.stringify({
                        model: App.settings.modelName,
                        messages,
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });
                const data = await res.json();
                let content = data.choices?.[0]?.message?.content || '';
                if (content.includes('[HANGUP]')) {
                    content = content.replace('[HANGUP]', '').trim();
                    if (content) handleVoiceResponse(content, char);
                    setTimeout(() => endVoiceChat(), 2000);
                    showToast(`${char.name} hung up`, 'info');
                    return;
                }
                handleVoiceResponse(content, char);
            } catch (e) {
                showToast('Voice error', 'error');
            }
        }

        function handleVoiceResponse(content, char) {
            const parts = content.split(/(\(.*?\))/g).filter(p => p.trim());
            parts.forEach(part => {
                const p = part.trim();
                if (!p) return;
                const isSound = p.startsWith('(') && p.endsWith(')');
                addLyric(p, isSound ? 'sound' : 'char');
                App.voiceState.lyrics.push({ role: 'assistant', content: p });
            });
        }

        function addLyric(text, type) {
            const container = document.getElementById('voiceLyricsContainer');
            const div = document.createElement('div');
            div.className = `lyric-line ${type === 'user' ? 'user-msg' : type === 'sound' ? 'sound-effect' : ''}`;
            div.textContent = text;
            div.onclick = () => {
                document.querySelectorAll('.lyric-line').forEach(l => l.classList.remove('active'));
                div.classList.add('active');
                div.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
            container.appendChild(div);
            document.querySelectorAll('.lyric-line').forEach(l => l.classList.remove('active'));
            div.classList.add('active');
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    </script>
</body>
</html>

```
