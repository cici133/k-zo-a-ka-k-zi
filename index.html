
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NOIR">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0a">
    <title>NOIR · Premium SMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <style id="globalFontStyle"></style>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-card: rgba(18, 18, 18, 0.85);
            --bg-glass: rgba(12, 12, 12, 0.75);
            --bg-glass-light: rgba(255, 255, 255, 0.03);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-accent: rgba(255, 255, 255, 0.12);
            --text-primary: #f5f5f5;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.35);
            --text-gold: #c9a962;
            --accent-primary: #c9a962;
            --accent-secondary: #8b7355;
            --accent-glow: rgba(201, 169, 98, 0.15);
            --danger: #8b3a3a;
            --success: #3a6b4a;
            --blur-heavy: 40px;
            --blur-medium: 25px;
            --blur-light: 15px;
            --shadow-deep: 0 25px 80px rgba(0, 0, 0, 0.8);
            --shadow-medium: 0 10px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 60px rgba(201, 169, 98, 0.08);
            --font-display: 'Playfair Display', 'Cormorant Garamond', Georgia, serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'SF Mono', 'Fira Code', monospace;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --transition-smooth: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --transition-fast: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @font-face {
            font-family: 'Custom Font';
            src: url('') format('truetype');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            height: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }

        /* 壁纸层 */
        #wallpaperLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(180deg, #0a0a0a 0%, #0f0f0f 50%, #0a0a0a 100%);
        }

        /* 装饰性元素 */
        .deco-line {
            position: absolute;
            background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
            height: 1px;
            width: 60%;
            left: 20%;
        }

        .deco-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: var(--border-accent);
            border-style: solid;
        }

        .deco-corner.tl { top: 10px; left: 10px; border-width: 1px 0 0 1px; }
        .deco-corner.tr { top: 10px; right: 10px; border-width: 1px 1px 0 0; }
        .deco-corner.bl { bottom: 10px; left: 10px; border-width: 0 0 1px 1px; }
        .deco-corner.br { bottom: 10px; right: 10px; border-width: 0 1px 1px 0; }

        /* 主容器 */
        .phone-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
            z-index: 1;
        }

        /* 状态栏 */
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: calc(28px + var(--safe-top));
            padding-top: var(--safe-top);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 28px;
            padding-right: 28px;
            z-index: 1000;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        }

        .status-bar.hidden { display: none !important; }

        .status-bar-time {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .status-bar-icons {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .status-bar-icons svg {
            width: 14px;
            height: 14px;
            fill: var(--text-primary);
            opacity: 0.8;
        }

        /* 主屏幕 */
        .home-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding-top: calc(60px + var(--safe-top));
            padding-bottom: calc(100px + var(--safe-bottom));
            padding-left: 24px;
            padding-right: 24px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 1;
        }

        .home-screen.no-statusbar {
            padding-top: calc(40px + var(--safe-top));
        }

        /* 主屏幕标题 */
        .home-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .home-brand {
            font-family: var(--font-display);
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 6px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .home-title {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 400;
            letter-spacing: 8px;
            color: var(--text-primary);
            text-transform: uppercase;
        }

        .home-subtitle {
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--text-tertiary);
            margin-top: 12px;
            text-transform: uppercase;
        }

        /* 应用网格 */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            justify-items: center;
            padding: 20px 0;
        }

        .app-icon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .app-icon-wrapper:active {
            transform: scale(0.92);
        }

        .app-icon {
            width: 62px;
            height: 62px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-medium);
            transition: var(--transition-smooth);
            overflow: hidden;
            position: relative;
        }

        .app-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        .app-icon svg {
            width: 26px;
            height: 26px;
            fill: var(--text-secondary);
            transition: var(--transition-fast);
        }

        .app-icon-wrapper:hover .app-icon svg {
            fill: var(--text-gold);
        }

        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-icon-label {
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 1px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* 底部指示器 */
        .home-indicator {
            position: absolute;
            bottom: calc(8px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            z-index: 1001;
        }

        /* 页面通用样式 */
        .page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-glass);
            backdrop-filter: blur(var(--blur-heavy));
            -webkit-backdrop-filter: blur(var(--blur-heavy));
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.45s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page.active {
            transform: translateX(0);
        }

        .page.slide-from-bottom {
            transform: translateY(100%);
        }

        .page.slide-from-bottom.active {
            transform: translateY(0);
        }

        .page#chatPage {
            background: var(--bg-glass);
        }

        .page#chatPage.has-custom-bg {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        /* 导航栏 - 高级雾气化设计 */
        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: calc(16px + var(--safe-top));
            padding-bottom: 20px;
            padding-left: 20px;
            padding-right: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%);
            backdrop-filter: blur(var(--blur-medium));
            -webkit-backdrop-filter: blur(var(--blur-medium));
            flex-shrink: 0;
            min-height: calc(70px + var(--safe-top));
            position: relative;
        }

        .nav-bar::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
        }

        .nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: var(--bg-glass-light);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-accent);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .nav-title-group {
            text-align: center;
            flex: 1;
        }

        .nav-title {
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 3px;
            color: var(--text-primary);
            text-transform: uppercase;
        }

        .nav-subtitle {
            font-size: 9px;
            letter-spacing: 2px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* 页面内容 */
        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }

        /* 设置组 */
        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-left: 4px;
        }

        .settings-section-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border-subtle), transparent);
        }

        .settings-section-title {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }

        .settings-group {
            background: var(--bg-card);
            backdrop-filter: blur(var(--blur-light));
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-medium);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--bg-glass-light);
        }

        .settings-item:active {
            background: rgba(255, 255, 255, 0.05);
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .settings-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
        }

        .settings-icon svg {
            width: 18px;
            height: 18px;
            fill: var(--text-secondary);
        }

        .settings-icon.gold svg { fill: var(--text-gold); }
        .settings-icon.danger svg { fill: #c75050; }
        .settings-icon.success svg { fill: #50a06a; }

        .settings-item-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .settings-item-label {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-primary);
        }

        .settings-item-desc {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .settings-item-arrow {
            width: 16px;
            height: 16px;
            fill: var(--text-tertiary);
        }

        /* 输入框 */
        .input-group {
            margin-bottom: 18px;
        }

        .input-label {
            display: block;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            padding-left: 2px;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-body);
            outline: none;
            transition: var(--transition-fast);
        }

        .input-field:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .input-field::placeholder {
            color: var(--text-tertiary);
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }

        textarea.code-editor {
            font-family: var(--font-mono);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.4);
            color: #a0d995;
        }

        /* 按钮 */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            width: 100%;
            transition: var(--transition-fast);
            font-family: var(--font-body);
            text-transform: uppercase;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: #0a0a0a;
            box-shadow: var(--shadow-glow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-accent);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--text-primary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
        }

        .btn-small {
            padding: 10px 16px;
            font-size: 11px;
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn-row .btn {
            flex: 1;
        }

        .btn-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 联系人列表 */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 14px;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .contact-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
        }

        .contact-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border-accent);
        }

        .contact-item:active {
            transform: scale(0.99);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            font-family: var(--font-display);
            font-size: 18px;
            color: var(--text-secondary);
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .contact-preview {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .contact-time {
            font-size: 11px;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 30px;
            text-align: center;
        }

        .empty-state-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-icon svg {
            width: 100%;
            height: 100%;
            fill: var(--text-tertiary);
        }

        .empty-state-title {
            font-family: var(--font-display);
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 2px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .empty-state-desc {
            font-size: 12px;
            color: var(--text-tertiary);
            letter-spacing: 1px;
        }

        /* 聊天容器 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.2) 100%);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            -webkit-overflow-scrolling: touch;
        }

        /* 消息 */
        .message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 2px;
        }

        .message-wrapper.sent {
            justify-content: flex-end;
        }

        .message-wrapper.received {
            justify-content: flex-start;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .message-avatar.square { border-radius: 6px; }
        .message-avatar.rounded-square { border-radius: 8px; }
        .message-avatar.hidden { display: none; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .message {
            max-width: 72%;
            padding: 12px 16px;
            font-size: 14px;
            line-height: 1.45;
            word-wrap: break-word;
            animation: msgIn 0.25s ease-out;
            position: relative;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message.sent {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: var(--text-primary);
            border-radius: 18px 18px 4px 18px;
            border: 1px solid var(--border-subtle);
        }

        .message.received {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border-radius: 18px 18px 18px 4px;
            border: 1px solid var(--border-subtle);
        }

        .message-quote {
            background: rgba(0, 0, 0, 0.3);
            border-left: 2px solid var(--accent-primary);
            border-radius: 4px;
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
            max-height: 42px;
            overflow: hidden;
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 6px;
            cursor: pointer;
            display: block;
        }

        .message-time {
            font-size: 9px;
            color: var(--text-tertiary);
            margin-top: 4px;
            letter-spacing: 0.5px;
        }

        .message-time.time-hidden { display: none; }
        .message-time.time-side {
            position: absolute;
            bottom: 6px;
            right: -42px;
            margin-top: 0;
        }
        .message-wrapper.sent .message-time.time-side {
            right: auto;
            left: -42px;
        }

        .message-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border-accent);
            background: transparent;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: var(--transition-fast);
        }

        .message-checkbox.checked {
            background: var(--danger);
            border-color: var(--danger);
        }

        .message-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 10px;
        }

        .chat-messages.select-mode .message-checkbox {
            display: flex;
        }

        /* 打字指示器 */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 14px 18px;
            background: var(--bg-card);
            border-radius: 18px 18px 18px 4px;
            border: 1px solid var(--border-subtle);
            width: fit-content;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* 聊天输入区域 */
        .chat-input-wrapper {
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.6) 30%, rgba(0,0,0,0.8) 100%);
            backdrop-filter: blur(var(--blur-medium));
            -webkit-backdrop-filter: blur(var(--blur-medium));
        }

        .quote-preview-bar {
            display: none;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.4);
            align-items: center;
            gap: 12px;
        }

        .quote-preview-bar.active { display: flex; }

        .quote-preview-content {
            flex: 1;
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 2px solid var(--accent-primary);
            padding-left: 10px;
        }

        .quote-preview-close {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
        }

        .chat-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition-fast);
        }

        .chat-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-accent);
        }

        .chat-btn:active {
            transform: scale(0.95);
        }

        .chat-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .chat-btn.send {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: #0a0a0a;
        }

        .chat-btn.ai {
            background: linear-gradient(135deg, #4a3a6a, #2a2a4a);
            border: none;
            color: #b8a0d0;
        }

        .chat-input-field {
            flex: 1;
            min-height: 40px;
            max-height: 100px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: var(--font-body);
            transition: var(--transition-fast);
        }

        .chat-input-field:focus {
            border-color: var(--accent-primary);
        }

        .chat-input-field::placeholder {
            color: var(--text-tertiary);
        }

        /* 扩展面板 */
        .extension-panel {
            position: absolute;
            bottom: calc(70px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 0;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateY(16px);
            transition: var(--transition-smooth);
            overflow: hidden;
            box-shadow: var(--shadow-deep);
        }

        .extension-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .ext-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .ext-panel-title {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }

        .ext-panel-close {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .ext-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 16px 18px;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition-fast);
            text-align: left;
        }

        .ext-btn:last-child { border-bottom: none; }
        .ext-btn:hover { background: var(--bg-glass-light); }

        .ext-btn-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
        }

        .ext-btn-icon svg {
            width: 18px;
            height: 18px;
            fill: var(--text-secondary);
        }

        .ext-btn-text { flex: 1; }
        .ext-btn-title { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .ext-btn-desc { font-size: 11px; color: var(--text-tertiary); }

        /* 上下文菜单 */
        .context-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .context-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .context-menu {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            width: 220px;
            overflow: hidden;
            box-shadow: var(--shadow-deep);
            transform: scale(0.9);
            transition: transform 0.25s ease;
        }

        .context-menu-overlay.active .context-menu {
            transform: scale(1);
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .context-menu-item:last-child { border-bottom: none; }
        .context-menu-item:hover { background: var(--bg-glass-light); }

        .context-menu-icon {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
        }

        .context-menu-icon svg {
            width: 16px;
            height: 16px;
            fill: var(--text-secondary);
        }

        .context-menu-label {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* 模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-smooth);
            padding: 24px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 100%;
            max-width: 360px;
            max-height: 85vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            backdrop-filter: blur(var(--blur-heavy));
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-subtle);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-deep);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 2px;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .modal-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            margin-bottom: 16px;
            font-family: var(--font-body);
        }

        .modal-input:focus {
            border-color: var(--accent-primary);
        }

        .modal-btns {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: var(--font-body);
            transition: var(--transition-fast);
        }

        .modal-btn.cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: #0a0a0a;
        }

        .modal-btn.danger {
            background: var(--danger);
            color: var(--text-primary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: calc(70px + var(--safe-top));
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            padding: 14px 24px;
            background: var(--bg-card);
            backdrop-filter: blur(var(--blur-medium));
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 400;
            border: 1px solid var(--border-subtle);
            animation: toastIn 0.35s ease-out, toastOut 0.35s ease-in 2.7s forwards;
            letter-spacing: 0.5px;
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--accent-primary); }
        .toast.warning { border-left: 3px solid #a08030; }

        @keyframes toastIn { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

        /* 搜索框 */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-field {
            width: 100%;
            padding: 14px 16px 14px 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: var(--transition-fast);
        }

        .search-field:focus {
            border-color: var(--accent-primary);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            fill: var(--text-tertiary);
        }

        /* 开关 */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-fast);
        }

        .toggle-switch.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: var(--transition-fast);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .toggle-switch.active::after {
            left: 23px;
        }

        /* 选择器 */
        .select-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            font-family: var(--font-body);
        }

        .select-field option {
            background: var(--bg-secondary);
        }

        /* 预设选择器 */
        .preset-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .preset-selector select {
            flex: 1;
        }

        .preset-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-accent);
        }

        .preset-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* 隐藏文件输入 */
        .file-input-hidden {
            display: none;
        }

        /* 分隔线 */
        .divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 18px 0;
        }

        /* 加载动画 */
        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* 滑块 */
        .slider-container {
            margin: 16px 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .slider-label {
            font-size: 12px;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }

        .slider-value {
            font-size: 12px;
            color: var(--accent-primary);
            font-weight: 500;
        }

        .slider-input {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            appearance: none;
        }

        .slider-input::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(201, 169, 98, 0.4);
        }

        /* 提示条 */
        .hint-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(201, 169, 98, 0.08);
            border: 1px solid rgba(201, 169, 98, 0.2);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .hint-bar-icon svg {
            width: 16px;
            height: 16px;
            fill: var(--accent-primary);
        }

        .hint-bar-text {
            font-size: 11px;
            color: var(--accent-primary);
            letter-spacing: 0.5px;
        }

        .hint-bar.success {
            background: rgba(80, 160, 106, 0.08);
            border-color: rgba(80, 160, 106, 0.2);
        }

        .hint-bar.success .hint-bar-icon svg { fill: var(--success); }
        .hint-bar.success .hint-bar-text { color: #50a06a; }

        .hint-bar.warning {
            background: rgba(160, 128, 48, 0.08);
            border-color: rgba(160, 128, 48, 0.2);
        }

        .hint-bar.warning .hint-bar-icon svg { fill: #a08030; }
        .hint-bar.warning .hint-bar-text { color: #a08030; }

        /* 删除区域 */
        .delete-zone {
            padding: 18px;
            border: 1px dashed var(--danger);
            border-radius: 14px;
            text-align: center;
            color: var(--danger);
            margin-top: 24px;
            cursor: pointer;
            font-size: 13px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: var(--transition-fast);
        }

        .delete-zone:hover {
            background: rgba(139, 58, 58, 0.1);
        }

        /* 日志 */
        .log-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            max-height: 150px;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: 10px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .log-entry.success { color: #50a06a; }
        .log-entry.error { color: #c75050; }
        .log-entry.info { color: var(--accent-primary); }

        /* 模型列表 */
        .model-list {
            max-height: 180px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .model-item {
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-fast);
        }

        .model-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border-accent);
        }

        .model-item.selected {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
        }

        .model-item-name {
            font-size: 12px;
            color: var(--text-primary);
        }

        /* 日期分隔 */
        .date-separator {
            display: flex;
            justify-content: center;
            padding: 12px 0;
        }

        .date-separator-text {
            padding: 4px 14px;
            background: var(--bg-glass-light);
            border-radius: 20px;
            font-size: 10px;
            color: var(--text-tertiary);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* 选择模式栏 */
        .select-mode-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px;
            background: rgba(139, 58, 58, 0.15);
            border-bottom: 1px solid rgba(139, 58, 58, 0.3);
        }

        .select-mode-bar.active { display: flex; }

        .select-mode-info {
            font-size: 13px;
            color: var(--text-primary);
        }

        .select-mode-btns {
            display: flex;
            gap: 10px;
        }

        .select-mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            letter-spacing: 0.5px;
        }

        .select-mode-btn.cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .select-mode-btn.delete {
            background: var(--danger);
            color: white;
        }

        /* 头像上传 */
        .avatar-upload-area {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 auto 16px;
            overflow: hidden;
            transition: var(--transition-fast);
        }

        .avatar-upload-area:hover {
            border-color: var(--accent-primary);
        }

        .avatar-upload-area.has-image {
            border-style: solid;
            border-color: var(--accent-primary);
        }

        .avatar-upload-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-area svg {
            width: 32px;
            height: 32px;
            fill: var(--text-tertiary);
        }

        /* 颜色选择器 */
        .color-picker-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .color-picker-label {
            font-size: 13px;
            color: var(--text-secondary);
            flex: 1;
        }

        .color-picker-input {
            width: 44px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        /* 形状选项 */
        .shape-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .shape-option {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .shape-option.selected {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* 世界书条目 */
        .worldbook-entries {
            margin-top: 12px;
        }

        .worldbook-entry-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }

        .worldbook-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .worldbook-entry-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .worldbook-entry-actions {
            display: flex;
            gap: 6px;
        }

        .worldbook-entry-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .worldbook-entry-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .worldbook-entry-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .worldbook-entry-keywords {
            font-size: 11px;
            color: var(--accent-primary);
            margin-bottom: 6px;
        }

        .worldbook-entry-preview {
            font-size: 11px;
            color: var(--text-tertiary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* 世界书列表 */
        .worldbook-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .worldbook-item:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: var(--border-accent);
        }

        .worldbook-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .worldbook-item-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .worldbook-item-badge {
            padding: 3px 10px;
            background: var(--accent-glow);
            border-radius: 12px;
            font-size: 10px;
            color: var(--accent-primary);
            letter-spacing: 0.5px;
        }

        .worldbook-item-preview {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* 字符计数 */
        .char-counter {
            font-size: 10px;
            color: var(--text-tertiary);
            text-align: right;
            margin-top: 4px;
        }

        .char-counter.warning { color: #a08030; }
        .char-counter.error { color: var(--danger); }

        /* 壁纸预览 */
        .wallpaper-preview {
            width: 100%;
            height: 140px;
            border-radius: 14px;
            margin-bottom: 16px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        /* 图标自定义网格 */
        .icon-customize-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
        }

        .icon-customize-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .icon-customize-preview {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px dashed var(--border-accent);
            overflow: hidden;
            transition: var(--transition-fast);
            background: var(--bg-tertiary);
        }

        .icon-customize-preview:hover {
            border-color: var(--accent-primary);
        }

        .icon-customize-preview.has-image {
            border-style: solid;
        }

        .icon-customize-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .icon-customize-preview svg {
            width: 24px;
            height: 24px;
            fill: var(--text-tertiary);
        }

        .icon-customize-label {
            font-size: 9px;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* 存储卡片 */
        .storage-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .storage-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .storage-size {
            font-size: 12px;
            color: var(--accent-primary);
        }

        .storage-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .storage-bar-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .storage-bar-fill.warning { background: #a08030; }
        .storage-bar-fill.danger { background: var(--danger); }

        .storage-details {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        /* CSS指南 */
        .guide-content {
            max-height: 55vh;
            overflow-y: auto;
            padding-right: 8px;
        }

        .guide-section {
            margin-bottom: 18px;
        }

        .guide-section-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-primary);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .guide-code {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 10px 12px;
            font-family: var(--font-mono);
            font-size: 11px;
            color: #a0d995;
            margin-bottom: 8px;
            overflow-x: auto;
        }

        /* 聊天壁纸预览 */
        .chat-wallpaper-preview {
            width: 100%;
            height: 90px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            font-size: 12px;
            overflow: hidden;
        }

        .chat-wallpaper-preview.has-image {
            background-size: cover !important;
            background-position: center !important;
        }

        .chat-wallpaper-preview.has-image span { display: none; }

        /* 世界书多选 */
        .worldbook-multi-select {
            max-height: 160px;
            overflow-y: auto;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            background: var(--bg-tertiary);
        }

        .worldbook-multi-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .worldbook-multi-item:last-child { border-bottom: none; }
        .worldbook-multi-item:hover { background: var(--bg-glass-light); }

        .worldbook-multi-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .worldbook-multi-checkbox.checked {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .worldbook-multi-checkbox.checked::after {
            content: '✓';
            color: #0a0a0a;
            font-size: 12px;
            font-weight: 600;
        }

        .worldbook-multi-name {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* 字体列表 */
        .font-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .font-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .font-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .font-item.selected {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
        }

        .font-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .font-item-name {
            font-size: 14px;
            color: var(--text-primary);
        }

        .font-item-preview {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .font-item-actions {
            display: flex;
            gap: 8px;
        }

        .font-item-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .font-item-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .font-item-btn.danger:hover {
            color: var(--danger);
        }

        .font-item-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        /* 自定义CSS样式容器 */
        #customCssStyles { }
    </style>
    <style id="customCssStyles"></style>
</head>
<body>
    <div id="wallpaperLayer"></div>

    <div class="phone-container">
        <!-- 状态栏 -->
        <div class="status-bar" id="statusBar">
            <span class="status-bar-time" id="statusBarTime">9:41</span>
            <div class="status-bar-icons">
                <svg viewBox="0 0 24 24"><path d="M12 3C7.46 3 3.34 4.78.29 7.67c-.18.18-.29.43-.29.71 0 .28.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73s3.15.25 4.6.73v3.1c0 .4.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71 0-.28-.11-.53-.29-.71C20.66 4.78 16.54 3 12 3z"/></svg>
                <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
            </div>
        </div>

        <!-- 主屏幕 -->
        <div class="home-screen" id="homeScreen">
            <div class="home-header">
                <div class="home-brand">Premium Experience</div>
                <div class="home-title">NOIR</div>
                <div class="home-subtitle">Elegant · Minimal · Refined</div>
            </div>

            <div class="app-grid" id="appGrid">
                <div class="app-icon-wrapper" onclick="openPage('settingsPage')">
                    <div class="app-icon" id="appIconSettings">
                        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    </div>
                    <span class="app-icon-label">Settings</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('messagesPage')">
                    <div class="app-icon" id="appIconMessages">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
                    </div>
                    <span class="app-icon-label">Messages</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('worldbookPage')">
                    <div class="app-icon" id="appIconWorldbook">
                        <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                    </div>
                    <span class="app-icon-label">Lore</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('wallpaperPage')">
                    <div class="app-icon" id="appIconPhotos">
                        <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </div>
                    <span class="app-icon-label">Theme</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('fontPage')">
                    <div class="app-icon" id="appIconFont">
                        <svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98 9.93 13.5zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg>
                    </div>
                    <span class="app-icon-label">Fonts</span>
                </div>
            </div>
        </div>

        <div class="home-indicator"></div>

        <!-- 设置页面 -->
        <div class="page" id="settingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('settingsPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title">Settings</div>
                    <div class="nav-subtitle">Configuration</div>
                </div>
                <div class="nav-btn" style="visibility:hidden"></div>
            </div>
            <div class="page-content">
                <!-- 存储卡片 -->
                <div class="storage-card">
                    <div class="storage-header">
                        <span class="storage-title">Storage Usage</span>
                        <span class="storage-size" id="storageSize">Calculating...</span>
                    </div>
                    <div class="storage-bar"><div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div></div>
                    <div class="storage-details">
                        <span id="storageUsed">Used: 0 MB</span>
                        <span id="storageTotal">Unlimited</span>
                    </div>
                </div>

                <!-- API配置 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">API Configuration</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="hint-bar" id="connectionStatusHint">
                            <div class="hint-bar-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div>
                            <span class="hint-bar-text">API not configured</span>
                        </div>

                        <!-- API预设选择器 -->
                        <div class="input-group">
                            <label class="input-label">API Presets</label>
                            <div class="preset-selector">
                                <select class="select-field" id="apiPresetSelect" onchange="loadApiPreset()">
                                    <option value="">-- Select Preset --</option>
                                </select>
                                <button class="preset-btn" onclick="addNewApiPreset()" title="New Preset">
                                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                </button>
                                <button class="preset-btn" onclick="updateApiPreset()" title="Update Preset">
                                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                                </button>
                                <button class="preset-btn" onclick="deleteApiPreset()" title="Delete Preset">
                                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">API Endpoint</label>
                            <input type="text" class="input-field" id="apiBaseUrl" placeholder="https://api.example.com">
                        </div>
                        <div class="input-group">
                            <label class="input-label">API Key</label>
                            <input type="password" class="input-field" id="apiKey" placeholder="sk-xxxxxxxxxxxxx">
                        </div>
                        <button class="btn btn-secondary" onclick="fetchModels()" id="fetchModelsBtn">Fetch Models</button>
                        <div id="modelListContainer" style="display:none">
                            <label class="input-label" style="margin-top:14px">Available Models</label>
                            <div class="model-list" id="modelList"></div>
                        </div>
                        <div class="input-group" style="margin-top:14px">
                            <label class="input-label">Current Model</label>
                            <input type="text" class="input-field" id="modelName" placeholder="Model name">
                        </div>
                        <div class="btn-stack" style="margin-top:14px">
                            <button class="btn btn-ghost" onclick="testConnection()" id="testConnectionBtn">Test Connection</button>
                            <button class="btn btn-primary" onclick="saveApiSettings()">Save Settings</button>
                        </div>
                        <div class="divider"></div>
                        <label class="input-label">Debug Log</label>
                        <div class="log-container" id="debugLog"><div class="log-entry info">Awaiting operation...</div></div>
                    </div>
                </div>

                <!-- 对话设置 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Conversation</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="input-group">
                            <label class="input-label">Max Context Messages</label>
                            <input type="number" class="input-field" id="maxContextMessages" value="200">
                        </div>
                    </div>
                </div>

                <!-- 模型参数 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Model Parameters</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Temperature</span>
                                <span class="slider-value" id="tempValue">0.7</span>
                            </div>
                            <input type="range" class="slider-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempValue').textContent=this.value">
                        </div>
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Max Tokens</span>
                                <span class="slider-value" id="maxTokensValue">2048</span>
                            </div>
                            <input type="range" class="slider-input" id="maxTokens" min="256" max="8192" step="256" value="2048" oninput="document.getElementById('maxTokensValue').textContent=this.value">
                        </div>
                    </div>
                </div>

                <!-- 缓存管理 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Cache Management</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="clearImageCache()">
                            <div class="settings-item-left">
                                <div class="settings-icon"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div>
                                <div class="settings-item-text">
                                    <span class="settings-item-label">Clear Image Cache</span>
                                    <span class="settings-item-desc">Avatars, wallpapers, etc.</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings-item" onclick="clearMessageCache()">
                            <div class="settings-item-left">
                                <div class="settings-icon"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div>
                                <div class="settings-item-text">
                                    <span class="settings-item-label">Clear Messages</span>
                                    <span class="settings-item-desc">Keep character settings</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings-item" onclick="compactDatabase()">
                            <div class="settings-item-left">
                                <div class="settings-icon"><svg viewBox="0 0 24 24"><path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6-4.72 7.28L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.94 2.55 2 6.81 2 12c0 3.76 2.09 7.07 5.22 8.78L6 22h5v-5l-2.28 2.28C6.92 18 5 15.21 5 12c0-4.08 3.05-7.44 7-7.93V2.05z"/></svg></div>
                                <div class="settings-item-text">
                                    <span class="settings-item-label">Optimize Storage</span>
                                    <span class="settings-item-desc">Compress images</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据管理 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Data Management</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="forceSaveAll()">
                            <div class="settings-item-left">
                                <div class="settings-icon gold"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></div>
                                <span class="settings-item-label">Force Save</span>
                            </div>
                        </div>
                        <div class="settings-item" onclick="exportAllData()">
                            <div class="settings-item-left">
                                <div class="settings-icon"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg></div>
                                <span class="settings-item-label">Export Data</span>
                            </div>
                        </div>
                        <div class="settings-item" onclick="document.getElementById('importFileInput').click()">
                            <div class="settings-item-left">
                                <div class="settings-icon"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6-.67l2.59 2.58L17 12.5l-5-5-5 5 1.41 1.41L11 11.33V21h2v-9.67z"/></svg></div>
                                <span class="settings-item-label">Import Data</span>
                            </div>
                        </div>
                        <input type="file" id="importFileInput" class="file-input-hidden" accept=".json" onchange="importData(event)">
                        <div class="settings-item" onclick="clearAllData()">
                            <div class="settings-item-left">
                                <div class="settings-icon danger"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div>
                                <span class="settings-item-label">Clear All Data</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="height:40px"></div>
            </div>
        </div>

        <!-- 短信列表页面 -->
        <div class="page" id="messagesPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('messagesPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title">Messages</div>
                    <div class="nav-subtitle">Conversations</div>
                </div>
                <button class="nav-btn" onclick="showModal('createCharacterModal')">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
            <div class="page-content">
                <div class="search-container">
                    <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input type="text" class="search-field" id="contactSearch" placeholder="Search characters..." oninput="filterContacts()">
                </div>
                <div class="empty-state" id="emptyContactState">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div>
                    <div class="empty-state-title">No Characters</div>
                    <div class="empty-state-desc">Tap + to create one</div>
                </div>
                <div class="contact-list" id="contactList" style="display:none"></div>
            </div>
        </div>

        <!-- 聊天页面 -->
        <div class="page" id="chatPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeChatPage()">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title" id="chatTitle">Character</div>
                    <div class="nav-subtitle">Online</div>
                </div>
                <button class="nav-btn" onclick="openCharacterSettings()">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </button>
            </div>
            <div class="select-mode-bar" id="selectModeBar">
                <span class="select-mode-info">Selected: <span id="selectedCount">0</span></span>
                <div class="select-mode-btns">
                    <button class="select-mode-btn cancel" onclick="exitSelectMode()">Cancel</button>
                    <button class="select-mode-btn delete" onclick="deleteSelectedMessages()">Delete</button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>

                <div class="extension-panel" id="extensionPanel">
                    <div class="ext-panel-header">
                        <span class="ext-panel-title">Actions</span>
                        <button class="ext-panel-close" onclick="toggleExtensionPanel()">✕</button>
                    </div>
                    <button class="ext-btn" onclick="enterSelectMode()">
                        <div class="ext-btn-icon"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Select & Delete</div><div class="ext-btn-desc">Batch delete messages</div></div>
                    </button>
                    <button class="ext-btn" onclick="regenerateLastReply()">
                        <div class="ext-btn-icon"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Regenerate</div><div class="ext-btn-desc">Regenerate AI response</div></div>
                    </button>
                    <button class="ext-btn" onclick="openImagePicker()">
                        <div class="ext-btn-icon"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">Send Image</div><div class="ext-btn-desc">Send image to AI</div></div>
                    </button>
                </div>

                <div class="chat-input-wrapper">
                    <div class="quote-preview-bar" id="quotePreviewBar">
                        <div class="quote-preview-content" id="quotePreviewContent"></div>
                        <button class="quote-preview-close" onclick="cancelQuote()">✕</button>
                    </div>
                    <div class="chat-input-area">
                        <button class="chat-btn" onclick="toggleExtensionPanel()" title="More">
                            <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
                        </button>
                        <textarea class="chat-input-field" id="chatInput" placeholder="Type a message..." rows="1" oninput="autoResizeTextarea(this)"></textarea>
                        <button class="chat-btn ai" onclick="triggerAIReply()" title="AI Reply">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        </button>
                        <button class="chat-btn send" onclick="sendMessage()" title="Send">
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <input type="file" id="chatImageInput" class="file-input-hidden" accept="image/*" onchange="handleChatImageUpload(event)">
        </div>

        <!-- 上下文菜单 -->
        <div class="context-menu-overlay" id="contextMenuOverlay" onclick="hideContextMenu()">
            <div class="context-menu" id="contextMenu" onclick="event.stopPropagation()">
                <div class="context-menu-item" onclick="copyMessageText()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></div>
                    <span class="context-menu-label">Copy Text</span>
                </div>
                <div class="context-menu-item" onclick="quoteMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/></svg></div>
                    <span class="context-menu-label">Quote Reply</span>
                </div>
                <div class="context-menu-item" onclick="editMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div>
                    <span class="context-menu-label">Edit Message</span>
                </div>
            </div>
        </div>

        <!-- 角色设置页面 -->
        <div class="page slide-from-bottom" id="characterSettingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeCharacterSettings()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title">Character</div>
                    <div class="nav-subtitle">Settings</div>
                </div>
                <button class="nav-btn" onclick="saveCharacterSettings()">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </button>
            </div>
            <div class="page-content">
                <!-- 聊天管理 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Chat Management</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="confirmClearAllMessages()">
                            <div class="settings-item-left">
                                <div class="settings-icon danger"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div>
                                <div class="settings-item-text">
                                    <span class="settings-item-label">Clear All Messages</span>
                                    <span class="settings-item-desc">Delete all chat history</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 聊天壁纸 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Chat Wallpaper</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="chat-wallpaper-preview" id="chatWallpaperPreview"><span>No custom wallpaper</span></div>
                        <div class="btn-row">
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('chatWallpaperInput').click()">Upload</button>
                            <button class="btn btn-ghost btn-small" onclick="clearChatWallpaper()">Clear</button>
                        </div>
                        <input type="file" id="chatWallpaperInput" class="file-input-hidden" accept="image/*" onchange="handleChatWallpaperUpload(event)">
                    </div>
                </div>

                <!-- 头像 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Avatars</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <label class="input-label">Character Avatar</label>
                        <div class="avatar-upload-area" id="charAvatarUpload" onclick="document.getElementById('charAvatarInput').click()">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <input type="file" id="charAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleCharAvatarUpload(event)">
                        <label class="input-label" style="margin-top:16px">User Avatar</label>
                        <div class="avatar-upload-area" id="userAvatarUpload" onclick="document.getElementById('userAvatarInput').click()">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <input type="file" id="userAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleUserAvatarUpload(event)">
                    </div>
                </div>

                <!-- 头像显示设置 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Avatar Display</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="settings-item" style="padding:0 0 14px 0">
                            <span class="settings-item-label">Show Avatars</span>
                            <div class="toggle-switch" id="showAvatarToggle" onclick="toggleSwitch(this)"></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Shape</label>
                            <div class="shape-options" id="avatarShapeOptions">
                                <div class="shape-option selected" data-shape="circle" onclick="selectShape(this)">Circle</div>
                                <div class="shape-option" data-shape="square" onclick="selectShape(this)">Square</div>
                                <div class="shape-option" data-shape="rounded-square" onclick="selectShape(this)">Rounded</div>
                            </div>
                        </div>
                        <div class="settings-item" style="padding:14px 0">
                            <span class="settings-item-label">Border</span>
                            <div class="toggle-switch" id="showBorderToggle" onclick="toggleSwitch(this)"></div>
                        </div>
                        <div class="color-picker-row">
                            <span class="color-picker-label">Border Color</span>
                            <input type="color" class="color-picker-input" id="borderColorPicker" value="#c9a962">
                        </div>
                    </div>
                </div>

                <!-- 基本信息 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Basic Info</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="input-group">
                            <label class="input-label">Name</label>
                            <input type="text" class="input-field" id="charName" placeholder="Character name">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Emoji (when no avatar)</label>
                            <input type="text" class="input-field" id="charAvatar" placeholder="😊">
                        </div>
                    </div>
                </div>

                <!-- 角色设定 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Character Definition</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <textarea class="input-field" id="charDescription" rows="5" placeholder="Personality, background, etc."></textarea>
                    </div>
                </div>

                <!-- 开场白 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">First Message (300 chars)</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <textarea class="input-field" id="charGreeting" rows="3" maxlength="300" placeholder="Opening message..." oninput="updateCharCounter()"></textarea>
                        <div class="char-counter" id="greetingCharCounter">0/300</div>
                    </div>
                </div>

                <!-- 情景 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Scenario</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <textarea class="input-field" id="charScenario" rows="3" placeholder="Scene description..."></textarea>
                    </div>
                </div>

                <!-- 世界书绑定 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Lore Books</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="worldbook-multi-select" id="worldbookMultiSelect"></div>
                    </div>
                </div>

                <!-- 高级设置 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Advanced</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="input-group">
                            <label class="input-label">User's Name</label>
                            <input type="text" class="input-field" id="charUserNick" placeholder="What is the user called in story...">
                        </div>
                        <div class="input-group">
                            <label class="input-label">System Prompt</label>
                            <textarea class="input-field" id="charSystemPrompt" rows="3" placeholder="Additional instructions..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- 自定义CSS -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Custom CSS</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="hint-bar warning">
                            <div class="hint-bar-icon"><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
                            <span class="hint-bar-text">Custom CSS overrides avatar settings above</span>
                        </div>
                        <div class="input-group">
                            <label class="input-label">CSS Presets</label>
                            <div class="preset-selector">
                                <select class="select-field" id="cssPresetSelect" onchange="loadCssPreset()"><option value="">-- No Preset --</option></select>
                                <button class="preset-btn" onclick="addNewCssPreset()" title="New Preset">
                                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                </button>
                                <button class="preset-btn" onclick="saveCssPreset()" title="Save Preset">
                                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                                </button>
                                <button class="preset-btn" onclick="deleteCssPreset()" title="Delete Preset">
                                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                                <button class="preset-btn" onclick="showCssGuide()" title="CSS Guide">
                                    <svg viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Timestamp Position</label>
                            <select class="select-field" id="timestampPosition">
                                <option value="default">Default (inside bubble)</option>
                                <option value="hidden">Hidden</option>
                                <option value="side">Side of bubble</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Custom CSS Code</label>
                            <textarea class="input-field code-editor" id="customCssEditor" rows="8" placeholder="/* Enter custom CSS here */"></textarea>
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-secondary btn-small" onclick="previewCss()">Preview</button>
                            <button class="btn btn-ghost btn-small" onclick="clearCustomCss()">Clear CSS</button>
                        </div>
                    </div>
                </div>

                <div class="delete-zone" onclick="deleteCurrentCharacter()">Delete Character</div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- 世界书页面 -->
        <div class="page" id="worldbookPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('worldbookPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title">Lore</div>
                    <div class="nav-subtitle">World Books</div>
                </div>
                <button class="nav-btn" onclick="showModal('createWorldbookModal')">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
            <div class="page-content">
                <div class="hint-bar">
                    <div class="hint-bar-icon"><svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></div>
                    <span class="hint-bar-text">Each lore book can contain multiple entries</span>
                </div>
                <div class="empty-state" id="emptyWorldbookState">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></div>
                    <div class="empty-state-title">No Lore Books</div>
                    <div class="empty-state-desc">Tap + to create one</div>
                </div>
                <div id="worldbookList" style="display:none"></div>
            </div>
        </div>

        <!-- 世界书编辑页面 -->
        <div class="page slide-from-bottom" id="worldbookEditPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeWorldbookEdit()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title">Edit</div>
                    <div class="nav-subtitle">Lore Book</div>
                </div>
                <button class="nav-btn" onclick="saveWorldbook()">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </button>
            </div>
            <div class="page-content">
                <div class="settings-group" style="padding:18px">
                    <div class="input-group">
                        <label class="input-label">Lore Book Name</label>
                        <input type="text" class="input-field" id="worldbookName" placeholder="Name">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Description</label>
                        <textarea class="input-field" id="worldbookSummary" rows="2" placeholder="Summary..."></textarea>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Entries</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="worldbook-entries" id="worldbookEntries"></div>
                        <button class="btn btn-secondary" onclick="addWorldbookEntry()">+ Add Entry</button>
                    </div>
                </div>

                <div class="delete-zone" onclick="deleteCurrentWorldbook()">Delete Lore Book</div>
                <div style="height:40px"></div>
            </div>
        </div>

        <!-- 条目编辑模态框 -->
        <div class="modal-overlay" id="entryEditModal">
            <div class="modal">
                <div class="modal-title">Edit Entry</div>
                <div class="input-group">
                    <label class="input-label">Entry Name</label>
                    <input type="text" class="modal-input" id="entryName" placeholder="Name" style="margin-bottom:10px">
                </div>
                <div class="input-group">
                    <label class="input-label">Trigger Keywords (comma-separated)</label>
                    <input type="text" class="modal-input" id="entryKeywords" placeholder="keyword1, keyword2..." style="margin-bottom:10px">
                </div>
                <div class="input-group">
                    <label class="input-label">Content</label>
                    <textarea class="input-field" id="entryContent" rows="5" placeholder="Content..."></textarea>
                </div>
                <div class="settings-item" style="padding:14px 0">
                    <span class="settings-item-label">Always Active</span>
                    <div class="toggle-switch" id="entryAlwaysActive" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="hideModal('entryEditModal')">Cancel</button>
                    <button class="modal-btn confirm" onclick="saveWorldbookEntry()">Save</button>
                </div>
            </div>
        </div>

        <!-- 壁纸页面 -->
        <div class="page" id="wallpaperPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('wallpaperPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title">Theme</div>
                    <div class="nav-subtitle">Customization</div>
                </div>
                <div class="nav-btn" style="visibility:hidden"></div>
            </div>
            <div class="page-content">
                <!-- 显示设置 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Display</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="toggleStatusBar()">
                            <div class="settings-item-left">
                                <div class="settings-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></div>
                                <div class="settings-item-text">
                                    <span class="settings-item-label">Hide Status Bar</span>
                                    <span class="settings-item-desc">Avoid overlap with system bar</span>
                                </div>
                            </div>
                            <div class="toggle-switch" id="hideStatusBarToggle"></div>
                        </div>
                    </div>
                </div>

                <!-- 壁纸预览 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Preview</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="wallpaper-preview" id="wallpaperPreview"></div>
                </div>

                <!-- 预设壁纸 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Preset Wallpapers</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px" id="wallpaperGrid">
                            <div onclick="selectPresetWallpaper('gradient1')" style="height:60px;border-radius:10px;background:linear-gradient(135deg,#0a0a0a,#1a1a1a);cursor:pointer;border:2px solid transparent" data-wp="gradient1"></div>
                            <div onclick="selectPresetWallpaper('gradient2')" style="height:60px;border-radius:10px;background:linear-gradient(135deg,#1a1510,#0a0a0a);cursor:pointer;border:2px solid transparent" data-wp="gradient2"></div>
                            <div onclick="selectPresetWallpaper('gradient3')" style="height:60px;border-radius:10px;background:linear-gradient(135deg,#0f0f1a,#1a1a2e);cursor:pointer;border:2px solid transparent" data-wp="gradient3"></div>
                            <div onclick="selectPresetWallpaper('gradient4')" style="height:60px;border-radius:10px;background:linear-gradient(135deg,#0a0f0a,#1a2a1a);cursor:pointer;border:2px solid transparent" data-wp="gradient4"></div>
                            <div onclick="selectPresetWallpaper('gradient5')" style="height:60px;border-radius:10px;background:linear-gradient(135deg,#1a0a0a,#0a0a0a);cursor:pointer;border:2px solid transparent" data-wp="gradient5"></div>
                            <div onclick="selectPresetWallpaper('gradient6')" style="height:60px;border-radius:10px;background:linear-gradient(180deg,#0a0a0a,#151515,#0a0a0a);cursor:pointer;border:2px solid transparent" data-wp="gradient6"></div>
                        </div>
                    </div>
                </div>

                <!-- 自定义壁纸 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">Custom</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="input-group">
                            <label class="input-label">Image URL</label>
                            <input type="text" class="input-field" id="customWallpaperUrl" placeholder="https://...">
                        </div>
                        <button class="btn btn-secondary" onclick="previewUrlWallpaper()">Preview</button>
                        <div class="divider"></div>
                        <button class="btn btn-secondary" onclick="document.getElementById('wallpaperUpload').click()">Upload Image</button>
                        <input type="file" id="wallpaperUpload" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveWallpaper()" style="margin-bottom:20px">Save Wallpaper</button>

                <!-- 图标自定义 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-title">App Icons</span>
                        <div class="settings-section-line"></div>
                    </div>
                    <div class="settings-group" style="padding:18px">
                        <div class="icon-customize-grid">
                            <div class="icon-customize-item">
                                <div class="icon-customize-preview" id="iconPreviewSettings" onclick="document.getElementById('iconInputSettings').click()">
                                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                </div>
                                <span class="icon-customize-label">Settings</span>
                                <input type="file" id="iconInputSettings" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'settings')">
                            </div>
                            <div class="icon-customize-item">
                                <div class="icon-customize-preview" id="iconPreviewMessages" onclick="document.getElementById('iconInputMessages').click()">
                                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                                </div>
                                <span class="icon-customize-label">Messages</span>
                                <input type="file" id="iconInputMessages" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'messages')">
                            </div>
                            <div class="icon-customize-item">
                                <div class="icon-customize-preview" id="iconPreviewWorldbook" onclick="document.getElementById('iconInputWorldbook').click()">
                                    <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                                </div>
                                <span class="icon-customize-label">Lore</span>
                                <input type="file" id="iconInputWorldbook" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'worldbook')">
                            </div>
                            <div class="icon-customize-item">
                                <div class="icon-customize-preview" id="iconPreviewPhotos" onclick="document.getElementById('iconInputPhotos').click()">
                                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                </div>
                                <span class="icon-customize-label">Theme</span>
                                <input type="file" id="iconInputPhotos" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'photos')">
                            </div>
                            <div class="icon-customize-item">
                                <div class="icon-customize-preview" id="iconPreviewFont" onclick="document.getElementById('iconInputFont').click()">
                                    <svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98 9.93 13.5zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg>
                                </div>
                                <span class="icon-customize-label">Fonts</span>
                                <input type="file" id="iconInputFont" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'font')">
                            </div>
                        </div>
                        <div class="divider"></div>
                        <button class="btn btn-primary" onclick="saveIcons()">Save Icons</button>
                        <div style="height:8px"></div>
                        <button class="btn btn-ghost" onclick="resetIcons()">Reset Icons</button>
                    </div>
                </div>

                <div style="height:40px"></div>
            </div>
        </div>

        <!-- 字体页面 -->
        <div class="page" id="fontPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('fontPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <div class="nav-title-group">
                    <div class="nav-title">Fonts</div>
                    <div class="nav-subtitle">Typography</div>
                </div>
                <button class="nav-btn" onclick="showModal('addFontModal')">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
            <div class="page-content">
                <div class="hint-bar">
                    <div class="hint-bar-icon"><svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98 9.93 13.5zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg></div>
                    <span class="hint-bar-text">Font changes apply globally to all text</span>
                </div>
                <div class="font-list" id="fontList"></div>
            </div>
        </div>
    </div>

    <!-- 创建角色模态框 -->
    <div class="modal-overlay" id="createCharacterModal">
        <div class="modal">
            <div class="modal-title">Create Character</div>
            <input type="text" class="modal-input" id="newCharacterName" placeholder="Character name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createCharacterModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createCharacter()">Create</button>
            </div>
        </div>
    </div>

    <!-- 创建世界书模态框 -->
    <div class="modal-overlay" id="createWorldbookModal">
        <div class="modal">
            <div class="modal-title">Create Lore Book</div>
            <input type="text" class="modal-input" id="newWorldbookName" placeholder="Lore book name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createWorldbookModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createWorldbook()">Create</button>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal">
            <div class="modal-title" id="deleteModalTitle">Confirm Delete?</div>
            <p style="color:var(--text-tertiary);text-align:center;margin-bottom:18px;font-size:13px" id="deleteModalDesc">This action cannot be undone</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('confirmDeleteModal')">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- 清除消息确认模态框 -->
    <div class="modal-overlay" id="clearMessagesModal">
        <div class="modal">
            <div class="modal-title">Clear All Messages</div>
            <p style="color:var(--text-tertiary);text-align:center;margin-bottom:18px;font-size:13px">Delete all chat history with this character?<br>This cannot be undone!</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('clearMessagesModal')">Cancel</button>
                <button class="modal-btn danger" onclick="executeClearAllMessages()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- API预设名称模态框 -->
    <div class="modal-overlay" id="apiPresetNameModal">
        <div class="modal">
            <div class="modal-title">New API Preset</div>
            <input type="text" class="modal-input" id="newApiPresetName" placeholder="Preset name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('apiPresetNameModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createApiPreset()">Create</button>
            </div>
        </div>
    </div>

    <!-- CSS预设名称模态框 -->
    <div class="modal-overlay" id="cssPresetNameModal">
        <div class="modal">
            <div class="modal-title">New CSS Preset</div>
            <input type="text" class="modal-input" id="newCssPresetName" placeholder="Preset name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('cssPresetNameModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createCssPreset()">Create</button>
            </div>
        </div>
    </div>

    <!-- CSS指南模态框 -->
    <div class="modal-overlay" id="cssGuideModal">
        <div class="modal" style="max-width:400px">
            <div class="modal-title">CSS Guide</div>
            <div class="guide-content">
                <div class="guide-section">
                    <div class="guide-section-title">Message Bubbles</div>
                    <div class="guide-code">.message.sent { }<br>.message.received { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Quote Bubble</div>
                    <div class="guide-code">.message-quote { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Avatar</div>
                    <div class="guide-code">.message-avatar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Timestamp</div>
                    <div class="guide-code">.message-time { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Input Area</div>
                    <div class="guide-code">.chat-input-area { }<br>.chat-input-field { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Navigation Bar</div>
                    <div class="guide-code">#chatPage .nav-bar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">Example</div>
                    <div class="guide-code">.message.sent {<br>  background: linear-gradient(135deg, #c9a962, #8b7355);<br>  border-radius: 20px;<br>}</div>
                </div>
            </div>
            <div class="modal-btns" style="margin-top:18px">
                <button class="modal-btn confirm" onclick="hideModal('cssGuideModal')">Got it</button>
            </div>
        </div>
    </div>

    <!-- 编辑消息模态框 -->
    <div class="modal-overlay" id="editMessageModal">
        <div class="modal">
            <div class="modal-title">Edit Message</div>
            <textarea class="input-field" id="editMessageContent" rows="5" placeholder="Edit content..."></textarea>
            <div class="modal-btns" style="margin-top:14px">
                <button class="modal-btn cancel" onclick="hideModal('editMessageModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="saveEditedMessage()">Save</button>
            </div>
        </div>
    </div>

    <!-- 添加字体模态框 -->
    <div class="modal-overlay" id="addFontModal">
        <div class="modal">
            <div class="modal-title">Add Font</div>
            <div class="input-group">
                <label class="input-label">Font Name</label>
                <input type="text" class="modal-input" id="newFontName" placeholder="e.g., My Custom Font" style="margin-bottom:10px">
            </div>
            <div class="input-group">
                <label class="input-label">Font URL (.ttf, .otf, .woff, .woff2)</label>
                <input type="text" class="modal-input" id="newFontUrl" placeholder="https://example.com/font.ttf" style="margin-bottom:0">
            </div>
            <div class="modal-btns" style="margin-top:18px">
                <button class="modal-btn cancel" onclick="hideModal('addFontModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="addCustomFont()">Add</button>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框（通用） -->
    <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal">
            <div class="modal-title" id="deleteConfirmTitle">Confirm Delete?</div>
            <p style="color:var(--text-tertiary);text-align:center;margin-bottom:18px;font-size:13px" id="deleteConfirmDesc">This action cannot be undone</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('deleteConfirmModal')">Cancel</button>
                <button class="modal-btn danger" onclick="executeGenericDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ==================== 数据库操作 ====================
        const DB_NAME = 'NoirSMSDB';
        const DB_VERSION = 4;
        let db = null;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('appData')) database.createObjectStore('appData', { keyPath: 'key' });
                    if (!database.objectStoreNames.contains('images')) database.createObjectStore('images', { keyPath: 'id' });
                };
            });
        }

        function saveToIDB(storeName, key, value) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).put(storeName === 'appData' ? { key, value } : { id: key, data: value });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        function loadFromIDB(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readonly');
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result ? (storeName === 'appData' ? req.result.value : req.result.data) : null);
                req.onerror = () => reject(req.error);
            });
        }

        function clearIDBStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DB not open'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).clear();
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function getStorageUsage() {
            try {
                if (navigator.storage?.estimate) {
                    const est = await navigator.storage.estimate();
                    return { used: est.usage || 0, quota: est.quota || 0, percent: est.quota ? (est.usage / est.quota * 100) : 0 };
                }
            } catch (e) {}
            return { used: 0, quota: 0, percent: 0 };
        }

        // ==================== 应用状态 ====================
        const App = {
            characters: [],
            worldbooks: [],
            currentCharId: null,
            currentWbId: null,
            currentEntryIndex: -1,
            pendingDeleteType: null,
            pendingDeleteId: null,
            models: [],
            connectionStatus: 'disconnected',
            isSelectMode: false,
            selectedMsgs: new Set(),
            lastAIStart: -1,
            tempWallpaper: null,
            tempIcons: {},
            appIcons: { settings: null, messages: null, worldbook: null, photos: null, font: null },
            settings: {
                apiBaseUrl: '',
                apiKey: '',
                modelName: '',
                temperature: 0.7,
                maxTokens: 2048,
                maxContextMessages: 200,
                wallpaper: 'gradient1',
                wallpaperData: null,
                hideStatusBar: false,
                currentFontId: null
            },
            globalCssPresets: [],
            apiPresets: [],
            customFonts: [],
            dataLoaded: false,
            currentQuote: null,
            contextMenuMsgId: null,
            longPressTimer: null,
            editingMsgId: null,
            genericDeleteCallback: null
        };

        // 预设字体
        const PRESET_FONTS = [
            { id: 'default', name: 'System Default', url: null, isPreset: true },
            { id: 'inter', name: 'Inter', url: 'https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiJ-Ek-_EeA.woff2', isPreset: true },
            { id: 'playfair', name: 'Playfair Display', url: 'https://fonts.gstatic.com/s/playfairdisplay/v30/nuFvD-vYSZviVYUb_rj3ij__anPXJzDwcbmjWBN2PKdFvXDXbtXK-F2qC0usEw.woff2', isPreset: true },
            { id: 'noto-sans-sc', name: 'Noto Sans SC', url: 'https://fonts.gstatic.com/s/notosanssc/v36/k3kCo84MPvpLmixcA63oeAL7Iqp5IZJF9bmaG9_FnYxNbPzS5HE.woff2', isPreset: true },
            { id: 'source-han-serif', name: 'Source Han Serif', url: 'https://fonts.gstatic.com/s/notoserifsc/v22/H4chBXePl9DZ0Xe7gG9cyOj7oqCcbzhrNiM.woff2', isPreset: true }
        ];

        const GRADIENTS = {
            gradient1: 'linear-gradient(180deg, #0a0a0a 0%, #0f0f0f 50%, #0a0a0a 100%)',
            gradient2: 'linear-gradient(135deg, #1a1510 0%, #0a0a0a 100%)',
            gradient3: 'linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%)',
            gradient4: 'linear-gradient(135deg, #0a0f0a 0%, #1a2a1a 100%)',
            gradient5: 'linear-gradient(135deg, #1a0a0a 0%, #0a0a0a 100%)',
            gradient6: 'linear-gradient(180deg, #0a0a0a 0%, #151515 50%, #0a0a0a 100%)'
        };

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadData();
                updateTime();
                setInterval(updateTime, 60000);
                applyWallpaper();
                applyAppIcons();
                applyStatusBarVisibility();
                applyGlobalFont();
                updateConnectionUI();
                highlightWallpaper();
                updateWallpaperPreview();
                updateIconPreviews();
                updateStorageDisplay();
                renderFontList();
                updateApiPresetSelect();
            } catch (e) {
                console.error('Init failed:', e);
                showToast('Initialization failed', 'error');
            }
        });

        // ==================== 数据管理 ====================
        async function saveData() {
            try {
                await Promise.all([
                    saveToIDB('appData', 'characters', App.characters),
                    saveToIDB('appData', 'worldbooks', App.worldbooks),
                    saveToIDB('appData', 'settings', App.settings),
                    saveToIDB('appData', 'appIcons', App.appIcons),
                    saveToIDB('appData', 'globalCssPresets', App.globalCssPresets),
                    saveToIDB('appData', 'apiPresets', App.apiPresets),
                    saveToIDB('appData', 'customFonts', App.customFonts)
                ]);
                return true;
            } catch (e) {
                console.error('Save failed:', e);
                return false;
            }
        }

        async function loadData() {
            try {
                const [characters, worldbooks, settings, icons, cssPresets, apiPresets, customFonts] = await Promise.all([
                    loadFromIDB('appData', 'characters'),
                    loadFromIDB('appData', 'worldbooks'),
                    loadFromIDB('appData', 'settings'),
                    loadFromIDB('appData', 'appIcons'),
                    loadFromIDB('appData', 'globalCssPresets'),
                    loadFromIDB('appData', 'apiPresets'),
                    loadFromIDB('appData', 'customFonts')
                ]);
                if (characters) App.characters = characters;
                if (worldbooks) App.worldbooks = worldbooks;
                if (settings) App.settings = { ...App.settings, ...settings };
                if (icons) App.appIcons = { ...App.appIcons, ...icons };
                if (cssPresets) App.globalCssPresets = cssPresets;
                if (apiPresets) App.apiPresets = apiPresets;
                if (customFonts) App.customFonts = customFonts;

                App.worldbooks.forEach(wb => {
                    if (!wb.entries) wb.entries = [{ name: 'Default Entry', keywords: wb.keywords || '', content: wb.content || '', alwaysActive: wb.alwaysActive || false }];
                });
                App.characters.forEach(c => {
                    if (c.worldbookId && !c.worldbookIds) c.worldbookIds = [c.worldbookId];
                    if (!c.worldbookIds) c.worldbookIds = [];
                });

                loadSettingsUI();
                if (App.settings.apiBaseUrl && App.settings.apiKey && App.settings.modelName) {
                    App.connectionStatus = 'connected';
                }
                App.dataLoaded = true;
                return true;
            } catch (e) {
                console.error('Load failed:', e);
                return false;
            }
        }

        function loadSettingsUI() {
            document.getElementById('apiBaseUrl').value = App.settings.apiBaseUrl || '';
            document.getElementById('apiKey').value = App.settings.apiKey || '';
            document.getElementById('modelName').value = App.settings.modelName || '';
            document.getElementById('maxContextMessages').value = App.settings.maxContextMessages || 200;
            document.getElementById('temperature').value = App.settings.temperature;
            document.getElementById('tempValue').textContent = App.settings.temperature;
            document.getElementById('maxTokens').value = App.settings.maxTokens;
            document.getElementById('maxTokensValue').textContent = App.settings.maxTokens;
        }

        async function updateStorageDisplay() {
            const usage = await getStorageUsage();
            const usedMB = (usage.used / (1024 * 1024)).toFixed(2);
            document.getElementById('storageSize').textContent = `${usedMB} MB`;
            document.getElementById('storageUsed').textContent = `Used: ${usedMB} MB`;
            document.getElementById('storageTotal').textContent = usage.quota > 0 ? `Quota: ${(usage.quota / (1024 * 1024)).toFixed(0)} MB` : 'Unlimited';
            const barFill = document.getElementById('storageBarFill');
            barFill.style.width = `${Math.min(usage.percent, 100)}%`;
            barFill.className = 'storage-bar-fill' + (usage.percent > 80 ? ' danger' : usage.percent > 60 ? ' warning' : '');
        }

        // ==================== 时间更新 ====================
        function updateTime() {
            document.getElementById('statusBarTime').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        // ==================== 状态栏 ====================
        function toggleStatusBar() {
            App.settings.hideStatusBar = !App.settings.hideStatusBar;
            applyStatusBarVisibility();
            saveData();
        }

        function applyStatusBarVisibility() {
            const statusBar = document.getElementById('statusBar');
            const homeScreen = document.getElementById('homeScreen');
            const toggle = document.getElementById('hideStatusBarToggle');
            if (App.settings.hideStatusBar) {
                statusBar.classList.add('hidden');
                homeScreen.classList.add('no-statusbar');
                toggle?.classList.add('active');
            } else {
                statusBar.classList.remove('hidden');
                homeScreen.classList.remove('no-statusbar');
                toggle?.classList.remove('active');
            }
        }

        // ==================== 壁纸管理 ====================
        function applyWallpaper() {
            const el = document.getElementById('wallpaperLayer');
            const wp = App.settings.wallpaper;
            const wpData = App.settings.wallpaperData;
            el.style.cssText = '';
            if (wpData) {
                el.style.cssText = `background-image:url(${wpData})!important;background-size:cover!important;background-position:center!important;`;
            } else if (wp?.startsWith('http')) {
                el.style.cssText = `background-image:url(${wp})!important;background-size:cover!important;background-position:center!important;`;
            } else if (GRADIENTS[wp]) {
                el.style.cssText = `background:${GRADIENTS[wp]}!important;`;
            } else {
                el.style.cssText = `background:${GRADIENTS.gradient1}!important;`;
            }
        }

        function updateWallpaperPreview() {
            const preview = document.getElementById('wallpaperPreview');
            const wp = App.tempWallpaper || App.settings.wallpaper;
            if (App.tempWallpaper?.startsWith('data:')) {
                preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            } else if (!App.tempWallpaper && App.settings.wallpaperData) {
                preview.style.cssText = `background-image:url(${App.settings.wallpaperData})!important;background-size:cover!important;background-position:center!important;`;
            } else if (App.tempWallpaper?.startsWith('http')) {
                preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            } else if (GRADIENTS[wp]) {
                preview.style.cssText = `background:${GRADIENTS[wp]}!important;`;
            } else {
                preview.style.cssText = `background:${GRADIENTS.gradient1}!important;`;
            }
        }

        function selectPresetWallpaper(name) {
            App.tempWallpaper = name;
            highlightWallpaper();
            updateWallpaperPreview();
            showToast('Click save to apply', 'info');
        }

        function previewUrlWallpaper() {
            const url = document.getElementById('customWallpaperUrl').value.trim();
            if (!url) { showToast('Please enter URL', 'error'); return; }
            App.tempWallpaper = url;
            updateWallpaperPreview();
            showToast('Click save to apply', 'info');
        }

        async function handleWallpaperUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                App.tempWallpaper = await compressImage(ev.target.result, 800, 0.8);
                updateWallpaperPreview();
                showToast('Click save to apply', 'success');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function saveWallpaper() {
            if (!App.tempWallpaper) { showToast('Please select first', 'warning'); return; }
            if (App.tempWallpaper.startsWith('data:')) {
                App.settings.wallpaperData = App.tempWallpaper;
                App.settings.wallpaper = 'custom';
            } else if (App.tempWallpaper.startsWith('http')) {
                App.settings.wallpaper = App.tempWallpaper;
                App.settings.wallpaperData = null;
            } else {
                App.settings.wallpaper = App.tempWallpaper;
                App.settings.wallpaperData = null;
            }
            App.tempWallpaper = null;
            if (await saveData()) {
                applyWallpaper();
                highlightWallpaper();
                updateWallpaperPreview();
                await updateStorageDisplay();
                showToast('Saved', 'success');
            }
        }

        function highlightWallpaper() {
            const current = App.tempWallpaper || App.settings.wallpaper;
            document.querySelectorAll('#wallpaperGrid > div').forEach(el => {
                el.style.borderColor = el.dataset.wp === current ? 'var(--accent-primary)' : 'transparent';
            });
        }

        // ==================== 图标管理 ====================
        function updateIconPreviews() {
            ['settings', 'messages', 'worldbook', 'photos', 'font'].forEach(app => {
                const preview = document.getElementById('iconPreview' + app.charAt(0).toUpperCase() + app.slice(1));
                if (!preview) return;
                const iconData = App.tempIcons[app] || App.appIcons[app];
                if (iconData) {
                    preview.innerHTML = `<img src="${iconData}">`;
                    preview.classList.add('has-image');
                } else {
                    // Keep SVG
                    preview.classList.remove('has-image');
                }
            });
        }

        function applyAppIcons() {
            const iconMap = {
                settings: 'appIconSettings',
                messages: 'appIconMessages',
                worldbook: 'appIconWorldbook',
                photos: 'appIconPhotos',
                font: 'appIconFont'
            };
            const defaultSvgs = {
                settings: '<svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>',
                messages: '<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>',
                worldbook: '<svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>',
                photos: '<svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>',
                font: '<svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98 9.93 13.5zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg>'
            };

            Object.keys(iconMap).forEach(app => {
                const el = document.getElementById(iconMap[app]);
                if (!el) return;
                const iconData = App.appIcons[app];
                if (iconData) {
                    el.innerHTML = `<img src="${iconData}" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    el.innerHTML = defaultSvgs[app];
                }
            });
        }

        async function handleIconUpload(e, appName) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                App.tempIcons[appName] = await compressImage(ev.target.result, 120, 0.8);
                updateIconPreviews();
                showToast('Click save to apply', 'info');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function saveIcons() {
            let changed = false;
            ['settings', 'messages', 'worldbook', 'photos', 'font'].forEach(app => {
                if (App.tempIcons[app]) {
                    App.appIcons[app] = App.tempIcons[app];
                    changed = true;
                }
            });
            App.tempIcons = {};
            if (changed && await saveData()) {
                applyAppIcons();
                await updateStorageDisplay();
                showToast('Saved', 'success');
            } else if (!changed) {
                showToast('No changes', 'info');
            }
        }

        async function resetIcons() {
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null, font: null };
            App.tempIcons = {};
            await saveData();
            applyAppIcons();
            updateIconPreviews();
            showToast('Reset', 'success');
        }

        // ==================== 字体管理 ====================
        function getAllFonts() {
            return [...PRESET_FONTS, ...App.customFonts];
        }

        function renderFontList() {
            const container = document.getElementById('fontList');
            const allFonts = getAllFonts();
            const currentFontId = App.settings.currentFontId || 'default';

            container.innerHTML = allFonts.map(font => `
                <div class="font-item ${font.id === currentFontId ? 'selected' : ''}" onclick="selectFont('${font.id}')">
                    <div class="font-item-info">
                        <span class="font-item-name">${escapeHtml(font.name)}</span>
                        <span class="font-item-preview">${font.isPreset ? 'Preset' : 'Custom'}</span>
                    </div>
                    <div class="font-item-actions">
                        ${!font.isPreset ? `<button class="font-item-btn danger" onclick="event.stopPropagation(); confirmDeleteFont('${font.id}')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function selectFont(fontId) {
            App.settings.currentFontId = fontId;
            await saveData();
            applyGlobalFont();
            renderFontList();
            showToast('Font applied', 'success');
        }

        function applyGlobalFont() {
            const styleEl = document.getElementById('globalFontStyle');
            const fontId = App.settings.currentFontId || 'default';

            if (fontId === 'default') {
                styleEl.textContent = '';
                return;
            }

            const allFonts = getAllFonts();
            const font = allFonts.find(f => f.id === fontId);

            if (font && font.url) {
                const format = getFontFormat(font.url);
                styleEl.textContent = `
                    @font-face {
                        font-family: 'CustomGlobalFont';
                        src: url('${font.url}') format('${format}');
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                    }
                    body, .input-field, .modal-input, .chat-input-field, textarea, input, select, button {
                        font-family: 'CustomGlobalFont', var(--font-body) !important;
                    }
                `;
            }
        }

        function getFontFormat(url) {
            if (url.includes('.woff2')) return 'woff2';
            if (url.includes('.woff')) return 'woff';
            if (url.includes('.otf')) return 'opentype';
            if (url.includes('.ttf')) return 'truetype';
            return 'truetype';
        }

        async function addCustomFont() {
            const name = document.getElementById('newFontName').value.trim();
            const url = document.getElementById('newFontUrl').value.trim();

            if (!name) { showToast('Please enter font name', 'error'); return; }
            if (!url) { showToast('Please enter font URL', 'error'); return; }

            const font = {
                id: Date.now().toString(),
                name,
                url,
                isPreset: false
            };

            App.customFonts.push(font);
            await saveData();
            hideModal('addFontModal');
            document.getElementById('newFontName').value = '';
            document.getElementById('newFontUrl').value = '';
            renderFontList();
            showToast(`Font "${name}" added`, 'success');
        }

        function confirmDeleteFont(fontId) {
            const font = App.customFonts.find(f => f.id === fontId);
            if (!font) return;

            App.genericDeleteCallback = async () => {
                App.customFonts = App.customFonts.filter(f => f.id !== fontId);
                if (App.settings.currentFontId === fontId) {
                    App.settings.currentFontId = 'default';
                    applyGlobalFont();
                }
                await saveData();
                renderFontList();
                showToast('Font deleted', 'success');
            };

            document.getElementById('deleteConfirmTitle').textContent = `Delete "${font.name}"?`;
            document.getElementById('deleteConfirmDesc').textContent = 'This font will be permanently removed';
            showModal('deleteConfirmModal');
        }

        // ==================== API预设管理 ====================
        function updateApiPresetSelect() {
            const select = document.getElementById('apiPresetSelect');
            select.innerHTML = '<option value="">-- Select Preset --</option>' +
                App.apiPresets.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
        }

        function loadApiPreset() {
            const presetId = document.getElementById('apiPresetSelect').value;
            if (!presetId) return;

            const preset = App.apiPresets.find(p => p.id === presetId);
            if (preset) {
                document.getElementById('apiBaseUrl').value = preset.apiBaseUrl || '';
                document.getElementById('apiKey').value = preset.apiKey || '';
                document.getElementById('modelName').value = preset.modelName || '';
                showToast(`Loaded: ${preset.name}`, 'success');
            }
        }

        function addNewApiPreset() {
            showModal('apiPresetNameModal');
            document.getElementById('newApiPresetName').value = '';
        }

        async function createApiPreset() {
            const name = document.getElementById('newApiPresetName').value.trim();
            if (!name) { showToast('Please enter name', 'error'); return; }

            const preset = {
                id: Date.now().toString(),
                name,
                apiBaseUrl: document.getElementById('apiBaseUrl').value.trim(),
                apiKey: document.getElementById('apiKey').value.trim(),
                modelName: document.getElementById('modelName').value.trim()
            };

            App.apiPresets.push(preset);
            await saveData();
            hideModal('apiPresetNameModal');
            updateApiPresetSelect();
            document.getElementById('apiPresetSelect').value = preset.id;
            showToast(`Preset "${name}" created`, 'success');
        }

        async function updateApiPreset() {
            const presetId = document.getElementById('apiPresetSelect').value;
            if (!presetId) { showToast('Please select a preset first', 'warning'); return; }

            const preset = App.apiPresets.find(p => p.id === presetId);
            if (!preset) return;

            preset.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            preset.apiKey = document.getElementById('apiKey').value.trim();
            preset.modelName = document.getElementById('modelName').value.trim();

            await saveData();
            showToast(`Preset "${preset.name}" updated`, 'success');
        }

        function deleteApiPreset() {
            const presetId = document.getElementById('apiPresetSelect').value;
            if (!presetId) { showToast('Please select a preset first', 'warning'); return; }

            const preset = App.apiPresets.find(p => p.id === presetId);
            if (!preset) return;

            App.genericDeleteCallback = async () => {
                App.apiPresets = App.apiPresets.filter(p => p.id !== presetId);
                await saveData();
                updateApiPresetSelect();
                showToast('Preset deleted', 'success');
            };

            document.getElementById('deleteConfirmTitle').textContent = `Delete "${preset.name}"?`;
            document.getElementById('deleteConfirmDesc').textContent = 'This API preset will be permanently removed';
            showModal('deleteConfirmModal');
        }

        // ==================== 通用删除 ====================
        async function executeGenericDelete() {
            hideModal('deleteConfirmModal');
            if (App.genericDeleteCallback) {
                await App.genericDeleteCallback();
                App.genericDeleteCallback = null;
            }
        }

        // ==================== 页面导航 ====================
        function openPage(id) {
            const page = document.getElementById(id);
            if (page) {
                page.classList.add('active');
                if (id === 'messagesPage') renderContacts();
                if (id === 'worldbookPage') renderWorldbooks();
                if (id === 'wallpaperPage') {
                    updateWallpaperPreview();
                    updateIconPreviews();
                    highlightWallpaper();
                    applyStatusBarVisibility();
                }
                if (id === 'settingsPage') {
                    updateStorageDisplay();
                    updateApiPresetSelect();
                }
                if (id === 'fontPage') renderFontList();
            }
        }

        function closePage(id) {
            document.getElementById(id)?.classList.remove('active');
        }

        function showModal(id) {
            document.getElementById(id)?.classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id)?.classList.remove('active');
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== API管理 ====================
        function addLog(msg, type = 'info') {
            const container = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateConnectionUI() {
            const hint = document.getElementById('connectionStatusHint');
            if (App.connectionStatus === 'connected') {
                hint.className = 'hint-bar success';
                hint.innerHTML = `<div class="hint-bar-icon"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div><span class="hint-bar-text">Connected - ${App.settings.modelName}</span>`;
            } else {
                hint.className = 'hint-bar';
                hint.innerHTML = `<div class="hint-bar-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div><span class="hint-bar-text">API not configured</span>`;
            }
        }

        async function fetchModels() {
            const url = document.getElementById('apiBaseUrl').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            if (!url || !key) { showToast('Please fill in fields', 'error'); return; }

            const btn = document.getElementById('fetchModelsBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                const r = await fetch(`${url.replace(/\/+$/, '').replace(/\/v1$/, '')}/v1/models`, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const d = await r.json();
                const models = d.data || d.models || d || [];
                App.models = models;
                document.getElementById('modelListContainer').style.display = 'block';
                document.getElementById('modelList').innerHTML = models.map(m => {
                    const id = m.id || m.name || m;
                    return `<div class="model-item" onclick="selectModel('${id}')"><span class="model-item-name">${id}</span></div>`;
                }).join('');
                addLog(`Found ${models.length} models`, 'success');
            } catch (e) {
                addLog(`Failed: ${e.message}`, 'error');
                showToast(`Failed: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Fetch Models';
            }
        }

        function selectModel(id) {
            App.settings.modelName = id;
            document.getElementById('modelName').value = id;
            document.querySelectorAll('.model-item').forEach(el => {
                el.classList.toggle('selected', el.querySelector('.model-item-name').textContent === id);
            });
            showToast(`Selected: ${id}`, 'success');
        }

        async function testConnection() {
            const url = document.getElementById('apiBaseUrl').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelName').value.trim();
            if (!url || !key || !model) { showToast('Please fill in fields', 'error'); return; }

            const btn = document.getElementById('testConnectionBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                const r = await fetch(`${url.replace(/\/+$/, '').replace(/\/v1$/, '')}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 })
                });
                if (r.ok) {
                    App.connectionStatus = 'connected';
                    App.settings.apiBaseUrl = url;
                    App.settings.apiKey = key;
                    App.settings.modelName = model;
                    await saveData();
                    showToast('Connection successful!', 'success');
                    addLog('Connected', 'success');
                } else {
                    throw new Error(`HTTP ${r.status}`);
                }
            } catch (e) {
                App.connectionStatus = 'disconnected';
                showToast(`Failed: ${e.message}`, 'error');
            } finally {
                updateConnectionUI();
                btn.disabled = false;
                btn.innerHTML = 'Test Connection';
            }
        }

        async function saveApiSettings() {
            App.settings.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            App.settings.apiKey = document.getElementById('apiKey').value.trim();
            App.settings.modelName = document.getElementById('modelName').value.trim();
            App.settings.temperature = parseFloat(document.getElementById('temperature').value);
            App.settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            App.settings.maxContextMessages = parseInt(document.getElementById('maxContextMessages').value) || 200;
            await saveData();
            showToast('Settings saved', 'success');
        }

        // ==================== 数据管理功能 ====================
        async function forceSaveAll() {
            if (await saveData()) {
                await updateStorageDisplay();
                showToast('Saved', 'success');
            }
        }

        async function clearImageCache() {
            if (!confirm('Clear image cache?')) return;
            App.settings.wallpaperData = null;
            App.settings.wallpaper = 'gradient1';
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null, font: null };
            App.characters.forEach(c => {
                c.avatarImage = null;
                c.userAvatar = null;
                c.chatWallpaper = null;
                c.messages.forEach(m => { if (m.image) m.image = null; });
            });
            await saveData();
            applyWallpaper();
            applyAppIcons();
            updateIconPreviews();
            await updateStorageDisplay();
            showToast('Cleared', 'success');
        }

        async function clearMessageCache() {
            if (!confirm('Clear messages?')) return;
            App.characters.forEach(c => { c.messages = []; });
            await saveData();
            await updateStorageDisplay();
            showToast('Cleared', 'success');
        }

        async function compactDatabase() {
            showToast('Optimizing...', 'info');
            for (let c of App.characters) {
                if (c.avatarImage?.length > 50000) c.avatarImage = await compressImage(c.avatarImage, 150, 0.7);
                if (c.userAvatar?.length > 50000) c.userAvatar = await compressImage(c.userAvatar, 150, 0.7);
                if (c.chatWallpaper?.length > 300000) c.chatWallpaper = await compressImage(c.chatWallpaper, 500, 0.7);
                for (let m of c.messages) {
                    if (m.image?.length > 200000) m.image = await compressImage(m.image, 400, 0.7);
                }
            }
            if (App.settings.wallpaperData?.length > 500000) {
                App.settings.wallpaperData = await compressImage(App.settings.wallpaperData, 600, 0.7);
            }
            for (let k of Object.keys(App.appIcons)) {
                if (App.appIcons[k]?.length > 30000) {
                    App.appIcons[k] = await compressImage(App.appIcons[k], 100, 0.7);
                }
            }
            await saveData();
            await updateStorageDisplay();
            showToast('Optimized', 'success');
        }

        function compressImage(dataUrl, maxWidth = 400, quality = 0.7) {
            return new Promise((resolve) => {
                if (!dataUrl?.startsWith('data:image')) { resolve(dataUrl); return; }
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        function exportAllData() {
            const data = {
                characters: App.characters,
                worldbooks: App.worldbooks,
                settings: App.settings,
                appIcons: App.appIcons,
                globalCssPresets: App.globalCssPresets,
                apiPresets: App.apiPresets,
                customFonts: App.customFonts,
                version: '7.0.0',
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `noir-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Exported', 'success');
        }

        async function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.characters) App.characters = data.characters;
                    if (data.worldbooks) App.worldbooks = data.worldbooks;
                    if (data.settings) App.settings = { ...App.settings, ...data.settings };
                    if (data.appIcons) App.appIcons = { ...App.appIcons, ...data.appIcons };
                    if (data.globalCssPresets) App.globalCssPresets = data.globalCssPresets;
                    if (data.apiPresets) App.apiPresets = data.apiPresets;
                    if (data.customFonts) App.customFonts = data.customFonts;

                    App.worldbooks.forEach(wb => {
                        if (!wb.entries) wb.entries = [{ name: 'Default Entry', keywords: wb.keywords || '', content: wb.content || '', alwaysActive: wb.alwaysActive || false }];
                    });
                    App.characters.forEach(c => {
                        if (c.worldbookId && !c.worldbookIds) c.worldbookIds = [c.worldbookId];
                        if (!c.worldbookIds) c.worldbookIds = [];
                    });

                    if (await saveData()) {
                        loadSettingsUI();
                        applyWallpaper();
                        applyAppIcons();
                        applyStatusBarVisibility();
                        applyGlobalFont();
                        await updateStorageDisplay();
                        showToast('Imported successfully', 'success');
                    }
                } catch (err) {
                    showToast('Import failed: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        async function clearAllData() {
            if (confirm('Clear ALL data?')) {
                try {
                    await clearIDBStore('appData');
                    await clearIDBStore('images');
                    location.reload();
                } catch (e) {
                    indexedDB.deleteDatabase(DB_NAME);
                    location.reload();
                }
            }
        }

        // ==================== 角色管理 ====================
        async function createCharacter() {
            const name = document.getElementById('newCharacterName').value.trim();
            if (!name) { showToast('Please enter name', 'error'); return; }

            const char = {
                id: Date.now().toString(),
                name,
                avatar: '',
                avatarImage: null,
                userAvatar: null,
                showAvatar: true,
                avatarShape: 'circle',
                showBorder: false,
                borderColor: '#c9a962',
                borderWidth: 2,
                description: '',
                greeting: '',
                scenario: '',
                worldbookIds: [],
                userNick: '',
                systemPrompt: '',
                messages: [],
                chatWallpaper: null,
                customCss: '',
                activeCssPresetId: null,
                timestampPosition: 'default'
            };

            App.characters.push(char);
            await saveData();
            hideModal('createCharacterModal');
            document.getElementById('newCharacterName').value = '';
            renderContacts();
            showToast(`"${name}" created`, 'success');
        }

        function renderContacts() {
            const list = document.getElementById('contactList');
            const empty = document.getElementById('emptyContactState');

            if (App.characters.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'flex';
                return;
            }

            list.style.display = 'flex';
            empty.style.display = 'none';

            list.innerHTML = App.characters.map(c => {
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length - 1].content.substring(0, 30) + '...' : 'Start conversation';
                const lastTime = c.messages.length > 0 ? formatTime(c.messages[c.messages.length - 1].timestamp) : '';
                const avatarContent = c.avatarImage
                    ? `<img src="${c.avatarImage}">`
                    : (c.avatar || c.name.charAt(0).toUpperCase());

                return `<div class="contact-item" onclick="openChat('${c.id}')">
                    <div class="contact-avatar">${avatarContent}</div>
                    <div class="contact-info">
                        <div class="contact-name">${escapeHtml(c.name)}</div>
                        <div class="contact-preview">${escapeHtml(lastMsg)}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${lastTime}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function filterContacts() {
            const query = document.getElementById('contactSearch').value.toLowerCase();
            document.querySelectorAll('.contact-item').forEach(el => {
                const name = el.querySelector('.contact-name').textContent.toLowerCase();
                el.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }

        // ==================== 聊天功能 ====================
        function openChat(id) {
            const char = App.characters.find(c => c.id === id);
            if (!char) return;

            App.currentCharId = id;
            App.isSelectMode = false;
            App.selectedMsgs.clear();
            App.lastAIStart = -1;
            App.currentQuote = null;

            document.getElementById('quotePreviewBar').classList.remove('active');
            document.getElementById('chatTitle').textContent = char.name;
            document.getElementById('selectModeBar').classList.remove('active');
            document.getElementById('chatMessages').classList.remove('select-mode');

            applyChatWallpaper(char);
            applyCustomCss(char);
            renderMessages();
            openPage('chatPage');

            if (char.messages.length === 0 && char.greeting) {
                addMessage(char.greeting, 'received');
            }
        }

        function applyChatWallpaper(char) {
            const chatPage = document.getElementById('chatPage');
            if (char.chatWallpaper) {
                chatPage.classList.add('has-custom-bg');
                chatPage.style.backgroundImage = `url(${char.chatWallpaper})`;
            } else {
                chatPage.classList.remove('has-custom-bg');
                chatPage.style.backgroundImage = '';
            }
        }

        function applyCustomCss(char) {
            const styleEl = document.getElementById('customCssStyles');
            let css = '';
            if (char.activeCssPresetId) {
                const preset = App.globalCssPresets.find(p => p.id === char.activeCssPresetId);
                if (preset) css = preset.css;
            }
            if (char.customCss) css = char.customCss;
            styleEl.textContent = css;
        }

        function closeChatPage() {
            exitSelectMode();
            closePage('chatPage');
            document.getElementById('customCssStyles').textContent = '';
            const chatPage = document.getElementById('chatPage');
            chatPage.classList.remove('has-custom-bg');
            chatPage.style.backgroundImage = '';
            App.currentCharId = null;
            App.currentQuote = null;
        }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            if (char.messages.length === 0) {
                container.innerHTML = '<div class="date-separator"><span class="date-separator-text">Today</span></div>';
                return;
            }

            const showAvatar = char.showAvatar !== false;
            const avatarShape = char.avatarShape || 'circle';
            const showBorder = char.showBorder === true;
            const borderColor = char.borderColor || '#c9a962';
            const borderWidth = char.borderWidth || 2;
            let shapeClass = avatarShape === 'square' ? 'square' : avatarShape === 'rounded-square' ? 'rounded-square' : '';
            const borderStyle = showBorder ? `border:${borderWidth}px solid ${borderColor};` : '';
            const timestampPos = char.timestampPosition || 'default';
            let timeClass = timestampPos === 'hidden' ? 'time-hidden' : timestampPos === 'side' ? 'time-side' : '';

            let html = '';
            let lastDate = null;

            char.messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString();
                if (msgDate !== lastDate) {
                    html += `<div class="date-separator"><span class="date-separator-text">${formatDate(msg.timestamp)}</span></div>`;
                    lastDate = msgDate;
                }

                const type = msg.role === 'user' ? 'sent' : 'received';
                const checked = App.selectedMsgs.has(msg.id) ? 'checked' : '';

                let avatarHtml = '';
                if (showAvatar) {
                    const avatarContent = type === 'received'
                        ? (char.avatarImage ? `<img src="${char.avatarImage}">` : (char.avatar || char.name.charAt(0).toUpperCase()))
                        : (char.userAvatar ? `<img src="${char.userAvatar}">` : 'U');
                    avatarHtml = `<div class="message-avatar ${shapeClass}" style="${borderStyle}">${avatarContent}</div>`;
                }

                let quoteHtml = '';
                if (msg.quoteContent) {
                    quoteHtml = `<div class="message-quote">${escapeHtml(msg.quoteContent)}</div>`;
                }

                let imageHtml = '';
                if (msg.image) {
                    imageHtml = `<img src="${msg.image}" class="message-image" onclick="viewImage('${msg.id}')">`;
                }

                let displayContent = msg.content === '[Image]' && msg.image ? '' : msg.content;

                html += `<div class="message-wrapper ${type}" data-msg-id="${msg.id}" ontouchstart="startLongPress('${msg.id}')" ontouchend="endLongPress()" ontouchmove="endLongPress()" oncontextmenu="showContextMenuDirect(event,'${msg.id}')">
                    <div class="message-checkbox ${checked}" onclick="toggleMsgSelect('${msg.id}')"></div>
                    ${type === 'received' ? avatarHtml : ''}
                    <div class="message ${type}">
                        ${quoteHtml}
                        ${escapeHtml(displayContent)}
                        ${imageHtml}
                        <div class="message-time ${timeClass}">${formatTime(msg.timestamp)}</div>
                    </div>
                    ${type === 'sent' ? avatarHtml : ''}
                </div>`;
            });

            container.innerHTML = html;
            scrollToBottom();
        }

        async function addMessage(content, type, imageData = null, quoteData = null) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            const msg = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                role: type === 'sent' ? 'user' : 'assistant',
                content,
                timestamp: new Date().toISOString(),
                image: imageData || null,
                quoteId: quoteData?.msgId || null,
                quoteContent: quoteData?.content || null
            };

            char.messages.push(msg);
            await saveData();
            renderMessages();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content && !App.currentQuote) return;

            const quoteData = App.currentQuote ? { ...App.currentQuote } : null;
            addMessage(content || 'Reply', 'sent', null, quoteData);
            input.value = '';
            autoResizeTextarea(input);
            cancelQuote();
        }

        // ==================== AI功能 ====================
        async function triggerAIReply() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            if (!App.settings.apiBaseUrl || !App.settings.apiKey || !App.settings.modelName) {
                showToast('Please configure API', 'error');
                return;
            }

            App.lastAIStart = char.messages.length;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', '<div class="typing-indicator" id="typingIndicator"><span></span><span></span><span></span></div>');
            scrollToBottom();

            try {
                const max = App.settings.maxContextMessages || 200;
                const history = char.messages.slice(-max);
                const messages = buildAPIMessages(char, history);
                const url = App.settings.apiBaseUrl.replace(/\/+$/, '').replace(/\/v1$/, '');

                const hasImage = history.some(m => m.image);
                let body;

                if (hasImage) {
                    const mmMsgs = [messages[0]];
                    let msgIdx = 1;
                    let historyIdx = 0;

                    while (msgIdx < messages.length && historyIdx < history.length) {
                        const apiMsg = messages[msgIdx];
                        const role = apiMsg.role === 'user' ? 'user' : 'assistant';

                        const samRoleMsgs = [];
                        while (historyIdx < history.length &&
                            ((history[historyIdx].role === 'user' && role === 'user') ||
                                (history[historyIdx].role === 'assistant' && role === 'assistant'))) {
                            samRoleMsgs.push(history[historyIdx]);
                            historyIdx++;
                        }

                        const hasImageInGroup = samRoleMsgs.some(m => m.image);

                        if (hasImageInGroup) {
                            const contentParts = [];
                            contentParts.push({ type: 'text', text: apiMsg.content });
                            samRoleMsgs.forEach(m => {
                                if (m.image) {
                                    contentParts.push({ type: 'image_url', image_url: { url: m.image } });
                                }
                            });
                            mmMsgs.push({ role: apiMsg.role, content: contentParts });
                        } else {
                            mmMsgs.push(apiMsg);
                        }
                        msgIdx++;
                    }

                    while (msgIdx < messages.length) {
                        mmMsgs.push(messages[msgIdx]);
                        msgIdx++;
                    }

                    body = JSON.stringify({
                        model: App.settings.modelName,
                        messages: mmMsgs,
                        temperature: App.settings.temperature,
                        max_tokens: App.settings.maxTokens
                    });
                } else {
                    body = JSON.stringify({
                        model: App.settings.modelName,
                        messages,
                        temperature: App.settings.temperature,
                        max_tokens: App.settings.maxTokens
                    });
                }

                const r = await fetch(`${url}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${App.settings.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body
                });

                document.getElementById('typingIndicator')?.remove();

                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json();
                const reply = data.choices[0].message.content;

                const parsedParts = parseAIResponse(reply, history);
                for (let i = 0; i < parsedParts.length; i++) {
                    if (i > 0) await new Promise(r => setTimeout(r, 300 + Math.random() * 400));
                    const p = parsedParts[i];
                    await addMessage(p.content, 'received', null, p.quote ? { msgId: null, content: p.quote } : null);
                }
            } catch (e) {
                document.getElementById('typingIndicator')?.remove();
                App.lastAIStart = -1;
                showToast(`Failed: ${e.message}`, 'error');
            }
        }

        function parseAIResponse(text, history) {
            if (!text) return [{ content: '...', quote: null }];
            const parts = text.trim().split(/\s*\|\|\|\s*/).map(s => s.trim()).filter(s => s);
            const results = [];
            const quoteRegex = /^\[Q:#(\d+)\](.*)$/s;

            for (const part of parts) {
                let cleanPart = part;
                let quoteContent = null;
                const match = cleanPart.match(quoteRegex);
                if (match) {
                    const idx = parseInt(match[1]) - 1;
                    cleanPart = match[2].trim();
                    if (idx >= 0 && idx < history.length) {
                        quoteContent = history[idx].content.substring(0, 100);
                    }
                }
                cleanPart = cleanPart.replace(/^["「『"]+/, '').replace(/["」』"]+$/, '').trim();
                if (cleanPart) {
                    results.push({ content: cleanPart, quote: quoteContent });
                }
            }
            return results.length > 0 ? results : [{ content: text.trim(), quote: null }];
        }

        function buildAPIMessages(char, history) {
            const msgs = [];
            let sys = `# SMS Simulation Rules\n\nYou are playing "${char.name}", chatting via text messages.\n\n## Output Format\n1. Separate each message with |||\n2. Keep messages short (5-20 chars) like real texts\n3. Don't add character name prefix\n4. Text like a real person\n5. DON'T add number prefixes like #1:\n\n## Quote Format (optional)\nTo quote a message: [Q:#number]reply\nExample: [Q:#3]Right|||Normal message\n\n## Correct Examples\nYeah|||Indeed\n[Q:#5]Really?|||Haha\n\n## Wrong (forbidden)\n❌ #1: content\n❌ Character: content\n\n## Character\n${char.description || 'Friend'}`;

            if (char.scenario) sys += `\n\n## Scenario\n${char.scenario}`;
            if (char.userNick) sys += `\n\n## User Name\n${char.userNick}`;
            if (char.systemPrompt) sys += `\n\n## Extra\n${char.systemPrompt}`;

            if (char.worldbookIds?.length > 0) {
                char.worldbookIds.forEach(wbId => {
                    const wb = App.worldbooks.find(w => w.id === wbId);
                    if (wb?.entries) {
                        wb.entries.forEach(entry => {
                            const shouldInject = entry.alwaysActive || (entry.keywords && history.some(m => entry.keywords.split(',').some(k => m.content.toLowerCase().includes(k.trim().toLowerCase()))));
                            if (shouldInject && entry.content) sys += `\n\n## Lore (${entry.name})\n${entry.content}`;
                        });
                    }
                });
            }

            if (history.length > 0) {
                sys += `\n\n## Message Reference (for quoting only)\n`;
                history.forEach((m, i) => {
                    const role = m.role === 'user' ? 'User' : 'You';
                    const hasImg = m.image ? '[Image]' : '';
                    sys += `#${i + 1} ${role}: ${m.content.substring(0, 30)}${m.content.length > 30 ? '...' : ''}${hasImg}\n`;
                });
            }

            msgs.push({ role: 'system', content: sys });

            let currentRole = null;
            let buffer = [];

            const flushBuffer = () => {
                if (buffer.length > 0) {
                    const role = buffer[0].role === 'user' ? 'user' : 'assistant';
                    const content = buffer.map(m => {
                        let text = m.content;
                        if (m.quoteContent) text = `[Quote:"${m.quoteContent.substring(0, 30)}"]${text}`;
                        if (m.image) text += '[Image]';
                        return text;
                    }).join('|||');
                    msgs.push({ role, content });
                    buffer = [];
                }
            };

            history.forEach((m) => {
                if (currentRole !== m.role) {
                    flushBuffer();
                    currentRole = m.role;
                }
                buffer.push(m);
            });
            flushBuffer();

            if (history.length > 10) {
                msgs.push({ role: 'system', content: 'Reminder: Use ||| to separate messages. Quote with [Q:#number]. NO number prefixes!' });
            }

            return msgs;
        }

        async function regenerateLastReply() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            toggleExtensionPanel();

            if (char.messages.length === 0) { showToast('No messages', 'warning'); return; }

            if (App.lastAIStart >= 0 && App.lastAIStart < char.messages.length) {
                let allAI = true;
                for (let i = App.lastAIStart; i < char.messages.length; i++) {
                    if (char.messages[i].role !== 'assistant') { allAI = false; break; }
                }
                if (allAI) {
                    const count = char.messages.length - App.lastAIStart;
                    char.messages.splice(App.lastAIStart, count);
                    await saveData();
                    renderMessages();
                    showToast(`Deleted ${count}`, 'info');
                    App.lastAIStart = -1;
                    await triggerAIReply();
                    return;
                }
            }

            if (char.messages[char.messages.length - 1].role !== 'assistant') {
                showToast('Last is not AI', 'warning');
                return;
            }

            let first = char.messages.length - 1;
            for (let i = char.messages.length - 1; i >= 0; i--) {
                if (char.messages[i].role === 'assistant') first = i;
                else break;
            }

            const count = char.messages.length - first;
            char.messages.splice(first, count);
            await saveData();
            renderMessages();
            showToast(`Deleted ${count}`, 'info');
            await triggerAIReply();
        }

        // ==================== 消息操作 ====================
        function startLongPress(msgId) {
            App.longPressTimer = setTimeout(() => { showContextMenu(msgId); }, 500);
        }

        function endLongPress() {
            if (App.longPressTimer) {
                clearTimeout(App.longPressTimer);
                App.longPressTimer = null;
            }
        }

        function showContextMenu(msgId) {
            App.contextMenuMsgId = msgId;
            document.getElementById('contextMenuOverlay').classList.add('active');
        }

        function showContextMenuDirect(e, msgId) {
            e.preventDefault();
            showContextMenu(msgId);
        }

        function hideContextMenu() {
            document.getElementById('contextMenuOverlay').classList.remove('active');
            App.contextMenuMsgId = null;
        }

        function copyMessageText() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId);
            if (!msg) return;
            navigator.clipboard.writeText(msg.content)
                .then(() => showToast('Copied', 'success'))
                .catch(() => showToast('Copy failed', 'error'));
            hideContextMenu();
        }

        function quoteMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId);
            if (!msg) return;
            App.currentQuote = { msgId: msg.id, content: msg.content.substring(0, 100) };
            document.getElementById('quotePreviewContent').textContent = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');
            document.getElementById('quotePreviewBar').classList.add('active');
            hideContextMenu();
            document.getElementById('chatInput').focus();
        }

        function cancelQuote() {
            App.currentQuote = null;
            document.getElementById('quotePreviewBar').classList.remove('active');
        }

        function editMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId);
            if (!msg) return;
            App.editingMsgId = App.contextMenuMsgId;
            document.getElementById('editMessageContent').value = msg.content;
            hideContextMenu();
            showModal('editMessageModal');
        }

        async function saveEditedMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const msg = char.messages.find(m => m.id === App.editingMsgId);
            if (!msg) {
                showToast('Message not found', 'error');
                hideModal('editMessageModal');
                return;
            }
            msg.content = document.getElementById('editMessageContent').value;
            await saveData();
            hideModal('editMessageModal');
            App.editingMsgId = null;
            renderMessages();
            showToast('Saved', 'success');
        }

        function viewImage(msgId) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            const msg = char.messages.find(m => m.id === msgId);
            if (msg?.image) window.open(msg.image, '_blank');
        }

        function openImagePicker() {
            toggleExtensionPanel();
            document.getElementById('chatImageInput').click();
        }

        async function handleChatImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024 * 1024) { showToast('Image too large (>2GB)', 'error'); return; }             const reader = new FileReader();
            reader.onload = async (ev) => {
                const compressed = await compressImage(ev.target.result, 600, 0.8);
                await addMessage('[Image]', 'sent', compressed);
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        // ==================== 选择模式 ====================
        function enterSelectMode() {
            toggleExtensionPanel();
            App.isSelectMode = true;
            App.selectedMsgs.clear();
            document.getElementById('selectModeBar').classList.add('active');
            document.getElementById('chatMessages').classList.add('select-mode');
            updateSelectedCount();
        }

        function exitSelectMode() {
            App.isSelectMode = false;
            App.selectedMsgs.clear();
            document.getElementById('selectModeBar').classList.remove('active');
            document.getElementById('chatMessages').classList.remove('select-mode');
            renderMessages();
        }

        function toggleMsgSelect(msgId) {
            if (!App.isSelectMode) return;
            if (App.selectedMsgs.has(msgId)) {
                App.selectedMsgs.delete(msgId);
            } else {
                App.selectedMsgs.add(msgId);
            }
            const checkbox = document.querySelector(`[data-msg-id="${msgId}"] .message-checkbox`);
            checkbox?.classList.toggle('checked', App.selectedMsgs.has(msgId));
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = App.selectedMsgs.size;
        }

        async function deleteSelectedMessages() {
            if (App.selectedMsgs.size === 0) { showToast('No messages selected', 'warning'); return; }
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            char.messages = char.messages.filter(m => !App.selectedMsgs.has(m.id));
            await saveData();
            exitSelectMode();
            showToast(`Deleted ${App.selectedMsgs.size} messages`, 'success');
        }

        // ==================== 扩展面板 ====================
        function toggleExtensionPanel() {
            document.getElementById('extensionPanel').classList.toggle('active');
        }

        // ==================== 角色设置 ====================
        function openCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            document.getElementById('charName').value = char.name || '';
            document.getElementById('charAvatar').value = char.avatar || '';
            document.getElementById('charDescription').value = char.description || '';
            document.getElementById('charGreeting').value = char.greeting || '';
            document.getElementById('charScenario').value = char.scenario || '';
            document.getElementById('charUserNick').value = char.userNick || '';
            document.getElementById('charSystemPrompt').value = char.systemPrompt || '';
            document.getElementById('customCssEditor').value = char.customCss || '';
            document.getElementById('timestampPosition').value = char.timestampPosition || 'default';

            const showAvatarToggle = document.getElementById('showAvatarToggle');
            showAvatarToggle.classList.toggle('active', char.showAvatar !== false);

            const showBorderToggle = document.getElementById('showBorderToggle');
            showBorderToggle.classList.toggle('active', char.showBorder === true);

            document.getElementById('borderColorPicker').value = char.borderColor || '#c9a962';

            document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.shape === (char.avatarShape || 'circle'));
            });

            const charAvatarUpload = document.getElementById('charAvatarUpload');
            if (char.avatarImage) {
                charAvatarUpload.innerHTML = `<img src="${char.avatarImage}">`;
                charAvatarUpload.classList.add('has-image');
            } else {
                charAvatarUpload.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                charAvatarUpload.classList.remove('has-image');
            }

            const userAvatarUpload = document.getElementById('userAvatarUpload');
            if (char.userAvatar) {
                userAvatarUpload.innerHTML = `<img src="${char.userAvatar}">`;
                userAvatarUpload.classList.add('has-image');
            } else {
                userAvatarUpload.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                userAvatarUpload.classList.remove('has-image');
            }

            const chatWpPreview = document.getElementById('chatWallpaperPreview');
            if (char.chatWallpaper) {
                chatWpPreview.style.background = `url(${char.chatWallpaper}) center/cover`;
                chatWpPreview.classList.add('has-image');
            } else {
                chatWpPreview.style.background = '';
                chatWpPreview.classList.remove('has-image');
            }

            updateCharCounter();
            updateCssPresetSelect(char);
            updateWorldbookMultiSelect(char);
            openPage('characterSettingsPage');
        }

        function updateCssPresetSelect(char) {
            const select = document.getElementById('cssPresetSelect');
            select.innerHTML = '<option value="">-- No Preset --</option>' +
                App.globalCssPresets.map(p => `<option value="${p.id}" ${char.activeCssPresetId === p.id ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('');
        }

        function updateWorldbookMultiSelect(char) {
            const container = document.getElementById('worldbookMultiSelect');
            if (App.worldbooks.length === 0) {
                container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-tertiary)">No lore books available</div>';
                return;
            }
            container.innerHTML = App.worldbooks.map(wb => {
                const isChecked = char.worldbookIds?.includes(wb.id);
                return `<div class="worldbook-multi-item" onclick="toggleWorldbookBinding('${wb.id}')">
                    <div class="worldbook-multi-checkbox ${isChecked ? 'checked' : ''}"></div>
                    <span class="worldbook-multi-name">${escapeHtml(wb.name)}</span>
                </div>`;
            }).join('');
        }

        function toggleWorldbookBinding(wbId) {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            if (!char.worldbookIds) char.worldbookIds = [];
            const idx = char.worldbookIds.indexOf(wbId);
            if (idx > -1) {
                char.worldbookIds.splice(idx, 1);
            } else {
                char.worldbookIds.push(wbId);
            }
            updateWorldbookMultiSelect(char);
        }

        async function saveCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;

            char.name = document.getElementById('charName').value.trim();
            char.avatar = document.getElementById('charAvatar').value.trim();
            char.description = document.getElementById('charDescription').value;
            char.greeting = document.getElementById('charGreeting').value;
            char.scenario = document.getElementById('charScenario').value;
            char.userNick = document.getElementById('charUserNick').value.trim();
            char.systemPrompt = document.getElementById('charSystemPrompt').value;
            char.customCss = document.getElementById('customCssEditor').value;
            char.timestampPosition = document.getElementById('timestampPosition').value;
            char.showAvatar = document.getElementById('showAvatarToggle').classList.contains('active');
            char.showBorder = document.getElementById('showBorderToggle').classList.contains('active');
            char.borderColor = document.getElementById('borderColorPicker').value;
            const selectedShape = document.querySelector('#avatarShapeOptions .shape-option.selected');
            char.avatarShape = selectedShape?.dataset.shape || 'circle';
            const selectedPresetId = document.getElementById('cssPresetSelect').value;
            char.activeCssPresetId = selectedPresetId || null;

            await saveData();
            document.getElementById('chatTitle').textContent = char.name;
            applyCustomCss(char);
            renderMessages();
            closeCharacterSettings();
            showToast('Saved', 'success');
        }

        function closeCharacterSettings() {
            closePage('characterSettingsPage');
        }

        function updateCharCounter() {
            const textarea = document.getElementById('charGreeting');
            const counter = document.getElementById('greetingCharCounter');
            const len = textarea.value.length;
            counter.textContent = `${len}/300`;
            counter.className = 'char-counter' + (len > 280 ? ' warning' : '') + (len >= 300 ? ' error' : '');
        }

        async function handleCharAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (!char) return;
                char.avatarImage = await compressImage(ev.target.result, 200, 0.8);
                const upload = document.getElementById('charAvatarUpload');
                upload.innerHTML = `<img src="${char.avatarImage}">`;
                upload.classList.add('has-image');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function handleUserAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (!char) return;
                char.userAvatar = await compressImage(ev.target.result, 200, 0.8);
                const upload = document.getElementById('userAvatarUpload');
                upload.innerHTML = `<img src="${char.userAvatar}">`;
                upload.classList.add('has-image');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function handleChatWallpaperUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (!char) return;
                char.chatWallpaper = await compressImage(ev.target.result, 600, 0.8);
                const preview = document.getElementById('chatWallpaperPreview');
                preview.style.background = `url(${char.chatWallpaper}) center/cover`;
                preview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function clearChatWallpaper() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            char.chatWallpaper = null;
            const preview = document.getElementById('chatWallpaperPreview');
            preview.style.background = '';
            preview.classList.remove('has-image');
            showToast('Wallpaper cleared', 'success');
        }

        function selectShape(el) {
            document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
        }

        function toggleSwitch(el) {
            el.classList.toggle('active');
        }

        // ==================== CSS预设 ====================
        function loadCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value;
            if (!presetId) {
                document.getElementById('customCssEditor').value = '';
                return;
            }
            const preset = App.globalCssPresets.find(p => p.id === presetId);
            if (preset) {
                document.getElementById('customCssEditor').value = preset.css;
                showToast(`Loaded: ${preset.name}`, 'success');
            }
        }

        function addNewCssPreset() {
            showModal('cssPresetNameModal');
            document.getElementById('newCssPresetName').value = '';
        }

        async function createCssPreset() {
            const name = document.getElementById('newCssPresetName').value.trim();
            if (!name) { showToast('Please enter name', 'error'); return; }
            const css = document.getElementById('customCssEditor').value;
            const preset = { id: Date.now().toString(), name, css };
            App.globalCssPresets.push(preset);
            await saveData();
            hideModal('cssPresetNameModal');
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (char) updateCssPresetSelect(char);
            document.getElementById('cssPresetSelect').value = preset.id;
            showToast(`Created: ${name}`, 'success');
        }

        async function saveCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value;
            if (!presetId) { showToast('Please select a preset first', 'warning'); return; }
            const preset = App.globalCssPresets.find(p => p.id === presetId);
            if (!preset) return;
            preset.css = document.getElementById('customCssEditor').value;
            await saveData();
            showToast(`Updated: ${preset.name}`, 'success');
        }

        function deleteCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value;
            if (!presetId) { showToast('Please select a preset first', 'warning'); return; }
            const preset = App.globalCssPresets.find(p => p.id === presetId);
            if (!preset) return;

            App.genericDeleteCallback = async () => {
                App.globalCssPresets = App.globalCssPresets.filter(p => p.id !== presetId);
                App.characters.forEach(c => {
                    if (c.activeCssPresetId === presetId) c.activeCssPresetId = null;
                });
                await saveData();
                const char = App.characters.find(c => c.id === App.currentCharId);
                if (char) updateCssPresetSelect(char);
                document.getElementById('customCssEditor').value = '';
                showToast('Preset deleted', 'success');
            };

            document.getElementById('deleteConfirmTitle').textContent = `Delete "${preset.name}"?`;
            document.getElementById('deleteConfirmDesc').textContent = 'This CSS preset will be permanently removed';
            showModal('deleteConfirmModal');
        }

        function previewCss() {
            const css = document.getElementById('customCssEditor').value;
            document.getElementById('customCssStyles').textContent = css;
            showToast('Preview applied', 'info');
        }

        function clearCustomCss() {
            document.getElementById('customCssEditor').value = '';
            document.getElementById('customCssStyles').textContent = '';
            document.getElementById('cssPresetSelect').value = '';
            showToast('CSS cleared', 'success');
        }

        function showCssGuide() {
            showModal('cssGuideModal');
        }

        // ==================== 消息管理 ====================
        function confirmClearAllMessages() {
            showModal('clearMessagesModal');
        }

        async function executeClearAllMessages() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            char.messages = [];
            await saveData();
            hideModal('clearMessagesModal');
            renderMessages();
            showToast('All messages cleared', 'success');
        }

        function deleteCurrentCharacter() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            App.pendingDeleteType = 'character';
            App.pendingDeleteId = char.id;
            document.getElementById('deleteModalTitle').textContent = `Delete "${char.name}"?`;
            document.getElementById('deleteModalDesc').textContent = 'This character and all messages will be permanently deleted';
            showModal('confirmDeleteModal');
        }

        async function confirmDelete() {
            if (App.pendingDeleteType === 'character') {
                App.characters = App.characters.filter(c => c.id !== App.pendingDeleteId);
                await saveData();
                hideModal('confirmDeleteModal');
                closeCharacterSettings();
                closeChatPage();
                closePage('messagesPage');
                showToast('Character deleted', 'success');
            } else if (App.pendingDeleteType === 'worldbook') {
                App.worldbooks = App.worldbooks.filter(w => w.id !== App.pendingDeleteId);
                App.characters.forEach(c => {
                    if (c.worldbookIds) c.worldbookIds = c.worldbookIds.filter(id => id !== App.pendingDeleteId);
                });
                await saveData();
                hideModal('confirmDeleteModal');
                closeWorldbookEdit();
                renderWorldbooks();
                showToast('Lore book deleted', 'success');
            }
            App.pendingDeleteType = null;
            App.pendingDeleteId = null;
        }

        // ==================== 世界书管理 ====================
        async function createWorldbook() {
            const name = document.getElementById('newWorldbookName').value.trim();
            if (!name) { showToast('Please enter name', 'error'); return; }
            const wb = {
                id: Date.now().toString(),
                name,
                summary: '',
                entries: [{ name: 'Default Entry', keywords: '', content: '', alwaysActive: false }]
            };
            App.worldbooks.push(wb);
            await saveData();
            hideModal('createWorldbookModal');
            document.getElementById('newWorldbookName').value = '';
            renderWorldbooks();
            showToast(`"${name}" created`, 'success');
        }

        function renderWorldbooks() {
            const list = document.getElementById('worldbookList');
            const empty = document.getElementById('emptyWorldbookState');

            if (App.worldbooks.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'flex';
                return;
            }

            list.style.display = 'block';
            empty.style.display = 'none';

            list.innerHTML = App.worldbooks.map(wb => {
                const entryCount = wb.entries?.length || 0;
                return `<div class="worldbook-item" onclick="openWorldbookEdit('${wb.id}')">
                    <div class="worldbook-item-header">
                        <span class="worldbook-item-title">${escapeHtml(wb.name)}</span>
                        <span class="worldbook-item-badge">${entryCount} entries</span>
                    </div>
                    <div class="worldbook-item-preview">${escapeHtml(wb.summary || 'No description')}</div>
                </div>`;
            }).join('');
        }

        function openWorldbookEdit(id) {
            const wb = App.worldbooks.find(w => w.id === id);
            if (!wb) return;

            App.currentWbId = id;
            document.getElementById('worldbookName').value = wb.name || '';
            document.getElementById('worldbookSummary').value = wb.summary || '';
            renderWorldbookEntries(wb);
            openPage('worldbookEditPage');
        }

        function renderWorldbookEntries(wb) {
            const container = document.getElementById('worldbookEntries');
            if (!wb.entries || wb.entries.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-tertiary);padding:20px">No entries yet</div>';
                return;
            }
            container.innerHTML = wb.entries.map((entry, idx) => `
                <div class="worldbook-entry-item">
                    <div class="worldbook-entry-header">
                        <span class="worldbook-entry-title">${escapeHtml(entry.name || 'Unnamed')}</span>
                        <div class="worldbook-entry-actions">
                            <button class="worldbook-entry-btn" onclick="editEntry(${idx})"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
                            <button class="worldbook-entry-btn" onclick="deleteEntry(${idx})"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                        </div>
                    </div>
                    <div class="worldbook-entry-keywords">${entry.alwaysActive ? '★ Always Active' : (entry.keywords || 'No keywords')}</div>
                    <div class="worldbook-entry-preview">${escapeHtml(entry.content?.substring(0, 100) || 'No content')}${entry.content?.length > 100 ? '...' : ''}</div>
                </div>
            `).join('');
        }

        function addWorldbookEntry() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb) return;
            if (!wb.entries) wb.entries = [];
            App.currentEntryIndex = wb.entries.length;
            document.getElementById('entryName').value = '';
            document.getElementById('entryKeywords').value = '';
            document.getElementById('entryContent').value = '';
            document.getElementById('entryAlwaysActive').classList.remove('active');
            showModal('entryEditModal');
        }

        function editEntry(idx) {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb || !wb.entries[idx]) return;
            App.currentEntryIndex = idx;
            const entry = wb.entries[idx];
            document.getElementById('entryName').value = entry.name || '';
            document.getElementById('entryKeywords').value = entry.keywords || '';
            document.getElementById('entryContent').value = entry.content || '';
            document.getElementById('entryAlwaysActive').classList.toggle('active', entry.alwaysActive === true);
            showModal('entryEditModal');
        }

        async function saveWorldbookEntry() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb) return;
            if (!wb.entries) wb.entries = [];
            const entry = {
                name: document.getElementById('entryName').value.trim() || 'Unnamed',
                keywords: document.getElementById('entryKeywords').value.trim(),
                content: document.getElementById('entryContent').value,
                alwaysActive: document.getElementById('entryAlwaysActive').classList.contains('active')
            };
            if (App.currentEntryIndex >= wb.entries.length) {
                wb.entries.push(entry);
            } else {
                wb.entries[App.currentEntryIndex] = entry;
            }
            await saveData();
            hideModal('entryEditModal');
            renderWorldbookEntries(wb);
            showToast('Entry saved', 'success');
        }

        async function deleteEntry(idx) {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb || !wb.entries[idx]) return;
            if (!confirm('Delete this entry?')) return;
            wb.entries.splice(idx, 1);
            await saveData();
            renderWorldbookEntries(wb);
            showToast('Entry deleted', 'success');
        }

        async function saveWorldbook() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb) return;
            wb.name = document.getElementById('worldbookName').value.trim();
            wb.summary = document.getElementById('worldbookSummary').value;
            await saveData();
            closeWorldbookEdit();
            renderWorldbooks();
            showToast('Saved', 'success');
        }

        function closeWorldbookEdit() {
            closePage('worldbookEditPage');
            App.currentWbId = null;
        }

        function deleteCurrentWorldbook() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId);
            if (!wb) return;
            App.pendingDeleteType = 'worldbook';
            App.pendingDeleteId = wb.id;
            document.getElementById('deleteModalTitle').textContent = `Delete "${wb.name}"?`;
            document.getElementById('deleteModalDesc').textContent = 'This lore book will be permanently deleted';
            showModal('confirmDeleteModal');
        }

        // ==================== 工具函数 ====================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const d = new Date(timestamp);
            return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const d = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (d.toDateString() === today.toDateString()) return 'Today';
            if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
        }

        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 100) + 'px';
        }

        // ==================== 键盘事件 ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
                document.querySelectorAll('.context-menu-overlay.active').forEach(m => m.classList.remove('active'));
            }
        });

        document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
```
