




```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AIÁü≠‰ø°">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <title>AIÁü≠‰ø°Ê®°ÊãüÂô® v6.5</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-bg-dark: rgba(0, 0, 0, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1);
            --blur-amount: 24px;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --accent-color: #007AFF;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --message-sent: #007AFF;
            --message-received: rgba(255, 255, 255, 0.12);
            --transition-smooth: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --metal-gradient: linear-gradient(180deg, rgba(30,30,35,0.95) 0%, rgba(20,20,25,0.98) 100%);
            --metal-border: rgba(255, 255, 255, 0.06);
            --metal-highlight: rgba(255, 255, 255, 0.08);
            --nav-height: 56px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; height: -webkit-fill-available; }
        body { height: 100%; min-height: 100vh; min-height: -webkit-fill-available; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; overscroll-behavior: none; position: fixed; width: 100%; top: 0; left: 0; }

        #wallpaperLayer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background-color: #0a0a0f; }
        .phone-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; margin: 0; overflow: hidden; z-index: 1; }

        .status-bar { position: absolute; top: 0; left: 0; right: 0; height: calc(44px + var(--safe-top)); padding-top: var(--safe-top); display: flex; justify-content: space-between; align-items: center; padding-left: 24px; padding-right: 24px; z-index: 1000; }
        .status-bar.hidden { display: none !important; }
        .status-bar-time { font-size: 15px; font-weight: 600; color: var(--text-primary); letter-spacing: 0.5px; }
        .status-bar-icons { display: flex; gap: 5px; align-items: center; }
        .status-bar-icons svg { width: 16px; height: 16px; fill: var(--text-primary); }

        .home-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding-top: calc(80px + var(--safe-top)); padding-bottom: calc(80px + var(--safe-bottom)); padding-left: 20px; padding-right: 20px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; z-index: 1; }
        .home-screen.no-statusbar { padding-top: calc(40px + var(--safe-top)); }

        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; justify-items: center; }
        .app-icon-wrapper { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; }
        .app-icon-wrapper:active { transform: scale(0.92); }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); transition: var(--transition-smooth); overflow: hidden; }
        .app-icon.settings { background: linear-gradient(135deg, #8e8e93, #636366); }
        .app-icon.messages { background: linear-gradient(135deg, #34c759, #30b350); }
        .app-icon.worldbook { background: linear-gradient(135deg, #ff9500, #ff6b00); }
        .app-icon.photos { background: linear-gradient(135deg, #ff2d55, #ff375f); }
        .app-icon img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon-label { font-size: 11px; color: var(--text-primary); text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); text-align: center; }

        .home-indicator { position: absolute; bottom: calc(8px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); width: 120px; height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 2px; z-index: 1001; }

        .page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: var(--glass-bg-dark); backdrop-filter: blur(var(--blur-amount)); -webkit-backdrop-filter: blur(var(--blur-amount)); z-index: 100; transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; overflow: hidden; }
        .page.active { transform: translateX(0); }
        .page.slide-from-bottom { transform: translateY(100%); }
        .page.slide-from-bottom.active { transform: translateY(0); }
        .page#chatPage { background: rgba(10, 10, 15, 0.85); }
        .page#chatPage.has-custom-bg { background-size: cover !important; background-position: center !important; background-repeat: no-repeat !important; }

        /* ÊôÆÈÄöÈ°µÈù¢È°∂Ê†è */
        .nav-bar { display: flex; align-items: center; justify-content: space-between; padding-top: calc(8px + var(--safe-top)); padding-bottom: 8px; padding-left: 12px; padding-right: 12px; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.08); flex-shrink: 0; min-height: calc(44px + var(--safe-top)); }

        /* ËÅäÂ§©È°µÈù¢È´òÁ∫ßÈ°∂Ê†è - ÈõæÊ∞îÂåñÊó†ËæπÁïåËÆæËÆ° */
        #chatPage .nav-bar {
            background: linear-gradient(180deg, rgba(15, 15, 20, 0.95) 0%, rgba(15, 15, 20, 0.85) 60%, rgba(15, 15, 20, 0) 100%);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-bottom: none;
            min-height: calc(var(--nav-height) + var(--safe-top));
            padding-top: calc(12px + var(--safe-top));
            padding-bottom: 16px;
            padding-left: 16px;
            padding-right: 16px;
        }

        .nav-btn { display: flex; align-items: center; gap: 4px; background: none; border: none; color: rgba(255, 255, 255, 0.85); font-size: 14px; cursor: pointer; padding: 6px; border-radius: 8px; min-width: 44px; transition: all 0.2s ease; }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.08); }
        .nav-btn:active { background: rgba(255, 255, 255, 0.12); transform: scale(0.96); }
        .nav-btn svg { width: 20px; height: 20px; fill: currentColor; opacity: 0.9; }
        .nav-btn.right { justify-content: flex-end; }
        .nav-title { font-size: 16px; font-weight: 600; color: var(--text-primary); text-align: center; flex: 1; letter-spacing: 0.3px; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* È´òÁ∫ßÂõæÊ†áÊ†∑Âºè */
        #chatPage .nav-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        #chatPage .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.12);
        }
        #chatPage .nav-btn:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.95);
        }
        #chatPage .nav-btn svg {
            width: 18px;
            height: 18px;
            opacity: 0.85;
        }

        .page-content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: calc(12px + var(--safe-bottom)); -webkit-overflow-scrolling: touch; }

        .settings-group { background: var(--glass-bg); backdrop-filter: blur(10px); border-radius: 14px; margin-bottom: 16px; overflow: hidden; border: 1px solid var(--glass-border); }
        .settings-group-title { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; padding: 16px 12px 4px; }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.06); cursor: pointer; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item-left { display: flex; align-items: center; gap: 10px; }
        .settings-icon { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 13px; }
        .settings-icon.blue { background: var(--accent-color); }
        .settings-icon.green { background: var(--success-color); }
        .settings-icon.red { background: var(--danger-color); }
        .settings-icon.orange { background: #FF9500; }
        .settings-icon.purple { background: #AF52DE; }
        .settings-icon.cyan { background: #5AC8FA; }
        .settings-icon.gray { background: #8e8e93; }
        .settings-icon.pink { background: #FF2D55; }
        .settings-icon.teal { background: #30B0C7; }
        .settings-item-label { color: var(--text-primary); font-size: 14px; }
        .settings-item-desc { color: var(--text-secondary); font-size: 11px; margin-top: 1px; }

        .input-group { margin-bottom: 14px; }
        .input-label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; }
        .input-field { width: 100%; padding: 10px 12px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary); font-size: 14px; outline: none; }
        .input-field:focus { border-color: var(--accent-color); }
        .input-field::placeholder { color: rgba(255, 255, 255, 0.3); }
        textarea.input-field { min-height: 80px; resize: vertical; font-family: inherit; line-height: 1.4; }
        textarea.css-editor { min-height: 150px; font-family: 'SF Mono', 'Menlo', 'Monaco', monospace; font-size: 12px; line-height: 1.5; background: rgba(0, 0, 0, 0.4); color: #00ff88; }

        .btn { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 12px 18px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-secondary { background: var(--glass-bg); color: var(--accent-color); border: 1px solid var(--glass-border); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn-small { padding: 8px 14px; font-size: 13px; }
        .btn-stack { display: flex; flex-direction: column; gap: 6px; }
        .btn-row { display: flex; gap: 6px; }
        .btn-row .btn { flex: 1; }

        .contact-list { display: flex; flex-direction: column; }
        .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--glass-bg); border-radius: 12px; margin-bottom: 6px; cursor: pointer; border: 1px solid var(--glass-border); }
        .contact-avatar { width: 46px; height: 46px; border-radius: 50%; background: var(--accent-gradient); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; overflow: hidden; }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
        .contact-preview { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-time { font-size: 12px; color: var(--text-secondary); flex-shrink: 0; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; }
        .empty-state-icon { font-size: 48px; margin-bottom: 14px; opacity: 0.5; }
        .empty-state-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .empty-state-desc { font-size: 13px; color: var(--text-secondary); }

        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 3px; -webkit-overflow-scrolling: touch; }

        .message-wrapper { display: flex; align-items: flex-end; gap: 5px; margin-bottom: 1px; }
        .message-wrapper.sent { justify-content: flex-end; }
        .message-wrapper.received { justify-content: flex-start; }

        .message-avatar { width: 26px; height: 26px; border-radius: 50%; background: var(--accent-gradient); display: flex; align-items: center; justify-content: center; font-size: 11px; color: white; flex-shrink: 0; overflow: hidden; }
        .message-avatar.square { border-radius: 5px; }
        .message-avatar.rounded-square { border-radius: 7px; }
        .message-avatar.hidden { display: none; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .message { max-width: 75%; padding: 7px 11px; font-size: 14px; line-height: 1.35; word-wrap: break-word; animation: msgIn 0.2s ease-out; position: relative; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(6px) scale(0.96); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .message.sent { background: var(--message-sent); color: white; border-radius: 16px 16px 4px 16px; }
        .message.received { background: var(--message-received); backdrop-filter: blur(8px); color: var(--text-primary); border-radius: 16px 16px 16px 4px; }

        .message-quote { background: rgba(0, 0, 0, 0.2); border-left: 2px solid rgba(255, 255, 255, 0.4); border-radius: 4px; padding: 4px 8px; margin-bottom: 6px; font-size: 12px; color: rgba(255, 255, 255, 0.7); max-height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .message.sent .message-quote { background: rgba(255, 255, 255, 0.15); border-left-color: rgba(255, 255, 255, 0.5); }

        .message-image { max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 4px; cursor: pointer; display: block; }

        .message-time { font-size: 9px; color: rgba(255, 255, 255, 0.5); margin-top: 2px; }
        .message-time.time-hidden { display: none; }
        .message-time.time-side { position: absolute; bottom: 4px; right: -40px; margin-top: 0; }
        .message-wrapper.sent .message-time.time-side { right: auto; left: -40px; }

        .message-checkbox { width: 18px; height: 18px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.4); background: transparent; display: none; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .message-checkbox.checked { background: var(--danger-color); border-color: var(--danger-color); }
        .message-checkbox.checked::after { content: '‚úì'; color: white; font-size: 10px; }
        .chat-messages.select-mode .message-checkbox { display: flex; }

        .typing-indicator { display: inline-flex; gap: 3px; padding: 9px 12px; background: var(--message-received); border-radius: 16px 16px 16px 4px; width: fit-content; }
        .typing-indicator span { width: 5px; height: 5px; background: var(--text-secondary); border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

        .chat-input-wrapper { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.08); }

        .quote-preview-bar { display: none; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border-bottom: 1px solid rgba(255, 255, 255, 0.08); align-items: center; gap: 10px; }
        .quote-preview-bar.active { display: flex; }
        .quote-preview-content { flex: 1; font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-left: 2px solid var(--accent-color); padding-left: 8px; }
        .quote-preview-close { width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: none; color: var(--text-primary); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .chat-input-area { display: flex; align-items: flex-end; gap: 5px; padding: 6px 10px; padding-bottom: calc(6px + var(--safe-bottom)); }

        .chat-btn { width: 34px; height: 34px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s ease; }
        .chat-btn:active { transform: scale(0.92); background: rgba(255, 255, 255, 0.2); }
        .chat-btn.send { background: var(--accent-color); }
        .chat-btn.ai { background: linear-gradient(135deg, #a855f7, #ec4899); }
        .chat-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .chat-input-field { flex: 1; min-height: 34px; max-height: 90px; padding: 7px 12px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 17px; color: var(--text-primary); font-size: 14px; resize: none; outline: none; font-family: inherit; }
        .chat-input-field::placeholder { color: rgba(255, 255, 255, 0.4); }

        .extension-panel { position: absolute; bottom: calc(60px + var(--safe-bottom)); left: 10px; right: 10px; background: var(--metal-gradient); border: 1px solid var(--metal-border); border-radius: 16px; padding: 0; z-index: 50; opacity: 0; visibility: hidden; transform: translateY(12px); transition: all 0.25s ease; overflow: hidden; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 var(--metal-highlight); }
        .extension-panel.active { opacity: 1; visibility: visible; transform: translateY(0); }

        .ext-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-bottom: 1px solid var(--metal-border); background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%); }
        .ext-panel-title { font-size: 13px; font-weight: 600; color: var(--text-primary); letter-spacing: 0.5px; text-transform: uppercase; }
        .ext-panel-close { width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.08); border: 1px solid var(--metal-border); color: var(--text-secondary); font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .ext-panel-close:hover { background: rgba(255, 255, 255, 0.15); color: var(--text-primary); }

        .ext-btn { display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: transparent; border: none; border-bottom: 1px solid var(--metal-border); color: var(--text-primary); font-size: 14px; cursor: pointer; transition: all 0.2s ease; text-align: left; }
        .ext-btn:last-child { border-bottom: none; }
        .ext-btn:hover { background: rgba(255, 255, 255, 0.05); }
        .ext-btn:active { background: rgba(255, 255, 255, 0.08); }

        .ext-btn-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: var(--metal-gradient); border: 1px solid var(--metal-border); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 var(--metal-highlight); }
        .ext-btn-icon svg { width: 18px; height: 18px; }
        .ext-btn-icon.danger { background: linear-gradient(180deg, #3a2020 0%, #2a1515 100%); }
        .ext-btn-icon.danger svg { fill: #ff6b6b; }
        .ext-btn-icon.purple { background: linear-gradient(180deg, #2a2035 0%, #1a1525 100%); }
        .ext-btn-icon.purple svg { fill: #b388ff; }
        .ext-btn-icon.blue { background: linear-gradient(180deg, #1a2535 0%, #101a25 100%); }
        .ext-btn-icon.blue svg { fill: #64b5f6; }

        .ext-btn-text { flex: 1; }
        .ext-btn-title { font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 2px; }
        .ext-btn-desc { font-size: 11px; color: var(--text-secondary); }

        .context-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); z-index: 2500; opacity: 0; visibility: hidden; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .context-menu-overlay.active { opacity: 1; visibility: visible; }

        .context-menu { background: var(--metal-gradient); border: 1px solid var(--metal-border); border-radius: 14px; width: 200px; overflow: hidden; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), inset 0 1px 0 var(--metal-highlight); transform: scale(0.9); transition: transform 0.2s ease; }
        .context-menu-overlay.active .context-menu { transform: scale(1); }

        .context-menu-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--metal-border); cursor: pointer; transition: all 0.15s ease; }
        .context-menu-item:last-child { border-bottom: none; }
        .context-menu-item:hover { background: rgba(255, 255, 255, 0.05); }
        .context-menu-item:active { background: rgba(255, 255, 255, 0.1); }

        .context-menu-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--metal-border); }
        .context-menu-icon svg { width: 16px; height: 16px; fill: var(--text-secondary); }
        .context-menu-item:hover .context-menu-icon svg { fill: var(--text-primary); }

        .context-menu-label { font-size: 14px; color: var(--text-primary); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.25s ease; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal { width: 100%; max-width: 340px; max-height: 80vh; overflow-y: auto; background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(40px); border-radius: 16px; padding: 18px; border: 1px solid rgba(255, 255, 255, 0.1); transform: scale(0.92); transition: transform 0.25s ease; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-title { font-size: 17px; font-weight: 700; color: var(--text-primary); text-align: center; margin-bottom: 14px; }
        .modal-body { color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin-bottom: 16px; }
        .modal-input { width: 100%; padding: 10px 12px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 10px; color: var(--text-primary); font-size: 14px; outline: none; margin-bottom: 12px; }
        .modal-btns { display: flex; gap: 8px; }
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn.cancel { background: rgba(255, 255, 255, 0.12); color: var(--text-primary); }
        .modal-btn.confirm { background: var(--accent-color); color: white; }

        .toast-container { position: fixed; top: calc(60px + var(--safe-top)); left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 6px; pointer-events: none; }
        .toast { padding: 10px 18px; background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(20px); border-radius: 10px; color: var(--text-primary); font-size: 13px; font-weight: 500; border: 1px solid rgba(255, 255, 255, 0.1); animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards; }
        .toast.success { border-left: 3px solid var(--success-color); }
        .toast.error { border-left: 3px solid var(--danger-color); }
        .toast.info { border-left: 3px solid var(--accent-color); }
        .toast.warning { border-left: 3px solid var(--warning-color); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

        .search-field { width: 100%; padding: 9px 12px 9px 36px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary); font-size: 14px; outline: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 10px center; }

        .toggle-switch { position: relative; width: 44px; height: 26px; background: rgba(120, 120, 128, 0.32); border-radius: 13px; cursor: pointer; }
        .toggle-switch.active { background: var(--success-color); }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: all 0.2s ease; }
        .toggle-switch.active::after { left: 20px; }

        .select-field { width: 100%; padding: 10px 12px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary); font-size: 14px; cursor: pointer; appearance: none; }
        .select-field option { background: #1a1a2e; }

        .file-input-hidden { display: none; }
        .divider { height: 1px; background: rgba(255, 255, 255, 0.08); margin: 14px 0; }

        .loading-spinner { width: 18px; height: 18px; border: 2px solid rgba(255, 255, 255, 0.2); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .slider-container { margin: 12px 0; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .slider-label { font-size: 13px; color: var(--text-primary); }
        .slider-value { font-size: 13px; color: var(--accent-color); font-weight: 600; }
        .slider-input { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; appearance: none; }
        .slider-input::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: white; border-radius: 50%; cursor: pointer; }

        .action-hint { display: flex; align-items: center; gap: 5px; padding: 7px 10px; background: rgba(0, 122, 255, 0.12); border-radius: 8px; margin-bottom: 12px; }
        .action-hint-icon { font-size: 13px; }
        .action-hint-text { font-size: 11px; color: var(--accent-color); }
        .action-hint.success { background: rgba(52, 199, 89, 0.12); }
        .action-hint.success .action-hint-text { color: var(--success-color); }
        .action-hint.warning { background: rgba(255, 149, 0, 0.12); }
        .action-hint.warning .action-hint-text { color: var(--warning-color); }

        .delete-zone { padding: 14px; border: 2px dashed var(--danger-color); border-radius: 12px; text-align: center; color: var(--danger-color); margin-top: 14px; cursor: pointer; font-size: 14px; }

        .log-container { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 8px; margin-top: 8px; max-height: 140px; overflow-y: auto; font-family: monospace; font-size: 10px; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
        .log-entry.success { color: var(--success-color); }
        .log-entry.error { color: var(--danger-color); }
        .log-entry.info { color: var(--accent-color); }

        .model-list { max-height: 160px; overflow-y: auto; margin-top: 8px; }
        .model-item { padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 5px; cursor: pointer; }
        .model-item:hover { background: rgba(255, 255, 255, 0.1); }
        .model-item.selected { background: var(--accent-color); }
        .model-item-name { font-size: 12px; color: var(--text-primary); }

        .date-separator { display: flex; justify-content: center; padding: 8px 0; }
        .date-separator-text { padding: 3px 9px; background: rgba(255, 255, 255, 0.06); border-radius: 8px; font-size: 10px; color: var(--text-secondary); }

        .select-mode-bar { display: none; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(255, 59, 48, 0.12); }
        .select-mode-bar.active { display: flex; }
        .select-mode-info { font-size: 13px; color: var(--text-primary); }
        .select-mode-btns { display: flex; gap: 8px; }
        .select-mode-btn { padding: 5px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .select-mode-btn.cancel { background: rgba(255, 255, 255, 0.15); color: var(--text-primary); }
        .select-mode-btn.delete { background: var(--danger-color); color: white; }

        .avatar-upload-area { width: 80px; height: 80px; border-radius: 50%; background: var(--glass-bg); border: 2px dashed var(--glass-border); display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto 12px; font-size: 26px; color: var(--text-secondary); overflow: hidden; transition: all 0.2s ease; }
        .avatar-upload-area:hover { border-color: var(--accent-color); }
        .avatar-upload-area.has-image { border-style: solid; border-color: var(--accent-color); }
        .avatar-upload-area img { width: 100%; height: 100%; object-fit: cover; }

        .color-picker-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .color-picker-label { font-size: 12px; color: var(--text-primary); flex: 1; }
        .color-picker-input { width: 40px; height: 28px; border: none; border-radius: 5px; cursor: pointer; background: transparent; }

        .shape-options { display: flex; gap: 6px; flex-wrap: wrap; }
        .shape-option { padding: 6px 12px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary); font-size: 12px; cursor: pointer; }
        .shape-option.selected { background: var(--accent-color); border-color: var(--accent-color); }

        .worldbook-entries { margin-top: 10px; }
        .worldbook-entry-item { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
        .worldbook-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .worldbook-entry-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .worldbook-entry-actions { display: flex; gap: 6px; }
        .worldbook-entry-btn { width: 24px; height: 24px; border-radius: 6px; border: none; background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .worldbook-entry-btn:hover { background: rgba(255, 255, 255, 0.2); color: var(--text-primary); }
        .worldbook-entry-keywords { font-size: 11px; color: var(--accent-color); margin-bottom: 4px; }
        .worldbook-entry-preview { font-size: 11px; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .worldbook-item { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 12px; margin-bottom: 8px; cursor: pointer; }
        .worldbook-item-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .worldbook-item-title { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .worldbook-item-badge { padding: 2px 7px; background: var(--accent-color); border-radius: 10px; font-size: 10px; color: white; }
        .worldbook-item-preview { font-size: 12px; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .char-counter { font-size: 10px; color: var(--text-secondary); text-align: right; margin-top: 2px; }
        .char-counter.warning { color: #FF9500; }
        .char-counter.error { color: var(--danger-color); }

        .wallpaper-preview { width: 100%; height: 120px; border-radius: 10px; margin-bottom: 12px; border: 2px solid var(--glass-border); overflow: hidden; }

        .icon-customize-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .icon-customize-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .icon-customize-preview { width: 50px; height: 50px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; border: 2px dashed var(--glass-border); overflow: hidden; transition: all 0.2s ease; }
        .icon-customize-preview:hover { border-color: var(--accent-color); }
        .icon-customize-preview.has-image { border-style: solid; }
        .icon-customize-preview img { width: 100%; height: 100%; object-fit: cover; }
        .icon-customize-label { font-size: 10px; color: var(--text-secondary); }

        .storage-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 12px; margin-bottom: 16px; }
        .storage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .storage-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .storage-size { font-size: 12px; color: var(--accent-color); }
        .storage-bar { height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .storage-bar-fill { height: 100%; background: var(--accent-color); border-radius: 3px; transition: width 0.3s ease; }
        .storage-bar-fill.warning { background: var(--warning-color); }
        .storage-bar-fill.danger { background: var(--danger-color); }
        .storage-details { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); }

        .preset-selector { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; }
        .preset-selector select { flex: 1; }
        .preset-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .preset-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .preset-btn:active { transform: scale(0.95); }

        .guide-content { max-height: 50vh; overflow-y: auto; padding-right: 5px; }
        .guide-section { margin-bottom: 14px; }
        .guide-section-title { font-size: 13px; font-weight: 600; color: var(--accent-color); margin-bottom: 6px; }
        .guide-code { background: rgba(0, 0, 0, 0.4); border-radius: 6px; padding: 8px; font-family: 'SF Mono', monospace; font-size: 11px; color: #00ff88; margin-bottom: 6px; overflow-x: auto; }
        .guide-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

        .chat-wallpaper-preview { width: 100%; height: 80px; border-radius: 8px; margin-bottom: 10px; border: 2px solid var(--glass-border); background: var(--glass-bg); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 12px; overflow: hidden; }
        .chat-wallpaper-preview.has-image { background-size: cover !important; background-position: center !important; }
        .chat-wallpaper-preview.has-image span { display: none; }

        .worldbook-multi-select { max-height: 150px; overflow-y: auto; border: 1px solid var(--glass-border); border-radius: 10px; background: var(--glass-bg); }
        .worldbook-multi-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; }
        .worldbook-multi-item:last-child { border-bottom: none; }
        .worldbook-multi-item:hover { background: rgba(255, 255, 255, 0.05); }
        .worldbook-multi-checkbox { width: 20px; height: 20px; border-radius: 5px; border: 2px solid var(--glass-border); display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .worldbook-multi-checkbox.checked { background: var(--accent-color); border-color: var(--accent-color); }
        .worldbook-multi-checkbox.checked::after { content: '‚úì'; color: white; font-size: 12px; }
        .worldbook-multi-name { font-size: 14px; color: var(--text-primary); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.12); border-radius: 2px; }

        #customCssStyles { }
    </style>
    <style id="customCssStyles"></style>
</head>
<body>
    <div id="wallpaperLayer"></div>

    <div class="phone-container">
        <div class="status-bar" id="statusBar">
            <span class="status-bar-time" id="statusBarTime">9:41</span>
            <div class="status-bar-icons">
                <svg viewBox="0 0 24 24"><path d="M12 3C7.46 3 3.34 4.78.29 7.67c-.18.18-.29.43-.29.71 0 .28.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73s3.15.25 4.6.73v3.1c0 .4.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71 0-.28-.11-.53-.29-.71C20.66 4.78 16.54 3 12 3z"/></svg>
                <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
            </div>
        </div>

        <div class="home-screen" id="homeScreen">
            <div class="app-grid" id="appGrid">
                <div class="app-icon-wrapper" onclick="openPage('settingsPage')">
                    <div class="app-icon settings" id="appIconSettings">‚öôÔ∏è</div>
                    <span class="app-icon-label">ËÆæÁΩÆ</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('messagesPage')">
                    <div class="app-icon messages" id="appIconMessages">üí¨</div>
                    <span class="app-icon-label">Áü≠‰ø°</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('worldbookPage')">
                    <div class="app-icon worldbook" id="appIconWorldbook">üìö</div>
                    <span class="app-icon-label">‰∏ñÁïå‰π¶</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('wallpaperPage')">
                    <div class="app-icon photos" id="appIconPhotos">üñºÔ∏è</div>
                    <span class="app-icon-label">Â£ÅÁ∫∏</span>
                </div>
            </div>
        </div>

        <div class="home-indicator"></div>

        <div class="page" id="settingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('settingsPage')"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>ËøîÂõû</button>
                <span class="nav-title">ËÆæÁΩÆ</span>
                <div class="nav-btn right" style="visibility:hidden">Âç†</div>
            </div>
            <div class="page-content">
                <div class="storage-card">
                    <div class="storage-header">
                        <span class="storage-title">üíæ Â≠òÂÇ®</span>
                        <span class="storage-size" id="storageSize">ËÆ°ÁÆó‰∏≠...</span>
                    </div>
                    <div class="storage-bar"><div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div></div>
                    <div class="storage-details">
                        <span id="storageUsed">Â∑≤Áî®: 0 MB</span>
                        <span id="storageTotal">Êó†ÈôêÂà∂</span>
                    </div>
                </div>

                <p class="settings-group-title">APIÈÖçÁΩÆ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="action-hint" id="connectionStatusHint">
                        <span class="action-hint-icon">‚ö†Ô∏è</span>
                        <span class="action-hint-text">Êú™ÈÖçÁΩÆAPI</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label">APIÂú∞ÂùÄ</label>
                        <input type="text" class="input-field" id="apiBaseUrl" placeholder="https://api.example.com">
                    </div>
                    <div class="input-group">
                        <label class="input-label">APIÂØÜÈí•</label>
                        <input type="password" class="input-field" id="apiKey" placeholder="sk-xxx">
                    </div>
                    <button class="btn btn-warning" onclick="fetchModels()" id="fetchModelsBtn">üìã ÊãâÂèñÊ®°Âûã</button>
                    <div id="modelListContainer" style="display:none">
                        <label class="input-label" style="margin-top:12px">ÂèØÁî®Ê®°Âûã</label>
                        <div class="model-list" id="modelList"></div>
                    </div>
                    <div class="input-group" style="margin-top:12px">
                        <label class="input-label">ÂΩìÂâçÊ®°Âûã</label>
                        <input type="text" class="input-field" id="modelName" placeholder="Ê®°ÂûãÂêçÁß∞">
                    </div>
                    <div class="btn-stack" style="margin-top:12px">
                        <button class="btn btn-secondary" onclick="testConnection()" id="testConnectionBtn">üîó ÊµãËØïËøûÊé•</button>
                        <button class="btn btn-primary" onclick="saveApiSettings()">üíæ ‰øùÂ≠òËÆæÁΩÆ</button>
                    </div>
                    <div class="divider"></div>
                    <label class="input-label">Ë∞ÉËØïÊó•Âøó</label>
                    <div class="log-container" id="debugLog"><div class="log-entry info">Á≠âÂæÖÊìç‰Ωú...</div></div>
                </div>

                <p class="settings-group-title">ÂØπËØùËÆæÁΩÆ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">ÊúÄÂ§ßËÆ∞ÂøÜÊù°Êï∞</label>
                        <input type="number" class="input-field" id="maxContextMessages" value="200">
                    </div>
                </div>

                <p class="settings-group-title">Ê®°ÂûãÂèÇÊï∞</p>
                <div class="settings-group" style="padding:12px">
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Temperature</span>
                            <span class="slider-value" id="tempValue">0.7</span>
                        </div>
                        <input type="range" class="slider-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempValue').textContent=this.value">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Max Tokens</span>
                            <span class="slider-value" id="maxTokensValue">2048</span>
                        </div>
                        <input type="range" class="slider-input" id="maxTokens" min="256" max="8192" step="256" value="2048" oninput="document.getElementById('maxTokensValue').textContent=this.value">
                    </div>
                </div>

                <p class="settings-group-title">ÁºìÂ≠ò‰∏éÂ≠òÂÇ®</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="clearImageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon cyan">üßπ</span>
                            <div><span class="settings-item-label">Ê∏ÖÈô§ÂõæÁâáÁºìÂ≠ò</span><div class="settings-item-desc">Â§¥ÂÉè„ÄÅÂ£ÅÁ∫∏Á≠â</div></div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="clearMessageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon orange">üí¨</span>
                            <div><span class="settings-item-label">Ê∏ÖÈô§Ê∂àÊÅØÁºìÂ≠ò</span><div class="settings-item-desc">‰øùÁïôËßíËâ≤ËÆæÂÆö</div></div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="compactDatabase()">
                        <div class="settings-item-left">
                            <span class="settings-icon purple">‚ö°</span>
                            <div><span class="settings-item-label">‰ºòÂåñÂ≠òÂÇ®</span><div class="settings-item-desc">ÂéãÁº©ÂõæÁâá</div></div>
                        </div>
                    </div>
                </div>

                <p class="settings-group-title">Êï∞ÊçÆÁÆ°ÁêÜ</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="forceSaveAll()">
                        <div class="settings-item-left"><span class="settings-icon green">üíæ</span><span class="settings-item-label">Âº∫Âà∂‰øùÂ≠ò</span></div>
                    </div>
                    <div class="settings-item" onclick="exportAllData()">
                        <div class="settings-item-left"><span class="settings-icon blue">üì§</span><span class="settings-item-label">ÂØºÂá∫Êï∞ÊçÆ</span></div>
                    </div>
                    <div class="settings-item" onclick="document.getElementById('importFileInput').click()">
                        <div class="settings-item-left"><span class="settings-icon orange">üì•</span><span class="settings-item-label">ÂØºÂÖ•Êï∞ÊçÆ</span></div>
                    </div>
                    <input type="file" id="importFileInput" class="file-input-hidden" accept=".json" onchange="importData(event)">
                    <div class="settings-item" onclick="clearAllData()">
                        <div class="settings-item-left"><span class="settings-icon red">üóëÔ∏è</span><span class="settings-item-label">Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ</span></div>
                    </div>
                </div>
                <div style="height:30px"></div>
            </div>
        </div>

        <div class="page" id="messagesPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('messagesPage')"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>ËøîÂõû</button>
                <span class="nav-title">Áü≠‰ø°</span>
                <button class="nav-btn right" onclick="showModal('createCharacterModal')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
            </div>
            <div style="padding:0 12px 10px">
                <input type="text" class="search-field" id="contactSearch" placeholder="ÊêúÁ¥¢ËßíËâ≤..." oninput="filterContacts()">
            </div>
            <div class="page-content" id="contactListContainer" style="padding-top:0">
                <div class="empty-state" id="emptyContactState">
                    <div class="empty-state-icon">üí¨</div>
                    <div class="empty-state-title">ÊöÇÊó†ËßíËâ≤</div>
                    <div class="empty-state-desc">ÁÇπÂáªÂè≥‰∏äËßí+ÂàõÂª∫</div>
                </div>
                <div class="contact-list" id="contactList" style="display:none"></div>
            </div>
        </div>

        <!-- ËÅäÂ§©È°µÈù¢ - ÊåâÈíÆ‰ΩçÁΩÆÂ∑≤‰∫§Êç¢ÔºöÂ∑¶‰∏äËßíÈÄÄÂá∫ÔºåÂè≥‰∏äËßíËÆæÁΩÆ -->
        <div class="page" id="chatPage">
            <div class="nav-bar">
                <!-- Â∑¶‰∏äËßíÔºöÈÄÄÂá∫ÊåâÈíÆ - È´òÁ∫ßXÂõæÊ†á -->
                <button class="nav-btn" onclick="closeChatPage()" title="ËøîÂõû">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <span class="nav-title" id="chatTitle">ËßíËâ≤Âêç</span>
                <!-- Âè≥‰∏äËßíÔºöËÆæÁΩÆÊåâÈíÆ - È´òÁ∫ßÈΩøËΩÆÂõæÊ†á -->
                <button class="nav-btn right" onclick="openCharacterSettings()" title="ËÆæÁΩÆ">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
            <div class="select-mode-bar" id="selectModeBar">
                <span class="select-mode-info">Â∑≤ÈÄâ <span id="selectedCount">0</span> Êù°</span>
                <div class="select-mode-btns">
                    <button class="select-mode-btn cancel" onclick="exitSelectMode()">ÂèñÊ∂à</button>
                    <button class="select-mode-btn delete" onclick="deleteSelectedMessages()">Âà†Èô§</button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>

                <div class="extension-panel" id="extensionPanel">
                    <div class="ext-panel-header">
                        <span class="ext-panel-title">Êìç‰Ωú</span>
                        <button class="ext-panel-close" onclick="toggleExtensionPanel()">‚úï</button>
                    </div>
                    <button class="ext-btn" onclick="enterSelectMode()">
                        <div class="ext-btn-icon danger"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">ÈÄâÊã©Âà†Èô§</div><div class="ext-btn-desc">ÊâπÈáèÂà†Èô§Ê∂àÊÅØ</div></div>
                    </button>
                    <button class="ext-btn" onclick="regenerateLastReply()">
                        <div class="ext-btn-icon purple"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">ÈáçÊñ∞ÁîüÊàê</div><div class="ext-btn-desc">ÈáçÊñ∞ÁîüÊàêAIÂõûÂ§ç</div></div>
                    </button>
                    <button class="ext-btn" onclick="openImagePicker()">
                        <div class="ext-btn-icon blue"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div>
                        <div class="ext-btn-text"><div class="ext-btn-title">ÂèëÈÄÅÂõæÁâá</div><div class="ext-btn-desc">ÂèëÈÄÅÂõæÁâáÁªôAI</div></div>
                    </button>
                </div>

                <div class="chat-input-wrapper">
                    <div class="quote-preview-bar" id="quotePreviewBar">
                        <div class="quote-preview-content" id="quotePreviewContent"></div>
                        <button class="quote-preview-close" onclick="cancelQuote()">‚úï</button>
                    </div>
                    <div class="chat-input-area">
                        <button class="chat-btn" onclick="toggleExtensionPanel()" title="Êõ¥Â§ö"><svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg></button>
                        <textarea class="chat-input-field" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" oninput="autoResizeTextarea(this)"></textarea>
                        <button class="chat-btn ai" onclick="triggerAIReply()" title="AIÂõûÂ§ç"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></button>
                        <button class="chat-btn send" onclick="sendMessage()" title="ÂèëÈÄÅ"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                    </div>
                </div>
            </div>
            <input type="file" id="chatImageInput" class="file-input-hidden" accept="image/*" onchange="handleChatImageUpload(event)">
        </div>

        <div class="context-menu-overlay" id="contextMenuOverlay" onclick="hideContextMenu()">
            <div class="context-menu" id="contextMenu" onclick="event.stopPropagation()">
                <div class="context-menu-item" onclick="copyMessageText()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></div>
                    <span class="context-menu-label">Â§çÂà∂ÊñáÊú¨</span>
                </div>
                <div class="context-menu-item" onclick="quoteMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/></svg></div>
                    <span class="context-menu-label">ÂºïÁî®ÂõûÂ§ç</span>
                </div>
                <div class="context-menu-item" onclick="editMessage()">
                    <div class="context-menu-icon"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div>
                    <span class="context-menu-label">ÁºñËæëÊ∂àÊÅØ</span>
                </div>
            </div>
        </div>

        <div class="page slide-from-bottom" id="characterSettingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeCharacterSettings()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>ÂèñÊ∂à</button>
                <span class="nav-title">ËßíËâ≤ËÆæÁΩÆ</span>
                <button class="nav-btn right" onclick="saveCharacterSettings()">‰øùÂ≠ò</button>
            </div>
            <div class="page-content">
                <p class="settings-group-title">ËÅäÂ§©ÁÆ°ÁêÜ</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="confirmClearAllMessages()">
                        <div class="settings-item-left">
                            <span class="settings-icon red">üóëÔ∏è</span>
                            <div><span class="settings-item-label">Ê∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï</span><div class="settings-item-desc">Âà†Èô§‰∏éÊ≠§ËßíËâ≤ÁöÑÂÖ®ÈÉ®Ê∂àÊÅØ</div></div>
                        </div>
                    </div>
                </div>

                <p class="settings-group-title">ËÅäÂ§©Á™óÂè£Â£ÅÁ∫∏</p>
                <div class="settings-group" style="padding:12px">
                    <div class="chat-wallpaper-preview" id="chatWallpaperPreview"><span>Êó†Ëá™ÂÆö‰πâÂ£ÅÁ∫∏</span></div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="document.getElementById('chatWallpaperInput').click()">üì§ ‰∏ä‰º†</button>
                        <button class="btn btn-secondary btn-small" onclick="clearChatWallpaper()">üóëÔ∏è Ê∏ÖÈô§</button>
                    </div>
                    <input type="file" id="chatWallpaperInput" class="file-input-hidden" accept="image/*" onchange="handleChatWallpaperUpload(event)">
                </div>

                <p class="settings-group-title">Â§¥ÂÉè</p>
                <div class="settings-group" style="padding:12px">
                    <label class="input-label">ËßíËâ≤Â§¥ÂÉè</label>
                    <div class="avatar-upload-area" id="charAvatarUpload" onclick="document.getElementById('charAvatarInput').click()">üì∑</div>
                    <input type="file" id="charAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleCharAvatarUpload(event)">
                    <label class="input-label" style="margin-top:12px">Áî®Êà∑Â§¥ÂÉè</label>
                    <div class="avatar-upload-area" id="userAvatarUpload" onclick="document.getElementById('userAvatarInput').click()">üë§</div>
                    <input type="file" id="userAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleUserAvatarUpload(event)">
                </div>

                <p class="settings-group-title">Â§¥ÂÉèÊòæÁ§∫</p>
                <div class="settings-group" style="padding:12px">
                    <div class="settings-item" style="padding:0 0 10px 0">
                        <span class="settings-item-label">ÊòæÁ§∫Â§¥ÂÉè</span>
                        <div class="toggle-switch" id="showAvatarToggle" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÂΩ¢Áä∂</label>
                        <div class="shape-options" id="avatarShapeOptions">
                            <div class="shape-option selected" data-shape="circle" onclick="selectShape(this)">ÂúÜÂΩ¢</div>
                            <div class="shape-option" data-shape="square" onclick="selectShape(this)">ÊñπÂΩ¢</div>
                            <div class="shape-option" data-shape="rounded-square" onclick="selectShape(this)">ÂúÜËßí</div>
                        </div>
                    </div>
                    <div class="settings-item" style="padding:10px 0">
                        <span class="settings-item-label">ËæπÊ°Ü</span>
                        <div class="toggle-switch" id="showBorderToggle" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="color-picker-row">
                        <span class="color-picker-label">ËæπÊ°ÜÈ¢úËâ≤</span>
                        <input type="color" class="color-picker-input" id="borderColorPicker" value="#007AFF">
                    </div>
                </div>

                <p class="settings-group-title">Âü∫Êú¨‰ø°ÊÅØ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">ËßíËâ≤ÂêçÁß∞</label>
                        <input type="text" class="input-field" id="charName" placeholder="ËßíËâ≤ÂêçÁß∞">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Ë°®ÊÉÖ(Êó†ÂõæÊó∂)</label>
                        <input type="text" class="input-field" id="charAvatar" placeholder="üòä">
                    </div>
                </div>

                <p class="settings-group-title">ËßíËâ≤ËÆæÂÆö</p>
                <div class="settings-group" style="padding:12px">
                    <textarea class="input-field" id="charDescription" rows="5" placeholder="ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºè..."></textarea>
                </div>

                <p class="settings-group-title">ÂºÄÂú∫ÁôΩ(300Â≠ó)</p>
                <div class="settings-group" style="padding:12px">
                    <textarea class="input-field" id="charGreeting" rows="2" maxlength="300" placeholder="ËßíËâ≤ÂèëÈÄÅÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØ..." oninput="updateCharCounter()"></textarea>
                    <div class="char-counter" id="greetingCharCounter">0/300</div>
                </div>

                <p class="settings-group-title">ÊÉÖÊôØ</p>
                <div class="settings-group" style="padding:12px">
                    <textarea class="input-field" id="charScenario" rows="2" placeholder="ÊïÖ‰∫ãÂèëÁîüÁöÑÂú∫ÊôØÂíåËÉåÊôØ..."></textarea>
                </div>

                <p class="settings-group-title">ÁªëÂÆö‰∏ñÁïå‰π¶ÔºàÂèØÂ§öÈÄâÔºâ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="worldbook-multi-select" id="worldbookMultiSelect"></div>
                </div>

                <!-- „Äê‰øÆÊîπ„ÄëÁî®Êà∑ËÆæÂÆö - Êîπ‰∏∫ÂÆö‰πâÁî®Êà∑ÊòØË∞Å -->
                <p class="settings-group-title">Áî®Êà∑ËÆæÂÆö</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">Áî®Êà∑ÂêçÂ≠ó</label>
                        <input type="text" class="input-field" id="charUserName" placeholder="Áî®Êà∑Âú®ÊïÖ‰∫ã‰∏≠ÁöÑÂêçÂ≠ó">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Áî®Êà∑‰∫∫ËÆæ</label>
                        <textarea class="input-field" id="charUserPersona" rows="3" placeholder="Áî®Êà∑ÁöÑË∫´‰ªΩ„ÄÅÊÄßÊ†º„ÄÅËÉåÊôØËÆæÂÆö..."></textarea>
                    </div>
                </div>

                <p class="settings-group-title">È´òÁ∫ß</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">È¢ùÂ§ñÁ≥ªÁªüÊèêÁ§∫ËØç</label>
                        <textarea class="input-field" id="charSystemPrompt" rows="2" placeholder="È¢ùÂ§ñÁöÑAIÊåá‰ª§..."></textarea>
                    </div>
                </div>

                <p class="settings-group-title">üé® Ëá™ÂÆö‰πâCSSÁæéÂåñ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="action-hint warning">
                        <span class="action-hint-icon">‚ö†Ô∏è</span>
                        <span class="action-hint-text">Ëá™ÂÆö‰πâCSS‰ºöË¶ÜÁõñ‰∏äÊñπÁöÑÂ§¥ÂÉèËÆæÁΩÆ</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label">CSSÈ¢ÑËÆæ</label>
                        <div class="preset-selector">
                            <select class="select-field" id="cssPresetSelect" onchange="loadCssPreset()"><option value="">-- Êó†È¢ÑËÆæ --</option></select>
                            <button class="preset-btn" onclick="addNewCssPreset()" title="Êñ∞Âª∫È¢ÑËÆæ">Ôºã</button>
                            <button class="preset-btn" onclick="saveCssPreset()" title="‰øùÂ≠òÈ¢ÑËÆæ">üíæ</button>
                            <button class="preset-btn" onclick="showCssGuide()" title="CSSÊåáÂçó">‚ùì</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Ê∂àÊÅØÊó∂Èó¥Êà≥</label>
                        <select class="select-field" id="timestampPosition">
                            <option value="default">ÈªòËÆ§(Ê∞îÊ≥°ÂÜÖÂ∫ïÈÉ®)</option>
                            <option value="hidden">ÈöêËóè</option>
                            <option value="side">Ê∞îÊ≥°ÊóÅËæπ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Ëá™ÂÆö‰πâCSS‰ª£Á†Å</label>
                        <textarea class="input-field css-editor" id="customCssEditor" rows="8" placeholder="/* Âú®Ê≠§ËæìÂÖ•Ëá™ÂÆö‰πâCSS */"></textarea>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="previewCss()">üëÅÔ∏è È¢ÑËßà</button>
                        <button class="btn btn-danger btn-small" onclick="clearCustomCss()">üóëÔ∏è Ê∏ÖÈô§CSS</button>
                    </div>
                </div>

                <div class="delete-zone" onclick="deleteCurrentCharacter()">üóëÔ∏è Âà†Èô§ËßíËâ≤</div>
                <div style="height:30px"></div>
            </div>
        </div>

        <div class="page" id="worldbookPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('worldbookPage')"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>ËøîÂõû</button>
                <span class="nav-title">‰∏ñÁïå‰π¶</span>
                <button class="nav-btn right" onclick="showModal('createWorldbookModal')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
            </div>
            <div class="page-content">
                <div class="action-hint">
                    <span class="action-hint-icon">üìö</span>
                    <span class="action-hint-text">ÊØè‰∏™‰∏ñÁïå‰π¶ÂèØÂåÖÂê´Â§ö‰∏™Êù°ÁõÆ</span>
                </div>
                <div class="empty-state" id="emptyWorldbookState">
                    <div class="empty-state-icon">üìö</div>
                    <div class="empty-state-title">ÊöÇÊó†‰∏ñÁïå‰π¶</div>
                    <div class="empty-state-desc">ÁÇπÂáª+ÂàõÂª∫</div>
                </div>
                <div id="worldbookList" style="display:none"></div>
            </div>
        </div>

        <div class="page slide-from-bottom" id="worldbookEditPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeWorldbookEdit()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>ÂèñÊ∂à</button>
                <span class="nav-title">ÁºñËæë‰∏ñÁïå‰π¶</span>
                <button class="nav-btn right" onclick="saveWorldbook()">‰øùÂ≠ò</button>
            </div>
            <div class="page-content">
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">‰∏ñÁïå‰π¶ÂêçÁß∞</label>
                        <input type="text" class="input-field" id="worldbookName" placeholder="ÂêçÁß∞">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÁÆÄ‰ªã</label>
                        <textarea class="input-field" id="worldbookSummary" rows="2" placeholder="ÁÆÄ‰ªã..."></textarea>
                    </div>
                </div>

                <p class="settings-group-title">Êù°ÁõÆÂàóË°®</p>
                <div class="settings-group" style="padding:12px">
                    <div class="worldbook-entries" id="worldbookEntries"></div>
                    <button class="btn btn-secondary" onclick="addWorldbookEntry()">+ Ê∑ªÂä†Êù°ÁõÆ</button>
                </div>

                <div class="delete-zone" onclick="deleteCurrentWorldbook()">üóëÔ∏è Âà†Èô§‰∏ñÁïå‰π¶</div>
                <div style="height:30px"></div>
            </div>
        </div>

        <div class="modal-overlay" id="entryEditModal">
            <div class="modal">
                <div class="modal-title">ÁºñËæëÊù°ÁõÆ</div>
                <div class="input-group">
                    <label class="input-label">Êù°ÁõÆÂêçÁß∞</label>
                    <input type="text" class="modal-input" id="entryName" placeholder="ÂêçÁß∞" style="margin-bottom:8px">
                </div>
                <div class="input-group">
                    <label class="input-label">Ëß¶ÂèëÂÖ≥ÈîÆËØç(ÈÄóÂè∑ÂàÜÈöî)</label>
                    <input type="text" class="modal-input" id="entryKeywords" placeholder="ÂÖ≥ÈîÆËØç1,ÂÖ≥ÈîÆËØç2..." style="margin-bottom:8px">
                </div>
                <div class="input-group">
                    <label class="input-label">ÂÜÖÂÆπ</label>
                    <textarea class="input-field" id="entryContent" rows="5" placeholder="ÂÜÖÂÆπ..."></textarea>
                </div>
                <div class="settings-item" style="padding:10px 0">
                    <span class="settings-item-label">ÂßãÁªàÊøÄÊ¥ª</span>
                    <div class="toggle-switch" id="entryAlwaysActive" onclick="toggleSwitch(this)"></div>
                </div>
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="hideModal('entryEditModal')">ÂèñÊ∂à</button>
                    <button class="modal-btn confirm" onclick="saveWorldbookEntry()">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>

        <div class="page" id="wallpaperPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('wallpaperPage')"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>ËøîÂõû</button>
                <span class="nav-title">Â£ÅÁ∫∏‰∏éÂõæÊ†á</span>
                <div class="nav-btn right" style="visibility:hidden">Âç†</div>
            </div>
            <div class="page-content">
                <p class="settings-group-title">ÊòæÁ§∫ËÆæÁΩÆ</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="toggleStatusBar()">
                        <div class="settings-item-left">
                            <span class="settings-icon gray">üì±</span>
                            <div><span class="settings-item-label">ÈöêËóèÊ®°ÊãüÊó∂Èó¥Ê†è</span><div class="settings-item-desc">ÂÖ®Â±èÊó∂ÈÅøÂÖç‰∏éÁ≥ªÁªüÊ†èÈáçÂè†</div></div>
                        </div>
                        <div class="toggle-switch" id="hideStatusBarToggle"></div>
                    </div>
                </div>

                <p class="settings-group-title">È¢ÑËßà</p>
                <div class="wallpaper-preview" id="wallpaperPreview"></div>

                <p class="settings-group-title">È¢ÑËÆæÂ£ÅÁ∫∏</p>
                <div class="settings-group" style="padding:12px">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px" id="wallpaperGrid">
                        <div onclick="selectPresetWallpaper('gradient1')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#0a0a0f,#1a1a2e,#0f0f1a);cursor:pointer;border:2px solid transparent" data-wp="gradient1"></div>
                        <div onclick="selectPresetWallpaper('gradient2')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#2d1b69,#11998e);cursor:pointer;border:2px solid transparent" data-wp="gradient2"></div>
                        <div onclick="selectPresetWallpaper('gradient3')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);cursor:pointer;border:2px solid transparent" data-wp="gradient3"></div>
                        <div onclick="selectPresetWallpaper('gradient4')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#141e30,#243b55);cursor:pointer;border:2px solid transparent" data-wp="gradient4"></div>
                        <div onclick="selectPresetWallpaper('gradient5')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#232526,#414345);cursor:pointer;border:2px solid transparent" data-wp="gradient5"></div>
                        <div onclick="selectPresetWallpaper('gradient6')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#1f1c2c,#928dab);cursor:pointer;border:2px solid transparent" data-wp="gradient6"></div>
                    </div>
                </div>

                <p class="settings-group-title">Ëá™ÂÆö‰πâ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">ÂõæÁâáURL</label>
                        <input type="text" class="input-field" id="customWallpaperUrl" placeholder="https://...">
                    </div>
                    <button class="btn btn-secondary" onclick="previewUrlWallpaper()">È¢ÑËßà</button>
                    <div class="divider"></div>
                    <button class="btn btn-secondary" onclick="document.getElementById('wallpaperUpload').click()">üì§ ‰∏ä‰º†ÂõæÁâá</button>
                    <input type="file" id="wallpaperUpload" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
                </div>

                <button class="btn btn-success" onclick="saveWallpaper()" style="margin-bottom:16px">üíæ ‰øùÂ≠òÂ£ÅÁ∫∏</button>

                <p class="settings-group-title">ÂõæÊ†á</p>
                <div class="settings-group" style="padding:12px">
                    <div class="icon-customize-grid">
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewSettings" onclick="document.getElementById('iconInputSettings').click()">‚öôÔ∏è</div>
                            <span class="icon-customize-label">ËÆæÁΩÆ</span>
                            <input type="file" id="iconInputSettings" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'settings')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewMessages" onclick="document.getElementById('iconInputMessages').click()">üí¨</div>
                            <span class="icon-customize-label">Áü≠‰ø°</span>
                            <input type="file" id="iconInputMessages" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'messages')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewWorldbook" onclick="document.getElementById('iconInputWorldbook').click()">üìö</div>
                            <span class="icon-customize-label">‰∏ñÁïå‰π¶</span>
                            <input type="file" id="iconInputWorldbook" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'worldbook')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewPhotos" onclick="document.getElementById('iconInputPhotos').click()">üñºÔ∏è</div>
                            <span class="icon-customize-label">Â£ÅÁ∫∏</span>
                            <input type="file" id="iconInputPhotos" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'photos')">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <button class="btn btn-primary" onclick="saveIcons()">üíæ ‰øùÂ≠òÂõæÊ†á</button>
                    <div style="height:6px"></div>
                    <button class="btn btn-secondary" onclick="resetIcons()">üîÑ ÈáçÁΩÆ</button>
                </div>
                <div style="height:30px"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createCharacterModal">
        <div class="modal">
            <div class="modal-title">ÂàõÂª∫ËßíËâ≤</div>
            <input type="text" class="modal-input" id="newCharacterName" placeholder="ËßíËâ≤ÂêçÁß∞...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createCharacterModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="createCharacter()">ÂàõÂª∫</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createWorldbookModal">
        <div class="modal">
            <div class="modal-title">ÂàõÂª∫‰∏ñÁïå‰π¶</div>
            <input type="text" class="modal-input" id="newWorldbookName" placeholder="ÂêçÁß∞...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createWorldbookModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="createWorldbook()">ÂàõÂª∫</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal">
            <div class="modal-title" id="deleteModalTitle">Á°ÆËÆ§Âà†Èô§Ôºü</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:14px;font-size:13px" id="deleteModalDesc">Êó†Ê≥ïÊí§ÈîÄ</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('confirmDeleteModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" style="background:var(--danger-color)" onclick="confirmDelete()">Âà†Èô§</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="clearMessagesModal">
        <div class="modal">
            <div class="modal-title">‚ö†Ô∏è Ê∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:14px;font-size:13px">Á°ÆÂÆöË¶ÅÂà†Èô§‰∏éÊ≠§ËßíËâ≤ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü<br>Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('clearMessagesModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" style="background:var(--danger-color)" onclick="executeClearAllMessages()">Á°ÆËÆ§Âà†Èô§</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cssPresetNameModal">
        <div class="modal">
            <div class="modal-title">Êñ∞Âª∫CSSÈ¢ÑËÆæ</div>
            <input type="text" class="modal-input" id="newCssPresetName" placeholder="È¢ÑËÆæÂêçÁß∞...">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('cssPresetNameModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="createCssPreset()">ÂàõÂª∫</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cssGuideModal">
        <div class="modal" style="max-width:380px">
            <div class="modal-title">üìñ CSSËá™ÂÆö‰πâÊåáÂçó</div>
            <div class="guide-content">
                <div class="guide-section">
                    <div class="guide-section-title">üí¨ Ê∂àÊÅØÊ∞îÊ≥°</div>
                    <div class="guide-code">.message.sent { }<br>.message.received { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üí¨ ÂºïÁî®Ê∞îÊ≥°</div>
                    <div class="guide-code">.message-quote { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üë§ Â§¥ÂÉè</div>
                    <div class="guide-code">.message-avatar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">‚è∞ Êó∂Èó¥Êà≥</div>
                    <div class="guide-code">.message-time { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üìù ËæìÂÖ•Âå∫Âüü</div>
                    <div class="guide-code">.chat-input-area { }<br>.chat-input-field { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üîù È°∂Ê†è</div>
                    <div class="guide-code">#chatPage .nav-bar { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üñºÔ∏è ÂõæÁâáÊ∂àÊÅØ</div>
                    <div class="guide-code">.message-image { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üí° Á§∫‰æã</div>
                    <div class="guide-code">.message.sent {<br>  background: linear-gradient(135deg, #ff6b9d, #c44569);<br>  border-radius: 20px;<br>}</div>
                </div>
            </div>
            <div class="modal-btns" style="margin-top:14px">
                <button class="modal-btn confirm" onclick="hideModal('cssGuideModal')">Áü•ÈÅì‰∫Ü</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editMessageModal">
        <div class="modal">
            <div class="modal-title">ÁºñËæëÊ∂àÊÅØ</div>
            <textarea class="input-field" id="editMessageContent" rows="4" placeholder="ÁºñËæëÂÜÖÂÆπ..."></textarea>
            <div class="modal-btns" style="margin-top:12px">
                <button class="modal-btn cancel" onclick="hideModal('editMessageModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="saveEditedMessage()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const DB_NAME = 'SMSAppDB';
        const DB_VERSION = 4;
        let db = null;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('appData')) database.createObjectStore('appData', { keyPath: 'key' });
                    if (!database.objectStoreNames.contains('images')) database.createObjectStore('images', { keyPath: 'id' });
                };
            });
        }

        function saveToIDB(storeName, key, value) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DBÊú™ÊâìÂºÄ'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).put(storeName === 'appData' ? { key, value } : { id: key, data: value });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        function loadFromIDB(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DBÊú™ÊâìÂºÄ'); return; }
                const tx = db.transaction([storeName], 'readonly');
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result ? (storeName === 'appData' ? req.result.value : req.result.data) : null);
                req.onerror = () => reject(req.error);
            });
        }

        function clearIDBStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DBÊú™ÊâìÂºÄ'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).clear();
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function getStorageUsage() {
            try { if (navigator.storage?.estimate) { const est = await navigator.storage.estimate(); return { used: est.usage || 0, quota: est.quota || 0, percent: est.quota ? (est.usage / est.quota * 100) : 0 }; } } catch (e) {}
            return { used: 0, quota: 0, percent: 0 };
        }

        const App = {
            characters: [], worldbooks: [], currentCharId: null, currentWbId: null,
            currentEntryIndex: -1, pendingDeleteType: null, pendingDeleteId: null, models: [],
            connectionStatus: 'disconnected', isSelectMode: false, selectedMsgs: new Set(),
            lastAIStart: -1, tempWallpaper: null, tempIcons: {},
            appIcons: { settings: null, messages: null, worldbook: null, photos: null },
            defaultEmojis: { settings: '‚öôÔ∏è', messages: 'üí¨', worldbook: 'üìö', photos: 'üñºÔ∏è' },
            settings: { apiBaseUrl: '', apiKey: '', modelName: '', temperature: 0.7, maxTokens: 2048, maxContextMessages: 200, wallpaper: 'gradient1', wallpaperData: null, hideStatusBar: false },
            globalCssPresets: [],
            dataLoaded: false,
            currentQuote: null,
            contextMenuMsgId: null,
            longPressTimer: null,
            editingMsgId: null
        };

        const GRADIENTS = {
            gradient1: 'linear-gradient(135deg, #0a0a0f, #1a1a2e, #0f0f1a)',
            gradient2: 'linear-gradient(135deg, #2d1b69, #11998e)',
            gradient3: 'linear-gradient(135deg, #0f0c29, #302b63, #24243e)',
            gradient4: 'linear-gradient(135deg, #141e30, #243b55)',
            gradient5: 'linear-gradient(135deg, #232526, #414345)',
            gradient6: 'linear-gradient(135deg, #1f1c2c, #928dab)'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadData();
                updateTime();
                setInterval(updateTime, 60000);
                applyWallpaper();
                applyAppIcons();
                applyStatusBarVisibility();
                updateConnectionUI();
                highlightWallpaper();
                updateWallpaperPreview();
                updateIconPreviews();
                updateStorageDisplay();
            } catch (e) { console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', e); showToast('ÂàùÂßãÂåñÂ§±Ë¥•', 'error'); }
        });

        async function updateStorageDisplay() {
            const usage = await getStorageUsage();
            const usedMB = (usage.used / (1024 * 1024)).toFixed(2);
            document.getElementById('storageSize').textContent = `${usedMB} MB`;
            document.getElementById('storageUsed').textContent = `Â∑≤Áî®: ${usedMB} MB`;
            document.getElementById('storageTotal').textContent = usage.quota > 0 ? `ÈÖçÈ¢ù: ${(usage.quota / (1024 * 1024)).toFixed(0)} MB` : 'Êó†ÈôêÂà∂';
            const barFill = document.getElementById('storageBarFill');
            barFill.style.width = `${Math.min(usage.percent, 100)}%`;
            barFill.className = 'storage-bar-fill' + (usage.percent > 80 ? ' danger' : usage.percent > 60 ? ' warning' : '');
}

        function updateTime() { document.getElementById('statusBarTime').textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); }

        function toggleStatusBar() { App.settings.hideStatusBar = !App.settings.hideStatusBar; applyStatusBarVisibility(); saveData(); }

        function applyStatusBarVisibility() {
            const statusBar = document.getElementById('statusBar');
            const homeScreen = document.getElementById('homeScreen');
            const toggle = document.getElementById('hideStatusBarToggle');
            if (App.settings.hideStatusBar) { statusBar.classList.add('hidden'); homeScreen.classList.add('no-statusbar'); toggle?.classList.add('active'); }
            else { statusBar.classList.remove('hidden'); homeScreen.classList.remove('no-statusbar'); toggle?.classList.remove('active'); }
        }

        async function saveData() {
            try {
                await Promise.all([
                    saveToIDB('appData', 'characters', App.characters),
                    saveToIDB('appData', 'worldbooks', App.worldbooks),
                    saveToIDB('appData', 'settings', App.settings),
                    saveToIDB('appData', 'appIcons', App.appIcons),
                    saveToIDB('appData', 'globalCssPresets', App.globalCssPresets)
                ]);
                return true;
            } catch (e) { console.error('‰øùÂ≠òÂ§±Ë¥•:', e); return false; }
        }

        async function loadData() {
            try {
                const [characters, worldbooks, settings, icons, presets] = await Promise.all([
                    loadFromIDB('appData', 'characters'),
                    loadFromIDB('appData', 'worldbooks'),
                    loadFromIDB('appData', 'settings'),
                    loadFromIDB('appData', 'appIcons'),
                    loadFromIDB('appData', 'globalCssPresets')
                ]);
                if (characters) App.characters = characters;
                if (worldbooks) App.worldbooks = worldbooks;
                if (settings) App.settings = { ...App.settings, ...settings };
                if (icons) App.appIcons = { ...App.appIcons, ...icons };
                if (presets) App.globalCssPresets = presets;
                App.worldbooks.forEach(wb => { if (!wb.entries) wb.entries = [{ name: 'ÈªòËÆ§Êù°ÁõÆ', keywords: wb.keywords || '', content: wb.content || '', alwaysActive: wb.alwaysActive || false }]; });
                App.characters.forEach(c => {
                    if (c.worldbookId && !c.worldbookIds) c.worldbookIds = [c.worldbookId];
                    if (!c.worldbookIds) c.worldbookIds = [];
                    // ËøÅÁßªÊóßÁâàÁî®Êà∑Áß∞ÂëºÂà∞Êñ∞ÁâàÁî®Êà∑ËÆæÂÆö
                    if (c.userNick && !c.userName) { c.userName = c.userNick; }
                    if (!c.userName) c.userName = '';
                    if (!c.userPersona) c.userPersona = '';
                });
                loadSettingsUI();
                if (App.settings.apiBaseUrl && App.settings.apiKey && App.settings.modelName) App.connectionStatus = 'connected';
                App.dataLoaded = true;
                return true;
            } catch (e) { console.error('Âä†ËΩΩÂ§±Ë¥•:', e); return false; }
        }

        async function forceSaveAll() { if (await saveData()) { await updateStorageDisplay(); showToast('Â∑≤‰øùÂ≠ò', 'success'); } }

        async function clearImageCache() {
            if (!confirm('Á°ÆÂÆöÊ∏ÖÈô§ÂõæÁâáÁºìÂ≠òÔºü')) return;
            App.settings.wallpaperData = null; App.settings.wallpaper = 'gradient1';
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null };
            App.characters.forEach(c => { c.avatarImage = null; c.userAvatar = null; c.chatWallpaper = null; c.messages.forEach(m => { if (m.image) m.image = null; }); });
            await saveData(); applyWallpaper(); applyAppIcons(); updateIconPreviews(); await updateStorageDisplay();
            showToast('Â∑≤Ê∏ÖÈô§', 'success');
        }

        async function clearMessageCache() {
            if (!confirm('Á°ÆÂÆöÊ∏ÖÈô§Ê∂àÊÅØÔºü')) return;
            App.characters.forEach(c => { c.messages = []; });
            await saveData(); await updateStorageDisplay(); showToast('Â∑≤Ê∏ÖÈô§', 'success');
        }

        async function compactDatabase() {
            showToast('‰ºòÂåñ‰∏≠...', 'info');
            for (let c of App.characters) {
                if (c.avatarImage?.length > 50000) c.avatarImage = await compressImage(c.avatarImage, 150, 0.7);
                if (c.userAvatar?.length > 50000) c.userAvatar = await compressImage(c.userAvatar, 150, 0.7);
                if (c.chatWallpaper?.length > 300000) c.chatWallpaper = await compressImage(c.chatWallpaper, 500, 0.7);
                for (let m of c.messages) { if (m.image?.length > 200000) m.image = await compressImage(m.image, 400, 0.7); }
            }
            if (App.settings.wallpaperData?.length > 500000) App.settings.wallpaperData = await compressImage(App.settings.wallpaperData, 600, 0.7);
            for (let k of Object.keys(App.appIcons)) { if (App.appIcons[k]?.length > 30000) App.appIcons[k] = await compressImage(App.appIcons[k], 100, 0.7); }
            await saveData(); await updateStorageDisplay(); showToast('ÂÆåÊàê', 'success');
        }

        function compressImage(dataUrl, maxWidth = 400, quality = 0.7) {
            return new Promise((resolve) => {
                if (!dataUrl?.startsWith('data:image')) { resolve(dataUrl); return; }
                const img = new Image();
                img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality)); };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        window.addEventListener('beforeunload', () => { saveData(); });
        setInterval(() => { if (App.dataLoaded) saveData(); }, 30000);

        function loadSettingsUI() {
            document.getElementById('apiBaseUrl').value = App.settings.apiBaseUrl || '';
            document.getElementById('apiKey').value = App.settings.apiKey || '';
            document.getElementById('modelName').value = App.settings.modelName || '';
            document.getElementById('maxContextMessages').value = App.settings.maxContextMessages || 200;
            document.getElementById('temperature').value = App.settings.temperature;
            document.getElementById('tempValue').textContent = App.settings.temperature;
            document.getElementById('maxTokens').value = App.settings.maxTokens;
            document.getElementById('maxTokensValue').textContent = App.settings.maxTokens;
        }

        function applyWallpaper() {
            const el = document.getElementById('wallpaperLayer');
            const wp = App.settings.wallpaper, wpData = App.settings.wallpaperData;
            el.style.cssText = '';
            if (wpData) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background-image:url(${wpData})!important;background-size:cover!important;background-position:center!important;`;
            else if (wp?.startsWith('http')) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background-image:url(${wp})!important;background-size:cover!important;background-position:center!important;`;
            else if (GRADIENTS[wp]) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background:${GRADIENTS[wp]}!important;`;
            else el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background:${GRADIENTS.gradient1}!important;`;
        }

        function updateWallpaperPreview() {
            const preview = document.getElementById('wallpaperPreview');
            const wp = App.tempWallpaper || App.settings.wallpaper;
            if (App.tempWallpaper?.startsWith('data:')) preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            else if (!App.tempWallpaper && App.settings.wallpaperData) preview.style.cssText = `background-image:url(${App.settings.wallpaperData})!important;background-size:cover!important;background-position:center!important;`;
            else if (App.tempWallpaper?.startsWith('http')) preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            else if (GRADIENTS[wp]) preview.style.cssText = `background:${GRADIENTS[wp]}!important;`;
            else preview.style.cssText = `background:${GRADIENTS.gradient1}!important;`;
        }

        function selectPresetWallpaper(name) { App.tempWallpaper = name; highlightWallpaper(); updateWallpaperPreview(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'info'); }
        function previewUrlWallpaper() { const url = document.getElementById('customWallpaperUrl').value.trim(); if (!url) { showToast('ËØ∑ËæìÂÖ•URL', 'error'); return; } App.tempWallpaper = url; updateWallpaperPreview(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'info'); }

        async function handleWallpaperUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => { App.tempWallpaper = await compressImage(ev.target.result, 800, 0.8); updateWallpaperPreview(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'success'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function saveWallpaper() {
            if (!App.tempWallpaper) { showToast('ËØ∑ÂÖàÈÄâÊã©', 'warning'); return; }
            if (App.tempWallpaper.startsWith('data:')) { App.settings.wallpaperData = App.tempWallpaper; App.settings.wallpaper = 'custom'; }
            else if (App.tempWallpaper.startsWith('http')) { App.settings.wallpaper = App.tempWallpaper; App.settings.wallpaperData = null; }
            else { App.settings.wallpaper = App.tempWallpaper; App.settings.wallpaperData = null; }
            App.tempWallpaper = null;
            if (await saveData()) { applyWallpaper(); highlightWallpaper(); updateWallpaperPreview(); await updateStorageDisplay(); showToast('Â∑≤‰øùÂ≠ò', 'success'); }
        }

        function highlightWallpaper() {
            const current = App.tempWallpaper || App.settings.wallpaper;
            document.querySelectorAll('#wallpaperGrid > div').forEach(el => { el.style.borderColor = el.dataset.wp === current ? 'var(--accent-color)' : 'transparent'; });
        }

        function updateIconPreviews() {
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => {
                const preview = document.getElementById('iconPreview' + app.charAt(0).toUpperCase() + app.slice(1));
                const iconData = App.tempIcons[app] || App.appIcons[app];
                if (iconData) { preview.innerHTML = `<img src="${iconData}">`; preview.classList.add('has-image'); }
                else { preview.innerHTML = App.defaultEmojis[app]; preview.classList.remove('has-image'); }
            });
        }

        function applyAppIcons() {
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => {
                const el = document.getElementById('appIcon' + app.charAt(0).toUpperCase() + app.slice(1));
                const iconData = App.appIcons[app];
                el.innerHTML = iconData ? `<img src="${iconData}" style="width:100%;height:100%;object-fit:cover;">` : App.defaultEmojis[app];
            });
        }

        async function handleIconUpload(e, appName) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => { App.tempIcons[appName] = await compressImage(ev.target.result, 120, 0.8); updateIconPreviews(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'info'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function saveIcons() {
            let changed = false;
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => { if (App.tempIcons[app]) { App.appIcons[app] = App.tempIcons[app]; changed = true; } });
            App.tempIcons = {};
            if (changed && await saveData()) { applyAppIcons(); await updateStorageDisplay(); showToast('Â∑≤‰øùÂ≠ò', 'success'); }
            else if (!changed) showToast('Ê≤°ÊúâÊõ¥Êîπ', 'info');
        }

        async function resetIcons() { App.appIcons = { settings: null, messages: null, worldbook: null, photos: null }; App.tempIcons = {}; await saveData(); applyAppIcons(); updateIconPreviews(); showToast('Â∑≤ÈáçÁΩÆ', 'success'); }

        function openPage(id) {
            const page = document.getElementById(id);
            if (page) {
                page.classList.add('active');
                if (id === 'messagesPage') renderContacts();
                if (id === 'worldbookPage') renderWorldbooks();
                if (id === 'wallpaperPage') { updateWallpaperPreview(); updateIconPreviews(); highlightWallpaper(); applyStatusBarVisibility(); }
                if (id === 'settingsPage') updateStorageDisplay();
            }
        }

        function closePage(id) { document.getElementById(id)?.classList.remove('active'); }
        function showModal(id) { document.getElementById(id)?.classList.add('active'); }
        function hideModal(id) { document.getElementById(id)?.classList.remove('active'); }
        function showToast(msg, type='info') { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); }

        function addLog(msg, type='info') { const c = document.getElementById('debugLog'); const e = document.createElement('div'); e.className = `log-entry ${type}`; e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; c.appendChild(e); c.scrollTop = c.scrollHeight; }
        function updateConnectionUI() { const h = document.getElementById('connectionStatusHint'); if (App.connectionStatus === 'connected') { h.className = 'action-hint success'; h.innerHTML = `<span class="action-hint-icon">‚úÖ</span><span class="action-hint-text">Â∑≤ËøûÊé• - ${App.settings.modelName}</span>`; } else { h.className = 'action-hint'; h.innerHTML = `<span class="action-hint-icon">‚ö†Ô∏è</span><span class="action-hint-text">Êú™ËøûÊé•</span>`; } }

        async function fetchModels() {
            const url = document.getElementById('apiBaseUrl').value.trim(), key = document.getElementById('apiKey').value.trim();
            if (!url || !key) { showToast('ËØ∑Â°´ÂÜô', 'error'); return; }
            const btn = document.getElementById('fetchModelsBtn'); btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>';
            try {
                const r = await fetch(`${url.replace(/\/+$/,'').replace(/\/v1$/,'')}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const d = await r.json(), models = d.data || d.models || d || [];
                App.models = models;
                document.getElementById('modelListContainer').style.display = 'block';
                document.getElementById('modelList').innerHTML = models.map(m => { const id = m.id || m.name || m; return `<div class="model-item" onclick="selectModel('${id}')"><span class="model-item-name">${id}</span></div>`; }).join('');
                addLog(`ÊâæÂà∞${models.length}‰∏™`, 'success');
            } catch(e) { addLog(`Â§±Ë¥•: ${e.message}`, 'error'); showToast(`Â§±Ë¥•: ${e.message}`, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = 'üìã ÊãâÂèñÊ®°Âûã'; }
        }

        function selectModel(id) { App.settings.modelName = id; document.getElementById('modelName').value = id; document.querySelectorAll('.model-item').forEach(el => { el.classList.toggle('selected', el.querySelector('.model-item-name').textContent === id); }); showToast(`Â∑≤ÈÄâ: ${id}`, 'success'); }

        async function testConnection() {
            const url = document.getElementById('apiBaseUrl').value.trim(), key = document.getElementById('apiKey').value.trim(), model = document.getElementById('modelName').value.trim();
            if (!url || !key || !model) { showToast('ËØ∑Â°´ÂÜô', 'error'); return; }
            const btn = document.getElementById('testConnectionBtn'); btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>';
            try {
                const r = await fetch(`${url.replace(/\/+$/,'').replace(/\/v1$/,'')}/v1/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 }) });
                if (r.ok) { App.connectionStatus = 'connected'; App.settings.apiBaseUrl = url; App.settings.apiKey = key; App.settings.modelName = model; await saveData(); showToast('ÊàêÂäüÔºÅ', 'success'); addLog('ËøûÊé•ÊàêÂäü', 'success'); }
                else throw new Error(`HTTP ${r.status}`);
            } catch(e) { App.connectionStatus = 'disconnected'; showToast(`Â§±Ë¥•: ${e.message}`, 'error'); }
            finally { updateConnectionUI(); btn.disabled = false; btn.innerHTML = 'üîó ÊµãËØïËøûÊé•'; }
        }

        async function saveApiSettings() {
            App.settings.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            App.settings.apiKey = document.getElementById('apiKey').value.trim();
            App.settings.modelName = document.getElementById('modelName').value.trim();
            App.settings.temperature = parseFloat(document.getElementById('temperature').value);
            App.settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            App.settings.maxContextMessages = parseInt(document.getElementById('maxContextMessages').value) || 200;
            await saveData(); showToast('Â∑≤‰øùÂ≠ò', 'success');
        }

        async function createCharacter() {
            const name = document.getElementById('newCharacterName').value.trim(); if (!name) { showToast('ËØ∑ËæìÂÖ•', 'error'); return; }
            const char = {
                id: Date.now().toString(), name,
                avatar: ['üòä','üòé','ü•∞','ü¶ä','üê±','üê∞'][Math.floor(Math.random()*6)],
                avatarImage: null, userAvatar: null, showAvatar: true, avatarShape: 'circle',
                showBorder: false, borderColor: '#007AFF', borderWidth: 2,
                description: '', greeting: '', scenario: '', worldbookIds: [],
                userName: '', userPersona: '', systemPrompt: '', messages: [],
                chatWallpaper: null, customCss: '', activeCssPresetId: null, timestampPosition: 'default'
            };
            App.characters.push(char); await saveData(); hideModal('createCharacterModal'); document.getElementById('newCharacterName').value = ''; renderContacts(); showToast(`"${name}"Â∑≤ÂàõÂª∫`, 'success');
        }

        function renderContacts() {
            const list = document.getElementById('contactList'), empty = document.getElementById('emptyContactState');
            if (App.characters.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; }
            list.style.display = 'flex'; empty.style.display = 'none';
            list.innerHTML = App.characters.map(c => {
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content.substring(0,25)+'...' : 'ÂºÄÂßãÂØπËØù';
                const lastTime = c.messages.length > 0 ? formatTime(c.messages[c.messages.length-1].timestamp) : '';
                const avatarHtml = c.avatarImage ? `<img src="${c.avatarImage}">` : (c.avatar || c.name[0]);
                return `<div class="contact-item" onclick="openChat('${c.id}')"><div class="contact-avatar">${avatarHtml}</div><div class="contact-info"><div class="contact-name">${escapeHtml(c.name)}</div><div class="contact-preview">${escapeHtml(lastMsg)}</div></div><div class="contact-time">${lastTime}</div></div>`;
            }).join('');
        }

        function filterContacts() { const q = document.getElementById('contactSearch').value.toLowerCase(); document.querySelectorAll('.contact-item').forEach(el => { el.style.display = el.querySelector('.contact-name').textContent.toLowerCase().includes(q) ? 'flex' : 'none'; }); }

        function openChat(id) {
            const char = App.characters.find(c => c.id === id); if (!char) return;
            App.currentCharId = id; App.isSelectMode = false; App.selectedMsgs.clear(); App.lastAIStart = -1;
            App.currentQuote = null;
            document.getElementById('quotePreviewBar').classList.remove('active');
            document.getElementById('chatTitle').textContent = char.name;
            document.getElementById('selectModeBar').classList.remove('active');
            document.getElementById('chatMessages').classList.remove('select-mode');
            applyChatWallpaper(char);
            applyCustomCss(char);
            renderMessages(); openPage('chatPage');
            if (char.messages.length === 0 && char.greeting) addMessage(char.greeting, 'received');
        }

        function applyChatWallpaper(char) {
            const chatPage = document.getElementById('chatPage');
            if (char.chatWallpaper) { chatPage.classList.add('has-custom-bg'); chatPage.style.backgroundImage = `url(${char.chatWallpaper})`; }
            else { chatPage.classList.remove('has-custom-bg'); chatPage.style.backgroundImage = ''; }
        }

        function applyCustomCss(char) {
            const styleEl = document.getElementById('customCssStyles');
            let css = '';
            if (char.activeCssPresetId) { const preset = App.globalCssPresets.find(p => p.id === char.activeCssPresetId); if (preset) css = preset.css; }
            if (char.customCss) css = char.customCss;
            styleEl.textContent = css;
        }

        function closeChatPage() {
            exitSelectMode(); closePage('chatPage');
            document.getElementById('customCssStyles').textContent = '';
            const chatPage = document.getElementById('chatPage');
            chatPage.classList.remove('has-custom-bg'); chatPage.style.backgroundImage = '';
            App.currentCharId = null; App.currentQuote = null;
        }

        function openCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            updateChatWallpaperPreview(char);
            const charAvUpload = document.getElementById('charAvatarUpload'), userAvUpload = document.getElementById('userAvatarUpload');
            if (char.avatarImage) { charAvUpload.innerHTML = `<img src="${char.avatarImage}">`; charAvUpload.classList.add('has-image'); } else { charAvUpload.innerHTML = 'üì∑'; charAvUpload.classList.remove('has-image'); }
            charAvUpload.dataset.image = char.avatarImage || '';
            if (char.userAvatar) { userAvUpload.innerHTML = `<img src="${char.userAvatar}">`; userAvUpload.classList.add('has-image'); } else { userAvUpload.innerHTML = 'üë§'; userAvUpload.classList.remove('has-image'); }
            userAvUpload.dataset.image = char.userAvatar || '';
            document.getElementById('showAvatarToggle').classList.toggle('active', char.showAvatar !== false);
            document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(el => { el.classList.toggle('selected', el.dataset.shape === (char.avatarShape || 'circle')); });
            document.getElementById('showBorderToggle').classList.toggle('active', char.showBorder === true);
            document.getElementById('borderColorPicker').value = char.borderColor || '#007AFF';
            document.getElementById('charName').value = char.name;
            document.getElementById('charAvatar').value = char.avatar || '';
            document.getElementById('charDescription').value = char.description || '';
            document.getElementById('charGreeting').value = char.greeting || '';
            document.getElementById('charScenario').value = char.scenario || '';
            // „Äê‰øÆÊîπ„ÄëÁî®Êà∑ËÆæÂÆöÂ≠óÊÆµ
            document.getElementById('charUserName').value = char.userName || '';
            document.getElementById('charUserPersona').value = char.userPersona || '';
            document.getElementById('charSystemPrompt').value = char.systemPrompt || '';
            document.getElementById('timestampPosition').value = char.timestampPosition || 'default';
            document.getElementById('customCssEditor').value = char.customCss || '';
            updateCssPresetSelect(char);
            updateWorldbookMultiSelect(char);
            updateCharCounter();
            openPage('characterSettingsPage');
        }

        function updateChatWallpaperPreview(char) {
            const preview = document.getElementById('chatWallpaperPreview');
            if (char.chatWallpaper) { preview.style.backgroundImage = `url(${char.chatWallpaper})`; preview.classList.add('has-image'); }
            else { preview.style.backgroundImage = ''; preview.classList.remove('has-image'); }
        }

        function updateCssPresetSelect(char) {
            const select = document.getElementById('cssPresetSelect');
            select.innerHTML = '<option value="">-- Êó†È¢ÑËÆæ --</option>' + App.globalCssPresets.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            select.value = char.activeCssPresetId || '';
        }

        function updateWorldbookMultiSelect(char) {
            const container = document.getElementById('worldbookMultiSelect');
            if (App.worldbooks.length === 0) { container.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:13px">ÊöÇÊó†‰∏ñÁïå‰π¶</div>'; return; }
            container.innerHTML = App.worldbooks.map(wb => {
                const checked = (char.worldbookIds || []).includes(wb.id);
                return `<div class="worldbook-multi-item" onclick="toggleWorldbookBinding('${wb.id}')"><div class="worldbook-multi-checkbox ${checked ? 'checked' : ''}"></div><span class="worldbook-multi-name">${escapeHtml(wb.name)}</span></div>`;
            }).join('');
        }

        function toggleWorldbookBinding(wbId) {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (!char.worldbookIds) char.worldbookIds = [];
            const idx = char.worldbookIds.indexOf(wbId);
            if (idx >= 0) char.worldbookIds.splice(idx, 1);
            else char.worldbookIds.push(wbId);
            updateWorldbookMultiSelect(char);
        }

        function closeCharacterSettings() { closePage('characterSettingsPage'); }

        async function handleCharAvatarUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async ev => { const compressed = await compressImage(ev.target.result, 200, 0.8); const upload = document.getElementById('charAvatarUpload'); upload.innerHTML = `<img src="${compressed}">`; upload.classList.add('has-image'); upload.dataset.image = compressed; }; reader.readAsDataURL(file); e.target.value = ''; }
        async function handleUserAvatarUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async ev => { const compressed = await compressImage(ev.target.result, 200, 0.8); const upload = document.getElementById('userAvatarUpload'); upload.innerHTML = `<img src="${compressed}">`; upload.classList.add('has-image'); upload.dataset.image = compressed; }; reader.readAsDataURL(file); e.target.value = ''; }
        function selectShape(el) { document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); }

        async function handleChatWallpaperUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const reader = new FileReader();
            reader.onload = async ev => { char.chatWallpaper = await compressImage(ev.target.result, 600, 0.8); updateChatWallpaperPreview(char); showToast('Â∑≤ËÆæÁΩÆÔºå‰øùÂ≠òÂêéÁîüÊïà', 'success'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        function clearChatWallpaper() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            char.chatWallpaper = null; updateChatWallpaperPreview(char); showToast('Â∑≤Ê∏ÖÈô§Ôºå‰øùÂ≠òÂêéÁîüÊïà', 'info');
        }

        function confirmClearAllMessages() { showModal('clearMessagesModal'); }

        async function executeClearAllMessages() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            char.messages = []; await saveData(); hideModal('clearMessagesModal'); renderMessages(); showToast('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÈô§', 'success');
        }

        function loadCssPreset() { const presetId = document.getElementById('cssPresetSelect').value; if (!presetId) { document.getElementById('customCssEditor').value = ''; return; } const preset = App.globalCssPresets.find(p => p.id === presetId); if (preset) document.getElementById('customCssEditor').value = preset.css; }
        function addNewCssPreset() { showModal('cssPresetNameModal'); document.getElementById('newCssPresetName').value = ''; }

        async function createCssPreset() {
            const name = document.getElementById('newCssPresetName').value.trim(); if (!name) { showToast('ËØ∑ËæìÂÖ•ÂêçÁß∞', 'error'); return; }
            const css = document.getElementById('customCssEditor').value;
            const preset = { id: Date.now().toString(), name, css };
            App.globalCssPresets.push(preset); await saveData(); hideModal('cssPresetNameModal');
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (char) { updateCssPresetSelect(char); document.getElementById('cssPresetSelect').value = preset.id; }
            showToast(`È¢ÑËÆæ"${name}"Â∑≤ÂàõÂª∫`, 'success');
        }

        async function saveCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value; if (!presetId) { showToast('ËØ∑ÂÖàÈÄâÊã©ÊàñÂàõÂª∫È¢ÑËÆæ', 'warning'); return; }
            const preset = App.globalCssPresets.find(p => p.id === presetId); if (!preset) return;
            preset.css = document.getElementById('customCssEditor').value; await saveData(); showToast(`È¢ÑËÆæ"${preset.name}"Â∑≤Êõ¥Êñ∞`, 'success');
        }

        function showCssGuide() { showModal('cssGuideModal'); }
        function previewCss() { document.getElementById('customCssStyles').textContent = document.getElementById('customCssEditor').value; showToast('CSSÂ∑≤È¢ÑËßà', 'info'); }
        function clearCustomCss() { document.getElementById('customCssEditor').value = ''; document.getElementById('cssPresetSelect').value = ''; document.getElementById('customCssStyles').textContent = ''; showToast('CSSÂ∑≤Ê∏ÖÈô§', 'info'); }

        async function saveCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const greeting = document.getElementById('charGreeting').value; if (greeting.length > 300) { showToast('ÂºÄÂú∫ÁôΩËøáÈïø', 'error'); return; }
            char.avatarImage = document.getElementById('charAvatarUpload').dataset.image || null;
            char.userAvatar = document.getElementById('userAvatarUpload').dataset.image || null;
            char.showAvatar = document.getElementById('showAvatarToggle').classList.contains('active');
            const shapeEl = document.querySelector('#avatarShapeOptions .shape-option.selected');
            char.avatarShape = shapeEl ? shapeEl.dataset.shape : 'circle';
            char.showBorder = document.getElementById('showBorderToggle').classList.contains('active');
            char.borderColor = document.getElementById('borderColorPicker').value;
            char.name = document.getElementById('charName').value.trim() || char.name;
            char.avatar = document.getElementById('charAvatar').value.trim() || char.avatar;
            char.description = document.getElementById('charDescription').value;
            char.greeting = greeting;
            char.scenario = document.getElementById('charScenario').value;
            // „Äê‰øÆÊîπ„Äë‰øùÂ≠òÁî®Êà∑ËÆæÂÆö
            char.userName = document.getElementById('charUserName').value.trim();
            char.userPersona = document.getElementById('charUserPersona').value;
            char.systemPrompt = document.getElementById('charSystemPrompt').value;
            char.timestampPosition = document.getElementById('timestampPosition').value;
            char.customCss = document.getElementById('customCssEditor').value;
            char.activeCssPresetId = document.getElementById('cssPresetSelect').value || null;
            document.getElementById('chatTitle').textContent = char.name;
            await saveData(); applyChatWallpaper(char); applyCustomCss(char); renderMessages(); closeCharacterSettings(); showToast('Â∑≤‰øùÂ≠ò', 'success');
        }

        function updateCharCounter() { const ta = document.getElementById('charGreeting'), counter = document.getElementById('greetingCharCounter'); counter.textContent = `${ta.value.length}/300`; counter.className = 'char-counter' + (ta.value.length >= 280 ? ' warning' : '') + (ta.value.length >= 300 ? ' error' : ''); }
        function deleteCurrentCharacter() { const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; App.pendingDeleteType = 'character'; App.pendingDeleteId = char.id; document.getElementById('deleteModalTitle').textContent = `Âà†Èô§"${char.name}"Ôºü`; showModal('confirmDeleteModal'); }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (char.messages.length === 0) { container.innerHTML = '<div class="date-separator"><span class="date-separator-text">‰ªäÂ§©</span></div>'; return; }
            const showAvatar = char.showAvatar !== false, avatarShape = char.avatarShape || 'circle', showBorder = char.showBorder === true, borderColor = char.borderColor || '#007AFF', borderWidth = char.borderWidth || 2;
            let shapeClass = avatarShape === 'square' ? 'square' : avatarShape === 'rounded-square' ? 'rounded-square' : '';
            const borderStyle = showBorder ? `border:${borderWidth}px solid ${borderColor};` : '';
            const timestampPos = char.timestampPosition || 'default';
            let timeClass = timestampPos === 'hidden' ? 'time-hidden' : timestampPos === 'side' ? 'time-side' : '';
            let html = '', lastDate = null;
            char.messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString();
                if (msgDate !== lastDate) { html += `<div class="date-separator"><span class="date-separator-text">${formatDate(msg.timestamp)}</span></div>`; lastDate = msgDate; }
                const type = msg.role === 'user' ? 'sent' : 'received', checked = App.selectedMsgs.has(msg.id) ? 'checked' : '';
                let avatarHtml = '';
                if (showAvatar) { const avatarContent = type === 'received' ? (char.avatarImage ? `<img src="${char.avatarImage}">` : (char.avatar || char.name[0])) : (char.userAvatar ? `<img src="${char.userAvatar}">` : 'üë§'); avatarHtml = `<div class="message-avatar ${shapeClass}" style="${borderStyle}">${avatarContent}</div>`; }
                let quoteHtml = '';
                if (msg.quoteContent) { quoteHtml = `<div class="message-quote">${escapeHtml(msg.quoteContent)}</div>`; }
                let imageHtml = '';
                if (msg.image) { imageHtml = `<img src="${msg.image}" class="message-image" onclick="viewImage('${msg.id}')">`; }
                let displayContent = msg.content === '[ÂõæÁâá]' && msg.image ? '' : msg.content;
                html += `<div class="message-wrapper ${type}" data-msg-id="${msg.id}" ontouchstart="startLongPress('${msg.id}')" ontouchend="endLongPress()" ontouchmove="endLongPress()" oncontextmenu="showContextMenuDirect(event,'${msg.id}')">
                    <div class="message-checkbox ${checked}" onclick="toggleMsgSelect('${msg.id}')"></div>
                    ${type === 'received' ? avatarHtml : ''}
                    <div class="message ${type}">
                        ${quoteHtml}
                        ${escapeHtml(displayContent)}
                        ${imageHtml}
                        <div class="message-time ${timeClass}">${formatTime(msg.timestamp)}</div>
                    </div>
                    ${type === 'sent' ? avatarHtml : ''}
                </div>`;
            });
            container.innerHTML = html;
            scrollToBottom();
        }

        function startLongPress(msgId) { App.longPressTimer = setTimeout(() => { showContextMenu(msgId); }, 500); }
        function endLongPress() { if (App.longPressTimer) { clearTimeout(App.longPressTimer); App.longPressTimer = null; } }
        function showContextMenu(msgId) { App.contextMenuMsgId = msgId; document.getElementById('contextMenuOverlay').classList.add('active'); }
        function showContextMenuDirect(e, msgId) { e.preventDefault(); showContextMenu(msgId); }
        function hideContextMenu() { document.getElementById('contextMenuOverlay').classList.remove('active'); App.contextMenuMsgId = null; }

        function copyMessageText() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId); if (!msg) return;
            navigator.clipboard.writeText(msg.content).then(() => showToast('Â∑≤Â§çÂà∂', 'success')).catch(() => showToast('Â§çÂà∂Â§±Ë¥•', 'error'));
            hideContextMenu();
        }

        function quoteMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId); if (!msg) return;
            App.currentQuote = { msgId: msg.id, content: msg.content.substring(0, 100) };
            document.getElementById('quotePreviewContent').textContent = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');
            document.getElementById('quotePreviewBar').classList.add('active');
            hideContextMenu();
            document.getElementById('chatInput').focus();
        }

        function cancelQuote() { App.currentQuote = null; document.getElementById('quotePreviewBar').classList.remove('active'); }

        function editMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.contextMenuMsgId); if (!msg) return;
            App.editingMsgId = App.contextMenuMsgId;
            document.getElementById('editMessageContent').value = msg.content;
            hideContextMenu();
            showModal('editMessageModal');
        }

        async function saveEditedMessage() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === App.editingMsgId);
            if (!msg) { showToast('Êâæ‰∏çÂà∞Ê∂àÊÅØ', 'error'); hideModal('editMessageModal'); return; }
            msg.content = document.getElementById('editMessageContent').value;
            await saveData(); hideModal('editMessageModal'); App.editingMsgId = null; renderMessages(); showToast('Â∑≤‰øùÂ≠ò', 'success');
        }

        function viewImage(msgId) {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = char.messages.find(m => m.id === msgId); if (msg?.image) window.open(msg.image, '_blank');
        }

        async function addMessage(content, type, imageData = null, quoteData = null) {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = {
                id: Date.now().toString() + Math.random().toString(36).substr(2,9),
                role: type === 'sent' ? 'user' : 'assistant',
                content, timestamp: new Date().toISOString(),
                image: imageData || null,
                quoteId: quoteData?.msgId || null,
                quoteContent: quoteData?.content || null
            };
            char.messages.push(msg); await saveData(); renderMessages();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput'), content = input.value.trim(); if (!content && !App.currentQuote) return;
            const quoteData = App.currentQuote ? { ...App.currentQuote } : null;
            addMessage(content || 'ÂõûÂ§ç', 'sent', null, quoteData);
            input.value = ''; autoResizeTextarea(input);
            cancelQuote();
        }

        function openImagePicker() { toggleExtensionPanel(); document.getElementById('chatImageInput').click(); }

        async function handleChatImageUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            if (file.size > 2 * 1024 * 1024 * 1024) { showToast('ÂõæÁâáËøáÂ§ß(>2GB)', 'error'); return; }
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const compressed = await compressImage(ev.target.result, 800, 0.8);
                await addMessage('[ÂõæÁâá]', 'sent', compressed);
            };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function triggerAIReply() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (!App.settings.apiBaseUrl || !App.settings.apiKey || !App.settings.modelName) { showToast('ËØ∑ÈÖçÁΩÆAPI', 'error'); return; }
            App.lastAIStart = char.messages.length;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', '<div class="typing-indicator" id="typingIndicator"><span></span><span></span><span></span></div>');
            scrollToBottom();
            try {
                const max = App.settings.maxContextMessages || 200;
                const history = char.messages.slice(-max);
                const messages = buildAPIMessages(char, history);
                const url = App.settings.apiBaseUrl.replace(/\/+$/,'').replace(/\/v1$/,'');

                const hasImage = history.some(m => m.image);
                let body;

                if (hasImage) {
                    const mmMsgs = [messages[0]];
                    let msgIdx = 1;
                    let historyIdx = 0;

                    while (msgIdx < messages.length && historyIdx < history.length) {
                        const apiMsg = messages[msgIdx];
                        const role = apiMsg.role === 'user' ? 'user' : 'assistant';

                        const samRoleMsgs = [];
                        while (historyIdx < history.length &&
                               ((history[historyIdx].role === 'user' && role === 'user') ||
                                (history[historyIdx].role === 'assistant' && role === 'assistant'))) {
                            samRoleMsgs.push(history[historyIdx]);
                            historyIdx++;
                        }

                        const hasImageInGroup = samRoleMsgs.some(m => m.image);

                        if (hasImageInGroup) {
                            const contentParts = [];
                            contentParts.push({ type: 'text', text: apiMsg.content });
                            samRoleMsgs.forEach(m => {
                                if (m.image) {
                                    contentParts.push({ type: 'image_url', image_url: { url: m.image } });
                                }
                            });
                            mmMsgs.push({ role: apiMsg.role, content: contentParts });
                        } else {
                            mmMsgs.push(apiMsg);
                        }
                        msgIdx++;
                    }

                    while (msgIdx < messages.length) {
                        mmMsgs.push(messages[msgIdx]);
                        msgIdx++;
                    }

                    body = JSON.stringify({
                        model: App.settings.modelName,
                        messages: mmMsgs,
                        temperature: App.settings.temperature,
                        max_tokens: App.settings.maxTokens
                    });
                } else {
                    body = JSON.stringify({
                        model: App.settings.modelName,
                        messages,
                        temperature: App.settings.temperature,
                        max_tokens: App.settings.maxTokens
                    });
                }

                const r = await fetch(`${url}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${App.settings.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body
                });

                document.getElementById('typingIndicator')?.remove();
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json(), reply = data.choices[0].message.content;

                const parsedParts = parseAIResponse(reply, history);
                for (let i = 0; i < parsedParts.length; i++) {
                    if (i > 0) await new Promise(r => setTimeout(r, 300 + Math.random()*400));
                    const p = parsedParts[i];
                    await addMessage(p.content, 'received', null, p.quote ? { msgId: null, content: p.quote } : null);
                }
            } catch(e) {
                document.getElementById('typingIndicator')?.remove();
                App.lastAIStart = -1;
                showToast(`Â§±Ë¥•: ${e.message}`, 'error');
            }
        }

        function parseAIResponse(text, history) {
            if (!text) return [{ content: '...', quote: null }];
            const parts = text.trim().split(/\s*\|\|\|\s*/).map(s => s.trim()).filter(s => s);
            const results = [];
            const quoteRegex = /^\[Q:#(\d+)\](.*)$/s;
            for (const part of parts) {
                let cleanPart = part;
                let quoteContent = null;
                const match = cleanPart.match(quoteRegex);
                if (match) {
                    const idx = parseInt(match[1]) - 1;
                    cleanPart = match[2].trim();
                    if (idx >= 0 && idx < history.length) {
                        quoteContent = history[idx].content.substring(0, 100);
                    }
                }
                cleanPart = cleanPart.replace(/^["„Äå„Äé"]+/, '').replace(/["„Äç„Äè"]+$/, '').trim();
                if (cleanPart) {
                    results.push({ content: cleanPart, quote: quoteContent });
                }
            }
            return results.length > 0 ? results : [{ content: text.trim(), quote: null }];
        }

        // „Äê‰øÆÊîπ„ÄëÊûÑÂª∫APIÊ∂àÊÅØÊó∂‰ΩøÁî®Êñ∞ÁöÑÁî®Êà∑ËÆæÂÆöÂ≠óÊÆµ
        function buildAPIMessages(char, history) {
            const msgs = [];
            let sys = `# Áü≠‰ø°Ê®°ÊãüËßÑÂàô\n\n‰Ω†Ê≠£Âú®ÊâÆÊºî"${char.name}"ÔºåÈÄöËøáÊâãÊú∫Áü≠‰ø°ËÅäÂ§©„ÄÇ\n\n## „ÄêÈáçË¶Å„ÄëËæìÂá∫Ê†ºÂºè\n1. ÊØèÊù°Áü≠‰ø°Áî® ||| ÂàÜÈöî\n2. Ê†πÊçÆÁúüÂÆûÁü≠‰ø°È£éÊ†ºÔºåÊØèÊù°5-20Â≠óÂ∑¶Âè≥ÔºåÂèØÈïøÂèØÁü≠ÔºåÁÅµÊ¥ªÂ∫îÂèò\n3. ‰∏çË¶ÅÂä†ËßíËâ≤ÂêçÂâçÁºÄ\n4. ÂÉèÁúü‰∫∫ÂèëÁü≠‰ø°\n5. „ÄêÁ¶ÅÊ≠¢„Äë‰∏çË¶ÅÂú®Ê∂àÊÅØÂâçÂä†ÁºñÂè∑Â¶Ç#1:Á≠â\n\n## ÂºïÁî®ÂõûÂ§çÊ†ºÂºèÔºàÂèØÈÄâÔºâ\nÂ¶ÇÊûúË¶ÅÂºïÁî®ÂéÜÂè≤Ê∂àÊÅØÂõûÂ§çÔºåÊ†ºÂºèÔºö[Q:#ÁºñÂè∑]ÂõûÂ§çÂÜÖÂÆπ\n‰æãÔºö[Q:#3]Á°ÆÂÆûÊòØËøôÊ†∑|||ÂêéÈù¢ÁöÑÊôÆÈÄöÊ∂àÊÅØ\nÁºñÂè∑ÂØπÂ∫îÂéÜÂè≤Ê∂àÊÅØÂ∫èÂè∑(‰ªé1ÂºÄÂßã)\n\n## Ê≠£Á°ÆÁ§∫‰æã\nÂóØ|||Á°ÆÂÆû\n[Q:#5]ÁúüÁöÑÂêóÔºü|||ÂìàÂìà\n\n## ÈîôËØØÔºàÁ¶ÅÊ≠¢Ôºâ\n‚ùå #1: ÂÜÖÂÆπÔºàÁ¶ÅÊ≠¢Âä†ÁºñÂè∑ÂâçÁºÄÔºâ\n‚ùå ËßíËâ≤Âêç: ÂÜÖÂÆπ\n‚ùå ‰∏ÄÊù°Ê∂àÊÅØ500Â≠óÂ§™Èïø\n\n## ËßíËâ≤ËÆæÂÆö\n${char.description || 'ÊúãÂèã'}`;
            if (char.scenario) sys += `\n\n## ÊÉÖÊôØ\n${char.scenario}`;
            // „Äê‰øÆÊîπ„Äë‰ΩøÁî®Êñ∞ÁöÑÁî®Êà∑ËÆæÂÆö
            if (char.userName) sys += `\n\n## Áî®Êà∑ÂêçÂ≠ó\nÁî®Êà∑ÁöÑÂêçÂ≠óÊòØÔºö${char.userName}`;
            if (char.userPersona) sys += `\n\n## Áî®Êà∑‰∫∫ËÆæ\n${char.userPersona}`;
            if (char.systemPrompt) sys += `\n\n## È¢ùÂ§ñÊåá‰ª§\n${char.systemPrompt}`;
            if (char.worldbookIds?.length > 0) {
                char.worldbookIds.forEach(wbId => {
                    const wb = App.worldbooks.find(w => w.id === wbId);
                    if (wb?.entries) {
                        wb.entries.forEach(entry => {
                            const shouldInject = entry.alwaysActive || (entry.keywords && history.some(m => entry.keywords.split(',').some(k => m.content.toLowerCase().includes(k.trim().toLowerCase()))));
                            if (shouldInject && entry.content) sys += `\n\n## ËÉåÊôØ(${entry.name})\n${entry.content}`;
                        });
                    }
                });
            }
            if (history.length > 0) {
                sys += `\n\n## ÂéÜÂè≤Ê∂àÊÅØÁºñÂè∑ÂèÇËÄÉÔºà‰ªÖ‰æõÂºïÁî®Êó∂‰ΩøÁî®ÁºñÂè∑Ôºâ\n`;
                history.forEach((m, i) => {
                    const role = m.role === 'user' ? 'Áî®Êà∑' : '‰Ω†';
                    const hasImg = m.image ? '[ÊúâÂõæÁâá]' : '';
                    sys += `#${i+1} ${role}: ${m.content.substring(0, 30)}${m.content.length > 30 ? '...' : ''}${hasImg}\n`;
                });
            }
            msgs.push({ role: 'system', content: sys });

            let currentRole = null;
            let buffer = [];
            const flushBuffer = () => {
                if (buffer.length > 0) {
                    const role = buffer[0].role === 'user' ? 'user' : 'assistant';
                    const content = buffer.map(m => {
                        let text = m.content;
                        if (m.quoteContent) text = `[ÂºïÁî®:"${m.quoteContent.substring(0,30)}"]${text}`;
                        if (m.image) text += '[ÂõæÁâá]';
                        return text;
                    }).join('|||');
                    msgs.push({ role, content });
                    buffer = [];
                }
            };
            history.forEach((m) => {
                if (currentRole !== m.role) { flushBuffer(); currentRole = m.role; }
                buffer.push(m);
            });
            flushBuffer();
            if (history.length > 10) {
                msgs.push({ role: 'system', content: '„ÄêÊèêÈÜí„ÄëÁî®|||ÂàÜÈöîÂ§öÊù°Áü≠‰ø°„ÄÇÂ¶ÇÈúÄÂºïÁî®ÂèØÁî®[Q:#ÁºñÂè∑]„ÄÇ„ÄêÁ¶ÅÊ≠¢Âú®Ê∂àÊÅØÂÜÖÂÆπÂâçÂä†#Êï∞Â≠ó:ÂâçÁºÄ„Äë' });
            }
            return msgs;
        }

        async function regenerateLastReply() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; toggleExtensionPanel();
            if (char.messages.length === 0) { showToast('Êó†Ê∂àÊÅØ', 'warning'); return; }
            if (App.lastAIStart >= 0 && App.lastAIStart < char.messages.length) {
                let allAI = true;
                for (let i = App.lastAIStart; i < char.messages.length; i++) { if (char.messages[i].role !== 'assistant') { allAI = false; break; } }
                if (allAI) { const count = char.messages.length - App.lastAIStart; char.messages.splice(App.lastAIStart, count); await saveData(); renderMessages(); showToast(`Â∑≤Âà†${count}Êù°`, 'info'); App.lastAIStart = -1; await triggerAIReply(); return; }
            }
            if (char.messages[char.messages.length-1].role !== 'assistant') { showToast('ÊúÄÂêéÈùûAI', 'warning'); return; }
            let first = char.messages.length - 1;
            for (let i = char.messages.length - 1; i >= 0; i--) { if (char.messages[i].role === 'assistant') first = i; else break; }
            const count = char.messages.length - first; char.messages.splice(first, count); await saveData(); renderMessages(); showToast(`Â∑≤Âà†${count}Êù°`, 'info'); await triggerAIReply();
        }

        function enterSelectMode() { toggleExtensionPanel(); App.isSelectMode = true; App.selectedMsgs.clear(); document.getElementById('chatMessages').classList.add('select-mode'); document.getElementById('selectModeBar').classList.add('active'); updateSelectedCount(); }
        function exitSelectMode() { App.isSelectMode = false; App.selectedMsgs.clear(); document.getElementById('chatMessages').classList.remove('select-mode'); document.getElementById('selectModeBar').classList.remove('active'); document.querySelectorAll('.message-checkbox').forEach(el => el.classList.remove('checked')); }
        function toggleMsgSelect(id) { if (!App.isSelectMode) return; if (App.selectedMsgs.has(id)) App.selectedMsgs.delete(id); else App.selectedMsgs.add(id); document.querySelector(`[data-msg-id="${id}"] .message-checkbox`)?.classList.toggle('checked', App.selectedMsgs.has(id)); updateSelectedCount(); }
        function updateSelectedCount() { document.getElementById('selectedCount').textContent = App.selectedMsgs.size; }
        async function deleteSelectedMessages() { const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; if (App.selectedMsgs.size === 0) { showToast('ËØ∑ÈÄâÊã©', 'warning'); return; } const count = App.selectedMsgs.size; char.messages = char.messages.filter(m => !App.selectedMsgs.has(m.id)); await saveData(); exitSelectMode(); renderMessages(); showToast(`Â∑≤Âà†${count}Êù°`, 'success'); App.lastAIStart = -1; }
        function toggleExtensionPanel() { document.getElementById('extensionPanel').classList.toggle('active'); }
        function autoResizeTextarea(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 90) + 'px'; }
        function scrollToBottom() { const c = document.getElementById('chatMessages'); c.scrollTop = c.scrollHeight; }

        async function createWorldbook() {
            const name = document.getElementById('newWorldbookName').value.trim(); if (!name) { showToast('ËØ∑ËæìÂÖ•', 'error'); return; }
            const wb = { id: Date.now().toString(), name, summary: '', entries: [{ name: 'ÈªòËÆ§Êù°ÁõÆ', keywords: '', content: '', alwaysActive: false }] };
            App.worldbooks.push(wb); await saveData(); hideModal('createWorldbookModal'); document.getElementById('newWorldbookName').value = ''; renderWorldbooks(); showToast(`"${name}"Â∑≤ÂàõÂª∫`, 'success'); openWorldbookEdit(wb.id);
        }

        function renderWorldbooks() {
            const list = document.getElementById('worldbookList'), empty = document.getElementById('emptyWorldbookState');
            if (App.worldbooks.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; }
            list.style.display = 'block'; empty.style.display = 'none';
            list.innerHTML = App.worldbooks.map(wb => {
                const entryCount = wb.entries?.length || 0;
                return `<div class="worldbook-item" onclick="openWorldbookEdit('${wb.id}')"><div class="worldbook-item-header"><span class="worldbook-item-title">${escapeHtml(wb.name)}</span><span class="worldbook-item-badge">${entryCount}Êù°ÁõÆ</span></div><div class="worldbook-item-preview">${escapeHtml(wb.summary || 'Êó†ÁÆÄ‰ªã')}</div></div>`;
            }).join('');
        }

        function openWorldbookEdit(id) {
            const wb = App.worldbooks.find(w => w.id === id); if (!wb) return;
            App.currentWbId = id;
            document.getElementById('worldbookName').value = wb.name;
            document.getElementById('worldbookSummary').value = wb.summary || '';
            renderWorldbookEntries(wb);
            openPage('worldbookEditPage');
        }

        function renderWorldbookEntries(wb) {
            const container = document.getElementById('worldbookEntries');
            if (!wb.entries || wb.entries.length === 0) { container.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;padding:10px">ÊöÇÊó†Êù°ÁõÆ</div>'; return; }
            container.innerHTML = wb.entries.map((entry, i) => `<div class="worldbook-entry-item"><div class="worldbook-entry-header"><span class="worldbook-entry-title">${escapeHtml(entry.name || `Êù°ÁõÆ${i+1}`)}${entry.alwaysActive ? ' üîí' : ''}</span><div class="worldbook-entry-actions"><button class="worldbook-entry-btn" onclick="editWorldbookEntry(${i})">‚úèÔ∏è</button><button class="worldbook-entry-btn" onclick="deleteWorldbookEntry(${i})">üóëÔ∏è</button></div></div><div class="worldbook-entry-keywords">${entry.keywords ? 'ÂÖ≥ÈîÆËØç: ' + escapeHtml(entry.keywords) : 'Êó†ÂÖ≥ÈîÆËØç'}</div><div class="worldbook-entry-preview">${escapeHtml(entry.content?.substring(0, 80) || 'Êó†ÂÜÖÂÆπ')}...</div></div>`).join('');
        }

        function addWorldbookEntry() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            App.currentEntryIndex = -1;
            document.getElementById('entryName').value = '';
            document.getElementById('entryKeywords').value = '';
            document.getElementById('entryContent').value = '';
            document.getElementById('entryAlwaysActive').classList.remove('active');
            showModal('entryEditModal');
        }

        function editWorldbookEntry(idx) {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb || !wb.entries[idx]) return;
            App.currentEntryIndex = idx;
            const entry = wb.entries[idx];
            document.getElementById('entryName').value = entry.name || '';
            document.getElementById('entryKeywords').value = entry.keywords || '';
            document.getElementById('entryContent').value = entry.content || '';
            document.getElementById('entryAlwaysActive').classList.toggle('active', entry.alwaysActive);
            showModal('entryEditModal');
        }

        async function saveWorldbookEntry() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            const entry = { name: document.getElementById('entryName').value.trim() || 'Êú™ÂëΩÂêçÊù°ÁõÆ', keywords: document.getElementById('entryKeywords').value, content: document.getElementById('entryContent').value, alwaysActive: document.getElementById('entryAlwaysActive').classList.contains('active') };
            if (App.currentEntryIndex >= 0) { wb.entries[App.currentEntryIndex] = entry; }
            else { wb.entries.push(entry); }
            await saveData(); hideModal('entryEditModal'); renderWorldbookEntries(wb); showToast('Êù°ÁõÆÂ∑≤‰øùÂ≠ò', 'success');
        }

        async function deleteWorldbookEntry(idx) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Êù°ÁõÆÔºü')) return;
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            wb.entries.splice(idx, 1);
            await saveData(); renderWorldbookEntries(wb); showToast('Â∑≤Âà†Èô§', 'success');
        }

        function closeWorldbookEdit() { closePage('worldbookEditPage'); App.currentWbId = null; }

        async function saveWorldbook() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            wb.name = document.getElementById('worldbookName').value.trim() || wb.name;
            wb.summary = document.getElementById('worldbookSummary').value;
            await saveData(); closeWorldbookEdit(); renderWorldbooks(); showToast('Â∑≤‰øùÂ≠ò', 'success');
        }

        function deleteCurrentWorldbook() {
            const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return;
            App.pendingDeleteType = 'worldbook'; App.pendingDeleteId = wb.id;
            document.getElementById('deleteModalTitle').textContent = `Âà†Èô§"${wb.name}"Ôºü`;
            showModal('confirmDeleteModal');
        }

        async function confirmDelete() {
            if (App.pendingDeleteType === 'character') {
                App.characters = App.characters.filter(c => c.id !== App.pendingDeleteId);
                await saveData(); hideModal('confirmDeleteModal'); closeCharacterSettings(); closeChatPage(); renderContacts(); showToast('Â∑≤Âà†Èô§', 'success');
            } else if (App.pendingDeleteType === 'worldbook') {
                App.characters.forEach(c => { if (c.worldbookIds) c.worldbookIds = c.worldbookIds.filter(id => id !== App.pendingDeleteId); });
                App.worldbooks = App.worldbooks.filter(w => w.id !== App.pendingDeleteId);
                await saveData(); hideModal('confirmDeleteModal'); closeWorldbookEdit(); renderWorldbooks(); showToast('Â∑≤Âà†Èô§', 'success');
            }
        }

        function exportAllData() {
            const data = { characters: App.characters, worldbooks: App.worldbooks, settings: App.settings, appIcons: App.appIcons, globalCssPresets: App.globalCssPresets, version: '6.5.0', exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sms-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
            showToast('Â∑≤ÂØºÂá∫', 'success');
        }

        async function importData(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.characters) App.characters = data.characters;
                    if (data.worldbooks) App.worldbooks = data.worldbooks;
                    if (data.settings) App.settings = {...App.settings, ...data.settings};
                    if (data.appIcons) App.appIcons = {...App.appIcons, ...data.appIcons};
                    if (data.globalCssPresets) App.globalCssPresets = data.globalCssPresets;
                    App.worldbooks.forEach(wb => { if (!wb.entries) wb.entries = [{ name: 'ÈªòËÆ§Êù°ÁõÆ', keywords: wb.keywords || '', content: wb.content || '', alwaysActive: wb.alwaysActive || false }]; });
                    App.characters.forEach(c => {
                        if (c.worldbookId && !c.worldbookIds) c.worldbookIds = [c.worldbookId];
                        if (!c.worldbookIds) c.worldbookIds = [];
                        if (c.userNick && !c.userName) { c.userName = c.userNick; }
                        if (!c.userName) c.userName = '';
                        if (!c.userPersona) c.userPersona = '';
                    });
                    if (await saveData()) { loadSettingsUI(); applyWallpaper(); applyAppIcons(); applyStatusBarVisibility(); await updateStorageDisplay(); showToast('ÂØºÂÖ•ÊàêÂäü', 'success'); }
                } catch(err) { showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message, 'error'); }
            };
            reader.readAsText(file); e.target.value = '';
        }

        async function clearAllData() {
            if (confirm('Á°ÆÂÆöÊ∏ÖÈô§ÊâÄÊúâÔºü')) {
                try { await clearIDBStore('appData'); await clearIDBStore('images'); location.reload(); }
                catch (e) { indexedDB.deleteDatabase(DB_NAME); location.reload(); }
            }
        }

        function toggleSwitch(el) { el.classList.toggle('active'); }
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatTime(ts) { return new Date(ts).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); }
        function formatDate(ts) { const d = new Date(ts), today = new Date(), yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1); if (d.toDateString() === today.toDateString()) return '‰ªäÂ§©'; if (d.toDateString() === yesterday.toDateString()) return 'Êò®Â§©'; return d.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' }); }

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { const input = document.getElementById('chatInput'); if (document.activeElement === input && document.getElementById('chatPage').classList.contains('active')) { e.preventDefault(); sendMessage(); } }
            if (e.key === 'Escape') { ['createCharacterModal','createWorldbookModal','confirmDeleteModal','clearMessagesModal','cssPresetNameModal','cssGuideModal','entryEditModal','editMessageModal'].forEach(hideModal); hideContextMenu(); if (App.isSelectMode) exitSelectMode(); }
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); }); });
    </script>
</body>
</html>
```
