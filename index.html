
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ÂÖ≥ÈîÆPWAËÆæÁΩÆ - iOSÂÖ®Â±èÊ®°Âºè -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- iOS PWA Ê†∏ÂøÉÊ†áÁ≠æ - Ëøô‰∫õÊòØÂÆûÁé∞ÂÖ®Â±èÁöÑÂÖ≥ÈîÆ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AIÁü≠‰ø°">

    <!-- Android PWA ÊîØÊåÅ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">

    <!-- Windows ÊîØÊåÅ -->
    <meta name="msapplication-navbutton-color" content="#1a1a2e">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    <meta name="msapplication-starturl" content="./">

    <!-- Á¶ÅÁî®Ëá™Âä®Ê£ÄÊµã -->
    <meta name="format-detection" content="telephone=no">

    <!-- PWA Manifest - ÂÜÖËÅîÁâàÊú¨ -->
    <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22AI%E7%9F%AD%E4%BF%A1%E6%A8%A1%E6%8B%9F%E5%99%A8%22%2C%22short_name%22%3A%22AI%E7%9F%AD%E4%BF%A1%22%2C%22description%22%3A%22%E4%B8%8EAI%E8%A7%92%E8%89%B2%E8%81%8A%E5%A4%A9%22%2C%22start_url%22%3A%22.%2F%22%2C%22scope%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22orientation%22%3A%22portrait%22%2C%22background_color%22%3A%22%231a1a2e%22%2C%22theme_color%22%3A%22%231a1a2e%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%2520viewBox%3D'0%25200%2520512%2520512'%253E%253Crect%2520width%3D'512'%2520height%3D'512'%2520fill%3D'%252334c759'%2520rx%3D'100'%2F%253E%253Ctext%2520x%3D'50%2525'%2520y%3D'55%2525'%2520dominant-baseline%3D'middle'%2520text-anchor%3D'middle'%2520font-size%3D'280'%253E%25F0%259F%2592%25AC%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">

    <!-- iOS ÂõæÊ†á - Â§öÁßçÂ∞∫ÂØ∏ -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%2334c759' rx='40'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='100'%3Eüí¨%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 152 152'%3E%3Crect width='152' height='152' fill='%2334c759' rx='30'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='80'%3Eüí¨%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%2334c759' rx='40'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='100'%3Eüí¨%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="167x167" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 167 167'%3E%3Crect width='167' height='167' fill='%2334c759' rx='35'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='90'%3Eüí¨%3C/text%3E%3C/svg%3E">

    <!-- iOS ÂêØÂä®ÁîªÈù¢È¢úËâ≤ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Èò≤Ê≠¢iOS SafariËá™Âä®Ë∞ÉÊï¥Â≠ó‰ΩìÂ§ßÂ∞è -->
    <style>html { -webkit-text-size-adjust: 100%; }</style>

    <title>AIÁü≠‰ø°Ê®°ÊãüÂô® v5.0</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-bg-dark: rgba(0, 0, 0, 0.4);
            --glass-border: rgba(255, 255, 255, 0.18);
            --blur-amount: 20px;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent-color: #007AFF;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --message-sent: #007AFF;
            --message-received: rgba(255, 255, 255, 0.15);
            --transition-smooth: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
            /* Èò≤Ê≠¢iOSÊñáÊú¨Â§ßÂ∞èËá™Âä®Ë∞ÉÊï¥ */
            -webkit-text-size-adjust: 100%;
        }

        body {
            height: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: #000;
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            /* Èò≤Ê≠¢ÈÄâÊã©ÊñáÊú¨ */
            -webkit-user-select: none;
            user-select: none;
            /* Âº∫Âà∂GPUÂä†ÈÄü */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        /* ÂÖÅËÆ∏ËæìÂÖ•Ê°ÜÈÄâÊã©ÊñáÊú¨ */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        #wallpaperLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-color: #1a1a2e;
        }

        .phone-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
            z-index: 1;
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: calc(44px + var(--safe-top));
            padding-top: var(--safe-top);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: calc(24px + var(--safe-left));
            padding-right: calc(24px + var(--safe-right));
            z-index: 1000;
        }

        .status-bar.hidden {
            display: none !important;
        }

        .status-bar-time {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-bar-icons {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .status-bar-icons svg {
            width: 16px;
            height: 16px;
            fill: var(--text-primary);
        }

        .home-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding-top: calc(80px + var(--safe-top));
            padding-bottom: calc(80px + var(--safe-bottom));
            padding-left: calc(20px + var(--safe-left));
            padding-right: calc(20px + var(--safe-right));
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
            z-index: 1;
            -webkit-overflow-scrolling: touch;
        }

        .home-screen.no-statusbar {
            padding-top: calc(40px + var(--safe-top));
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            justify-items: center;
        }

        .app-icon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .app-icon-wrapper:active {
            transform: scale(0.92);
        }

        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: var(--transition-smooth);
            overflow: hidden;
        }

        .app-icon.settings { background: linear-gradient(135deg, #8e8e93, #636366); }
        .app-icon.messages { background: linear-gradient(135deg, #34c759, #30b350); }
        .app-icon.worldbook { background: linear-gradient(135deg, #ff9500, #ff6b00); }
        .app-icon.photos { background: linear-gradient(135deg, #ff2d55, #ff375f); }

        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-icon-label {
            font-size: 11px;
            color: var(--text-primary);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .home-indicator {
            position: absolute;
            bottom: calc(8px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 2px;
            z-index: 1001;
        }

        .page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: var(--glass-bg-dark);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page.active {
            transform: translateX(0);
        }

        .page.slide-from-bottom {
            transform: translateY(100%);
        }

        .page.slide-from-bottom.active {
            transform: translateY(0);
        }

        .page#chatPage {
            background: var(--glass-bg-dark);
        }

        .page#chatPage.has-custom-bg {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: calc(8px + var(--safe-top));
            padding-bottom: 8px;
            padding-left: calc(12px + var(--safe-left));
            padding-right: calc(12px + var(--safe-right));
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
            min-height: calc(44px + var(--safe-top));
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 15px;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            min-width: 50px;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .nav-btn.right { justify-content: flex-end; }

        .nav-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            flex: 1;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            padding-bottom: calc(12px + var(--safe-bottom));
            padding-left: calc(12px + var(--safe-left));
            padding-right: calc(12px + var(--safe-right));
            -webkit-overflow-scrolling: touch;
        }

        .settings-group {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 14px;
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .settings-group-title {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 12px 4px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .settings-item:last-child { border-bottom: none; }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-icon {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .settings-icon.blue { background: var(--accent-color); }
        .settings-icon.green { background: var(--success-color); }
        .settings-icon.red { background: var(--danger-color); }
        .settings-icon.orange { background: #FF9500; }
        .settings-icon.purple { background: #AF52DE; }
        .settings-icon.cyan { background: #5AC8FA; }
        .settings-icon.gray { background: #8e8e93; }
        .settings-icon.pink { background: #FF2D55; }
        .settings-icon.teal { background: #30B0C7; }

        .settings-item-label { color: var(--text-primary); font-size: 14px; }
        .settings-item-desc { color: var(--text-secondary); font-size: 11px; margin-top: 1px; }

        .input-group { margin-bottom: 14px; }

        .input-label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .input-field:focus { border-color: var(--accent-color); }
        .input-field::placeholder { color: rgba(255, 255, 255, 0.3); }

        textarea.input-field {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.4;
        }

        textarea.css-editor {
            min-height: 150px;
            font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.4);
            color: #00ff88;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 12px 18px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
            -webkit-appearance: none;
        }

        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; }

        .btn-primary { background: var(--accent-color); color: white; }
        .btn-secondary { background: var(--glass-bg); color: var(--accent-color); border: 1px solid var(--glass-border); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }

        .btn-small {
            padding: 8px 14px;
            font-size: 13px;
        }

        .btn-stack { display: flex; flex-direction: column; gap: 6px; }

        .btn-row {
            display: flex;
            gap: 6px;
        }

        .btn-row .btn {
            flex: 1;
        }

        .contact-list { display: flex; flex-direction: column; }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--glass-bg);
            border-radius: 12px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 1px solid var(--glass-border);
            -webkit-tap-highlight-color: transparent;
        }

        .contact-avatar {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .contact-info { flex: 1; min-width: 0; }

        .contact-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .contact-preview {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-time {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-state-icon { font-size: 48px; margin-bottom: 14px; opacity: 0.5; }
        .empty-state-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .empty-state-desc { font-size: 13px; color: var(--text-secondary); }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            padding-left: calc(10px + var(--safe-left));
            padding-right: calc(10px + var(--safe-right));
            display: flex;
            flex-direction: column;
            gap: 3px;
            -webkit-overflow-scrolling: touch;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 5px;
            margin-bottom: 1px;
        }

        .message-wrapper.sent { justify-content: flex-end; }
        .message-wrapper.received { justify-content: flex-start; }

        .message-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .message-avatar.square { border-radius: 5px; }
        .message-avatar.rounded-square { border-radius: 7px; }
        .message-avatar.hidden { display: none; }

        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .message {
            max-width: 75%;
            padding: 7px 11px;
            font-size: 14px;
            line-height: 1.35;
            word-wrap: break-word;
            animation: msgIn 0.2s ease-out;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(6px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message.sent {
            background: var(--message-sent);
            color: white;
            border-radius: 16px 16px 4px 16px;
        }

        .message.received {
            background: var(--message-received);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text-primary);
            border-radius: 16px 16px 16px 4px;
        }

        .message-time {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 2px;
        }

        .message-time.time-hidden { display: none; }
        .message-time.time-side { position: absolute; bottom: 4px; right: -40px; margin-top: 0; }
        .message-wrapper.sent .message-time.time-side { right: auto; left: -40px; }

        .message-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.4);
            background: transparent;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .message-checkbox.checked {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .message-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 10px;
        }

        .chat-messages.select-mode .message-checkbox { display: flex; }

        .typing-indicator {
            display: inline-flex;
            gap: 3px;
            padding: 9px 12px;
            background: var(--message-received);
            border-radius: 16px 16px 16px 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 5px;
            height: 5px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            gap: 5px;
            padding: 6px 10px;
            padding-bottom: calc(6px + var(--safe-bottom));
            padding-left: calc(10px + var(--safe-left));
            padding-right: calc(10px + var(--safe-right));
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .chat-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .chat-btn:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-btn.send { background: var(--accent-color); }
        .chat-btn.ai { background: linear-gradient(135deg, #a855f7, #ec4899); }
        .chat-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .chat-input-field {
            flex: 1;
            min-height: 34px;
            max-height: 90px;
            padding: 7px 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 17px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
            -webkit-appearance: none;
        }

        .chat-input-field::placeholder { color: rgba(255, 255, 255, 0.4); }

        .extension-panel {
            position: absolute;
            bottom: calc(60px + var(--safe-bottom));
            left: calc(10px + var(--safe-left));
            right: calc(10px + var(--safe-right));
            background: rgba(30, 30, 35, 0.95);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 14px;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateY(12px);
            transition: all 0.25s ease;
        }

        .extension-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .extension-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .extension-panel-title { font-size: 15px; font-weight: 600; color: var(--text-primary); }

        .extension-panel-close {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .extension-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 6px;
            -webkit-tap-highlight-color: transparent;
        }

        .extension-btn:last-child { margin-bottom: 0; }

        .extension-btn-icon {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .extension-btn-icon.danger { background: rgba(255, 59, 48, 0.2); }
        .extension-btn-icon.purple { background: rgba(175, 82, 222, 0.2); }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            padding: 20px;
            padding-left: calc(20px + var(--safe-left));
            padding-right: calc(20px + var(--safe-right));
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            width: 100%;
            max-width: 340px;
            max-height: 80vh;
            overflow-y: auto;
            background: rgba(30, 30, 35, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.92);
            transition: transform 0.25s ease;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 14px;
        }

        .modal-body {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            margin-bottom: 12px;
            -webkit-appearance: none;
        }

        .modal-btns { display: flex; gap: 8px; }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-btn.cancel { background: rgba(255, 255, 255, 0.12); color: var(--text-primary); }
        .modal-btn.confirm { background: var(--accent-color); color: white; }

        .toast-container {
            position: fixed;
            top: calc(60px + var(--safe-top));
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 6px;
            pointer-events: none;
        }

        .toast {
            padding: 10px 18px;
            background: rgba(30, 30, 35, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }

        .toast.success { border-left: 3px solid var(--success-color); }
        .toast.error { border-left: 3px solid var(--danger-color); }
        .toast.info { border-left: 3px solid var(--accent-color); }
        .toast.warning { border-left: 3px solid var(--warning-color); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .search-field {
            width: 100%;
            padding: 9px 12px 9px 36px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
            -webkit-appearance: none;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 26px;
            background: rgba(120, 120, 128, 0.32);
            border-radius: 13px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .toggle-switch.active { background: var(--success-color); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toggle-switch.active::after { left: 20px; }

        .select-field {
            width: 100%;
            padding: 10px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='rgba(255,255,255,0.5)'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .select-field option { background: #1a1a2e; }

        .file-input-hidden { display: none; }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            margin: 14px 0;
        }

        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .slider-container { margin: 12px 0; }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .slider-label { font-size: 13px; color: var(--text-primary); }
        .slider-value { font-size: 13px; color: var(--accent-color); font-weight: 600; }

        .slider-input {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        .action-hint {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 7px 10px;
            background: rgba(0, 122, 255, 0.12);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .action-hint-icon { font-size: 13px; }
        .action-hint-text { font-size: 11px; color: var(--accent-color); }
        .action-hint.success { background: rgba(52, 199, 89, 0.12); }
        .action-hint.success .action-hint-text { color: var(--success-color); }
        .action-hint.warning { background: rgba(255, 149, 0, 0.12); }
        .action-hint.warning .action-hint-text { color: var(--warning-color); }

        .delete-zone {
            padding: 14px;
            border: 2px dashed var(--danger-color);
            border-radius: 12px;
            text-align: center;
            color: var(--danger-color);
            margin-top: 14px;
            cursor: pointer;
            font-size: 14px;
            -webkit-tap-highlight-color: transparent;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            max-height: 140px;
            overflow-y: auto;
            font-family: 'SF Mono', monospace;
            font-size: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .log-entry { padding: 2px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
        .log-entry.success { color: var(--success-color); }
        .log-entry.error { color: var(--danger-color); }
        .log-entry.info { color: var(--accent-color); }

        .model-list { max-height: 160px; overflow-y: auto; margin-top: 8px; -webkit-overflow-scrolling: touch; }

        .model-item {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .model-item:hover { background: rgba(255, 255, 255, 0.1); }
        .model-item.selected { background: var(--accent-color); }
        .model-item-name { font-size: 12px; color: var(--text-primary); }

        .date-separator {
            display: flex;
            justify-content: center;
            padding: 8px 0;
        }

        .date-separator-text {
            padding: 3px 9px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .select-mode-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            padding-left: calc(12px + var(--safe-left));
            padding-right: calc(12px + var(--safe-right));
            background: rgba(255, 59, 48, 0.12);
        }

        .select-mode-bar.active { display: flex; }

        .select-mode-info { font-size: 13px; color: var(--text-primary); }
        .select-mode-btns { display: flex; gap: 8px; }

        .select-mode-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .select-mode-btn.cancel { background: rgba(255, 255, 255, 0.15); color: var(--text-primary); }
        .select-mode-btn.delete { background: var(--danger-color); color: white; }

        .avatar-upload-area {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 2px dashed var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 auto 12px;
            font-size: 26px;
            color: var(--text-secondary);
            overflow: hidden;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .avatar-upload-area:hover { border-color: var(--accent-color); }
        .avatar-upload-area.has-image { border-style: solid; border-color: var(--accent-color); }
        .avatar-upload-area img { width: 100%; height: 100%; object-fit: cover; }

        .color-picker-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .color-picker-label { font-size: 12px; color: var(--text-primary); flex: 1; }

        .color-picker-input {
            width: 40px;
            height: 28px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: transparent;
            -webkit-appearance: none;
        }

        .shape-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .shape-option {
            padding: 6px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .shape-option.selected {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .worldbook-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .worldbook-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .worldbook-item-title { font-size: 15px; font-weight: 600; color: var(--text-primary); }

        .worldbook-item-badge {
            padding: 2px 7px;
            background: var(--accent-color);
            border-radius: 10px;
            font-size: 10px;
            color: white;
        }

        .worldbook-item-preview {
            font-size: 12px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .char-counter {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 2px;
        }

        .char-counter.warning { color: #FF9500; }
        .char-counter.error { color: var(--danger-color); }

        .wallpaper-preview {
            width: 100%;
            height: 120px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 2px solid var(--glass-border);
            overflow: hidden;
        }

        .icon-customize-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .icon-customize-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .icon-customize-preview {
            width: 50px;
            height: 50px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            border: 2px dashed var(--glass-border);
            overflow: hidden;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .icon-customize-preview:hover { border-color: var(--accent-color); }
        .icon-customize-preview.has-image { border-style: solid; }
        .icon-customize-preview img { width: 100%; height: 100%; object-fit: cover; }

        .icon-customize-label { font-size: 10px; color: var(--text-secondary); }

        .storage-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .storage-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .storage-size { font-size: 12px; color: var(--accent-color); }

        .storage-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .storage-bar-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .storage-bar-fill.warning { background: var(--warning-color); }
        .storage-bar-fill.danger { background: var(--danger-color); }

        .storage-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .preset-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
        }

        .preset-selector select {
            flex: 1;
        }

        .preset-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .preset-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .preset-btn:active { transform: scale(0.95); }

        .guide-content {
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .guide-section {
            margin-bottom: 14px;
        }

        .guide-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 6px;
        }

        .guide-code {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            padding: 8px;
            font-family: 'SF Mono', monospace;
            font-size: 11px;
            color: #00ff88;
            margin-bottom: 6px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .guide-text {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .chat-wallpaper-preview {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid var(--glass-border);
            background: var(--glass-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 12px;
            overflow: hidden;
        }

        .chat-wallpaper-preview.has-image {
            background-size: cover !important;
            background-position: center !important;
        }

        .chat-wallpaper-preview.has-image span {
            display: none;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.12); border-radius: 2px; }

        /* PWAÂÖ®Â±èÊ®°ÂºèÁâπÊÆäÂ§ÑÁêÜ */
        @media all and (display-mode: standalone) {
            .status-bar {
                /* Âú®standaloneÊ®°Âºè‰∏ãÂèØ‰ª•ÈÄâÊã©ÈöêËóèÊ®°ÊãüÁä∂ÊÄÅÊ†è */
            }
        }

        /* iOSÂÆâÂÖ®Âå∫ÂüüÊîØÊåÅ */
        @supports (padding: max(0px)) {
            .page-content {
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
        }

        #customCssStyles { }
    </style>
    <style id="customCssStyles"></style>
</head>
<body>
    <div id="wallpaperLayer"></div>

    <div class="phone-container">
        <div class="status-bar" id="statusBar">
            <span class="status-bar-time" id="statusBarTime">9:41</span>
            <div class="status-bar-icons">
                <svg viewBox="0 0 24 24"><path d="M12 3C7.46 3 3.34 4.78.29 7.67c-.18.18-.29.43-.29.71 0 .28.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73s3.15.25 4.6.73v3.1c0 .4.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71 0-.28-.11-.53-.29-.71C20.66 4.78 16.54 3 12 3z"/></svg>
                <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
            </div>
        </div>

        <div class="home-screen" id="homeScreen">
            <div class="app-grid" id="appGrid">
                <div class="app-icon-wrapper" onclick="openPage('settingsPage')">
                    <div class="app-icon settings" id="appIconSettings">‚öôÔ∏è</div>
                    <span class="app-icon-label">ËÆæÁΩÆ</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('messagesPage')">
                    <div class="app-icon messages" id="appIconMessages">üí¨</div>
                    <span class="app-icon-label">Áü≠‰ø°</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('worldbookPage')">
                    <div class="app-icon worldbook" id="appIconWorldbook">üìö</div>
                    <span class="app-icon-label">‰∏ñÁïå‰π¶</span>
                </div>
                <div class="app-icon-wrapper" onclick="openPage('wallpaperPage')">
                    <div class="app-icon photos" id="appIconPhotos">üñºÔ∏è</div>
                    <span class="app-icon-label">Â£ÅÁ∫∏</span>
                </div>
            </div>
        </div>

        <div class="home-indicator"></div>

        <!-- ËÆæÁΩÆÈ°µÈù¢ -->
        <div class="page" id="settingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('settingsPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    ËøîÂõû
                </button>
                <span class="nav-title">ËÆæÁΩÆ</span>
                <div class="nav-btn right" style="visibility:hidden">Âç†</div>
            </div>
            <div class="page-content">
                <div class="storage-card">
                    <div class="storage-header">
                        <span class="storage-title">üíæ Â≠òÂÇ®</span>
                        <span class="storage-size" id="storageSize">ËÆ°ÁÆó‰∏≠...</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div>
                    </div>
                    <div class="storage-details">
                        <span id="storageUsed">Â∑≤Áî®: 0 MB</span>
                        <span id="storageTotal">Êó†ÈôêÂà∂</span>
                    </div>
                </div>

                <p class="settings-group-title">APIÈÖçÁΩÆ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="action-hint" id="connectionStatusHint">
                        <span class="action-hint-icon">‚ö†Ô∏è</span>
                        <span class="action-hint-text">Êú™ÈÖçÁΩÆAPI</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label">APIÂú∞ÂùÄ</label>
                        <input type="text" class="input-field" id="apiBaseUrl" placeholder="https://api.example.com" autocomplete="off" autocorrect="off" autocapitalize="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">APIÂØÜÈí•</label>
                        <input type="password" class="input-field" id="apiKey" placeholder="sk-xxx" autocomplete="off">
                    </div>
                    <button class="btn btn-warning" onclick="fetchModels()" id="fetchModelsBtn">üìã ÊãâÂèñÊ®°Âûã</button>
                    <div id="modelListContainer" style="display:none">
                        <label class="input-label" style="margin-top:12px">ÂèØÁî®Ê®°Âûã</label>
                        <div class="model-list" id="modelList"></div>
                    </div>
                    <div class="input-group" style="margin-top:12px">
                        <label class="input-label">ÂΩìÂâçÊ®°Âûã</label>
                        <input type="text" class="input-field" id="modelName" placeholder="Ê®°ÂûãÂêçÁß∞" autocomplete="off">
                    </div>
                    <div class="btn-stack" style="margin-top:12px">
                        <button class="btn btn-secondary" onclick="testConnection()" id="testConnectionBtn">üîó ÊµãËØïËøûÊé•</button>
                        <button class="btn btn-primary" onclick="saveApiSettings()">üíæ ‰øùÂ≠òËÆæÁΩÆ</button>
                    </div>
                    <div class="divider"></div>
                    <label class="input-label">Ë∞ÉËØïÊó•Âøó</label>
                    <div class="log-container" id="debugLog"><div class="log-entry info">Á≠âÂæÖÊìç‰Ωú...</div></div>
                </div>

                <p class="settings-group-title">ÂØπËØùËÆæÁΩÆ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">ÊúÄÂ§ßËÆ∞ÂøÜÊù°Êï∞</label>
                        <input type="number" class="input-field" id="maxContextMessages" value="200" inputmode="numeric">
                    </div>
                </div>

                <p class="settings-group-title">Ê®°ÂûãÂèÇÊï∞</p>
                <div class="settings-group" style="padding:12px">
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Temperature</span>
                            <span class="slider-value" id="tempValue">0.7</span>
                        </div>
                        <input type="range" class="slider-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempValue').textContent=this.value">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Max Tokens</span>
                            <span class="slider-value" id="maxTokensValue">2048</span>
                        </div>
                        <input type="range" class="slider-input" id="maxTokens" min="256" max="8192" step="256" value="2048" oninput="document.getElementById('maxTokensValue').textContent=this.value">
                    </div>
                </div>

                <p class="settings-group-title">ÁºìÂ≠ò‰∏éÂ≠òÂÇ®</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="clearImageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon cyan">üßπ</span>
                            <div>
                                <span class="settings-item-label">Ê∏ÖÈô§ÂõæÁâáÁºìÂ≠ò</span>
                                <div class="settings-item-desc">Â§¥ÂÉè„ÄÅÂ£ÅÁ∫∏Á≠â</div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="clearMessageCache()">
                        <div class="settings-item-left">
                            <span class="settings-icon orange">üí¨</span>
                            <div>
                                <span class="settings-item-label">Ê∏ÖÈô§Ê∂àÊÅØÁºìÂ≠ò</span>
                                <div class="settings-item-desc">‰øùÁïôËßíËâ≤ËÆæÂÆö</div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="compactDatabase()">
                        <div class="settings-item-left">
                            <span class="settings-icon purple">‚ö°</span>
                            <div>
                                <span class="settings-item-label">‰ºòÂåñÂ≠òÂÇ®</span>
                                <div class="settings-item-desc">ÂéãÁº©ÂõæÁâá</div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="settings-group-title">Êï∞ÊçÆÁÆ°ÁêÜ</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="forceSaveAll()">
                        <div class="settings-item-left"><span class="settings-icon green">üíæ</span><span class="settings-item-label">Âº∫Âà∂‰øùÂ≠ò</span></div>
                    </div>
                    <div class="settings-item" onclick="exportAllData()">
                        <div class="settings-item-left"><span class="settings-icon blue">üì§</span><span class="settings-item-label">ÂØºÂá∫Êï∞ÊçÆ</span></div>
                    </div>
                    <div class="settings-item" onclick="document.getElementById('importFileInput').click()">
                        <div class="settings-item-left"><span class="settings-icon orange">üì•</span><span class="settings-item-label">ÂØºÂÖ•Êï∞ÊçÆ</span></div>
                    </div>
                    <input type="file" id="importFileInput" class="file-input-hidden" accept=".json" onchange="importData(event)">
                    <div class="settings-item" onclick="clearAllData()">
                        <div class="settings-item-left"><span class="settings-icon red">üóëÔ∏è</span><span class="settings-item-label">Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ</span></div>
                    </div>
                </div>

                <p class="settings-group-title">ÂÖ≥‰∫é</p>
                <div class="settings-group">
                    <div class="settings-item">
                        <div class="settings-item-left"><span class="settings-icon gray">üì±</span><span class="settings-item-label">ÁâàÊú¨</span></div>
                        <span style="color:var(--text-secondary);font-size:14px">5.0.0</span>
                    </div>
                    <div class="settings-item" id="pwaStatusItem">
                        <div class="settings-item-left">
                            <span class="settings-icon green">‚úÖ</span>
                            <div>
                                <span class="settings-item-label">PWAÁä∂ÊÄÅ</span>
                                <div class="settings-item-desc" id="pwaStatusDesc">Ê£ÄÊµã‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="height:30px"></div>
            </div>
        </div>

        <!-- Áü≠‰ø°ÂàóË°® -->
        <div class="page" id="messagesPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('messagesPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    ËøîÂõû
                </button>
                <span class="nav-title">Áü≠‰ø°</span>
                <button class="nav-btn right" onclick="showModal('createCharacterModal')">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
            <div style="padding:0 12px 10px">
                <input type="text" class="search-field" id="contactSearch" placeholder="ÊêúÁ¥¢ËßíËâ≤..." oninput="filterContacts()" autocomplete="off" autocorrect="off">
            </div>
            <div class="page-content" id="contactListContainer" style="padding-top:0">
                <div class="empty-state" id="emptyContactState">
                    <div class="empty-state-icon">üí¨</div>
                    <div class="empty-state-title">ÊöÇÊó†ËßíËâ≤</div>
                    <div class="empty-state-desc">ÁÇπÂáªÂè≥‰∏äËßí+ÂàõÂª∫</div>
                </div>
                <div class="contact-list" id="contactList" style="display:none"></div>
            </div>
        </div>

        <!-- ËÅäÂ§©È°µÈù¢ -->
        <div class="page" id="chatPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="openCharacterSettings()">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </button>
                <span class="nav-title" id="chatTitle">ËßíËâ≤Âêç</span>
                <button class="nav-btn right" onclick="closeChatPage()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="select-mode-bar" id="selectModeBar">
                <span class="select-mode-info">Â∑≤ÈÄâ <span id="selectedCount">0</span> Êù°</span>
                <div class="select-mode-btns">
                    <button class="select-mode-btn cancel" onclick="exitSelectMode()">ÂèñÊ∂à</button>
                    <button class="select-mode-btn delete" onclick="deleteSelectedMessages()">Âà†Èô§</button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="extension-panel" id="extensionPanel">
                    <div class="extension-panel-header">
                        <span class="extension-panel-title">Êìç‰Ωú</span>
                        <button class="extension-panel-close" onclick="toggleExtensionPanel()">√ó</button>
                    </div>
                    <button class="extension-btn" onclick="enterSelectMode()">
                        <div class="extension-btn-icon danger">üóëÔ∏è</div>
                        <span>ÈÄâÊã©Âà†Èô§</span>
                    </button>
                    <button class="extension-btn" onclick="regenerateLastReply()">
                        <div class="extension-btn-icon purple">üîÑ</div>
                        <span>ÈáçÊñ∞ÁîüÊàê</span>
                    </button>
                </div>
                <div class="chat-input-area">
                    <button class="chat-btn" onclick="toggleExtensionPanel()" title="Êõ¥Â§ö">
                        <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
                    </button>
                    <textarea class="chat-input-field" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" oninput="autoResizeTextarea(this)" autocomplete="off" autocorrect="off"></textarea>
                    <button class="chat-btn ai" onclick="triggerAIReply()" title="AIÂõûÂ§ç">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    </button>
                    <button class="chat-btn send" onclick="sendMessage()" title="ÂèëÈÄÅ">
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- ËßíËâ≤ËÆæÁΩÆÈ°µÈù¢ -->
        <div class="page slide-from-bottom" id="characterSettingsPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeCharacterSettings()">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    ÂèñÊ∂à
                </button>
                <span class="nav-title">ËßíËâ≤ËÆæÁΩÆ</span>
                <button class="nav-btn right" onclick="saveCharacterSettings()">‰øùÂ≠ò</button>
            </div>
            <div class="page-content">
                <p class="settings-group-title">ËÅäÂ§©ÁÆ°ÁêÜ</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="confirmClearAllMessages()">
                        <div class="settings-item-left">
                            <span class="settings-icon red">üóëÔ∏è</span>
                            <div>
                                <span class="settings-item-label">Ê∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï</span>
                                <div class="settings-item-desc">Âà†Èô§‰∏éÊ≠§ËßíËâ≤ÁöÑÂÖ®ÈÉ®Ê∂àÊÅØ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="settings-group-title">ËÅäÂ§©Á™óÂè£Â£ÅÁ∫∏</p>
                <div class="settings-group" style="padding:12px">
                    <div class="chat-wallpaper-preview" id="chatWallpaperPreview">
                        <span>Êó†Ëá™ÂÆö‰πâÂ£ÅÁ∫∏</span>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="document.getElementById('chatWallpaperInput').click()">üì§ ‰∏ä‰º†</button>
                        <button class="btn btn-secondary btn-small" onclick="clearChatWallpaper()">üóëÔ∏è Ê∏ÖÈô§</button>
                    </div>
                    <input type="file" id="chatWallpaperInput" class="file-input-hidden" accept="image/*" onchange="handleChatWallpaperUpload(event)">
                    <div class="input-group" style="margin-top:10px">
                        <label class="input-label">ÊàñËæìÂÖ•ÂõæÁâáURL</label>
                        <input type="text" class="input-field" id="chatWallpaperUrl" placeholder="https://..." autocomplete="off">
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="applyChatWallpaperUrl()">Â∫îÁî®URL</button>
                </div>

                <p class="settings-group-title">Â§¥ÂÉè</p>
                <div class="settings-group" style="padding:12px">
                    <label class="input-label">ËßíËâ≤Â§¥ÂÉè</label>
                    <div class="avatar-upload-area" id="charAvatarUpload" onclick="document.getElementById('charAvatarInput').click()">üì∑</div>
                    <input type="file" id="charAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleCharAvatarUpload(event)">

                    <label class="input-label" style="margin-top:12px">Áî®Êà∑Â§¥ÂÉè</label>
                    <div class="avatar-upload-area" id="userAvatarUpload" onclick="document.getElementById('userAvatarInput').click()">üë§</div>
                    <input type="file" id="userAvatarInput" class="file-input-hidden" accept="image/*" onchange="handleUserAvatarUpload(event)">
                </div>

                <p class="settings-group-title">Â§¥ÂÉèÊòæÁ§∫</p>
                <div class="settings-group" style="padding:12px">
                    <div class="settings-item" style="padding:0 0 10px 0">
                        <span class="settings-item-label">ÊòæÁ§∫Â§¥ÂÉè</span>
                        <div class="toggle-switch" id="showAvatarToggle" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÂΩ¢Áä∂</label>
                        <div class="shape-options" id="avatarShapeOptions">
                            <div class="shape-option selected" data-shape="circle" onclick="selectShape(this)">ÂúÜÂΩ¢</div>
                            <div class="shape-option" data-shape="square" onclick="selectShape(this)">ÊñπÂΩ¢</div>
                            <div class="shape-option" data-shape="rounded-square" onclick="selectShape(this)">ÂúÜËßí</div>
                        </div>
                    </div>
                    <div class="settings-item" style="padding:10px 0">
                        <span class="settings-item-label">ËæπÊ°Ü</span>
                        <div class="toggle-switch" id="showBorderToggle" onclick="toggleSwitch(this)"></div>
                    </div>
                    <div class="color-picker-row">
                        <span class="color-picker-label">ËæπÊ°ÜÈ¢úËâ≤</span>
                        <input type="color" class="color-picker-input" id="borderColorPicker" value="#007AFF">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">ËæπÊ°ÜÂÆΩÂ∫¶</span>
                            <span class="slider-value" id="borderWidthValue">2</span>
                        </div>
                        <input type="range" class="slider-input" id="borderWidthSlider" min="0" max="5" step="1" value="2" oninput="document.getElementById('borderWidthValue').textContent=this.value">
                    </div>
                </div>

                <p class="settings-group-title">Âü∫Êú¨‰ø°ÊÅØ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">ÂêçÁß∞</label>
                        <input type="text" class="input-field" id="charName" placeholder="ÂêçÁß∞" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Ë°®ÊÉÖ(Êó†ÂõæÊó∂)</label>
                        <input type="text" class="input-field" id="charAvatar" placeholder="üòä" autocomplete="off">
                    </div>
                </div>

                <p class="settings-group-title">ËÆæÂÆö</p>
                <div class="settings-group" style="padding:12px">
                    <textarea class="input-field" id="charDescription" rows="5" placeholder="ÊÄßÊ†º„ÄÅËÉåÊôØ..." autocomplete="off"></textarea>
                </div>

                <p class="settings-group-title">ÂºÄÂú∫ÁôΩ(300Â≠ó)</p>
                <div class="settings-group" style="padding:12px">
                    <textarea class="input-field" id="charGreeting" rows="2" maxlength="300" placeholder="Á¨¨‰∏ÄÊù°..." oninput="updateCharCounter()" autocomplete="off"></textarea>
                    <div class="char-counter" id="greetingCharCounter">0/300</div>
                </div>

                <p class="settings-group-title">ÊÉÖÊôØ</p>
                <div class="settings-group" style="padding:12px">
                    <textarea class="input-field" id="charScenario" rows="2" placeholder="Âú∫ÊôØ..." autocomplete="off"></textarea>
                </div>

                <p class="settings-group-title">ÁªëÂÆö‰∏ñÁïå‰π¶</p>
                <div class="settings-group" style="padding:12px">
                    <select class="select-field" id="charWorldbook">
                        <option value="">‰∏çÁªëÂÆö</option>
                    </select>
                </div>

                <p class="settings-group-title">È´òÁ∫ß</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">Áî®Êà∑Áß∞Âëº</label>
                        <input type="text" class="input-field" id="charUserNick" placeholder="‰∫≤Áà±ÁöÑ..." autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÊèêÁ§∫ËØç</label>
                        <textarea class="input-field" id="charSystemPrompt" rows="2" placeholder="È¢ùÂ§ñÊåá‰ª§..." autocomplete="off"></textarea>
                    </div>
                </div>

                <p class="settings-group-title">üé® Ëá™ÂÆö‰πâCSSÁæéÂåñ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="action-hint warning">
                        <span class="action-hint-icon">‚ö†Ô∏è</span>
                        <span class="action-hint-text">Ëá™ÂÆö‰πâCSS‰ºöË¶ÜÁõñ‰∏äÊñπÁöÑÂ§¥ÂÉèËÆæÁΩÆ</span>
                    </div>

                    <div class="input-group">
                        <label class="input-label">CSSÈ¢ÑËÆæ</label>
                        <div class="preset-selector">
                            <select class="select-field" id="cssPresetSelect" onchange="loadCssPreset()">
                                <option value="">-- Êó†È¢ÑËÆæ --</option>
                            </select>
                            <button class="preset-btn" onclick="addNewCssPreset()" title="Êñ∞Âª∫È¢ÑËÆæ">Ôºã</button>
                            <button class="preset-btn" onclick="saveCssPreset()" title="‰øùÂ≠òÈ¢ÑËÆæ">üíæ</button>
                            <button class="preset-btn" onclick="showCssGuide()" title="CSSÊåáÂçó">‚ùì</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Ê∂àÊÅØÊó∂Èó¥Êà≥</label>
                        <select class="select-field" id="timestampPosition">
                            <option value="default">ÈªòËÆ§(Ê∞îÊ≥°ÂÜÖÂ∫ïÈÉ®)</option>
                            <option value="hidden">ÈöêËóè</option>
                            <option value="side">Ê∞îÊ≥°ÊóÅËæπ</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Ëá™ÂÆö‰πâCSS‰ª£Á†Å</label>
                        <textarea class="input-field css-editor" id="customCssEditor" rows="8" placeholder="/* Âú®Ê≠§ËæìÂÖ•Ëá™ÂÆö‰πâCSS */&#10;&#10;.message.sent {&#10;  background: #yourcolor;&#10;}" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                    </div>

                    <div class="btn-row">
                        <button class="btn btn-secondary btn-small" onclick="previewCss()">üëÅÔ∏è È¢ÑËßà</button>
                        <button class="btn btn-danger btn-small" onclick="clearCustomCss()">üóëÔ∏è Ê∏ÖÈô§CSS</button>
                    </div>
                </div>

                <div class="delete-zone" onclick="deleteCurrentCharacter()">üóëÔ∏è Âà†Èô§ËßíËâ≤</div>
                <div style="height:30px"></div>
            </div>
        </div>

        <!-- ‰∏ñÁïå‰π¶È°µÈù¢ -->
        <div class="page" id="worldbookPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('worldbookPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    ËøîÂõû
                </button>
                <span class="nav-title">‰∏ñÁïå‰π¶</span>
                <button class="nav-btn right" onclick="showModal('createWorldbookModal')">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
            <div class="page-content">
                <div class="action-hint">
                    <span class="action-hint-icon">üìö</span>
                    <span class="action-hint-text">È¢ùÂ§ñÁü•ËØÜÂ∫ì</span>
                </div>
                <div class="empty-state" id="emptyWorldbookState">
                    <div class="empty-state-icon">üìö</div>
                    <div class="empty-state-title">ÊöÇÊó†‰∏ñÁïå‰π¶</div>
                    <div class="empty-state-desc">ÁÇπÂáª+ÂàõÂª∫</div>
                </div>
                <div id="worldbookList" style="display:none"></div>
            </div>
        </div>

        <!-- ‰∏ñÁïå‰π¶ÁºñËæë -->
        <div class="page slide-from-bottom" id="worldbookEditPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closeWorldbookEdit()">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    ÂèñÊ∂à
                </button>
                <span class="nav-title">ÁºñËæë</span>
                <button class="nav-btn right" onclick="saveWorldbook()">‰øùÂ≠ò</button>
            </div>
            <div class="page-content">
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">ÂêçÁß∞</label>
                        <input type="text" class="input-field" id="worldbookName" placeholder="ÂêçÁß∞" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÁÆÄ‰ªã</label>
                        <textarea class="input-field" id="worldbookSummary" rows="2" placeholder="ÁÆÄ‰ªã..." autocomplete="off"></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÂÖ≥ÈîÆËØç(ÈÄóÂè∑ÂàÜÈöî)</label>
                        <input type="text" class="input-field" id="worldbookKeywords" placeholder="ËØç1,ËØç2..." autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÂÜÖÂÆπ</label>
                        <textarea class="input-field" id="worldbookContent" rows="5" placeholder="ÂÜÖÂÆπ..." autocomplete="off"></textarea>
                    </div>
                    <div class="settings-item" style="padding:10px 0">
                        <span class="settings-item-label">ÂßãÁªàÊøÄÊ¥ª</span>
                        <div class="toggle-switch" id="worldbookAlwaysActive" onclick="toggleSwitch(this)"></div>
                    </div>
                </div>
                <div class="delete-zone" onclick="deleteCurrentWorldbook()">üóëÔ∏è Âà†Èô§</div>
                <div style="height:30px"></div>
            </div>
        </div>

        <!-- Â£ÅÁ∫∏È°µÈù¢ -->
        <div class="page" id="wallpaperPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="closePage('wallpaperPage')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    ËøîÂõû
                </button>
                <span class="nav-title">Â£ÅÁ∫∏‰∏éÂõæÊ†á</span>
                <div class="nav-btn right" style="visibility:hidden">Âç†</div>
            </div>
            <div class="page-content">
                <p class="settings-group-title">ÊòæÁ§∫ËÆæÁΩÆ</p>
                <div class="settings-group">
                    <div class="settings-item" onclick="toggleStatusBar()">
                        <div class="settings-item-left">
                            <span class="settings-icon gray">üì±</span>
                            <div>
                                <span class="settings-item-label">ÈöêËóèÊ®°ÊãüÊó∂Èó¥Ê†è</span>
                                <div class="settings-item-desc">ÂÖ®Â±èÊó∂ÈÅøÂÖç‰∏éÁ≥ªÁªüÊ†èÈáçÂè†</div>
                            </div>
                        </div>
                        <div class="toggle-switch" id="hideStatusBarToggle"></div>
                    </div>
                </div>

                <p class="settings-group-title">È¢ÑËßà</p>
                <div class="wallpaper-preview" id="wallpaperPreview"></div>

                <p class="settings-group-title">È¢ÑËÆæÂ£ÅÁ∫∏</p>
                <div class="settings-group" style="padding:12px">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px" id="wallpaperGrid">
                        <div onclick="selectPresetWallpaper('gradient1')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);cursor:pointer;border:2px solid transparent" data-wp="gradient1"></div>
                        <div onclick="selectPresetWallpaper('gradient2')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#2d1b69,#11998e);cursor:pointer;border:2px solid transparent" data-wp="gradient2"></div>
                        <div onclick="selectPresetWallpaper('gradient3')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);cursor:pointer;border:2px solid transparent" data-wp="gradient3"></div>
                        <div onclick="selectPresetWallpaper('gradient4')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#141e30,#243b55);cursor:pointer;border:2px solid transparent" data-wp="gradient4"></div>
                        <div onclick="selectPresetWallpaper('gradient5')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#232526,#414345);cursor:pointer;border:2px solid transparent" data-wp="gradient5"></div>
                        <div onclick="selectPresetWallpaper('gradient6')" style="height:60px;border-radius:8px;background:linear-gradient(135deg,#1f1c2c,#928dab);cursor:pointer;border:2px solid transparent" data-wp="gradient6"></div>
                    </div>
                </div>

                <p class="settings-group-title">Ëá™ÂÆö‰πâ</p>
                <div class="settings-group" style="padding:12px">
                    <div class="input-group">
                        <label class="input-label">ÂõæÁâáURL</label>
                        <input type="text" class="input-field" id="customWallpaperUrl" placeholder="https://..." autocomplete="off">
                    </div>
                    <button class="btn btn-secondary" onclick="previewUrlWallpaper()">È¢ÑËßà</button>
                    <div class="divider"></div>
                    <button class="btn btn-secondary" onclick="document.getElementById('wallpaperUpload').click()">üì§ ‰∏ä‰º†ÂõæÁâá</button>
                    <input type="file" id="wallpaperUpload" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
                </div>

                <button class="btn btn-success" onclick="saveWallpaper()" style="margin-bottom:16px">üíæ ‰øùÂ≠òÂ£ÅÁ∫∏</button>

                <p class="settings-group-title">ÂõæÊ†á</p>
                <div class="settings-group" style="padding:12px">
                    <div class="icon-customize-grid">
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewSettings" onclick="document.getElementById('iconInputSettings').click()">‚öôÔ∏è</div>
                            <span class="icon-customize-label">ËÆæÁΩÆ</span>
                            <input type="file" id="iconInputSettings" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'settings')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewMessages" onclick="document.getElementById('iconInputMessages').click()">üí¨</div>
                            <span class="icon-customize-label">Áü≠‰ø°</span>
                            <input type="file" id="iconInputMessages" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'messages')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewWorldbook" onclick="document.getElementById('iconInputWorldbook').click()">üìö</div>
                            <span class="icon-customize-label">‰∏ñÁïå‰π¶</span>
                            <input type="file" id="iconInputWorldbook" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'worldbook')">
                        </div>
                        <div class="icon-customize-item">
                            <div class="icon-customize-preview" id="iconPreviewPhotos" onclick="document.getElementById('iconInputPhotos').click()">üñºÔ∏è</div>
                            <span class="icon-customize-label">Â£ÅÁ∫∏</span>
                            <input type="file" id="iconInputPhotos" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event,'photos')">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <button class="btn btn-primary" onclick="saveIcons()">üíæ ‰øùÂ≠òÂõæÊ†á</button>
                    <div style="height:6px"></div>
                    <button class="btn btn-secondary" onclick="resetIcons()">üîÑ ÈáçÁΩÆ</button>
                </div>
                <div style="height:30px"></div>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="createCharacterModal">
        <div class="modal">
            <div class="modal-title">ÂàõÂª∫ËßíËâ≤</div>
            <input type="text" class="modal-input" id="newCharacterName" placeholder="ËßíËâ≤ÂêçÁß∞..." autocomplete="off">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createCharacterModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="createCharacter()">ÂàõÂª∫</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createWorldbookModal">
        <div class="modal">
            <div class="modal-title">ÂàõÂª∫‰∏ñÁïå‰π¶</div>
            <input type="text" class="modal-input" id="newWorldbookName" placeholder="ÂêçÁß∞..." autocomplete="off">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('createWorldbookModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="createWorldbook()">ÂàõÂª∫</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal">
            <div class="modal-title" id="deleteModalTitle">Á°ÆËÆ§Âà†Èô§Ôºü</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:14px;font-size:13px" id="deleteModalDesc">Êó†Ê≥ïÊí§ÈîÄ</p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('confirmDeleteModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" style="background:var(--danger-color)" onclick="confirmDelete()">Âà†Èô§</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="clearMessagesModal">
        <div class="modal">
            <div class="modal-title">‚ö†Ô∏è Ê∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï</div>
            <p style="color:var(--text-secondary);text-align:center;margin-bottom:14px;font-size:13px">
                Á°ÆÂÆöË¶ÅÂà†Èô§‰∏éÊ≠§ËßíËâ≤ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü<br>Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ
            </p>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('clearMessagesModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" style="background:var(--danger-color)" onclick="executeClearAllMessages()">Á°ÆËÆ§Âà†Èô§</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cssPresetNameModal">
        <div class="modal">
            <div class="modal-title">Êñ∞Âª∫CSSÈ¢ÑËÆæ</div>
            <input type="text" class="modal-input" id="newCssPresetName" placeholder="È¢ÑËÆæÂêçÁß∞..." autocomplete="off">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideModal('cssPresetNameModal')">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="createCssPreset()">ÂàõÂª∫</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cssGuideModal">
        <div class="modal" style="max-width:380px">
            <div class="modal-title">üìñ CSSËá™ÂÆö‰πâÊåáÂçó</div>
            <div class="guide-content">
                <div class="guide-section">
                    <div class="guide-section-title">üí¨ Ê∂àÊÅØÊ∞îÊ≥°</div>
                    <div class="guide-code">.message.sent { }<br>.message.received { }</div>
                    <div class="guide-text">sent=ÂèëÈÄÅÁöÑÊ∂àÊÅØ, received=Êî∂Âà∞ÁöÑÊ∂àÊÅØ</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üë§ Â§¥ÂÉè</div>
                    <div class="guide-code">.message-avatar { }<br>.message-wrapper.sent .message-avatar { }<br>.message-wrapper.received .message-avatar { }</div>
                    <div class="guide-text">ÂèØÂàÜÂà´ËÆæÁΩÆÂèëÈÄÅÊñπÂíåÊé•Êî∂ÊñπÂ§¥ÂÉè</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">‚è∞ Êó∂Èó¥Êà≥</div>
                    <div class="guide-code">.message-time { }</div>
                    <div class="guide-text">Ê∂àÊÅØ‰∏ãÊñπÁöÑÊó∂Èó¥ÊòæÁ§∫</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üìù ËæìÂÖ•Âå∫Âüü</div>
                    <div class="guide-code">.chat-input-area { }<br>.chat-input-field { }<br>.chat-btn { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üîù È°∂Ê†è</div>
                    <div class="guide-code">#chatPage .nav-bar { }<br>.nav-title { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üì¶ Ê∂àÊÅØÂÆπÂô®</div>
                    <div class="guide-code">.chat-messages { }<br>.message-wrapper { }</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üé® Â∏∏Áî®Â±ûÊÄß</div>
                    <div class="guide-code">background: #Ëâ≤ÂÄº;<br>color: #ÊñáÂ≠óËâ≤;<br>border-radius: ÂúÜËßípx;<br>padding: ÂÜÖËæπË∑ù;<br>border: ËæπÊ°Ü;<br>box-shadow: Èò¥ÂΩ±;</div>
                </div>
                <div class="guide-section">
                    <div class="guide-section-title">üí° Á§∫‰æã</div>
                    <div class="guide-code">/* Á≤âËâ≤Ê∞îÊ≥° */<br>.message.sent {<br>  background: linear-gradient(135deg, #ff6b9d, #c44569);<br>  border-radius: 20px;<br>}<br><br>/* ÂúÜÂΩ¢Â§ßÂ§¥ÂÉè */<br>.message-avatar {<br>  width: 40px;<br>  height: 40px;<br>  border: 2px solid gold;<br>}</div>
                </div>
            </div>
            <div class="modal-btns" style="margin-top:14px">
                <button class="modal-btn confirm" onclick="hideModal('cssGuideModal')">Áü•ÈÅì‰∫Ü</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ==================== PWA Ê£ÄÊµã ====================
        function checkPWAStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            const statusDesc = document.getElementById('pwaStatusDesc');
            const statusItem = document.getElementById('pwaStatusItem');

            if (isStandalone) {
                statusDesc.textContent = 'Â∑≤Âú®ÂÖ®Â±èÊ®°ÂºèËøêË°å ‚úÖ';
                statusItem.querySelector('.settings-icon').textContent = '‚úÖ';
            } else {
                statusDesc.textContent = 'ËØ∑Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï‰ª•ÂÖ®Â±èËøêË°å';
                statusItem.querySelector('.settings-icon').textContent = 'üì±';
                statusItem.querySelector('.settings-icon').classList.remove('green');
                statusItem.querySelector('.settings-icon').classList.add('gray');
            }
        }

        // ==================== IndexedDB ====================
        const DB_NAME = 'SMSAppDB';
        const DB_VERSION = 2;
        let db = null;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('appData')) database.createObjectStore('appData', { keyPath: 'key' });
                    if (!database.objectStoreNames.contains('images')) database.createObjectStore('images', { keyPath: 'id' });
                };
            });
        }

        function saveToIDB(storeName, key, value) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DBÊú™ÊâìÂºÄ'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                store.put(storeName === 'appData' ? { key, value } : { id: key, data: value });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        function loadFromIDB(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DBÊú™ÊâìÂºÄ'); return; }
                const tx = db.transaction([storeName], 'readonly');
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result ? (storeName === 'appData' ? req.result.value : req.result.data) : null);
                req.onerror = () => reject(req.error);
            });
        }

        function clearIDBStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) { reject('DBÊú™ÊâìÂºÄ'); return; }
                const tx = db.transaction([storeName], 'readwrite');
                tx.objectStore(storeName).clear();
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function getStorageUsage() {
            try {
                if (navigator.storage?.estimate) {
                    const est = await navigator.storage.estimate();
                    return { used: est.usage || 0, quota: est.quota || 0, percent: est.quota ? (est.usage / est.quota * 100) : 0 };
                }
            } catch (e) {}
            return { used: 0, quota: 0, percent: 0 };
        }

        // ==================== ÂÖ®Â±ÄÁä∂ÊÄÅ ====================
        const App = {
            characters: [], worldbooks: [], currentCharId: null, currentWbId: null,
            pendingDeleteType: null, pendingDeleteId: null, models: [],
            connectionStatus: 'disconnected', isSelectMode: false, selectedMsgs: new Set(),
            lastAIStart: -1, tempWallpaper: null, tempIcons: {},
            appIcons: { settings: null, messages: null, worldbook: null, photos: null },
            defaultEmojis: { settings: '‚öôÔ∏è', messages: 'üí¨', worldbook: 'üìö', photos: 'üñºÔ∏è' },
            settings: {
                apiBaseUrl: '', apiKey: '', modelName: '', temperature: 0.7, maxTokens: 2048,
                maxContextMessages: 200, wallpaper: 'gradient1', wallpaperData: null, hideStatusBar: false
            },
            globalCssPresets: [],
            dataLoaded: false
        };

        const GRADIENTS = {
            gradient1: 'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)',
            gradient2: 'linear-gradient(135deg, #2d1b69, #11998e)',
            gradient3: 'linear-gradient(135deg, #0f0c29, #302b63, #24243e)',
            gradient4: 'linear-gradient(135deg, #141e30, #243b55)',
            gradient5: 'linear-gradient(135deg, #232526, #414345)',
            gradient6: 'linear-gradient(135deg, #1f1c2c, #928dab)'
        };

        // ==================== ÂàùÂßãÂåñ ====================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadData();
                updateTime();
                setInterval(updateTime, 60000);
                applyWallpaper();
                applyAppIcons();
                applyStatusBarVisibility();
                updateConnectionUI();
                highlightWallpaper();
                updateWallpaperPreview();
                updateIconPreviews();
                updateStorageDisplay();
                checkPWAStatus();
            } catch (e) {
                console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', e);
                showToast('ÂàùÂßãÂåñÂ§±Ë¥•', 'error');
            }
        });

        async function updateStorageDisplay() {
            const usage = await getStorageUsage();
            const usedMB = (usage.used / (1024 * 1024)).toFixed(2);
            document.getElementById('storageSize').textContent = `${usedMB} MB`;
            document.getElementById('storageUsed').textContent = `Â∑≤Áî®: ${usedMB} MB`;
            document.getElementById('storageTotal').textContent = usage.quota > 0 ? `ÈÖçÈ¢ù: ${(usage.quota / (1024 * 1024)).toFixed(0)} MB` : 'Êó†ÈôêÂà∂';
            const barFill = document.getElementById('storageBarFill');
            barFill.style.width = `${Math.min(usage.percent, 100)}%`;
            barFill.className = 'storage-bar-fill' + (usage.percent > 80 ? ' danger' : usage.percent > 60 ? ' warning' : '');
        }

        function updateTime() {
            document.getElementById('statusBarTime').textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        function toggleStatusBar() {
            App.settings.hideStatusBar = !App.settings.hideStatusBar;
            applyStatusBarVisibility();
            saveData();
        }

        function applyStatusBarVisibility() {
            const statusBar = document.getElementById('statusBar');
            const homeScreen = document.getElementById('homeScreen');
            const toggle = document.getElementById('hideStatusBarToggle');
            if (App.settings.hideStatusBar) {
                statusBar.classList.add('hidden');
                homeScreen.classList.add('no-statusbar');
                toggle?.classList.add('active');
            } else {
                statusBar.classList.remove('hidden');
                homeScreen.classList.remove('no-statusbar');
                toggle?.classList.remove('active');
            }
        }

        // ==================== Êï∞ÊçÆÊåÅ‰πÖÂåñ ====================
        async function saveData() {
            try {
                await Promise.all([
                    saveToIDB('appData', 'characters', App.characters),
                    saveToIDB('appData', 'worldbooks', App.worldbooks),
                    saveToIDB('appData', 'settings', App.settings),
                    saveToIDB('appData', 'appIcons', App.appIcons),
                    saveToIDB('appData', 'globalCssPresets', App.globalCssPresets)
                ]);
                return true;
            } catch (e) { console.error('‰øùÂ≠òÂ§±Ë¥•:', e); return false; }
        }

        async function loadData() {
            try {
                const [characters, worldbooks, settings, icons, presets] = await Promise.all([
                    loadFromIDB('appData', 'characters'),
                    loadFromIDB('appData', 'worldbooks'),
                    loadFromIDB('appData', 'settings'),
                    loadFromIDB('appData', 'appIcons'),
                    loadFromIDB('appData', 'globalCssPresets')
                ]);
                if (characters) App.characters = characters;
                if (worldbooks) App.worldbooks = worldbooks;
                if (settings) App.settings = { ...App.settings, ...settings };
                if (icons) App.appIcons = { ...App.appIcons, ...icons };
                if (presets) App.globalCssPresets = presets;
                loadSettingsUI();
                if (App.settings.apiBaseUrl && App.settings.apiKey && App.settings.modelName) App.connectionStatus = 'connected';
                App.dataLoaded = true;
                return true;
            } catch (e) { console.error('Âä†ËΩΩÂ§±Ë¥•:', e); return false; }
        }

        async function forceSaveAll() { if (await saveData()) { await updateStorageDisplay(); showToast('Â∑≤‰øùÂ≠ò', 'success'); } }

        async function clearImageCache() {
            if (!confirm('Á°ÆÂÆöÊ∏ÖÈô§ÂõæÁâáÁºìÂ≠òÔºü')) return;
            App.settings.wallpaperData = null; App.settings.wallpaper = 'gradient1';
            App.appIcons = { settings: null, messages: null, worldbook: null, photos: null };
            App.characters.forEach(c => { c.avatarImage = null; c.userAvatar = null; c.chatWallpaper = null; });
            await saveData(); applyWallpaper(); applyAppIcons(); updateIconPreviews(); await updateStorageDisplay();
            showToast('Â∑≤Ê∏ÖÈô§', 'success');
        }

        async function clearMessageCache() {
            if (!confirm('Á°ÆÂÆöÊ∏ÖÈô§Ê∂àÊÅØÔºü')) return;
            App.characters.forEach(c => { c.messages = []; });
            await saveData(); await updateStorageDisplay(); showToast('Â∑≤Ê∏ÖÈô§', 'success');
        }

        async function compactDatabase() {
            showToast('‰ºòÂåñ‰∏≠...', 'info');
            for (let c of App.characters) {
                if (c.avatarImage?.length > 50000) c.avatarImage = await compressImage(c.avatarImage, 150, 0.7);
                if (c.userAvatar?.length > 50000) c.userAvatar = await compressImage(c.userAvatar, 150, 0.7);
                if (c.chatWallpaper?.length > 300000) c.chatWallpaper = await compressImage(c.chatWallpaper, 500, 0.7);
            }
            if (App.settings.wallpaperData?.length > 500000) App.settings.wallpaperData = await compressImage(App.settings.wallpaperData, 600, 0.7);
            for (let k of Object.keys(App.appIcons)) {
                if (App.appIcons[k]?.length > 30000) App.appIcons[k] = await compressImage(App.appIcons[k], 100, 0.7);
            }
            await saveData(); await updateStorageDisplay(); showToast('ÂÆåÊàê', 'success');
        }

        function compressImage(dataUrl, maxWidth = 400, quality = 0.7) {
            return new Promise((resolve) => {
                if (!dataUrl?.startsWith('data:image')) { resolve(dataUrl); return; }
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        window.addEventListener('beforeunload', () => { saveData(); });
        setInterval(() => { if (App.dataLoaded) saveData(); }, 30000);

        function loadSettingsUI() {
            document.getElementById('apiBaseUrl').value = App.settings.apiBaseUrl || '';
            document.getElementById('apiKey').value = App.settings.apiKey || '';
            document.getElementById('modelName').value = App.settings.modelName || '';
            document.getElementById('maxContextMessages').value = App.settings.maxContextMessages || 200;
            document.getElementById('temperature').value = App.settings.temperature;
            document.getElementById('tempValue').textContent = App.settings.temperature;
            document.getElementById('maxTokens').value = App.settings.maxTokens;
            document.getElementById('maxTokensValue').textContent = App.settings.maxTokens;
        }

        // ==================== Â£ÅÁ∫∏ ====================
        function applyWallpaper() {
            const el = document.getElementById('wallpaperLayer');
            const wp = App.settings.wallpaper, wpData = App.settings.wallpaperData;
            el.style.cssText = '';
            if (wpData) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background-image:url(${wpData})!important;background-size:cover!important;background-position:center!important;`;
            else if (wp?.startsWith('http')) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background-image:url(${wp})!important;background-size:cover!important;background-position:center!important;`;
            else if (GRADIENTS[wp]) el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background:${GRADIENTS[wp]}!important;`;
            else el.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:0!important;background:${GRADIENTS.gradient1}!important;`;
        }

        function updateWallpaperPreview() {
            const preview = document.getElementById('wallpaperPreview');
            const wp = App.tempWallpaper || App.settings.wallpaper;
            if (App.tempWallpaper?.startsWith('data:')) preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            else if (!App.tempWallpaper && App.settings.wallpaperData) preview.style.cssText = `background-image:url(${App.settings.wallpaperData})!important;background-size:cover!important;background-position:center!important;`;
            else if (App.tempWallpaper?.startsWith('http')) preview.style.cssText = `background-image:url(${App.tempWallpaper})!important;background-size:cover!important;background-position:center!important;`;
            else if (GRADIENTS[wp]) preview.style.cssText = `background:${GRADIENTS[wp]}!important;`;
            else preview.style.cssText = `background:${GRADIENTS.gradient1}!important;`;
        }

        function selectPresetWallpaper(name) { App.tempWallpaper = name; highlightWallpaper(); updateWallpaperPreview(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'info'); }
        function previewUrlWallpaper() { const url = document.getElementById('customWallpaperUrl').value.trim(); if (!url) { showToast('ËØ∑ËæìÂÖ•URL', 'error'); return; } App.tempWallpaper = url; updateWallpaperPreview(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'info'); }

        async function handleWallpaperUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => { App.tempWallpaper = await compressImage(ev.target.result, 800, 0.8); updateWallpaperPreview(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'success'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function saveWallpaper() {
            if (!App.tempWallpaper) { showToast('ËØ∑ÂÖàÈÄâÊã©', 'warning'); return; }
            if (App.tempWallpaper.startsWith('data:')) { App.settings.wallpaperData = App.tempWallpaper; App.settings.wallpaper = 'custom'; }
            else if (App.tempWallpaper.startsWith('http')) { App.settings.wallpaper = App.tempWallpaper; App.settings.wallpaperData = null; }
            else { App.settings.wallpaper = App.tempWallpaper; App.settings.wallpaperData = null; }
            App.tempWallpaper = null;
            if (await saveData()) { applyWallpaper(); highlightWallpaper(); updateWallpaperPreview(); await updateStorageDisplay(); showToast('Â∑≤‰øùÂ≠ò', 'success'); }
        }

        function highlightWallpaper() {
            const current = App.tempWallpaper || App.settings.wallpaper;
            document.querySelectorAll('#wallpaperGrid > div').forEach(el => { el.style.borderColor = el.dataset.wp === current ? 'var(--accent-color)' : 'transparent'; });
        }

        // ==================== ÂõæÊ†á ====================
        function updateIconPreviews() {
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => {
                const preview = document.getElementById('iconPreview' + app.charAt(0).toUpperCase() + app.slice(1));
                const iconData = App.tempIcons[app] || App.appIcons[app];
                if (iconData) { preview.innerHTML = `<img src="${iconData}">`; preview.classList.add('has-image'); }
                else { preview.innerHTML = App.defaultEmojis[app]; preview.classList.remove('has-image'); }
            });
        }

        function applyAppIcons() {
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => {
                const el = document.getElementById('appIcon' + app.charAt(0).toUpperCase() + app.slice(1));
                const iconData = App.appIcons[app];
                el.innerHTML = iconData ? `<img src="${iconData}" style="width:100%;height:100%;object-fit:cover;">` : App.defaultEmojis[app];
            });
        }

        async function handleIconUpload(e, appName) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => { App.tempIcons[appName] = await compressImage(ev.target.result, 120, 0.8); updateIconPreviews(); showToast('ÁÇπÂáª‰øùÂ≠òÂ∫îÁî®', 'info'); };
            reader.readAsDataURL(file); e.target.value = '';
        }

        async function saveIcons() {
            let changed = false;
            ['settings', 'messages', 'worldbook', 'photos'].forEach(app => { if (App.tempIcons[app]) { App.appIcons[app] = App.tempIcons[app]; changed = true; } });
            App.tempIcons = {};
            if (changed && await saveData()) { applyAppIcons(); await updateStorageDisplay(); showToast('Â∑≤‰øùÂ≠ò', 'success'); }
            else if (!changed) showToast('Ê≤°ÊúâÊõ¥Êîπ', 'info');
        }

        async function resetIcons() { App.appIcons = { settings: null, messages: null, worldbook: null, photos: null }; App.tempIcons = {}; await saveData(); applyAppIcons(); updateIconPreviews(); showToast('Â∑≤ÈáçÁΩÆ', 'success'); }

        // ==================== È°µÈù¢ÂØºËà™ ====================
        function openPage(id) {
            const page = document.getElementById(id);
            if (page) {
                page.classList.add('active');
                if (id === 'messagesPage') renderContacts();
                if (id === 'worldbookPage') renderWorldbooks();
                if (id === 'wallpaperPage') { updateWallpaperPreview(); updateIconPreviews(); highlightWallpaper(); applyStatusBarVisibility(); }
                if (id === 'settingsPage') { updateStorageDisplay(); checkPWAStatus(); }
            }
        }

        function closePage(id) { document.getElementById(id)?.classList.remove('active'); }
        function showModal(id) { document.getElementById(id)?.classList.add('active'); }
        function hideModal(id) { document.getElementById(id)?.classList.remove('active'); }
        function showToast(msg, type='info') { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); }

        // ==================== API ====================
        function addLog(msg, type='info') { const c = document.getElementById('debugLog'); const e = document.createElement('div'); e.className = `log-entry ${type}`; e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; c.appendChild(e); c.scrollTop = c.scrollHeight; }
        function updateConnectionUI() { const h = document.getElementById('connectionStatusHint'); if (App.connectionStatus === 'connected') { h.className = 'action-hint success'; h.innerHTML = `<span class="action-hint-icon">‚úÖ</span><span class="action-hint-text">Â∑≤ËøûÊé• - ${App.settings.modelName}</span>`; } else { h.className = 'action-hint'; h.innerHTML = `<span class="action-hint-icon">‚ö†Ô∏è</span><span class="action-hint-text">Êú™ËøûÊé•</span>`; } }

        async function fetchModels() {
            const url = document.getElementById('apiBaseUrl').value.trim(), key = document.getElementById('apiKey').value.trim();
            if (!url || !key) { showToast('ËØ∑Â°´ÂÜô', 'error'); return; }
            const btn = document.getElementById('fetchModelsBtn'); btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>';
            try {
                const r = await fetch(`${url.replace(/\/+$/,'').replace(/\/v1$/,'')}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const d = await r.json(), models = d.data || d.models || d || [];
                App.models = models;
                document.getElementById('modelListContainer').style.display = 'block';
                document.getElementById('modelList').innerHTML = models.map(m => { const id = m.id || m.name || m; return `<div class="model-item" onclick="selectModel('${id}')"><span class="model-item-name">${id}</span></div>`; }).join('');
                addLog(`ÊâæÂà∞${models.length}‰∏™`, 'success');
            } catch(e) { addLog(`Â§±Ë¥•: ${e.message}`, 'error'); showToast(`Â§±Ë¥•: ${e.message}`, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = 'üìã ÊãâÂèñÊ®°Âûã'; }
        }

        function selectModel(id) { App.settings.modelName = id; document.getElementById('modelName').value = id; document.querySelectorAll('.model-item').forEach(el => { el.classList.toggle('selected', el.querySelector('.model-item-name').textContent === id); }); showToast(`Â∑≤ÈÄâ: ${id}`, 'success'); }

        async function testConnection() {
            const url = document.getElementById('apiBaseUrl').value.trim(), key = document.getElementById('apiKey').value.trim(), model = document.getElementById('modelName').value.trim();
            if (!url || !key || !model) { showToast('ËØ∑Â°´ÂÜô', 'error'); return; }
            const btn = document.getElementById('testConnectionBtn'); btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span>';
            try {
                const r = await fetch(`${url.replace(/\/+$/,'').replace(/\/v1$/,'')}/v1/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 }) });
                if (r.ok) { App.connectionStatus = 'connected'; App.settings.apiBaseUrl = url; App.settings.apiKey = key; App.settings.modelName = model; await saveData(); showToast('ÊàêÂäüÔºÅ', 'success'); addLog('ËøûÊé•ÊàêÂäü', 'success'); }
                else throw new Error(`HTTP ${r.status}`);
            } catch(e) { App.connectionStatus = 'disconnected'; showToast(`Â§±Ë¥•: ${e.message}`, 'error'); }
            finally { updateConnectionUI(); btn.disabled = false; btn.innerHTML = 'üîó ÊµãËØïËøûÊé•'; }
        }

        async function saveApiSettings() {
            App.settings.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            App.settings.apiKey = document.getElementById('apiKey').value.trim();
            App.settings.modelName = document.getElementById('modelName').value.trim();
            App.settings.temperature = parseFloat(document.getElementById('temperature').value);
            App.settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            App.settings.maxContextMessages = parseInt(document.getElementById('maxContextMessages').value) || 200;
            await saveData(); showToast('Â∑≤‰øùÂ≠ò', 'success');
        }

        // ==================== ËßíËâ≤ ====================
        async function createCharacter() {
            const name = document.getElementById('newCharacterName').value.trim(); if (!name) { showToast('ËØ∑ËæìÂÖ•', 'error'); return; }
            const char = {
                id: Date.now().toString(), name,
                avatar: ['üòä','üòé','ü•∞','ü¶ä','üê±','üê∞'][Math.floor(Math.random()*6)],
                avatarImage: null, userAvatar: null, showAvatar: true, avatarShape: 'circle',
                showBorder: false, borderColor: '#007AFF', borderWidth: 2,
                description: '', greeting: '', scenario: '', worldbookId: '', userNick: '', systemPrompt: '',
                messages: [], chatWallpaper: null, customCss: '', activeCssPresetId: null, timestampPosition: 'default'
            };
            App.characters.push(char); await saveData(); hideModal('createCharacterModal'); renderContacts(); showToast(`"${name}"Â∑≤ÂàõÂª∫`, 'success');
        }

        function renderContacts() {
            const list = document.getElementById('contactList'), empty = document.getElementById('emptyContactState');
            if (App.characters.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; }
            list.style.display = 'flex'; empty.style.display = 'none';
            list.innerHTML = App.characters.map(c => {
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content.substring(0,25)+'...' : 'ÂºÄÂßãÂØπËØù';
                const lastTime = c.messages.length > 0 ? formatTime(c.messages[c.messages.length-1].timestamp) : '';
                const avatarHtml = c.avatarImage ? `<img src="${c.avatarImage}">` : (c.avatar || c.name[0]);
                return `<div class="contact-item" onclick="openChat('${c.id}')"><div class="contact-avatar">${avatarHtml}</div><div class="contact-info"><div class="contact-name">${escapeHtml(c.name)}</div><div class="contact-preview">${escapeHtml(lastMsg)}</div></div><div class="contact-time">${lastTime}</div></div>`;
            }).join('');
        }

        function filterContacts() { const q = document.getElementById('contactSearch').value.toLowerCase(); document.querySelectorAll('.contact-item').forEach(el => { el.style.display = el.querySelector('.contact-name').textContent.toLowerCase().includes(q) ? 'flex' : 'none'; }); }

        function openChat(id) {
            const char = App.characters.find(c => c.id === id); if (!char) return;
            App.currentCharId = id; App.isSelectMode = false; App.selectedMsgs.clear(); App.lastAIStart = -1;
            document.getElementById('chatTitle').textContent = char.name;
            document.getElementById('selectModeBar').classList.remove('active');
            document.getElementById('chatMessages').classList.remove('select-mode');
            applyChatWallpaper(char);
            applyCustomCss(char);
            renderMessages(); openPage('chatPage');
            if (char.messages.length === 0 && char.greeting) addMessage(char.greeting, 'received');
        }

        function applyChatWallpaper(char) {
            const chatPage = document.getElementById('chatPage');
            if (char.chatWallpaper) {
                chatPage.classList.add('has-custom-bg');
                chatPage.style.backgroundImage = `url(${char.chatWallpaper})`;
            } else {
                chatPage.classList.remove('has-custom-bg');
                chatPage.style.backgroundImage = '';
            }
        }

        function applyCustomCss(char) {
            const styleEl = document.getElementById('customCssStyles');
            let css = '';
            if (char.activeCssPresetId) {
                const preset = App.globalCssPresets.find(p => p.id === char.activeCssPresetId);
                if (preset) css = preset.css;
            }
            if (char.customCss) css = char.customCss;
            styleEl.textContent = css;
        }

        function closeChatPage() {
            exitSelectMode();
            closePage('chatPage');
            document.getElementById('customCssStyles').textContent = '';
            const chatPage = document.getElementById('chatPage');
            chatPage.classList.remove('has-custom-bg');
            chatPage.style.backgroundImage = '';
            App.currentCharId = null;
        }

        function openCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            updateChatWallpaperPreview(char);
            const charAvUpload = document.getElementById('charAvatarUpload'), userAvUpload = document.getElementById('userAvatarUpload');
            if (char.avatarImage) { charAvUpload.innerHTML = `<img src="${char.avatarImage}">`; charAvUpload.classList.add('has-image'); } else { charAvUpload.innerHTML = 'üì∑'; charAvUpload.classList.remove('has-image'); }
            charAvUpload.dataset.image = char.avatarImage || '';
            if (char.userAvatar) { userAvUpload.innerHTML = `<img src="${char.userAvatar}">`; userAvUpload.classList.add('has-image'); } else { userAvUpload.innerHTML = 'üë§'; userAvUpload.classList.remove('has-image'); }
            userAvUpload.dataset.image = char.userAvatar || '';
            document.getElementById('showAvatarToggle').classList.toggle('active', char.showAvatar !== false);
            document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(el => { el.classList.toggle('selected', el.dataset.shape === (char.avatarShape || 'circle')); });
            document.getElementById('showBorderToggle').classList.toggle('active', char.showBorder === true);
            document.getElementById('borderColorPicker').value = char.borderColor || '#007AFF';
            document.getElementById('borderWidthSlider').value = char.borderWidth || 2;
            document.getElementById('borderWidthValue').textContent = char.borderWidth || 2;
            document.getElementById('charName').value = char.name;
            document.getElementById('charAvatar').value = char.avatar || '';
            document.getElementById('charDescription').value = char.description || '';
            document.getElementById('charGreeting').value = char.greeting || '';
            document.getElementById('charScenario').value = char.scenario || '';
            document.getElementById('charUserNick').value = char.userNick || '';
            document.getElementById('charSystemPrompt').value = char.systemPrompt || '';
            document.getElementById('timestampPosition').value = char.timestampPosition || 'default';
            document.getElementById('customCssEditor').value = char.customCss || '';
            updateCssPresetSelect(char);
            updateWorldbookSelect();
            document.getElementById('charWorldbook').value = char.worldbookId || '';
            updateCharCounter();
            openPage('characterSettingsPage');
        }

        function updateChatWallpaperPreview(char) {
            const preview = document.getElementById('chatWallpaperPreview');
            if (char.chatWallpaper) {
                preview.style.backgroundImage = `url(${char.chatWallpaper})`;
                preview.classList.add('has-image');
            } else {
                preview.style.backgroundImage = '';
                preview.classList.remove('has-image');
            }
        }

        function updateCssPresetSelect(char) {
            const select = document.getElementById('cssPresetSelect');
            select.innerHTML = '<option value="">-- Êó†È¢ÑËÆæ --</option>' +
                App.globalCssPresets.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            select.value = char.activeCssPresetId || '';
        }

        function closeCharacterSettings() { closePage('characterSettingsPage'); }

        async function handleCharAvatarUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async ev => { const compressed = await compressImage(ev.target.result, 200, 0.8); const upload = document.getElementById('charAvatarUpload'); upload.innerHTML = `<img src="${compressed}">`; upload.classList.add('has-image'); upload.dataset.image = compressed; }; reader.readAsDataURL(file); e.target.value = ''; }
        async function handleUserAvatarUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async ev => { const compressed = await compressImage(ev.target.result, 200, 0.8); const upload = document.getElementById('userAvatarUpload'); upload.innerHTML = `<img src="${compressed}">`; upload.classList.add('has-image'); upload.dataset.image = compressed; }; reader.readAsDataURL(file); e.target.value = ''; }
        function selectShape(el) { document.querySelectorAll('#avatarShapeOptions .shape-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); }

        async function handleChatWallpaperUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                char.chatWallpaper = await compressImage(ev.target.result, 600, 0.8);
                updateChatWallpaperPreview(char);
                showToast('Â∑≤ËÆæÁΩÆÔºå‰øùÂ≠òÂêéÁîüÊïà', 'success');
            };
            reader.readAsDataURL(file); e.target.value = '';
        }

        function applyChatWallpaperUrl() {
            const url = document.getElementById('chatWallpaperUrl').value.trim();
            if (!url) { showToast('ËØ∑ËæìÂÖ•URL', 'error'); return; }
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            char.chatWallpaper = url;
            updateChatWallpaperPreview(char);
            showToast('Â∑≤ËÆæÁΩÆÔºå‰øùÂ≠òÂêéÁîüÊïà', 'success');
        }

        function clearChatWallpaper() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            char.chatWallpaper = null;
            updateChatWallpaperPreview(char);
            showToast('Â∑≤Ê∏ÖÈô§Ôºå‰øùÂ≠òÂêéÁîüÊïà', 'info');
        }

        function confirmClearAllMessages() { showModal('clearMessagesModal'); }

        async function executeClearAllMessages() {
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (!char) return;
            char.messages = [];
            await saveData();
            hideModal('clearMessagesModal');
            renderMessages();
            showToast('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÈô§', 'success');
        }

        function loadCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value;
            if (!presetId) { document.getElementById('customCssEditor').value = ''; return; }
            const preset = App.globalCssPresets.find(p => p.id === presetId);
            if (preset) document.getElementById('customCssEditor').value = preset.css;
        }

        function addNewCssPreset() {
            showModal('cssPresetNameModal');
            document.getElementById('newCssPresetName').value = '';
        }

        async function createCssPreset() {
            const name = document.getElementById('newCssPresetName').value.trim();
            if (!name) { showToast('ËØ∑ËæìÂÖ•ÂêçÁß∞', 'error'); return; }
            const css = document.getElementById('customCssEditor').value;
            const preset = { id: Date.now().toString(), name: name, css: css };
            App.globalCssPresets.push(preset);
            await saveData();
            hideModal('cssPresetNameModal');
            const char = App.characters.find(c => c.id === App.currentCharId);
            if (char) {
                updateCssPresetSelect(char);
                document.getElementById('cssPresetSelect').value = preset.id;
            }
            showToast(`È¢ÑËÆæ"${name}"Â∑≤ÂàõÂª∫`, 'success');
        }

        async function saveCssPreset() {
            const presetId = document.getElementById('cssPresetSelect').value;
            if (!presetId) { showToast('ËØ∑ÂÖàÈÄâÊã©ÊàñÂàõÂª∫È¢ÑËÆæ', 'warning'); return; }
            const preset = App.globalCssPresets.find(p => p.id === presetId);
            if (!preset) return;
            preset.css = document.getElementById('customCssEditor').value;
            await saveData();
            showToast(`È¢ÑËÆæ"${preset.name}"Â∑≤Êõ¥Êñ∞`, 'success');
        }

        function showCssGuide() { showModal('cssGuideModal'); }

        function previewCss() {
            const css = document.getElementById('customCssEditor').value;
            document.getElementById('customCssStyles').textContent = css;
            showToast('CSSÂ∑≤È¢ÑËßà', 'info');
        }

        function clearCustomCss() {
            document.getElementById('customCssEditor').value = '';
            document.getElementById('cssPresetSelect').value = '';
            document.getElementById('customCssStyles').textContent = '';
            showToast('CSSÂ∑≤Ê∏ÖÈô§', 'info');
        }

        async function saveCharacterSettings() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const greeting = document.getElementById('charGreeting').value; if (greeting.length > 300) { showToast('ÂºÄÂú∫ÁôΩËøáÈïø', 'error'); return; }
            char.avatarImage = document.getElementById('charAvatarUpload').dataset.image || null;
            char.userAvatar = document.getElementById('userAvatarUpload').dataset.image || null;
            char.showAvatar = document.getElementById('showAvatarToggle').classList.contains('active');
            const shapeEl = document.querySelector('#avatarShapeOptions .shape-option.selected');
            char.avatarShape = shapeEl ? shapeEl.dataset.shape : 'circle';
            char.showBorder = document.getElementById('showBorderToggle').classList.contains('active');
            char.borderColor = document.getElementById('borderColorPicker').value;
            char.borderWidth = parseInt(document.getElementById('borderWidthSlider').value);
            char.name = document.getElementById('charName').value.trim() || char.name;
            char.avatar = document.getElementById('charAvatar').value.trim() || char.avatar;
            char.description = document.getElementById('charDescription').value;
            char.greeting = greeting;
            char.scenario = document.getElementById('charScenario').value;
            char.worldbookId = document.getElementById('charWorldbook').value;
            char.userNick = document.getElementById('charUserNick').value.trim();
            char.systemPrompt = document.getElementById('charSystemPrompt').value;
            char.timestampPosition = document.getElementById('timestampPosition').value;
            char.customCss = document.getElementById('customCssEditor').value;
            char.activeCssPresetId = document.getElementById('cssPresetSelect').value || null;
            document.getElementById('chatTitle').textContent = char.name;
            await saveData();
            applyChatWallpaper(char);
            applyCustomCss(char);
            renderMessages();
            closeCharacterSettings();
            showToast('Â∑≤‰øùÂ≠ò', 'success');
        }

        function updateCharCounter() { const ta = document.getElementById('charGreeting'), counter = document.getElementById('greetingCharCounter'); counter.textContent = `${ta.value.length}/300`; counter.className = 'char-counter' + (ta.value.length >= 280 ? ' warning' : '') + (ta.value.length >= 300 ? ' error' : ''); }
        function deleteCurrentCharacter() { const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; App.pendingDeleteType = 'character'; App.pendingDeleteId = char.id; document.getElementById('deleteModalTitle').textContent = `Âà†Èô§"${char.name}"Ôºü`; showModal('confirmDeleteModal'); }

        // ==================== Ê∂àÊÅØ ====================
        function renderMessages() {
            const container = document.getElementById('chatMessages');
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (char.messages.length === 0) { container.innerHTML = '<div class="date-separator"><span class="date-separator-text">‰ªäÂ§©</span></div>'; return; }
            const showAvatar = char.showAvatar !== false, avatarShape = char.avatarShape || 'circle', showBorder = char.showBorder === true, borderColor = char.borderColor || '#007AFF', borderWidth = char.borderWidth || 2;
            let shapeClass = avatarShape === 'square' ? 'square' : avatarShape === 'rounded-square' ? 'rounded-square' : '';
            const borderStyle = showBorder ? `border:${borderWidth}px solid ${borderColor};` : '';
            const timestampPos = char.timestampPosition || 'default';
            let timeClass = '';
            if (timestampPos === 'hidden') timeClass = 'time-hidden';
            else if (timestampPos === 'side') timeClass = 'time-side';
            let html = '', lastDate = null;
            char.messages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString();
                if (msgDate !== lastDate) { html += `<div class="date-separator"><span class="date-separator-text">${formatDate(msg.timestamp)}</span></div>`; lastDate = msgDate; }
                const type = msg.role === 'user' ? 'sent' : 'received', checked = App.selectedMsgs.has(msg.id) ? 'checked' : '';
                let avatarHtml = '';
                if (showAvatar) { const avatarContent = type === 'received' ? (char.avatarImage ? `<img src="${char.avatarImage}">` : (char.avatar || char.name[0])) : (char.userAvatar ? `<img src="${char.userAvatar}">` : 'üë§'); avatarHtml = `<div class="message-avatar ${shapeClass}" style="${borderStyle}">${avatarContent}</div>`; }
                html += `<div class="message-wrapper ${type}" data-msg-id="${msg.id}"><div class="message-checkbox ${checked}" onclick="toggleMsgSelect('${msg.id}')"></div>${type === 'received' ? avatarHtml : ''}<div class="message ${type}" style="position:relative;">${escapeHtml(msg.content)}<div class="message-time ${timeClass}">${formatTime(msg.timestamp)}</div></div>${type === 'sent' ? avatarHtml : ''}</div>`;
            });
            container.innerHTML = html;
            scrollToBottom();
        }

        async function addMessage(content, type) {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            const msg = { id: Date.now().toString() + Math.random().toString(36).substr(2,9), role: type === 'sent' ? 'user' : 'assistant', content, timestamp: new Date().toISOString() };
            char.messages.push(msg); await saveData(); renderMessages();
        }

        function sendMessage() { const input = document.getElementById('chatInput'), content = input.value.trim(); if (!content) return; addMessage(content, 'sent'); input.value = ''; autoResizeTextarea(input); }
        function parseAIResponse(text) { if (!text) return ['...']; let cleaned = text.trim().replace(/^\s*\[[^\]]*\]\s*[:Ôºö]\s*/g, '').replace(/^\s*„Äê[^„Äë]*„Äë\s*[:Ôºö]?\s*/g, '').replace(/^[^:Ôºö\n]{1,20}[:Ôºö]\s*/g, ''); const seps = [/\s*\|\|\|\s*/g, /\s*\|\|\s*/g, /\s*\|\s*/g, /\n\n+/g, /\n/g]; let parts = [cleaned]; for (const sep of seps) { const test = cleaned.split(sep).map(s => s.trim()).filter(s => s); if (test.length > 1) { parts = test; break; } } return parts.map(p => p.replace(/^["„Äå„Äé"]+/, '').replace(/["„Äç„Äè"]+$/, '').trim()).filter(p => p); }

        async function triggerAIReply() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return;
            if (!App.settings.apiBaseUrl || !App.settings.apiKey || !App.settings.modelName) { showToast('ËØ∑ÈÖçÁΩÆAPI', 'error'); return; }
            App.lastAIStart = char.messages.length;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', '<div class="typing-indicator" id="typingIndicator"><span></span><span></span><span></span></div>');
            scrollToBottom();
            try {
                const messages = buildAPIMessages(char);
                const url = App.settings.apiBaseUrl.replace(/\/+$/,'').replace(/\/v1$/,'');
                const r = await fetch(`${url}/v1/chat/completions`, { method: 'POST', headers: { 'Authorization': `Bearer ${App.settings.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: App.settings.modelName, messages, temperature: App.settings.temperature, max_tokens: App.settings.maxTokens }) });
                document.getElementById('typingIndicator')?.remove();
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json(), reply = data.choices[0].message.content, parts = parseAIResponse(reply);
                for (let i = 0; i < parts.length; i++) { if (i > 0) await new Promise(r => setTimeout(r, 300 + Math.random()*400)); await addMessage(parts[i], 'received'); }
            } catch(e) { document.getElementById('typingIndicator')?.remove(); App.lastAIStart = -1; showToast(`Â§±Ë¥•: ${e.message}`, 'error'); }
        }

        function buildAPIMessages(char) {
            const msgs = [];
            let sys = `# Áü≠‰ø°Ê®°ÊãüËßÑÂàô\n\n‰Ω†Ê≠£Âú®ÊâÆÊºî"${char.name}"ÔºåÈÄöËøáÊâãÊú∫Áü≠‰ø°ËÅäÂ§©„ÄÇ\n\n## „ÄêÈáçË¶Å„ÄëËæìÂá∫Ê†ºÂºè\n1. ÊØèÊù°Áü≠‰ø°Áî® ||| ÂàÜÈöî\n2. ÊØèÊù°5-20Â≠óÂ∑¶Âè≥ÔºåÂèØÈïøÂèØÁü≠\n3. ‰∏çË¶ÅÂä†ËßíËâ≤ÂêçÂâçÁºÄ\n4. ÂÉèÁúü‰∫∫ÂèëÁü≠‰ø°\n\n## Ê≠£Á°ÆÁ§∫‰æã\nÂóØ|||ÊÄé‰πà‰∫Ü?|||Êúâ‰∫ã?\nÂ•ΩÊó†ËÅä|||‰Ω†Âú®Âπ≤Âòõ\n\n## ÈîôËØØÔºàÁ¶ÅÊ≠¢Ôºâ\n‚ùå ËßíËâ≤Âêç: ÂÜÖÂÆπ\n‚ùå ‰∏ÄÊù°Ê∂àÊÅØÂ§™Èïø\n\n## ËßíËâ≤\n${char.description || 'ÊúãÂèã'}`;
            if (char.scenario) sys += `\n\n## ÊÉÖÊôØ\n${char.scenario}`;
            if (char.userNick) sys += `\n\n## Áß∞Âëº\n${char.userNick}`;
            if (char.systemPrompt) sys += `\n\n## È¢ùÂ§ñ\n${char.systemPrompt}`;
            const wb = App.worldbooks.find(w => w.id === char.worldbookId);
            if (wb?.content) { const inject = wb.alwaysActive || (wb.keywords && char.messages.some(m => wb.keywords.split(',').some(k => m.content.toLowerCase().includes(k.trim().toLowerCase())))); if (inject) sys += `\n\n## ËÉåÊôØ\n${wb.content}`; }
            msgs.push({ role: 'system', content: sys });
            const max = App.settings.maxContextMessages || 200, history = char.messages.slice(-max), merged = [];
            for (let i = 0; i < history.length; i++) { const cur = history[i], last = merged[merged.length - 1]; if (last && last.role === cur.role) last.content += '|||' + cur.content; else merged.push({ role: cur.role, content: cur.content }); }
            merged.forEach(m => { msgs.push({ role: m.role === 'user' ? 'user' : 'assistant', content: m.content }); });
            if (history.length > 10) msgs.push({ role: 'system', content: '„ÄêÊèêÈÜí„ÄëÁî®|||ÂàÜÈöîÁü≠‰ø°ÔºåÊØèÊù°ÁÆÄÁü≠Ëá™ÁÑ∂„ÄÇ' });
            return msgs;
        }

        async function regenerateLastReply() {
            const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; toggleExtensionPanel();
            if (char.messages.length === 0) { showToast('Êó†Ê∂àÊÅØ', 'warning'); return; }
            if (App.lastAIStart >= 0 && App.lastAIStart < char.messages.length) { let allAI = true; for (let i = App.lastAIStart; i < char.messages.length; i++) { if (char.messages[i].role !== 'assistant') { allAI = false; break; } } if (allAI) { const count = char.messages.length - App.lastAIStart; char.messages.splice(App.lastAIStart, count); await saveData(); renderMessages(); showToast(`Â∑≤Âà†${count}Êù°`, 'info'); App.lastAIStart = -1; await triggerAIReply(); return; } }
            if (char.messages[char.messages.length-1].role !== 'assistant') { showToast('ÊúÄÂêéÈùûAI', 'warning'); return; }
            let first = char.messages.length - 1; for (let i = char.messages.length - 1; i >= 0; i--) { if (char.messages[i].role === 'assistant') first = i; else break; }
            const count = char.messages.length - first; char.messages.splice(first, count); await saveData(); renderMessages(); showToast(`Â∑≤Âà†${count}Êù°`, 'info'); await triggerAIReply();
        }

        function enterSelectMode() { toggleExtensionPanel(); App.isSelectMode = true; App.selectedMsgs.clear(); document.getElementById('chatMessages').classList.add('select-mode'); document.getElementById('selectModeBar').classList.add('active'); updateSelectedCount(); }
        function exitSelectMode() { App.isSelectMode = false; App.selectedMsgs.clear(); document.getElementById('chatMessages').classList.remove('select-mode'); document.getElementById('selectModeBar').classList.remove('active'); document.querySelectorAll('.message-checkbox').forEach(el => el.classList.remove('checked')); }
        function toggleMsgSelect(id) { if (!App.isSelectMode) return; if (App.selectedMsgs.has(id)) App.selectedMsgs.delete(id); else App.selectedMsgs.add(id); document.querySelector(`[data-msg-id="${id}"] .message-checkbox`)?.classList.toggle('checked', App.selectedMsgs.has(id)); updateSelectedCount(); }
        function updateSelectedCount() { document.getElementById('selectedCount').textContent = App.selectedMsgs.size; }
        async function deleteSelectedMessages() { const char = App.characters.find(c => c.id === App.currentCharId); if (!char) return; if (App.selectedMsgs.size === 0) { showToast('ËØ∑ÈÄâÊã©', 'warning'); return; } const count = App.selectedMsgs.size; char.messages = char.messages.filter(m => !App.selectedMsgs.has(m.id)); await saveData(); exitSelectMode(); renderMessages(); showToast(`Â∑≤Âà†${count}Êù°`, 'success'); App.lastAIStart = -1; }
        function toggleExtensionPanel() { document.getElementById('extensionPanel').classList.toggle('active'); }
        function autoResizeTextarea(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 90) + 'px'; }
        function scrollToBottom() { const c = document.getElementById('chatMessages'); c.scrollTop = c.scrollHeight; }

        // ==================== ‰∏ñÁïå‰π¶ ====================
        async function createWorldbook() { const name = document.getElementById('newWorldbookName').value.trim(); if (!name) { showToast('ËØ∑ËæìÂÖ•', 'error'); return; } const wb = { id: Date.now().toString(), name, summary: '', keywords: '', content: '', alwaysActive: false }; App.worldbooks.push(wb); await saveData(); hideModal('createWorldbookModal'); renderWorldbooks(); showToast(`"${name}"Â∑≤ÂàõÂª∫`, 'success'); openWorldbookEdit(wb.id); }
        function renderWorldbooks() { const list = document.getElementById('worldbookList'), empty = document.getElementById('emptyWorldbookState'); if (App.worldbooks.length === 0) { list.style.display = 'none'; empty.style.display = 'flex'; return; } list.style.display = 'block'; empty.style.display = 'none'; list.innerHTML = App.worldbooks.map(wb => `<div class="worldbook-item" onclick="openWorldbookEdit('${wb.id}')"><div class="worldbook-item-header"><span class="worldbook-item-title">${escapeHtml(wb.name)}</span>${wb.alwaysActive ? '<span class="worldbook-item-badge">ÂßãÁªà</span>' : ''}</div><div class="worldbook-item-preview">${escapeHtml(wb.summary || wb.content?.substring(0,60) || 'Êó†ÂÜÖÂÆπ')}</div></div>`).join(''); }
        function openWorldbookEdit(id) { const wb = App.worldbooks.find(w => w.id === id); if (!wb) return; App.currentWbId = id; document.getElementById('worldbookName').value = wb.name; document.getElementById('worldbookSummary').value = wb.summary || ''; document.getElementById('worldbookKeywords').value = wb.keywords || ''; document.getElementById('worldbookContent').value = wb.content || ''; document.getElementById('worldbookAlwaysActive').classList.toggle('active', wb.alwaysActive); openPage('worldbookEditPage'); }
        function closeWorldbookEdit() { closePage('worldbookEditPage'); App.currentWbId = null; }
        async function saveWorldbook() { const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return; wb.name = document.getElementById('worldbookName').value.trim() || wb.name; wb.summary = document.getElementById('worldbookSummary').value; wb.keywords = document.getElementById('worldbookKeywords').value; wb.content = document.getElementById('worldbookContent').value; wb.alwaysActive = document.getElementById('worldbookAlwaysActive').classList.contains('active'); await saveData(); closeWorldbookEdit(); renderWorldbooks(); showToast('Â∑≤‰øùÂ≠ò', 'success'); }
        function deleteCurrentWorldbook() { const wb = App.worldbooks.find(w => w.id === App.currentWbId); if (!wb) return; App.pendingDeleteType = 'worldbook'; App.pendingDeleteId = wb.id; document.getElementById('deleteModalTitle').textContent = `Âà†Èô§"${wb.name}"Ôºü`; showModal('confirmDeleteModal'); }
        function updateWorldbookSelect() { const sel = document.getElementById('charWorldbook'); sel.innerHTML = '<option value="">‰∏çÁªëÂÆö</option>' + App.worldbooks.map(wb => `<option value="${wb.id}">${escapeHtml(wb.name)}</option>`).join(''); }

        async function confirmDelete() {
            if (App.pendingDeleteType === 'character') { App.characters = App.characters.filter(c => c.id !== App.pendingDeleteId); await saveData(); hideModal('confirmDeleteModal'); closeCharacterSettings(); closeChatPage(); renderContacts(); showToast('Â∑≤Âà†Èô§', 'success'); }
            else if (App.pendingDeleteType === 'worldbook') { App.characters.forEach(c => { if (c.worldbookId === App.pendingDeleteId) c.worldbookId = ''; }); App.worldbooks = App.worldbooks.filter(w => w.id !== App.pendingDeleteId); await saveData(); hideModal('confirmDeleteModal'); closeWorldbookEdit(); renderWorldbooks(); showToast('Â∑≤Âà†Èô§', 'success'); }
        }

        // ==================== ÂØºÂÖ•ÂØºÂá∫ ====================
        function exportAllData() { const data = { characters: App.characters, worldbooks: App.worldbooks, settings: App.settings, appIcons: App.appIcons, globalCssPresets: App.globalCssPresets, version: '5.0.0', exportedAt: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sms-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); showToast('Â∑≤ÂØºÂá∫', 'success'); }
        async function importData(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async ev => { try { const data = JSON.parse(ev.target.result); if (data.characters) App.characters = data.characters; if (data.worldbooks) App.worldbooks = data.worldbooks; if (data.settings) App.settings = {...App.settings, ...data.settings}; if (data.appIcons) App.appIcons = {...App.appIcons, ...data.appIcons}; if (data.globalCssPresets) App.globalCssPresets = data.globalCssPresets; if (await saveData()) { loadSettingsUI(); applyWallpaper(); applyAppIcons(); applyStatusBarVisibility(); await updateStorageDisplay(); showToast('ÂØºÂÖ•ÊàêÂäü', 'success'); } } catch(err) { showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message, 'error'); } }; reader.readAsText(file); e.target.value = ''; }
        async function clearAllData() { if (confirm('Á°ÆÂÆöÊ∏ÖÈô§ÊâÄÊúâÔºü')) { try { await clearIDBStore('appData'); await clearIDBStore('images'); location.reload(); } catch (e) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } } }

        // ==================== Â∑•ÂÖ∑ ====================
        function toggleSwitch(el) { el.classList.toggle('active'); }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatTime(ts) { return new Date(ts).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); }
        function formatDate(ts) { const d = new Date(ts), today = new Date(), yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1); if (d.toDateString() === today.toDateString()) return '‰ªäÂ§©'; if (d.toDateString() === yesterday.toDateString()) return 'Êò®Â§©'; return d.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' }); }

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { const input = document.getElementById('chatInput'); if (document.activeElement === input && document.getElementById('chatPage').classList.contains('active')) { e.preventDefault(); sendMessage(); } }
            if (e.key === 'Escape') { ['createCharacterModal','createWorldbookModal','confirmDeleteModal','clearMessagesModal','cssPresetNameModal','cssGuideModal'].forEach(hideModal); if (App.isSelectMode) exitSelectMode(); }
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); }); });

        // Èò≤Ê≠¢iOS SafariÁöÑÊ©°ÁöÆÁ≠ãÊªöÂä®ÊïàÊûú
        document.body.addEventListener('touchmove', function(e) {
            if (!e.target.closest('.page-content, .chat-messages, .modal, .guide-content, .model-list, .log-container')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
```
